import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService, ContextDashboardManagedObject, ContextWidgetConfig } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
var DashboardBridgeService = /** @class */ (function () {
    function DashboardBridgeService(ng1Injector, zone, router, contextDashboardService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    Object.defineProperty(DashboardBridgeService.prototype, "ng1Components", {
        get: function () {
            return this.ng1Injector.get('c8yComponents');
        },
        enumerable: true,
        configurable: true
    });
    DashboardBridgeService.prototype.instantiateComponent = function (widget, element) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dashboard, context, child, transformedChild_1;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        dashboard = widget.dashboard, context = widget.context, child = widget.child;
                        if (!dashboard) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child)];
                    case 1:
                        transformedChild_1 = _a.sent();
                        if (!(this.dashboardSvc.forcedContext || dashboard.deviceType)) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild_1.config)];
                    case 2:
                        _a.sent();
                        _a.label = 3;
                    case 3: return [2 /*return*/, this.zone.runOutsideAngular(function () {
                            return _this.loadTemplate(transformedChild_1, child, element, context);
                        })];
                    case 4: return [2 /*return*/, this.loadConfigTemplate(element, widget)];
                }
            });
        });
    };
    DashboardBridgeService.prototype.editDashboard = function (dashboard) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id })];
            });
        });
    };
    DashboardBridgeService.prototype.copyDashboard = function () {
        var dashboard = this.getDashboard();
        var couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            return dashboard;
        }
    };
    DashboardBridgeService.prototype.pasteDashboard = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var newDashboard, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.dashboardSvc.pasteDashboard()];
                    case 1:
                        newDashboard = _a.sent();
                        return [4 /*yield*/, this.contextDashboardService.addTab(newDashboard)];
                    case 2:
                        _a.sent();
                        this.navigateToDashboard(newDashboard);
                        this.dashboardClipboard = undefined;
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    DashboardBridgeService.prototype.instantiateDeviceSelector = function (element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    };
    DashboardBridgeService.prototype.loadTemplate = function (transformedChild, child, element, context) {
        var scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = "<c8y-ui-component component-name=\"'" + child.widgetComponent + "'\" config=\"child.config\" context=\"dashboardContext\"></c8y-ui-component>";
        }
        else if (child.templateUrl) {
            element.innerHTML = "<ng-include src=\"'" + child.templateUrl + "'\"></ng-include>";
        }
        this.compile(element)(scope);
        return scope;
    };
    DashboardBridgeService.prototype.navigateToDashboard = function (dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    };
    DashboardBridgeService.prototype.getDashboard = function () {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    };
    DashboardBridgeService.prototype.loadConfigTemplate = function (element, widgetConfig, onlyDeviceSelector) {
        var _this = this;
        if (onlyDeviceSelector === void 0) { onlyDeviceSelector = false; }
        var settings = widgetConfig.settings;
        var scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = tslib_1.__assign({}, settings, settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.dashboard = widgetConfig.dashboardMo;
        scope.rootId = settings.context.id;
        var configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = "<c8y-ui-component component-name=\"'" + widgetConfig.settings.configComponent + "'\" config=\"config\"></c8y-ui-component>";
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = "<ng-include src=\"'" + widgetConfig.settings.configTemplateUrl + "'\"></ng-include>";
            }
        }
        element.innerHTML = "\n    <ng-form name=\"forms.componentForm\">\n      <div class=\"form-group\"\n        ng-if=\"!settings.noDeviceTarget\"\n        ng-style=\"{height: settings.hideTarget && '0', overflow: 'hidden'}\"\n      >\n        <label translate>" + gettext('Target assets or devices') + "</label>\n        <c8y-device-selector-combo parent=\"rootId\"\n          selected-child-device=\"config.device\"\n          groups-selectable=\"settings.groupsSelectable\"\n        ></c8y-device-selector-combo>\n      </div>\n      " + configCmp + "\n    </ng-form>";
        scope.$watch('forms.componentForm.$invalid', function (formStatus) {
            _this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    };
    DashboardBridgeService.ctorParameters = function () { return [
        { type: undefined },
        { type: NgZone },
        { type: Router },
        { type: ContextDashboardService }
    ]; };
    DashboardBridgeService = tslib_1.__decorate([
        Injectable()
    ], DashboardBridgeService);
    return DashboardBridgeService;
}());
export { DashboardBridgeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsiZGFzaGJvYXJkL2Rhc2hib2FyZC1icmlkZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsNkJBQTZCLEVBQzdCLG1CQUFtQixFQUNwQixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUc5QztJQUtFLGdDQUNVLFdBQWdCLEVBQ2hCLElBQVksRUFDWixNQUFjLEVBQ2QsdUJBQWdEO1FBSGhELGdCQUFXLEdBQVgsV0FBVyxDQUFLO1FBQ2hCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUV4RCxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxzQkFBSSxpREFBYTthQUFqQjtZQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDL0MsQ0FBQzs7O09BQUE7SUFFSyxxREFBb0IsR0FBMUIsVUFBMkIsTUFBTSxFQUFFLE9BQU87Ozs7Ozs7d0JBQ2hDLFNBQVMsR0FBcUIsTUFBTSxVQUEzQixFQUFF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QXFKbEM7SUFBRCw2QkFBQztDQUFBLEFBckpELElBcUpDO1NBckpZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGdldEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBDb250ZXh0RGFzaGJvYXJkU2VydmljZSxcbiAgQ29udGV4dERhc2hib2FyZE1hbmFnZWRPYmplY3QsXG4gIENvbnRleHRXaWRnZXRDb25maWdcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9jb250ZXh0LWRhc2hib2FyZCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRCcmlkZ2VTZXJ2aWNlIHtcbiAgZGFzaGJvYXJkU3ZjO1xuICBjb21waWxlO1xuICBkYXNoYm9hcmRDbGlwYm9hcmQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZzFJbmplY3RvcjogYW55LFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBjb250ZXh0RGFzaGJvYXJkU2VydmljZTogQ29udGV4dERhc2hib2FyZFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5kYXNoYm9hcmRTdmMgPSBuZzFJbmplY3Rvci5nZXQoJ2Rhc2hib2FyZFN2YycpO1xuICAgIHRoaXMuY29tcGlsZSA9IG5nMUluamVjdG9yLmdldCgnJGNvbXBpbGUnKTtcbiAgfVxuXG4gIGdldCBuZzFDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLm5nMUluamVjdG9yLmdldCgnYzh5Q29tcG9uZW50cycpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFudGlhdGVDb21wb25lbnQod2lkZ2V0LCBlbGVtZW50KSB7XG4gICAgY29uc3QgeyBkYXNoYm9hcmQsIGNvbnRleHQsIGNoaWxkIH0gPSB3aWRnZXQ7XG4gICAgaWYgKGRhc2hib2FyZCkge1xuICAgICAgY29uc3QgdHJhbnNmb3JtZWRDaGlsZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnRyYW5zZm9ybUNoaWxkV2l0aENvbnRleHQoXG4gICAgICAgIHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgY29udGV4dCxcbiAgICAgICAgZGFzaGJvYXJkLFxuICAgICAgICBjaGlsZFxuICAgICAgKTtcbiAgICAgIGlmICh0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGRhc2hib2FyZC5kZXZpY2VUeXBlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnVwZGF0ZUNvbmZpZ1RhcmdldHNXaXRoQ29udGV4dChcbiAgICAgICAgICB0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGNvbnRleHQsXG4gICAgICAgICAgdHJhbnNmb3JtZWRDaGlsZC5jb25maWdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT5cbiAgICAgICAgdGhpcy5sb2FkVGVtcGxhdGUodHJhbnNmb3JtZWRDaGlsZCwgY2hpbGQsIGVsZW1lbnQsIGNvbnRleHQpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlnVGVtcGxhdGUoZWxlbWVudCwgd2lkZ2V0KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBlZGl0RGFzaGJvYXJkKGRhc2hib2FyZCkge1xuICAgIHJldHVybiB0aGlzLmRhc2hib2FyZFN2Yy5lZGl0Q3VycmVudERhc2hib2FyZCh7IGRhc2hib2FyZElkOiBkYXNoYm9hcmQuaWQgfSk7XG4gIH1cblxuICBjb3B5RGFzaGJvYXJkKCkge1xuICAgIGNvbnN0IGRhc2hib2FyZCA9IHRoaXMuZ2V0RGFzaGJvYXJkKCk7XG4gICAgY29uc3QgY291bGRDb3B5ID0gdGhpcy5kYXNoYm9hcmRTdmMuY29weURhc2hib2FyZChkYXNoYm9hcmQuYzh5X0Rhc2hib2FyZCk7XG4gICAgaWYgKGNvdWxkQ29weSkge1xuICAgICAgdGhpcy5kYXNoYm9hcmRDbGlwYm9hcmQgPSBkYXNoYm9hcmQ7XG4gICAgICByZXR1cm4gZGFzaGJvYXJkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHBhc3RlRGFzaGJvYXJkKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBuZXdEYXNoYm9hcmQgPSBhd2FpdCB0aGlzLmRhc2hib2FyZFN2Yy5wYXN0ZURhc2hib2FyZCgpO1xuICAgICAgYXdhaXQgdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS5hZGRUYWIobmV3RGFzaGJvYXJkKTtcbiAgICAgIHRoaXMubmF2aWdhdGVUb0Rhc2hib2FyZChuZXdEYXNoYm9hcmQpO1xuICAgICAgdGhpcy5kYXNoYm9hcmRDbGlwYm9hcmQgPSB1bmRlZmluZWQ7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgaW5zdGFudGlhdGVEZXZpY2VTZWxlY3RvcihlbGVtZW50LCB3aWRnZXRDb25maWc6IENvbnRleHRXaWRnZXRDb25maWcpIHtcbiAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlnVGVtcGxhdGUoZWxlbWVudCwgd2lkZ2V0Q29uZmlnLCB0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KSB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG4gICAgc2NvcGUuY2hpbGQgPSB0cmFuc2Zvcm1lZENoaWxkO1xuICAgIHNjb3BlLmRhc2hib2FyZENvbnRleHQgPSBjb250ZXh0O1xuICAgIGlmIChjaGlsZC53aWRnZXRDb21wb25lbnQpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxjOHktdWktY29tcG9uZW50IGNvbXBvbmVudC1uYW1lPVwiJyR7XG4gICAgICAgIGNoaWxkLndpZGdldENvbXBvbmVudFxuICAgICAgfSdcIiBjb25maWc9XCJjaGlsZC5jb25maWdcIiBjb250ZXh0PVwiZGFzaGJvYXJkQ29udGV4dFwiPjwvYzh5LXVpLWNvbXBvbmVudD5gO1xuICAgIH0gZWxzZSBpZiAoY2hpbGQudGVtcGxhdGVVcmwpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxuZy1pbmNsdWRlIHNyYz1cIicke2NoaWxkLnRlbXBsYXRlVXJsfSdcIj48L25nLWluY2x1ZGU+YDtcbiAgICB9XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlVG9EYXNoYm9hcmQoZGFzaGJvYXJkOiBDb250ZXh0RGFzaGJvYXJkTWFuYWdlZE9iamVjdCkge1xuICAgIGlmICgvZGFzaGJvYXJkLy50ZXN0KHRoaXMucm91dGVyLnVybCkpIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCBkYXNoYm9hcmQuaWRdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCAnZGFzaGJvYXJkJywgZGFzaGJvYXJkLmlkXSwge1xuICAgICAgICByZWxhdGl2ZVRvOiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcilcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGFzaGJvYXJkKCkge1xuICAgIHJldHVybiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcikuc25hcHNob3QuZGF0YS5kYXNoYm9hcmQ7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb25maWdUZW1wbGF0ZShcbiAgICBlbGVtZW50LFxuICAgIHdpZGdldENvbmZpZzogQ29udGV4dFdpZGdldENvbmZpZyxcbiAgICBvbmx5RGV2aWNlU2VsZWN0b3IgPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCB7IHNldHRpbmdzIH0gPSB3aWRnZXRDb25maWc7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG5cbiAgICBzY29wZS5zZXR0aW5ncyA9IHsgLi4uc2V0dGluZ3MsIC4uLnNldHRpbmdzLm5nMSB9O1xuICAgIHNjb3BlLm9wdGlvbnMgPSB3aWRnZXRDb25maWcub3B0aW9ucztcbiAgICBzY29wZS5jb25maWcgPSB3aWRnZXRDb25maWc7XG4gICAgc2NvcGUuZm9ybXMgPSB7fTtcbiAgICBzY29wZS5kYXNoYm9hcmQgPSB3aWRnZXRDb25maWcuZGFzaGJvYXJkTW87XG4gICAgc2NvcGUucm9vdElkID0gc2V0dGluZ3MuY29udGV4dC5pZDtcblxuICAgIGxldCBjb25maWdDbXAgPSAnJztcbiAgICBpZiAoIW9ubHlEZXZpY2VTZWxlY3Rvcikge1xuICAgICAgaWYgKHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdDb21wb25lbnQpIHtcbiAgICAgICAgY29uZmlnQ21wID0gYDxjOHktdWktY29tcG9uZW50IGNvbXBvbmVudC1uYW1lPVwiJyR7XG4gICAgICAgICAgd2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ0NvbXBvbmVudFxuICAgICAgICB9J1wiIGNvbmZpZz1cImNvbmZpZ1wiPjwvYzh5LXVpLWNvbXBvbmVudD5gO1xuICAgICAgfSBlbHNlIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmwpIHtcbiAgICAgICAgY29uZmlnQ21wID0gYDxuZy1pbmNsdWRlIHNyYz1cIicke3dpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdUZW1wbGF0ZVVybH0nXCI+PC9uZy1pbmNsdWRlPmA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZWxlbWVudC5pbm5lckhUTUwgPSBgXG4gICAgPG5nLWZvcm0gbmFtZT1cImZvcm1zLmNvbXBvbmVudEZvcm1cIj5cbiAgICAgIDxkaXYgY2xhc3M9XCJmb3JtLWdyb3VwXCJcbiAgICAgICAgbmctaWY9XCIhc2V0dGluZ3Mubm9EZXZpY2VUYXJnZXRcIlxuICAgICAgICBuZy1zdHlsZT1cIntoZWlnaHQ6IHNldHRpbmdzLmhpZGVUYXJnZXQgJiYgJzAnLCBvdmVyZmxvdzogJ2hpZGRlbid9XCJcbiAgICAgID5cbiAgICAgICAgPGxhYmVsIHRyYW5zbGF0ZT4ke2dldHRleHQoJ1RhcmdldCBhc3NldHMgb3IgZGV2aWNlcycpfTwvbGFiZWw+XG4gICAgICAgIDxjOHktZGV2aWNlLXNlbGVjdG9yLWNvbWJvIHBhcmVudD1cInJvb3RJZFwiXG4gICAgICAgICAgc2VsZWN0ZWQtY2hpbGQtZGV2aWNlPVwiY29uZmlnLmRldmljZVwiXG4gICAgICAgICAgZ3JvdXBzLXNlbGVjdGFibGU9XCJzZXR0aW5ncy5ncm91cHNTZWxlY3RhYmxlXCJcbiAgICAgICAgPjwvYzh5LWRldmljZS1zZWxlY3Rvci1jb21ibz5cbiAgICAgIDwvZGl2PlxuICAgICAgJHtjb25maWdDbXB9XG4gICAgPC9uZy1mb3JtPmA7XG5cbiAgICBzY29wZS4kd2F0Y2goJ2Zvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQnLCBmb3JtU3RhdHVzID0+IHtcbiAgICAgIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuZm9ybURpc2FibGVkID0gZm9ybVN0YXR1cztcbiAgICB9KTtcbiAgICB0aGlzLmNvbXBpbGUoZWxlbWVudCkoc2NvcGUpO1xuICAgIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuZm9ybURpc2FibGVkID0gc2NvcGUuZm9ybXMuY29tcG9uZW50Rm9ybS4kaW52YWxpZDtcblxuICAgIHJldHVybiBzY29wZTtcbiAgfVxufVxuIl19