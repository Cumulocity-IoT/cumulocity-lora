import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService, ContextDashboardManagedObject, ContextWidgetConfig } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
let DashboardBridgeService = class DashboardBridgeService {
    constructor(ng1Injector, zone, router, contextDashboardService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    get ng1Components() {
        return this.ng1Injector.get('c8yComponents');
    }
    instantiateComponent(widget, element) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { dashboard, context, child } = widget;
            if (dashboard) {
                const transformedChild = yield this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child);
                if (this.dashboardSvc.forcedContext || dashboard.deviceType) {
                    yield this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild.config);
                }
                return this.zone.runOutsideAngular(() => this.loadTemplate(transformedChild, child, element, context));
            }
            else {
                return this.loadConfigTemplate(element, widget);
            }
        });
    }
    editDashboard(dashboard) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id });
        });
    }
    copyDashboard() {
        const dashboard = this.getDashboard();
        const couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            return dashboard;
        }
    }
    pasteDashboard() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const newDashboard = yield this.dashboardSvc.pasteDashboard();
                yield this.contextDashboardService.addTab(newDashboard);
                this.navigateToDashboard(newDashboard);
                this.dashboardClipboard = undefined;
            }
            catch (ex) {
                // intended empty
            }
        });
    }
    instantiateDeviceSelector(element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    }
    loadTemplate(transformedChild, child, element, context) {
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = `<c8y-ui-component component-name="'${child.widgetComponent}'" config="child.config" context="dashboardContext"></c8y-ui-component>`;
        }
        else if (child.templateUrl) {
            element.innerHTML = `<ng-include src="'${child.templateUrl}'"></ng-include>`;
        }
        this.compile(element)(scope);
        return scope;
    }
    navigateToDashboard(dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    }
    getDashboard() {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    }
    loadConfigTemplate(element, widgetConfig, onlyDeviceSelector = false) {
        const { settings } = widgetConfig;
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = Object.assign({}, settings, settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.dashboard = widgetConfig.dashboardMo;
        scope.rootId = settings.context.id;
        let configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = `<c8y-ui-component component-name="'${widgetConfig.settings.configComponent}'" config="config"></c8y-ui-component>`;
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = `<ng-include src="'${widgetConfig.settings.configTemplateUrl}'"></ng-include>`;
            }
        }
        element.innerHTML = `
    <ng-form name="forms.componentForm">
      <div class="form-group"
        ng-if="!settings.noDeviceTarget"
        ng-style="{height: settings.hideTarget && '0', overflow: 'hidden'}"
      >
        <label translate>${gettext('Target assets or devices')}</label>
        <c8y-device-selector-combo parent="rootId"
          selected-child-device="config.device"
          groups-selectable="settings.groupsSelectable"
        ></c8y-device-selector-combo>
      </div>
      ${configCmp}
    </ng-form>`;
        scope.$watch('forms.componentForm.$invalid', formStatus => {
            this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    }
};
DashboardBridgeService.ctorParameters = () => [
    { type: undefined },
    { type: NgZone },
    { type: Router },
    { type: ContextDashboardService }
];
DashboardBridgeService = tslib_1.__decorate([
    Injectable()
], DashboardBridgeService);
export { DashboardBridgeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsiZGFzaGJvYXJkL2Rhc2hib2FyZC1icmlkZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsNkJBQTZCLEVBQzdCLG1CQUFtQixFQUNwQixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUc5QyxJQUFhLHNCQUFzQixHQUFuQyxNQUFhLHNCQUFzQjtJQUtqQyxZQUNVLFdBQWdCLEVBQ2hCLElBQVksRUFDWixNQUFjLEVBQ2QsdUJBQWdEO1FBSGhELGdCQUFXLEdBQVgsV0FBVyxDQUFLO1FBQ2hCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUV4RCxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxJQUFJLGFBQWE7UUFDZixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFSyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsT0FBTzs7WUFDeEMsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFP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YmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBnZXRBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgQ29udGV4dERhc2hib2FyZFNlcnZpY2UsXG4gIENvbnRleHREYXNoYm9hcmRNYW5hZ2VkT2JqZWN0LFxuICBDb250ZXh0V2lkZ2V0Q29uZmlnXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvY29udGV4dC1kYXNoYm9hcmQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGFzaGJvYXJkQnJpZGdlU2VydmljZSB7XG4gIGRhc2hib2FyZFN2YztcbiAgY29tcGlsZTtcbiAgZGFzaGJvYXJkQ2xpcGJvYXJkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmcxSW5qZWN0b3I6IGFueSxcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgY29udGV4dERhc2hib2FyZFNlcnZpY2U6IENvbnRleHREYXNoYm9hcmRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZGFzaGJvYXJkU3ZjID0gbmcxSW5qZWN0b3IuZ2V0KCdkYXNoYm9hcmRTdmMnKTtcbiAgICB0aGlzLmNvbXBpbGUgPSBuZzFJbmplY3Rvci5nZXQoJyRjb21waWxlJyk7XG4gIH1cblxuICBnZXQgbmcxQ29tcG9uZW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5uZzFJbmplY3Rvci5nZXQoJ2M4eUNvbXBvbmVudHMnKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbnRpYXRlQ29tcG9uZW50KHdpZGdldCwgZWxlbWVudCkge1xuICAgIGNvbnN0IHsgZGFzaGJvYXJkLCBjb250ZXh0LCBjaGlsZCB9ID0gd2lkZ2V0O1xuICAgIGlmIChkYXNoYm9hcmQpIHtcbiAgICAgIGNvbnN0IHRyYW5zZm9ybWVkQ2hpbGQgPSBhd2FpdCB0aGlzLmRhc2hib2FyZFN2Yy50cmFuc2Zvcm1DaGlsZFdpdGhDb250ZXh0KFxuICAgICAgICB0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGNvbnRleHQsXG4gICAgICAgIGRhc2hib2FyZCxcbiAgICAgICAgY2hpbGRcbiAgICAgICk7XG4gICAgICBpZiAodGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBkYXNoYm9hcmQuZGV2aWNlVHlwZSkge1xuICAgICAgICBhd2FpdCB0aGlzLmRhc2hib2FyZFN2Yy51cGRhdGVDb25maWdUYXJnZXRzV2l0aENvbnRleHQoXG4gICAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICAgIHRyYW5zZm9ybWVkQ2hpbGQuY29uZmlnXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+XG4gICAgICAgIHRoaXMubG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ1RlbXBsYXRlKGVsZW1lbnQsIHdpZGdldCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZWRpdERhc2hib2FyZChkYXNoYm9hcmQpIHtcbiAgICByZXR1cm4gdGhpcy5kYXNoYm9hcmRTdmMuZWRpdEN1cnJlbnREYXNoYm9hcmQoeyBkYXNoYm9hcmRJZDogZGFzaGJvYXJkLmlkIH0pO1xuICB9XG5cbiAgY29weURhc2hib2FyZCgpIHtcbiAgICBjb25zdCBkYXNoYm9hcmQgPSB0aGlzLmdldERhc2hib2FyZCgpO1xuICAgIGNvbnN0IGNvdWxkQ29weSA9IHRoaXMuZGFzaGJvYXJkU3ZjLmNvcHlEYXNoYm9hcmQoZGFzaGJvYXJkLmM4eV9EYXNoYm9hcmQpO1xuICAgIGlmIChjb3VsZENvcHkpIHtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gZGFzaGJvYXJkO1xuICAgICAgcmV0dXJuIGRhc2hib2FyZDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBwYXN0ZURhc2hib2FyZCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbmV3RGFzaGJvYXJkID0gYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMucGFzdGVEYXNoYm9hcmQoKTtcbiAgICAgIGF3YWl0IHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuYWRkVGFiKG5ld0Rhc2hib2FyZCk7XG4gICAgICB0aGlzLm5hdmlnYXRlVG9EYXNoYm9hcmQobmV3RGFzaGJvYXJkKTtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gdW5kZWZpbmVkO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlbmRlZCBlbXB0eVxuICAgIH1cbiAgfVxuXG4gIGluc3RhbnRpYXRlRGV2aWNlU2VsZWN0b3IoZWxlbWVudCwgd2lkZ2V0Q29uZmlnOiBDb250ZXh0V2lkZ2V0Q29uZmlnKSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ1RlbXBsYXRlKGVsZW1lbnQsIHdpZGdldENvbmZpZywgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRUZW1wbGF0ZSh0cmFuc2Zvcm1lZENoaWxkLCBjaGlsZCwgZWxlbWVudCwgY29udGV4dCkge1xuICAgIGNvbnN0IHNjb3BlID0gdGhpcy5uZzFJbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKS4kbmV3KHRydWUpO1xuICAgIHNjb3BlLmNoaWxkID0gdHJhbnNmb3JtZWRDaGlsZDtcbiAgICBzY29wZS5kYXNoYm9hcmRDb250ZXh0ID0gY29udGV4dDtcbiAgICBpZiAoY2hpbGQud2lkZ2V0Q29tcG9uZW50KSB7XG4gICAgICBlbGVtZW50LmlubmVySFRNTCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke1xuICAgICAgICBjaGlsZC53aWRnZXRDb21wb25lbnRcbiAgICAgIH0nXCIgY29uZmlnPVwiY2hpbGQuY29uZmlnXCIgY29udGV4dD1cImRhc2hib2FyZENvbnRleHRcIj48L2M4eS11aS1jb21wb25lbnQ+YDtcbiAgICB9IGVsc2UgaWYgKGNoaWxkLnRlbXBsYXRlVXJsKSB7XG4gICAgICBlbGVtZW50LmlubmVySFRNTCA9IGA8bmctaW5jbHVkZSBzcmM9XCInJHtjaGlsZC50ZW1wbGF0ZVVybH0nXCI+PC9uZy1pbmNsdWRlPmA7XG4gICAgfVxuICAgIHRoaXMuY29tcGlsZShlbGVtZW50KShzY29wZSk7XG4gICAgcmV0dXJuIHNjb3BlO1xuICB9XG5cbiAgcHJpdmF0ZSBuYXZpZ2F0ZVRvRGFzaGJvYXJkKGRhc2hib2FyZDogQ29udGV4dERhc2hib2FyZE1hbmFnZWRPYmplY3QpIHtcbiAgICBpZiAoL2Rhc2hib2FyZC8udGVzdCh0aGlzLnJvdXRlci51cmwpKSB7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy4uJywgZGFzaGJvYXJkLmlkXSwge1xuICAgICAgICByZWxhdGl2ZVRvOiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcilcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy4uJywgJ2Rhc2hib2FyZCcsIGRhc2hib2FyZC5pZF0sIHtcbiAgICAgICAgcmVsYXRpdmVUbzogZ2V0QWN0aXZhdGVkUm91dGUodGhpcy5yb3V0ZXIpXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldERhc2hib2FyZCgpIHtcbiAgICByZXR1cm4gZ2V0QWN0aXZhdGVkUm91dGUodGhpcy5yb3V0ZXIpLnNuYXBzaG90LmRhdGEuZGFzaGJvYXJkO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkQ29uZmlnVGVtcGxhdGUoXG4gICAgZWxlbWVudCxcbiAgICB3aWRnZXRDb25maWc6IENvbnRleHRXaWRnZXRDb25maWcsXG4gICAgb25seURldmljZVNlbGVjdG9yID0gZmFsc2VcbiAgKSB7XG4gICAgY29uc3QgeyBzZXR0aW5ncyB9ID0gd2lkZ2V0Q29uZmlnO1xuICAgIGNvbnN0IHNjb3BlID0gdGhpcy5uZzFJbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKS4kbmV3KHRydWUpO1xuXG4gICAgc2NvcGUuc2V0dGluZ3MgPSB7IC4uLnNldHRpbmdzLCAuLi5zZXR0aW5ncy5uZzEgfTtcbiAgICBzY29wZS5vcHRpb25zID0gd2lkZ2V0Q29uZmlnLm9wdGlvbnM7XG4gICAgc2NvcGUuY29uZmlnID0gd2lkZ2V0Q29uZmlnO1xuICAgIHNjb3BlLmZvcm1zID0ge307XG4gICAgc2NvcGUuZGFzaGJvYXJkID0gd2lkZ2V0Q29uZmlnLmRhc2hib2FyZE1vO1xuICAgIHNjb3BlLnJvb3RJZCA9IHNldHRpbmdzLmNvbnRleHQuaWQ7XG5cbiAgICBsZXQgY29uZmlnQ21wID0gJyc7XG4gICAgaWYgKCFvbmx5RGV2aWNlU2VsZWN0b3IpIHtcbiAgICAgIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke1xuICAgICAgICAgIHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdDb21wb25lbnRcbiAgICAgICAgfSdcIiBjb25maWc9XCJjb25maWdcIj48L2M4eS11aS1jb21wb25lbnQ+YDtcbiAgICAgIH0gZWxzZSBpZiAod2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ1RlbXBsYXRlVXJsKSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8bmctaW5jbHVkZSBzcmM9XCInJHt3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmx9J1wiPjwvbmctaW5jbHVkZT5gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYFxuICAgIDxuZy1mb3JtIG5hbWU9XCJmb3Jtcy5jb21wb25lbnRGb3JtXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiZm9ybS1ncm91cFwiXG4gICAgICAgIG5nLWlmPVwiIXNldHRpbmdzLm5vRGV2aWNlVGFyZ2V0XCJcbiAgICAgICAgbmctc3R5bGU9XCJ7aGVpZ2h0OiBzZXR0aW5ncy5oaWRlVGFyZ2V0ICYmICcwJywgb3ZlcmZsb3c6ICdoaWRkZW4nfVwiXG4gICAgICA+XG4gICAgICAgIDxsYWJlbCB0cmFuc2xhdGU+JHtnZXR0ZXh0KCdUYXJnZXQgYXNzZXRzIG9yIGRldmljZXMnKX08L2xhYmVsPlxuICAgICAgICA8Yzh5LWRldmljZS1zZWxlY3Rvci1jb21ibyBwYXJlbnQ9XCJyb290SWRcIlxuICAgICAgICAgIHNlbGVjdGVkLWNoaWxkLWRldmljZT1cImNvbmZpZy5kZXZpY2VcIlxuICAgICAgICAgIGdyb3Vwcy1zZWxlY3RhYmxlPVwic2V0dGluZ3MuZ3JvdXBzU2VsZWN0YWJsZVwiXG4gICAgICAgID48L2M4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8+XG4gICAgICA8L2Rpdj5cbiAgICAgICR7Y29uZmlnQ21wfVxuICAgIDwvbmctZm9ybT5gO1xuXG4gICAgc2NvcGUuJHdhdGNoKCdmb3Jtcy5jb21wb25lbnRGb3JtLiRpbnZhbGlkJywgZm9ybVN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IGZvcm1TdGF0dXM7XG4gICAgfSk7XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IHNjb3BlLmZvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQ7XG5cbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cbn1cbiJdfQ==