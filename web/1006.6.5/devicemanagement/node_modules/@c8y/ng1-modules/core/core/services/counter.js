"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}angular.module("c8y.core").factory("c8yCounter",["$q","c8yBase","c8yRealtime",function(w,E,b){function i(t){var e=_.cloneDeep(t),n=this;if(this.properties=null,this.filterFn=null,this.dependencies=null,_.isArray(e)){if(!function(t){var e=t.length,r=_.last(t);return _.isArray(r)?(n.dependencies=r,n.filterFn=t[e-2],n.properties=t.slice(0,e-2),_.isFunction(n.filterFn)&&_.every(n.properties,String)):!!_.isFunction(r)&&(n.dependencies=_.initial(t),n.filterFn=r,n.properties=n.dependencies,_.every(n.properties,String))}(e))throw new Error("property map is not valid")}else{if(!_.isString(e))throw new Error("parameter is invalid");!function(r){n.properties=[r],n.filterFn=function(t,e){return _.isEqual(t,e[r])},n.dependencies=[r]}(e)}}function A(t,e){var r=this;this.pickList=null;var n=t;this.queryParams=n,this.propertyMapList=e&&_.map(e,function(t){return new i(t)})||[],n=_.pickBy(n,function(t){return void 0!==t}),_.forEach(_.keys(n),function(e){var t=_.some(r.propertyMapList,function(t){return _.some(t.properties,function(t){return t===e})});t||r.propertyMapList.push(new i(e))}),function(){var t=_.reduce(r.propertyMapList,function(e,t){return _.forEach(t.dependencies,function(t){e[t]=!0}),e},{});t.id=!0,r.pickList=_.keys(t)}()}return i.prototype.matches=function(t,e){var r=_.cloneDeep(t);_.forEach(this.properties,function(t){r[t]=r[t]||void 0});var n=_.values(_.pick(r,this.properties));return n.push(e),this.filterFn.apply(this,_toConsumableArray(n))},A.prototype.matches=function(e){var r=this;return _.every(this.propertyMapList,function(t){return t.matches(r.queryParams,e)})},{Counter:function(e,r){if(!_.isFunction(e))throw new Error("list function must be provided");var n,i,o,a,s=this,c=!1,u=!1,f={pageSize:1},t=!1,p=!1,l={CREATE:function(t){u?v(t)&&n.unshift(m(t)):i+=1},UPDATE:function(t){if(u){var e=_.findIndex(n,{id:t.id});-1===e&&v(t)?n.unshift(m(t)):-1===e||v(t)||n.splice(e,1)}},DELETE:function(t){if(u){var e=_.findIndex(n,{id:t.id});-1!==e&&n.splice(e,1)}else i-=1}};function h(){if(!r)return w.resolve();var t=b.realtimeActions();return _.forEach(t,function(t){b.addListener(s.__realtimeId,r,t,d)}),w.when(b.start(s.__realtimeId,r))}function d(t,e){if(!c){var r=s.count;l[t.name||t](e),y();var n=s.count;o&&n!==r&&o(n,r)}}function y(){s.count=n&&n.length||i||0}function m(t){return _.pick(t,a.pickList)}function v(t){return a.matches(t)}E.createLocalId(this,"__realtimeId"),this.start=function(){if(t)throw new Error("Cannot restart a counter instance, please create a new instance");return t=!0,this.refresh().then(h)},this.stop=function(){if(!t)throw new Error("Cannot stop counter instance without starting it first");if(p)throw new Error("Cannot stop an already stopped counter instance");p=!0,r&&b.removeSubscriber(s.__realtimeId,r)},this.onNotification=function(t){o=t},this.refresh=function(){c=!0;var t=u?a.queryParams:f;return w.when(e(t)).then(function(t){u?n=_(t).filter(v).map(m).value():i=t.statistics.totalPages,y(),c=!1})},this.filter=function(t,e){if(t||e){if(u)throw new Error("filter can be set only once");u=!0,a=new A(t,e)}}},defaultPropertyMaps:{date:["dateFrom","dateTo",function(t,e,r){var n=r&&(r.date||r.time);return!(!n||t&&moment(t).isAfter(n)||e&&moment(e).isBefore(n))},["date","time"]],source:["source",function(t,e){return(e&&e.source&&e.source.id)===t},["source"]]}}}]);