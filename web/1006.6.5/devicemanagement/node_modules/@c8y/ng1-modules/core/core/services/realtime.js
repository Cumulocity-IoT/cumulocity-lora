"use strict";function _slicedToArray(n,e){return _arrayWithHoles(n)||_iterableToArrayLimit(n,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(n,e){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n)){var t=[],r=!0,i=!1,o=void 0;try{for(var s,c=n[Symbol.iterator]();!(r=(s=c.next()).done)&&(t.push(s.value),!e||t.length!==e);r=!0);}catch(n){i=!0,o=n}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return t}}function _arrayWithHoles(n){if(Array.isArray(n))return n}!function(){function n(n,t,s,r,e,i,o,c,a,u,f,l){var d,h,b=this,p="XSRF-TOKEN",v=3e4,g=new org.cometd.CometD;g.unregisterTransports(),window.c8y_testing||g.registerTransport("websocket",new org.cometd.WebSocketTransport),e.has("ngZone")&&(h=e.get("ngZone")),window.c8y_testing&&(d=n.when("")),g.registerTransport("long-polling",new u.LongPollingTransport);var m=n.defer();g.addListener("/meta/handshake",function(n){if("websocket"===_.get(n,"failure.connectionType"))return t.error(n.failure),void g.disconnect(function(){g.websocketEnabled=!1,g.handshake()});if(!n.successful){var e=new Error("Handshake failed.");throw m.reject(e),e}_.forEach(w,function(n){var e=n.subscription;e&&g.resubscribe(e)}),m.resolve()});var E=g.addListener("/meta/connect",function(n){n.failure&&401===n.failure.httpCode&&(T(),g.removeListener(E))});function y(){var e;_.isUndefined(d)&&(d=a.current().then(function(n){return function(n){var e={params:{fragmentType:n}},t=o.url("inventory/managedObjects");return r.get(t,e)}(e="unit".concat(n.userName))}).then(o.getResData).then(function(n){return _.first(n.managedObjects)}).then(function(n){return _.get(n,e)}));return d}function T(){m=n.defer(),g.disconnect()}s.$on("authStateChange",function(n,e){e.hasAuth?y().then(function(n){var e={"X-Cumulocity-System-Of-Units":n};return _.merge(c.headers(),e)}).then(function(n){!function(n){g.configure({url:o.absoluteUrl("cep/realtime"),logLevel:"info",requestHeaders:n,appendMessageTypeToURL:!1,stickyReconnect:!1})}(n),y().then(function(n){return g.handshake(function(n){var e=function(n){for(var e="".concat(n,"="),t=document.cookie.split(";"),r=0;r<t.length;r++){for(var i=t[r];" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(e))return decodeURIComponent(i.substring(e.length,i.length))}return}(p),t={ext:{"com.cumulocity.authn":{token:l.token,tfa:l.TFAToken}}};e&&_.merge(t,{ext:{"com.cumulocity.authn":{xsrfToken:e}}});n&&(t.ext.systemOfUnits=n);return t}(n))})}):T()}),g.onListenerException=function(n,e,t){throw t?b.removeListener(e):b.unsubscribe(e),new Error("Something went wrong: ".concat(n))};var w=[],A={addListener:_.wrap(L,j),realtimeActions:k,switchRealtime:_.wrap(function(n,e){S(n,e)?U(n,e):R(n,e)},j),getStatus:S,start:_.wrap(R,j),stop:_.wrap(U,j),removeSubscriber:_.wrap(C,j),destroySubscription:_.wrap(function(n,e){C(n,e)},j),icon:function(n){return n?"active":"inactive"},watch:function(n){var e=n.id||String(Math.random()).substr(2),t=n.channel,r=_.flattenDeep([n.ops||_.values({CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"})]),i=n.onUpdate||_.noop;return _.forEach(r,function(n){L(e,t,n,i)}),R(e,t),{stop:function(){C(e,t)}}},_getSubscriptionChannels:function(){o.getFlag("test")||console.warn("DO NOT USE THIS API CALL: it will break encapsulation,\n          use it only for doing state verification in unit test.");return w},status:function(){return g.getStatus()}};return window.c8y_testing&&_.assign(A,{cometd:g,handshakeDeferred:m}),A;function L(n,e,t,r){var i=_.find(w,{name:e});i||(i=function(n){return{name:n,subscription:void 0,subscribers:[]}}(e),w.push(i));var o=i.subscribers,s=_.find(o,{id:n});s||(s=function(n){return{id:n,subscribedEvents:_.map({CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"},D),active:!1}}(n),o.push(s));var c=s.subscribedEvents,a=_.find(c,{name:t});a||(a=D(t),c.push(a)),a.listeners.push(r)}function k(){return{CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"}}function D(n){return{name:n,listeners:[]}}function S(r,n){var e=x(n);return _.every(e,function(n){var e=!1,t=_.find(w,{name:n});return t&&(e=_.some(t.subscribers,{id:r,active:!0})),e})}function U(n,e){var t=O(e),r=P(n,e);r&&(r.active=!1,_.some(t.subscribers,"active")||$(t))}function R(n,e){var t=P(n,e);if(t){t.active=!0;var r=_.find(w,{name:e});if(_.isUndefined(r.subscription)&&!r.subscriptionPending)return function(o){o.subscriptionPending=!0;var n=function(){o.subscriptionPending=!1,o.subscription=g.subscribe(o.name,function(n){var e=n.data,r=e.realtimeAction,i=e.data,t=function(){_(o.subscribers).filter("active").forEach(function(n){var e=_.find(n.subscribedEvents,{name:r}),t=e.listeners;_.forEach(t,function(n){n(r,i)})})};"websocket"===g.getTransport().getType()?s.$applyAsync(t):t()},function(n){n.successful||i(function(){return g.resubscribe(o.subscription)},v)})};m.promise.then(h?function(){return h.runOutsideAngular(n)}:n)}(r)}}function C(n,e){if(P(n,e)){var t=O(e),r=t.subscribers;_.remove(r,{id:n}),_.isEmpty(r)&&function(n){$(n),_.remove(w,n)}(t)}}function P(n,e){var t,r=O(e);if(!r)throw new Error('There is no listener registered for your scope on the channel "'.concat(e,'"'));if(t=_.find(r.subscribers,{id:n}),_.isUndefined(t))throw new Error('There is no subscriber with id "'.concat(n,'" ')+'registered for your scope on the channel "'.concat(e,'"'));return t}function O(n){return _.find(w,{name:n})}function $(n){var e=n.subscription;e&&g.unsubscribe(e),delete n.subscription}function j(e){for(var t=this,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=x(r[1]);_.forEach(o,function(n){r[1]=n,e.apply(t,r)})}function x(n){var e=[],t=n.match(/(\/.*)\/(.*)$/);if(_.isEmpty(t))e.push(n);else{var r=_slicedToArray(t,3),i=r[1],o=r[2].split(",");_.forEach(o,function(n){e.push("".concat(i,"/").concat(n))})}return e}}n.$inject=["$q","$log","$rootScope","$http","$injector","$timeout","c8yBase","c8yAuth","c8yUser","c8yLongPollingTransport","c8yCometdExtensions","info"],angular.module("c8y.core").factory("c8yRealtime",n)}();