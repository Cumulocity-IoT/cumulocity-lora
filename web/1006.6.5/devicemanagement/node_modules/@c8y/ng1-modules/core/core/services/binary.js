"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(r,o,t,a,i,s,c,u,l,n,m){var f="inventory/binaries",d=/(?:\.([^.]+))?$/,y={archive:{mimes:[],exts:["7z","apk","cab","gz","iso","jar","rar","tar","zip"]},audio:{mimes:[],exts:["3gp","aiff","aac","amr","m4a","m4p","mp3","oga","ogg","raw","wav","wma"]},code:{mimes:[],exts:["aspx","exe","htm","html","jad","js","json","jsp","php","xml"]},excel:{mimes:[],exts:["xls","xlsx"]},image:{mimes:[],exts:["bmp","gif","jpeg","jpg","png","tiff","svg"]},pdf:{mimes:[],exts:["pdf"]},powerpoint:{mimes:[],exts:["ppt","pptx"]},text:{mimes:[],exts:["txt"]},video:{mimes:[],exts:["3gp","asf","avi","flv","mov","mp4","ogv","qt","rm","rmvb","wmv"]},word:{mimes:[],exts:["doc","docx"]},epl:{mimes:[],exts:["mon"]}},p={systemOption:{category:"files",key:"max.size"},defaultBytesLimit:52428800,actualBytesLimitPromise:void 0,actualBytesLimit:void 0};function e(){var t=p.systemOption,e=p.defaultBytesLimit;p.actualBytesLimitPromise=l.whenAuthorized().then(function(){return n.getSystemOptionValue(t,e)}).then(function(t){return p.actualBytesLimit=t,p.actualBytesLimit})}return window.c8y_testing||e(),_.assign(_.cloneDeep(u),{loadBytesSizeLimit:e,getBytesSizeLimit:function(){return p.actualBytesLimit},getBytesSizeLimitAsync:function(){return p.actualBytesLimitPromise},list:function t(e){var n=c.url(f);var r=c.pageSizeFilter(e);var a={params:r};var i=c.cleanListCallback("managedObjects",t,r,!0);return o.get(n,a).then(i)},upload:function(t,e){var n={name:t.name,type:t.type},r=_.assign(n,e);return m.upload(t,{url:c.url(f),headers:c.contentHeaders("managedObject","managedObject"),data:{object:r}})},downloadAndSaveAs:function(a,t){var e=g(a);return m.download(a,e,t).then(function(t){var e=t.getResponseHeader("Content-Type"),n=t.getResponseHeader("Content-Disposition"),r=v(a)?function(t){for(var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:512,r=w(t.data),a=[],i=0;i<r.length;i+=n){for(var o=r.slice(i,i+n),s=new Array(o.length),c=0;c<o.length;c++)s[c]=o.charCodeAt(c);var u=new Uint8Array(s);a.push(u)}return new Blob(a,{type:e})}(a,e):new Blob([t.response],{type:e});saveAs(r,m.getFilenameFromContentDisposition(n))})},downloadAsDataUri:function(a){var t=g(a);return m.download(a,t).then(function(t){var e=t.getResponseHeader("Content-Type"),n=m.arrayBufferToBase64(t.response),r=v(a)?b(a):"data:".concat(e,";base64,").concat(n);return r}).catch(function(){return b(a)||r.reject()})},downloadAsText:function(t){var e=g(t),n={headers:l.headers(),responseType:"text",transformResponse:function(t){return t}};return o.get(e,n)},getDownloadUrl:function(t){return t&&t.self&&t.self.replace(c.url("inventory/managedObjects"),c.url(f))},removeBinary:function(t){var e=g(t);return o.delete(e)},icon:function(t){var e=["file","o"],n=h(t);n&&e.splice(1,0,n);return e.join("-")},size:function(t){return m.size(t)},isImage:function(t){return"image"===h(t)},hasValidSize:function(t){return m.size(t)<=p.actualBytesLimit},getIdFromUrl:function(t){var e=new RegExp("\\/inventory\\/binaries\\/(\\d+)|\\/inventory\\/managedObjects\\/(\\d+)"),n=t.match(e);return n&&(n[1]||n[2])},readDataUri:function(t){var e=new FileReader,n=r.defer();e.addEventListener("load",function(){n.resolve(e.result)},!1),e.addEventListener("error",function(t){n.reject(t)}),t&&e.readAsDataURL(t);return n.promise},decodeDataUri:function(t){return w(_.last(t.split(",")))},setGlobalFlag:function(t,e){var n={id:c.getId(t)};return n.c8y_Global=e?{}:null,x(n)},getFileGenericType:h,save:x,detail:function(t,e,n){return u.detail(t,e,n)},remove:function(t){return u.remove(t)},getDataUri:b,getText:function(t){if(t&&t.data)return w(t.data);return""}});function v(t){return t&&t.data}function g(t){var e=t.id||t;return c.url("".concat(f,"/").concat(e))}function h(e){var i="";return _.forEach(y,function(t,n){var r=_slicedToArray(d.exec(e.name),2)[1];if(_.forEach(t.exts,function(t){var e=!0;return t===_.lowerCase(r)&&(i=n,e=!1),e}),!i){var a=function(t){var e=t.contentType;e||_.isUndefined(t._attachments)||(e=t._attachments[_.keys(t._attachments)[0]].content_type);return e}(e);_.forEach(t.mimes,function(t){var e=!0;return t===a&&(i=n,e=!1),e})}}),i}function x(t){return t.id?function(t){return u.update(t)}(t):function(t){var e=_.assign(t,{c8y_IsBinary:!0});return u.createConfirm(e)}(t)}function b(t){var e=_.get(t,"type")||_.get(t,"dataType"),n=_.get(t,"data"),r="";return e&&n&&(function(e){var t=[i,s];return _.some(t,function(t){return!function(t){var e;try{t(),e=!1}catch(t){e=!0}return e}(_.partial(t,e))})}(n)||(n=a(n)),r="data:".concat(e,";base64,").concat(n)),r}function w(e){var t=[i,s];return _.first(_.compact(_.map(t,function(t){return function(t){var e;try{e=t()}catch(t){e=null}return e}(_.partial(t,e))})))}}t.$inject=["$q","$http","$rootScope","utoa","atou","atob","c8yBase","c8yInventory","c8yAuth","c8ySettings","c8yBinaryCommon"],angular.module("c8y.core").factory("c8yBinary",t)}();