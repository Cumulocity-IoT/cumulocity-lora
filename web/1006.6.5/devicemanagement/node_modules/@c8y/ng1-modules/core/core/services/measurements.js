"use strict";!function(){function e(o,l,g,c,v,e,s,t){var p=window.c8y_testing?1:500,m=2083,a=v.clean,d="measurement/measurements",i={headers:v.contentHeaders("measurement")},f=t.getUnitHeaders(),n={status:"DEPLOYED",name:"c8yui_measurements",body:'insert into SendNotification\n        select\n          measurement as payload,\n          "c8yui/measurements" as channelName\n        from MeasurementCreated;'},h=1440,u=_.once(function(){var e=v.url(d),t={params:{pageSize:1},headers:{Accept:y.stream.value},silentError:!0};if(window.c8y_testing)return l.when();return o.get(e,t).catch(function(e){y.stream.notAcceptable=406===e.status})});function F(e){var t=e.id||e;return"".concat(v.url(d),"/").concat(t)}var y=v.createEnum([{name:"stream",value:"application/json-stream"},{name:"csv",value:"text/csv"},{name:"xlsx",value:"application/vnd.ms-excel"}]);function b(e,t){var n,r=v.url(d),a=_.assign({},v.todayFilter({}),{pageSize:h},e),i={params:a};return n=t?(i.responseType="blob",function(e){return e.data}):v.cleanListCallback("measurements",b,a),function(e){return u().then(function(){return e&&_(y).reject("notAcceptable").map("value").includes(e.value)?e.value:"application/json"})}(t||y.stream).then(function(t){return f.then(function(e){return i.headers=_.assign({},e,{Accept:t}),o.get(r,i).then(function(e){return 202===e.status?l.reject({async:!0,data:e.data}):e})})}).then(n)}function w(e){var t=h,n=v.url("".concat(d,"/series")),r=v.todayFilter(_.assign({pageSize:t,revert:!0},e||{}));r.dateFrom&&(r.dateFrom=moment(r.dateFrom).format(v.dateFullFormat)),r.dateTo&&(r.dateTo=moment(r.dateTo).format(v.dateFullFormat));var a={params:r},i=function(e){return e.data},s=_.findIndex(w._cacheFilter,_.partial(_.isEqual,r)),u=0<=s?w._cacheRequest[s]:null;return r.dateFrom&&(r.dateFrom=moment(r.dateFrom).format(v.dateFullFormat)),r.dateTo&&(r.dateTo=moment(r.dateTo).format(v.dateFullFormat)),function(e,t){return"".concat(v.absoluteUrl(e),"?").concat(c(t)).length>m}(n,r)&&_.unset(r,"series"),f.then(function(e){if(_.assign(a,{headers:e}),!u){u=o.get(n,a).then(i);var t=_.cloneDeep(r);w._cacheFilter.push(_.cloneDeep(t)),w._cacheRequest.push(u),moment(r.dateTo).isAfter(moment())&&setTimeout(function(){!function(e,t){_.remove(w._cacheFilter,e),_.remove(w._cacheRequest,t)}(t,u)},3e3)}return u})}function r(e){var t=v.url(d),n=e,r=_.cloneDeep(i);if(!n.source)throw new Error("c8yMeasurement: source must be defined");return o.post(t,n,r)}function T(e){var t=F(e),n=a(e),r=_.cloneDeep(i);return o.put(t,n,r)}return w._cacheFilter=[],w._cacheRequest=[],{format:y,list:b,listPaged:function(e){var r=l.defer(),a=_.assign(e||{},{pageSize:1e3,withTotalPages:!0}),i=!1;return _.assign(r.promise,{cancel:function(){i=!0,r.reject("canceled")}}),b(a).then(function e(t){var n=!_.isUndefined(t.paging.next)&&t.length>=a.pageSize;return r.notify(t),n||r.resolve(!0),!!i||!n||t.paging.next().then(e)}),r.promise},listSeries:w,listSeriesPaged:function(e){var n=l.defer(),t=_.assign({revert:!0},e||{},{pageSize:1e3,withTotalPages:!0}),r=!1;return _.assign(n.promise,{cancel:function(){r=!0,n.reject("canceled")}}),w(t).then(function e(t){return n.notify(t),t.paging.next||n.resolve(!0),!!r||!t.paging.next||t.paging.next().then(e)}),n.promise},detail:function(e){var t=F(e);return o.get(t)},create:r,update:T,save:function(e){return e.id?T(e):r(e)},remove:function(e){var t=F(e);return o.delete(t)},activateCep:function(){return e.createOrDeploy(n)},latest:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length?arguments[1]:void 0,a={};if(!r.device)throw new Error("filter.device must be defined");if(!r.fragment)throw new Error("filter.fragment must be defined");if(!r.series)throw new Error("filter.series must be defined");var t=b(_.assign(v.timeOrderFilter(),{revert:!0,valueFragmentType:r.fragment,valueFragmentSeries:r.series,source:r.device,pageSize:1})).then(function(e){return _.assign(a,_.first(e)||{}),a});if(e){var n={ops:"CREATE",channel:"/measurements/".concat(r.device),onUpdate:function(e,t){var n=t[r.fragment];n&&n[r.series]&&_.assign(a,t)}},i=s.watch(n);t.stop=_.bind(i.stop,i)}return t},listForDataPoint:function e(t,n,r,a){var i=n,s=r,u=e._cachedRequests=e._cachedRequests||[],o=t.__target.id,c=("NONE"!==a?a:0)||void 0;if(i){switch(i=moment(i),a){case"HOURLY":i.subtract(1,"hour").startOf("hour");break;case"DAILY":i.subtract(1,"day").startOf("day");break;default:i.subtract(1,"minute").startOf("minute")}i=i.format(v.dateFullFormat)}if(s){switch(s=moment(s),a){case"HOURLY":s.add(1,"hour").startOf("hour");break;case"DAILY":s.add(1,"days").startOf("day");break;default:s.add(1,"minute").startOf("minute")}s=s.format(v.dateFullFormat)}var m={dateFrom:i,dateTo:s,source:o,aggregationType:c},d=_.find(u,function(e){return _.isMatch(e.filters,m)});d||(d={deferred:l.defer(),sendDebounced:function(){return d._sendDebounced(),d.deferred.promise},_sendDebounced:_.debounce(function(){w(d.filters).then(_.unary(d.deferred.resolve))},p),filters:m},u.push(d));var f=[t.fragment,t.series].join(".");return d.filters.series=_.uniq((d.filters.series||[]).concat([f])),g(function(){return d.sendDebounced().then(function(t){return function(e){var n=_.findIndex(e.series,function(e){return e.name===t.series&&e.type===t.fragment}),r=[];return-1<n&&_.forEach(e.values,function(e,t){_.isObjectLike(e[n])&&r.push({time:t,min:e[n].min&&Number(e[n].min),max:e[n].max&&Number(e[n].max)})}),{dataPoint:t,values:r,truncated:e.truncated}}}(t)).then(function(e){return e.aggregation=a,e.dateFrom=i,e.dateTo=s,e}).finally(function(){_.remove(u,d)})},5)},rtMeasurementForDatapoint:function(i){return function(e){var t=i.__target.id,n=i.fragment,r=i.series,a=_.get(e,[n,r]);return e.source.id===t&&!!a&&{dataPoint:i,values:[{time:e.time,min:a.value,max:a.value}]}}}}}e.$inject=["$http","$q","$timeout","$httpParamSerializer","c8yBase","c8yCepModule","c8yRealtime","c8yMeasurementUnits"],angular.module("c8y.core").factory("c8yMeasurements",e)}();