"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,i=!1,a=void 0;try{for(var c,o=e[Symbol.iterator]();!(r=(c=o.next()).done)&&(n.push(c.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw a}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(c,p,a,u,v,r,g,o){var s="inventory/managedObjects",n="\\/inventory\\/managedObjects\\/(\\d+)",d={headers:v.contentHeaders("managedObject","managedObject")},l={headers:v.contentHeaders("managedObjectReference")},f=["lastUpdated","assetParents","deviceParents","additionParents","childAssets","childDevices","childAdditions","c8y_ActiveAlarmsStatus","c8y_Availability"];function h(e){var t=e&&(e.id||e);return t&&v.url("".concat(s,"/").concat(t))}function y(e,t){return"".concat(h(e),"/").concat(t)}function m(e,t){var n=v.url(s),r=v.pageSizeFilter(function(e){var t=e||{};return t.text&&(t=_.pick(t,["text","pageSize","currentPage","skipChildrenNames","fragmentType","withParents","q","query"])),t}(e)),i=_objectSpread({params:r},t),a=v.cleanListCallback("managedObjects",m,r,!0);return c.get(n,i).then(a)}function b(e,t,n){var r=h(e),i=t||{},a=_.defaults({params:i},n);return r?c.get(r,a):p.reject("Managed object not valid")}function A(e){return b(e)}function i(e){var t=_.get(e,"assetParents.references"),n=_.get(e,"deviceParents.references"),r=_.get(e,"additionParents.references");return _.union(t,n,r).map(function(e){return e.managedObject})}function t(e){var t=v.url(s),n=_.cloneDeep(d),r=v.cleanFields(e,f);return c.post(t,r,n)}function j(e,t,n){var r=y(t,n),i=_.omit(e,["id"]),a=_.assign({},d,{Accept:"application/json"});return T(t),c.post(r,i,a)}function w(e){var t=new RegExp(n);return e.headers("Location").match(t)[1]}function O(t){var e=h(t),n=_.cloneDeep(d),r=v.cleanFields(t,f),i=c.put(e,r,n);return i.then(function(e){a.$emit("c8yInventory:update",{mo:e.data,res:e}),a.$emit("c8yInventory:update:".concat(t.id),{mo:e.data,res:e})}),T(t),i}function C(e,t){return!!S(e,t)}function S(e,t){return _.get(e,[t,"references","length"])}function D(e,t,n){var r=y(e,t),i=n||{};return A(e).then(function(e){return e.data[t].references.length}).then(function(e){return i.params={pageSize:e},c.get(r,i)})}function P(e){return _.map(e.data.references,_.property("managedObject"))}function I(e,t,n){var r=y(e,n),i={managedObject:t},a=_.cloneDeep(l);return T(e),c.post(r,i,a)}function E(e,n,r,i){return b(e,{withParents:!0}).then(function(e){var t="data.".concat(n,"Parents.references");return _.map(_.get(e,t),_.property("managedObject.id"))}).then(function(e){var t=[],n={ids:e.join(",")};return e.length&&(t=m(n),(r||i)&&(t=t.then(k(r,i)))),t})}function k(t,n){return function(e){return _.filter(e,function(e){return t&&e.type===t||n&&!_.isUndefined(e[n])})}}function R(e,t,n,r){var i={withParents:!0};return i[_.camelCase(["child",_.lowerCase(t),"id"])]=e.id||e,m(i).then(function(e){return n||r?k(n,r)(e):e})}function $(e,t,n){var r=function(e,t,n){var r=t.id||t;return"".concat(y(e,n),"/").concat(r)}(e,t,n);return T(e),c.delete(r)}function T(e){var t=v.getId(e);z.cache.delete(t)}function F(e){var t="".concat(h(e),"/supportedMeasurements");return c.get(t).then(_.property("data.c8y_SupportedMeasurements"))}function U(e){return(_.get(e,"owner")?p.when(e):b(e).then(v.getResData)).then(_.property("owner"))}var x=_.memoize(U,function(e){return v.getId(e)}),z=_.memoize(A,_.identity);function L(e){return v.url("inventory/managedObjects/".concat(e,"/user"))}return{list:m,listQuery:function(e,t,n,r){var i=v.pageSizeFilter(t);return i[n?"query":"q"]=o.buildQuery(e),m(i,r)},listAll:function(e){var a=[];return m(_objectSpread({pageSize:v.MAX_PAGESIZE},e)).then(function e(t){a.push.apply(a,_toConsumableArray(t));var n=t.statistics.pageSize,r=t.paging.next,i=t.length>=n;return r&&i?t.paging.next().then(e):p.resolve(a)})},detail:b,detailCached:z,detailRealtime:function(e,t,r){var i,n,a,c=e.id||e,o=_.isObjectLike(e)?p.when(e):b(c).then(v.getResData),u="/managedobjects/".concat(c),s=g.realtimeActions().UPDATE;function d(n){return i?_.assign(i,n):i=n,_.forEach(i,function(e,t){void 0===n[t]&&delete i[t]}),_.isFunction(r)&&r(i),i}if(t)n=t.$id,g.addListener(n,u,s,function(e,t){d(t)}),g.start(n,u),t.$on("stopRealtime",function(){g.stop(n,u)}),t.$on("$destroy",function(){g.removeSubscriber(n,u)}),a=o.then(function(e){return d(e)});else{var l=a=b(c).then(function(e){return d(e.data)}),f={ops:s,channel:u,onUpdate:function(e,t){d(t)}},h=g.watch(f);l.stop=_.bind(h.stop,h)}return a},create:t,createChild:j,createConfirm:function(e){return t(e).then(w).then(b)},update:O,save:function(e){return e.id?O(e):t(e)},remove:function(e,t){var n=h(e);if(!n)throw new Error("No managed object id provided!");var r=i(e);return _.forEach(r,function(e){T(e)}),c.delete(n,{params:_.isObjectLike(t)?t:{}})},extractParents:i,hasChildAssets:function(e){return C(e,"childAssets")},hasChildDevices:function(e){return C(e,"childDevices")},hasChildAdditions:function(e){return C(e,"childAdditions")},getChildAssetsCount:function(e){return S(e,"childAssets")},getChildDevicesCount:function(e){return S(e,"childDevices")},getChildAdditionsCount:function(e){return S(e,"childAdditions")},childAssets:function(e,t){return D(e,"childAssets",t).then(P)},childDevices:function(e,t){return D(e,"childDevices",t).then(P)},childAdditions:function(e,t){return D(e,"childAdditions",t).then(P)},addChildAsset:function(e,t){return I(e,t,"childAssets")},addChildDevice:function(e,t){return I(e,t,"childDevices")},addChildAddition:function(e,t){return I(e,t,"childAdditions")},createChildAsset:function(e,t){return j(e,t,"childAssets")},createChildDevice:function(e,t){return j(e,t,"childDevices")},createChildAddition:function(e,t){return j(e,t,"childAdditions")},removeChildAsset:function(e,t){return $(e,t,"childAssets")},removeChildDevice:function(e,t){return $(e,t,"childDevices")},removeChildAddition:function(e,t){return $(e,t,"childAdditions")},parentsAsset:function(e,t,n){return E(e,"asset",t,n)},parentsDevice:function(e,t,n){return E(e,"device",t,n)},parentsAddition:function(e,t,n){return E(e,"addition",t,n)},directParentAssets:function(e,t,n){return R(e,"asset",t,n)},directParentDevices:function(e,t,n){return R(e,"device",t,n)},directParentAdditions:function(e,t,n){return R(e,"addition",t,n)},getCount:function(e){return v.getCount(m,e||{})},getFragments:function(e){var t=_.union(f,["id","type","name","owner","self"]);return _.keys(v.cleanFields(e,t))},getSupportedMeasurements:F,getSupportedSeries:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return function(e){return p.all([F(e),function(e){var t="".concat(h(e),"/supportedSeries");return c.get(t).then(_.property("data.c8y_SupportedSeries"))}(e)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],i=_.sortBy(n,"length").reverse();return _(r).map(function(t){var e=_.find(i,function(e){return 0===t.indexOf(e)}),n=t.replace("".concat(e,"."),"");return{fragment:e,series:n}}).filter(_.property("fragment")).value()})}(t).then(function(e){return function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length?arguments[2]:void 0;return t.withUnits?function e(t,r){var n=t&&(t.id||t),i=_.reject(r,"checked"),a=_.head(i);if(a){var c=u.get("c8yMeasurements");return c.latest({device:n,fragment:a.fragment,series:a.series}).then(function(n){return _.forEach(i,function(e){var t=_.get(n,[e.fragment,e.series]);t&&(e.unit=t.unit,e.checked=!0)}),e(t,r)})}var o=_.map(r,function(e){return _.omit(e,"checked")});return p.resolve(o)}(e,n):p.resolve(n)}(t,n,e)})},isOwner:function(e,t){var n={user:t?p.when(t):r.current(),owner:U(e)};return p.all(n).then(function(e){return e.user.userName===e.owner})},isOwnerCached:function(e,t){var n={user:t?p.when(t):r.current(),owner:x(e)};return p.all(n).then(function(e){return e.user.userName===e.owner})},getOwner:U,getOwnerObject:function(e,t){var n=L(v.getId(e));return c.get(n,t).then(v.getResData).catch(function(t){return U(e).then(function(e){return p.reject({notFound:404===t.status,accessDenied:403===t.status,serviceUser:r.isServiceUser(e)})})})},getOwnerCached:x,setOwnerEnabled:function(e,t){var n=v.getId(e);return c.put(L(n),{enabled:!!t}).then(v.getResData)},addGlobalFlag:function(e,t){return e.c8y_Global=t?{}:null,e},updateManagedObject:function(t,e){var n=_.keys(e),r=_.keys(t).filter(function(e){return!_.includes(n,e)});return _.forEach(r,function(e){return _.unset(t,e)}),_.assign(t,e)}}}e.$inject=["$http","$q","$rootScope","$injector","c8yBase","c8yUser","c8yRealtime","c8yQueriesUtil"],angular.module("c8y.core").factory("c8yInventory",e)}();