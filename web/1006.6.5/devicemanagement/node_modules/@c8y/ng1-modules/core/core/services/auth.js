"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],r=!0,o=!1,a=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){o=!0,a=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw a}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(a,e,n,i,o,u,r,s){var c,l,p,h,f,d,g,v,m,y="_tcy8",k="_ocy8",w="TFAToken",T="Basic",S=i.defer(),A=i.defer(),I=/\.html$/,F=/\.json$/,P=document.createElement("a"),$={hasAuth:!1},C=s.appKey,E=T,b=T;function L(t){var e=t;t.startsWith(T)&&(e=t.replace(T,"").trim());var n=r(e).match(/(([^/]*)\/)?([^/:]+):(.+)/);return{tenant:n[2],user:n[3],password:n[4]}}function O(t,e,n){var r="".concat((n?"".concat(n,"/"):"")+t,":").concat(e);return u(r)}function U(t){return t.headers||(t.headers={}),_.defaults(t.headers,Y.headers()),t}function j(){return f.post(d.url("user/logout"),{},{silentError:!0}).then(function(t){return z(),t.data},function(){return z()})}function z(){x(),_.isFunction(s.logout)&&s.logout()}function R(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:T,n={token:e,type:function(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}(t)},r=d.url("user/currentUser?auth");if(p=n.token,b=n.type,window.c8y_testing)return i.when(K(n));s.tokenType=t;var o={url:r,silentError:!0,skipInterceptor:!0,headers:{Authorization:n.token?"".concat(n.type," ").concat(n.token):void 0,tfatoken:h,UseXBasic:!0,Accept:"application/vnd.com.nsn.cumulocity.user+json;"}};return f(o).then(d.getResData).then(function(t){return e?function(t,e){var n=L(t.token);return t.token=O(function(t,e){var n=_slicedToArray(t.user.match(/^(.+\$)?(.+)?$/),3),r=n[1],o=n[2];return"".concat(r||"").concat(o?e.id:"")}(n,e),n.password,function(t){return t.self.match(/\/user\/([\w-]+)\//)[1]}(e)),t}(n,t):B()}).then(K)}function K(t){var e=t.token,n=t.type;s.token=e,c=s.token,E=n,X(s.appKey);var r=!C?g.currentAppCached().then(function(t){s.appConfig=_.defaults(s.appConfig||{},t),X(t.key)}):i.when();return function(){o.sessionStorage&&o.sessionStorage.setItem(y,c);o.localStorage.getItem(y)&&o.localStorage.setItem(y,c)}(),r.then(B)}function B(){S.resolve(),t({hasAuth:!0})}function t(t){_.isEqual(t,$)||($=t,e.$emit("authStateChange",$))}function W(){h=void 0,delete s.TFAToken,M()}function q(t){s.TFAToken=t,G(h=s.TFAToken,!1,w),function(t,e){return n.get("c8ySettings").getSystemOptionValue({category:t,key:e},!1)}("two-factor-authentication","logout-on-browser-termination").then(function(t){G(h,!t,w)})}function x(){W(),delete s.token,S.promise.$$state.status&&(S=i.defer()),t({hasAuth:!1}),D()}function G(t,e,n){o["".concat(e?"local":"session","Storage")].setItem(n,t)}function H(t){return o.localStorage.getItem(t)||o.sessionStorage.getItem(t)||void 0}function X(t){s.appKey=t,C=s.appKey}function D(){o.localStorage.removeItem(y),o.sessionStorage.removeItem(y),o.localStorage.removeItem(k),o.sessionStorage.removeItem(k)}function M(){o.localStorage.removeItem(w),o.sessionStorage.removeItem(w)}function V(){var t=s.token||H(y),e=s.TFAToken||H(w),n=s.tokenType||H(k);return X(s.appKey),e&&q(e),R(t,n).catch(D)}function J(t){l=t}function N(t){var e=t.headers("tfatoken");return e&&q(e),R(p,b)}function Q(t){var e=_.map(t,function(n){var t={};return t[n.prop]=!1,f({url:d.url("tenant/".concat(n.path)),silentError:!0}).then(function(t){var e={};return e[n.prop]=n.checkFn(t),e}).catch(function(){return t})});return i.all(e).then(function(t){return _.reduce(t,function(t,e){return _.assign(t,e)},{})})}A.resolve(),J(s.passResetToken||function(){if(a.search)return a.search();return{}}().token);var Y={decodeToken:L,encodeToken:O,logout:j,updatePassword:function(t){var e=L(c);return K({token:O(e.user,t,e.tenant),type:s.tokenType||T})},request:function(t){var e,n=t.url,r=function(t){var e=s.baseUrl||"/";if(!t)return!0;P.href=t||"";var n=P.host;return 1<e.length&&-1<t.indexOf(e)||!n||n===function(){var t=a.host(),e=a.port();return 80!==e&&443!==e?[t,e].join(":"):t}()}(n);if(!r||I.test(n)||F.test(n)||t.skipInterceptor)return t;e=r&&!function(t){return!(!t.headers||!t.headers.Authorization)}(t)&&function(t){return!c||!t.noAppKey}(t)?Y.initializing.done?S.promise:i.all([Y.initializing,S.promise]):A.promise;var o=r?_.partial(U,t):function(){return t};return c&&window.c8y_testing?o():e.then(o)},responseError:function(t){_.isFunction(t.headers)&&t.headers("tfatokenexpired")&&$.hasAuth&&j();var e=Boolean(s.token);return 401!==t.status||e||function(){var t=d.url("user/currentUser");return f.get(t,{headers:d.contentHeaders("user",!0),silentError:!0}).then(function(){return!0},function(t){return 401!==t.status})}().then(function(t){t||j()}),i.reject(t)},setAuthToken:R,clearTokens:x,setTFAToken:q,clearTFAToken:W,saveAuthToken:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:T;G(c,t,y),G(e,t,k)},checkSavedTokens:V,setAppKey:X,headers:function(){var t={Authorization:c?"".concat(E," ").concat(c):void 0,tfatoken:h,UseXBasic:!0};return t["X-Cumulocity-Application-Key"]=C,t},resetPasword:function(t){var e={method:"POST",url:d.url("user/passwordReset"),params:{tenantId:t.tenant},data:{email:t.email},silentError:!0};return f(e)},changePasswordWithResetToken:function(t){var e={method:"PUT",url:d.url("user/passwordReset"),params:{tenantId:t.tenant},data:{email:t.email,token:l,newPassword:t.newPassword,passwordStrength:(t.passwordStrength||"").toUpperCase()},silentError:!0};return f(e).then(function(t){return l=void 0,a.url(a.path()),t})},setRecoverPassToken:J,verifyTFACode:function(t){M();var e={url:d.url("user/pin"),data:{pin:t},method:"POST",silentError:!0,headers:{Authorization:"".concat(b||T," ").concat(p),"Content-Type":"application/vnd.com.nsn.cumulocity.user+json;"}};return f(e).then(N)},getPassword:function(){return c&&L(c).password},getUserFromToken:function(){return L(c).user},getTenantFromToken:function(){return L(c).tenant},mustEnforcePasswordStrength:function(t){return Q([{path:"system/options/password/enforce.strength",prop:"systemLevel",checkFn:function(t){return"true"===(t.data||{}).value}},{path:"security-options/password/strength.validity",prop:"tenantLevel",checkFn:function(t){return"true"===(t.data||{}).value}}]).then(function(t){return t.systemLevel||t.tenantLevel})},getPasswordMinGreenLength:function(t){return Q([{path:"system/options/password/green.min-length",prop:"minGreenLength",checkFn:function(t){return _.parseInt((t.data||{}).value)}}]).then(function(t){return t.minGreenLength})},onSetToken:K,authReady:B,isSupportUser:function(){var t=L(p);return(t?t.user:"").includes("$")},getLoginOptions:function(){return v},whenAuthorized:function(){return S.promise}};return Y.initializing=i.resolve().then(function(){f=n.get("$http"),d=n.get("c8yBase"),g=n.get("c8yApplication")}).then(window.preventInit?function(){}:function(){if(window.c8y_testing)return i.when();var t=[{type:(m=n.get("c8yLoginOptions",[f,d])).loginOptions.BASIC.value}];return m.list({skipInterceptor:!0,params:{tenantId:d.getParamFromUrl("tenantId",window.location.search)}}).then(function(t){v=t.data.loginOptions},function(){v=t})}).then(function(){return window.c8y_testing?(K({token:s.token,type:s.tokenType||T}),{testing:!0}):s.oauthCode?function(t){D();var e={silentError:!1,url:d.url("tenant/oauth"+"?grant_type=authorization_code".concat(_.get(d.appOption("oauth"),"uriAddition",""))+"&code=".concat(t)),method:"POST",skipInterceptor:!0};return f(e).then(B)}(s.oauthCode):l?(a.search("token",l),x(),{recoverPassword:!0}):s.noSavedTokens?{noSavedTokens:!0}:V()}).finally(function(){Y.initializing.done=!0}),window.c8y_testing&&(o.localStorage||(o.localStorage=window.localStorage),o.sessionStorage||(o.sessionStorage=window.sessionStorage)),Y}t.$inject=["$location","$rootScope","$injector","$q","$window","utoa","atou","info"],angular.module("c8y.core").factory("c8yAuth",t).config(["$httpProvider",function(t){t.interceptors.push("c8yAuth")}])}();