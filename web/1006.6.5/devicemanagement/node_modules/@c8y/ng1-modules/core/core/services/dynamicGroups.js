"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,o=!1,i=void 0;try{for(var u,c=e[Symbol.iterator]();!(r=(u=c.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(u,c,a,o,l,s,f,e){var t="c8y_DynamicGroup",n="c8y_IsDynamicGroup",y="c8y_UIDeviceColumnsMeta",p="c8y_UIDeviceFilterConfig",g="c8y_DeviceQueryString",r="c8y_DeviceGroup",i="c8y_DeviceSubgroup",d="c8y_IsDeviceGroup",m="smartgroup",b="".concat("service/smartgroup","/smartgroups");return{spawnEmpty:function(){return _defineProperty({type:t},n,{})},createWithUI:function(e){var t=e.columns,n=e.columnsConfig,r=e.configurableColumns;return o({templateUrl:":::PLUGIN_PATH:::/ui/views/addDynamicGroupModal.html",controller:"addDynamicGroupModalController",resolve:{columns:function(){return _.cloneDeep(t)},columnsConfig:function(){return _.cloneDeep(n)},configurableColumns:function(){return _.cloneDeep(r)}}})},create:function(e){var t,n=e.dynamicGroup,r=e.columns,o=e.columnsConfig,i=e.configurableColumns,u=_objectSpread({},n,(_defineProperty(t={},p,o),_defineProperty(t,g,s.buildQuery(f.getQuery(r,o))),_defineProperty(t,y,_.map(i,"meta")),t));return P().then(function(e){return e?v(u):l.create(u)}).then(a.getResData)},getGroupList:function(){return l.list({fragmentType:n})},getGroupItems:h,getConfigurableColumnsMeta:function(e){return D(e).then(function(e){return _.get(e,y)})},saveConfigurableColumnsMeta:function(e,t){return l.save(_defineProperty({id:_.get(e,"id",e)},y,_.map(t,"meta")))},getColumnsConfig:function(e){return D(e).then(function(e){return _.get(e,p)})},saveColumnsConfig:function(e,t,n){var r,i=(_defineProperty(r={id:_.get(e,"id",e)},p,n),_defineProperty(r,g,s.buildQuery(f.getQuery(t,n))),r);return u.all([P(),D(i)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],o=_objectSpread({},r,i);return!n||!j(o)&&_.get(o,"id")?l.save(o):function(e){return a.hasId(e)?function(e){return c.put(a.url("".concat(b,"/").concat(e.id)),_.pick(e,[p,g]))}(e):v(e)}(o)}).then(a.getResData)},isSmartGroupV2:j,isDynamicGroup:C,isDynamicGroupForId:function(e){return _.isUndefined(e)?u.resolve(!1):l.detailCached(e).then(a.getResData).then(function(e){return C(e)})},addChildCountProperty:function(t,e){return u.all(_.map(t,function(t){return C(t)?h(t,_objectSpread({pageSize:1,withTotalPages:!0},e)).then(function(e){return t.childCount=_.get(e,"statistics.totalPages",0),t}):u.resolve(t)})).then(function(e){return e.statistics=t.statistics,e.paging=t.paging,e})},getType:function(){return t},remove:function(e){return u.all([P(),D(e)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return n&&j(r)?function(e){return c.delete(a.url("".concat(b,"/").concat(e.id))).then(a.getResData)}(r):l.remove(r)}).then(a.getResData)}};function v(e){return c.post(a.url(b),e)}function h(e,o){return u.all([P(),D(e)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return n&&j(r)?l.listQuery({__bygroupid:r.id},_objectSpread({},o,{withParents:!0}),!1):l.list(_objectSpread({q:_.get(r,g)},o))})}function D(e){return C(e)?u.resolve(e):l.detail(e).then(a.getResData)}function C(e){return _.has(e,n)||_.get(e,"type")===t}function P(){return e.isAvailable({name:m})}function j(e){var t=_.get(e,"type");return _.has(e,n)&&_.has(e,d)&&(t===r||t===i)}}e.$inject=["$q","$http","c8yBase","c8yModal","c8yInventory","c8yQueriesUtil","c8yFilteringSortingInventoryQueries","c8yApplication"],angular.module("c8y.core").factory("c8yDynamicGroups",e)}();