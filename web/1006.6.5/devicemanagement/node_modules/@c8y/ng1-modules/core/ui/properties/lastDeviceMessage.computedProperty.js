"use strict";!function(){function e(e){e.register("lastDeviceMessage",t)}function t(r,e,t,a,c,o,i){var n={};function s(e){return i.list({source:e,pageSize:50})}function d(e,t){var i=this;i.device=e,i.service=t.service,i.check_audit=t.check_audit,i.rt_channel="/".concat(t.rt_channel,"/").concat(e.id),i.filter_prop=t.filter_prop||"source",i.time_prop=t.time_prop||"time",i.ops=t.ops,i.list().then(_.bind(i.onList,i))}function p(i){var n=this;n.device=i,n.dateObj=[function(t){var e={};return Object.defineProperty(e,"timestamp",{get:function(){var e=t.device||{};return e.c8y_Availability&&e.c8y_Availability.lastMessage}}),e}(n)],n.devices=new Set,_.forEach([{service:e,rt_channel:"alarms",check_audit:!0},{service:t,rt_channel:"events",ops:["CREATE"],time_prop:"creationTime"},{service:a,rt_channel:"measurements",ops:["CREATE"]},{service:c,rt_channel:"operations",ops:["UPDATE"],filter_prop:"deviceId",check_audit:!0}],function(e){var t=new d(i,e);n.dateObj.push(t)})}function u(e){n[e.id]=n[e.id]||new p(e);var t=n[e.id];return t.device=e,t.add(e),t.get()}return d.prototype.list=function(){var e=this,t={pageSize:1};return t[e.filter_prop]=e.device.id,e.service.list(t)},d.prototype.updateValue=function(e){var t=this;t.timestamp||(t.timestamp=e),moment(t.timestamp).isBefore(e)&&(t.timestamp=e)},d.prototype.onList=function(e){var t=this,i=_(e),n=t.check_audit?"id":t.time_prop,r=_.bind(t.updateValue,t),a=t.check_audit?function(e){s(e).then(_.bind(t.onAudit,t))}:r;i.map(n).forEach(a),t.startRealtime()},d.prototype.onRealtime=function(e,t){var i=this;i.check_audit?s(t.id).then(_.bind(i.onAudit,i)):i.updateValue(t[i.time_prop])},d.prototype.onAudit=function(e){var t=this;_(e).filter(_.bind(t.byOwner,t)).map("creationTime").forEach(_.bind(t.updateValue,t))},d.prototype.byOwner=function(e){var t=this.device;return e.user===t.owner},d.prototype.startRealtime=function(){var t=this;o.createLocalId(t,"rtId");var i=t.rtId,n=t.rt_channel,e=t.ops||["CREATE","UPDATE","DELETE"];_.forEach(e,function(e){r.addListener(i,n,e,_.bind(t.onRealtime,t))}),r.start(i,n)},d.prototype.stopRealtime=function(){r.removeSubscriber(this.rtId,this.rt_channel)},p.prototype.detach=function(e){var t=this.devices;t.delete(e),t.size||(_(this.dateObj).filter("stopRealtime").forEach(function(e){return e.stopRealtime()}),delete n[e.id])},p.prototype.add=function(e){this.devices.has(e)||this.devices.add(e)},p.prototype.get=function(){return function(e){var t=_(e).map(function(e){return e&&moment(e)}).filter(_.identity).value();return t.length?moment.max(t).format("YYYY-MM-DDTHH:mm:ssZ"):void 0}(_.map(this.dateObj,"timestamp"))},u.detach=function(e){var t=n[e.id];t&&t.detach(e)},u}t.$inject=["c8yRealtime","c8yAlarms","c8yEvents","c8yMeasurements","c8yDeviceControl","c8yBase","c8yAudits"],e.$inject=["c8yComputedPropertiesProvider"],angular.module("c8y.ui").config(e)}();