"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),r.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}!function(){t.$inject=["$q","$injector","$window","c8yAlarms","c8yAlert","c8yInventory","c8yBase","c8yRealtime","c8yUser","c8yConfig","c8ySmartRulesAvailability","gettextCatalog"];var J="c8yAlarmList";function t(F,x,P,K,z,U,B,G,V,H,M,q){return{restrict:"EA",scope:{severities:"=?activeSeverities",options:"=?filter",realtime:"=?",hideHeaderActions:"=?",title:"=?",unresolved:"=?",paginate:"=?",refreshLoading:"=?",hideDevice:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/views/alarmList.html",link:function(a,t,i){var r={};function o(t){K.detail(t).then(_.partial(e,t))}function e(t,e){var n=F.when(t);return r[t.id]&&(n=n.then(a.auditRefresh[t.id])),n.then(function(){_.assign(t,e.data)})}function n(t){if(!a.auditList||!a.auditList[t.id])return q.getString("ACKNOWLEDGED");var e=a.auditList[t.id],n=K.ackTime(t,e),r={ackBy:K.acknowledgedBy(t,e),ackTimeFromNow:moment(n).fromNow()};return q.getString("ACKNOWLEDGED by: {{ackBy}} {{ackTimeFromNow}}",r)}function u(t){if(!a.auditList||!a.auditList[t.id])return q.getString("CLEARED");var e={alarmDuration:K.alarmDuration(t,a.auditList[t.id])};return q.getString("CLEARED: was active for {{alarmDuration}}",e)}function s(t){var e={alarmTimeFromNow:moment(t.time).fromNow()};return q.getString("ACTIVE: triggered {{alarmTimeFromNow}}",e)}function c(t){var e=!0;return i.activeSeverities&&(e=_.isEmpty(a.severities)||a.severities[t.severity]),e&&!((a.unresolved||!1===(a.options&&a.options.resolved))&&"CLEARED"===t.status)}function l(){return a.refreshLoading?F.resolve():(a.refreshLoading=!0,a.alarms=[],a.auditList={},r={},a.options=a.options||{},a.options.type&&(a.options.types=[a.options.type]),function(){if(!b(a.options).byDevices())return F.reject();var t=W();if(t.length<=0)return F.reject();var e=_.map(t,function(t){return K.list(_objectSpread({source:t,withSourceDevices:!0,withSourceAssets:!0,resolved:a.options.resolved,pageSize:T()},v()))});return F.all(e).then(_.flatten)}().catch(y).catch(p).catch(m).catch(f).then(h).then(function(){a.refreshLoading=!1}))}function f(){var t={pageSize:T()};return K.list(t)}a.refreshLoading=!1;var d=_.throttle(function(){a.refreshLoading||(a.paging.loading=!0,a.refreshLoading=!0,a.realtimeAnimation=!1,a.paging.next().then(function(t){_.forEach(t,function(t){a.alarms.push(t)}),a.paging.loading=!1,a.refreshLoading=!1,a.paging=t.paging}))},300,{trailing:!0});function m(){if(!b(a.options).bySeverity())return F.reject();var t={severity:a.options.severity,resolved:a.options.resolved,pageSize:T()};return B.timeOrderFilter(t),K.list(t)}function p(){return b(a.options).byStatus()?K.listByStatus(a.options.status,_objectSpread({pageSize:T()},v())):F.reject()}function v(){var t=_.reduce(a.severities,function(t,e,n){return e?[].concat(_toConsumableArray(t),[n]):t},[]);return 1===t.length?{severity:_.head(t)}:{}}function y(){if(!b(a.options).byType())return F.reject();var e=a.options.types,t=_objectSpread({pageSize:T()},v());return 1===e.length&&(t.type=e[0]),K.list(t).then(function(t){return _.filter(t,function(t){return _.includes(e,t.type)})})}function h(t){var e=t;(function(){if(i.paginate&&!a.paginate)return!1;if(void 0!==a.unresolved||i.severities)return!1;var t=a.options;if(!t)return!0;if(t.source)return!1;var e=b(t),n=[e.byType()?1:0,e.byStatus()&&function(t){return _.reduce(t,function(t,e){return e?t+1:t},0)}(_.values(t.status))||0,e.bySeverity()?1:0];return _.sum(n)<=1})()&&(a.paging=e.paging);var n=a.options;if(n){var r=b(n);e=_.filter(e,function(t){return(!r.byType()||_.includes(n.types,t.type))&&(!r.byStatus()||n.status[t.status])&&(!r.bySeverity()||n.severity===t.severity)})}return a.alarms=e}function g(t){var e=[["severity","time"],["asc","desc"]];if("ACTIVE_FIRST"===a.options.orderMode){var n={ACTIVE:1,ACKNOWLEDGED:0,CLEARED:-1};e=[[function(t){return n[t.status]},"severity","time"],["desc","asc","desc"]]}var r=_(t).filter(c).orderBy(e[0],e[1]).value(),i=_.get(a,"options.displayFilter");return i&&(r=_.filter(r,i)),a.filteredAlarms=r}function b(e){function t(t){return function(){return e&&!!t}}var n=e||{};return{byType:t(!_.isEmpty(n.types)),byStatus:t(n.status&&!_.isEmpty(n.status)&&function(t){return _.some(t,function(t){return!0===t})}(n.status)),bySeverity:t(n.severity),byDevices:function(){return t(!_.isEmpty(W()))}}}function S(){a.realtimeAnimation=!1,l()}function A(t,e){if(a.realtimeAnimation=!0,R(e,a.options)){var n=_.find(a.alarms,{id:e.id});n?L(e,n):E(e)}}function E(t){var e=E._executing;if(e)return e.creating=!0,F.reject(e);var n=j(t).then(function(t){a.alarms.unshift(t)}).finally(function(){E._executing=null});return E._executing=n}function L(e,t){var n=j(e,t.source.name);return r[e.id]&&(n=n.then(a.auditRefresh[e.id])),n.then(function(){a.realtimeAnimation=!0;var t=_.findIndex(a.alarms,{id:e.id});a.alarms[t]=e})}function w(t){_.remove(a.alarms,{id:t.id}),delete a.auditList[t.id],delete r[t.id]}function D(t,n){a.realtimeAnimation=!0,!_.some(a.alarms,function(t){var e;return t.id===n.id&&(R(n,a.options)?L(n,t):w(n),e=!0),e})&&R(n,a.options)&&E(n).catch(function(e,n){return function(t){return t&&t.creating&&_.isFunction(t.then)?t.then(_.partial(D,e,n)):F.reject(t)}}(t,n))}function C(t,e){var n;return a.realtimeAnimation=!0,_.forEach(a.alarms,function(t){t.id===e.id&&(w(e),n=!1)}),n}function j(e,t){var n=F.resolve(e);return _.defaultsDeep(e,{source:{name:t}}),!e.source.name&&e.source.id&&(n=function(t){return U.detail(t).then(B.getResData).then(function(t){return t.name})}(e.source.id).then(function(t){e.source.name=t}).then(function(){return e})),n}function R(t,e){return function(n,t){return!t||_.some(t,function(t,e){return t&&e===n.status})}(t,e.status)&&function(t,e){return _.isEmpty(e)||_.includes(e,t.type)}(t,e.types)&&function(t,e){return!e||e===t.severity}(t,e.severity)}function T(){return a.options&&Number(a.options.pageSize)||10}function O(){G.switchRealtime(a.$id,a.realtimeChannel)}function $(){return G.getStatus(a.$id,a.realtimeChannel)}function I(t,e){G.addListener(a.$id,a.realtimeChannel,t,e)}function N(){var t=a.realtimeChannel,e=function(){var t=W();return"/alarmsWithChildren/".concat(t.length?t.join(","):"*")}();if(t){if(e===t)return;G.removeSubscriber(a.$id,t),a.cancelDestroyRemoveSubscriber(),a.stopWatchingRealtime()}a.realtimeChannel=e,I("".concat(a.$id,"-subscribed"),S),I("CREATE",A),I("UPDATE",D),I("DELETE",C),a.cancelDestroyRemoveSubscriber=a.$on("$destroy",function(){return G.removeSubscriber(a.$id,a.realtimeChannel)}),a.stopWatchingRealtime=a.$watch("realtime",k),a.realtime&&O()}function W(){var t=a.options,e=t.source,n=t.sources,r=_.concat(n,e);return _(r).map(function(t){return B.hasId(t)&&B.getId(t)}).compact().value()}function k(){a.realtime&&l(),a.realtime!==$()&&O()}a.auditRefresh={},a.statusText=function(t){var e;switch((t.status||"").toUpperCase()){case K.status.ACKNOWLEDGED:e=n;break;case K.status.CLEARED:e=u;break;case K.status.ACTIVE:e=s;break;default:e=function(){return""}}return e(t)},a.isActive=function(t){return t.status===K.status.ACTIVE},a.toggle=function(t){r[t.id]=!r[t.id]},a.isOpen=function(t){return!0===r[t.id]},a.isNarrow=function(){return a.containerWidth<=991},a.changeStatus=function(t,e){a.changingStatus=!0;var n=q.getString('Alarm status changed to "{{status | translate}}".',{status:e}),r=K.update({id:t.id,status:e});return $()||(r=r.then(_.partial(o,t))),(r=r.then(function(){z.success(n)})).finally(function(){a.changingStatus=!1})},a.isFitSeverity=c,a.icon=K.icon,a.getStandardKeys=K.getStandardKeys.bind(K),a.getNonStandardKeys=K.getNonStandardKeys.bind(K),a.alarmDuration=function(t){return a.auditList&&a.auditList[t.id]?K.alarmDuration(t,a.auditList[t.id]):""},a.refresh=l,a.loadNext=d,a.createSmartRule=function(e){var t;if(a.smartRules){var n=x.get("smartRulesSvc");t=V.current().then(function(t){return n.addNewForInputAlarmAndOutputUserWithUI(e,t)})}return t},a.translateAlarmText=function(t){return q.getString(t.text)},a.getDeviceLinkFromAlarm=_.memoize(function(t){var e=H[J]||{};return e.getDeviceLinkFromAlarm?e.getDeviceLinkFromAlarm(t):["#","device",t.source.id].join("/")},function(t){return t.id}),a.$watch(function(){return{containerWidth:t.parent().width(),windowWidth:P.innerWidth}},function(t){a.containerWidth=t.containerWidth||t.windowWidth},!0),a.$watch("alarms",g,!0),a.$watch("severities",function(){l().then(function(){return g(a.alarms)})},!0),a.$on("alarmListRefresh",l),i.filter?a.$watch("options",function(){l().then(N)},!0):a.realtime||l(),M.shouldShowGlobalSmartRules().then(function(t){a.smartRules=t&&B.checkIfModulesExist(["c8y.cockpit.config"])})}}}angular.module("c8y.ui").directive(J,t)}();