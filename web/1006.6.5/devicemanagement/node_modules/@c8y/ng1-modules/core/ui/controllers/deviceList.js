"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},i=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){function e(t,e,n,o,i,r,c,u,a,s,l,d,f,g,m,p,v,h){var y,C="all-devices-columns-config",D=this,I=f("No devices to display."),b=_.throttle(function(){t.parentDeviceId()&&(D.realtimeAnimation=!1,D.realtimeChannel="/managedobjects/*",u.addListener(t.$id,D.realtimeChannel,u.realtimeActions().CREATE,P),u.addListener(t.$id,D.realtimeChannel,u.realtimeActions().UPDATE,E),u.addListener(t.$id,D.realtimeChannel,u.realtimeActions().DELETE,N),D.rtState=function(){return u.getStatus(t.$id,D.realtimeChannel)},D.rtStart=function(){u.start(t.$id,D.realtimeChannel)},D.rtStop=function(){u.stop(t.$id,D.realtimeChannel)});return n.when().then(w).then(G).then($).then(U).then(T)},500,{leading:!1,trailing:!0}),S={clickDeleteCallback:function(e){return m.deleteDeviceWithConfirmation(e).then(function(){_.pull(D.devices,e),D.totalDevices-=1})}};function w(){return(t.parentDeviceId()?n.resolve(p.getChildDeviceColumns(S)):v.getConfigurableColumns({dynamicGroupId:t.dynamicGroupId(),options:S}).then(function(e){return A(y=e)})).then(function(e){D.columns=e||D.columns})}function G(){return(t.parentDeviceId()?n.when({}):t.dynamicGroupId()?l.getColumnsConfig(t.dynamicGroupId()):d.get(C)).then(function(e){D.columnsConfig=e||D.columnsConfig})}function $(e){return(t.parentDeviceId()?(D.rtStop&&D.rtStop(),i.childDevices(t.parentDeviceId())):t.dynamicGroupId()?l.getGroupItems(t.dynamicGroupId(),e):function(e){var n=s.getQuery(D.columns,D.columnsConfig);return o.listQuery(n,_objectSpread({withGroups:!0},e))}(e)).then(function(e){return L(e,!0)})}function L(e,n){D.devices||(D.devices=[]),n&&(D.devices.length=0),e.forEach(function(e){_.assign(e,{properName:o.properName(e)}),D.devices.push(e)}),D.devices=function(e){var n=e,t=D.columnsConfig.systemId;if(t&&0!==t.sorting.order){var i=1===t.sorting.order?"asc":"desc";n=_.orderBy(e,function(e){return _.toNumber(e.id)},i)}return n}(D.devices),t.paging=e.paging}function A(e){return _.filter(e,"meta.active")}function O(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:t.dynamicGroupId();return v.saveConfigurableColumnsMeta({dynamicGroupId:e,configurableColumns:y})}function j(e){D.columnsConfig=e||D.columnsConfig,function(){var e;e=t.parentDeviceId()?n.when():t.dynamicGroupId()?l.saveColumnsConfig(t.dynamicGroupId(),D.columns,D.columnsConfig):d.set(C,D.columnsConfig);return e}().then(function(){return $()})}function P(e,n){var t=!n.c8y_IsDevice,i=!1;D.realtimeAnimation=!0,_.forOwn(D.devices,function(e){return e.id!==n.id||!(i=!0)}),t||i||(_.assign(n,{properName:o.properName(n)}),D.devices.push(n),D.totalDevices+=1)}function E(e,n){D.realtimeAnimation=!0,_.forOwn(D.devices,function(e){e.id===n.id&&(_.assign(n,{properName:o.properName(n)}),_.assign(e,n))})}function N(e,n){D.devices=_.reject(D.devices,{id:n.id})}function T(){if(t.setTitles()&&D.devices){var e={title:void 0,subtitle:void 0};return t.parentDeviceId()?e.subtitle=g.getPlural(D.devices.length,"Showing 1 child device","Showing {{$count}} child devices",{}):t.dynamicGroupId()?e.subtitle=g.getString("Showing {{devices.length}} items",D):(e.title=f("All devices"),e.subtitle=_.isUndefined(D.totalDevices)?g.getString("Showing {{devices.length}}",D):g.getString("Showing {{devices.length}} of {{totalDevices}}",D)),h.changeTitle(n.when(e))}return!1}function U(){t.parentDeviceId()?D.totalDevices=D.devices.length:t.dynamicGroupId()||o.getCount().then(function(e){D.totalDevices=e})}_.assign(D,{columnsConfig:{},noItemsMessage:I,clearColumnsConfig:function(){j({})},createSmartGroup:function(){return l.createWithUI({columns:D.columns,columnsConfig:D.columnsConfig,configurableColumns:y})},onLoadMore:function(e){D.realtimeAnimation=!1,t.paging.loading=!0,(e?$({pageSize:e}):t.paging.next().then(L)).finally(function(){t.paging.loading=!1})},onColumnsConfigChanged:j,parentDeviceId:function(){return t.parentDeviceId()},configureColumns:function(){return v.popupModalColumnsConfigure({dynamicGroupId:t.dynamicGroupId(),columnOptions:S}).then(function(e){y=e,D.columns=A(e)}).then(O).then(function(){return c.success(f("Columns definitions saved."))}).then($)}}),t.refresh=function(){return D.realtimeAnimation=!1,D.refreshLoading=!0,t.paging?(t.paging.refresh().then(_.partialRight(L,!0)).then(U).finally(function(){D.refreshLoading=!1}),t.paging=null,!1):$().finally(function(){D.refreshLoading=!1})},t.$watch("parentDeviceId()",b),t.$watch("dynamicGroupId()",b),t.$watch("ctrl.devices.length",T),t.$watch("ctrl.totalDevices",T),e.$on("deviceList.getLoadedDevicesList",function(){e.$emit("deviceList.loadedDevicesList",D.devices)})}e.$inject=["$scope","$rootScope","$q","c8yDevices","c8yInventory","c8yBase","c8yAlert","c8yRealtime","c8yQueriesUtil","c8yFilteringSortingInventoryQueries","c8yDynamicGroups","c8yUserPreferences","gettext","gettextCatalog","groupsHierarchySvc","c8yDeviceListColumns","c8yConfigurableDeviceListColumns","c8yTitle"],angular.module("c8y.ui").controller("c8yDeviceListCtrl",e)}();