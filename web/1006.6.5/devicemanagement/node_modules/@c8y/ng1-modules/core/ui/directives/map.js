"use strict";function _slicedToArray(n,t){return _arrayWithHoles(n)||_iterableToArrayLimit(n,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(n,t){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n)){var e=[],i=!0,r=!1,a=void 0;try{for(var o,l=n[Symbol.iterator]();!(i=(o=l.next()).done)&&(e.push(o.value),!t||e.length!==t);i=!0);}catch(n){r=!0,a=n}finally{try{i||null==l.return||l.return()}finally{if(r)throw a}}return e}}function _arrayWithHoles(n){if(Array.isArray(n))return n}!function(){function n(w,A,N,P,T,$,D){return{link:function(e){var a=[],i="c8y_Position",r="com_nsn_startups_vendme_fragments_GPSCoordinates",o=v,l=b,c=[];function n(){c.length=0,a.length=0,e.deviceId?u(e.deviceId):d()}function u(n){return A.detail(n).then(T.getResData).then(t)}function t(n){c.push(n),e.multipleDevices?function(n){w.all([A.childDevices(n),A.childAssets(n)]).then(_.flattenDeep).then(s)}(e.deviceId):d(f(c))}function s(n){d(f(_.union(c,n)))}function f(n){return _.map(function(n){return _.filter(n,function(n){return!$.isGroup(n)})}(n),"id")}function d(n){var t={};return(n&&n.length?(t.ids=n.join(","),A.list(t)):w.all([A.list({fragmentType:r}),A.list({fragmentType:i})]).then(_.flattenDeep)).then(m).then(v)}function m(n){return e.withPosition=function(n){return _.filter(n,function(n){return g(n)})}(n),_.filter(_.map(e.withPosition,b),_.identity)}function h(){e.realtimeAnimation=!1}function p(n,t){N.addListener(e.$id,e.realtimeChannel,n,t)}function y(n,t){g(t)&&(l(t),o())}function g(n){return n[i]||n[r]}function v(n){n&&n.length&&_.forEach(n,function(n){a.push(n)}),e.withPosition.length&&P.getMap("c8y-map-".concat(e.$id)).then(function(n){n.fitBounds(a,{padding:[50,50]})})}function b(n){var t=g(n),e=_.cloneDeep(t||{}),i=null,r=_.find(a,{id:n.id});return r?(t.lat=Number(t.lat),r.lat=t.lat,t.lng=Number(t.lng),r.lng=t.lng):(t.lat=Number(t.lat),e.lat=t.lat,t.lng=Number(t.lng),e.lng=t.lng,t&&_.isNumber(t.lat)&&_.isNumber(t.lng)&&!_.isNaN(_.toNumber(t.lat))&&!_.isNaN(_.toNumber(t.lng))&&(e.id=n.id,e.message=function(n){return'\n          <a\n            class="btn btn-link"\n            style="width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"\n            href="#/device/'.concat(n.id,'"\n            title="').concat(n.name,'"\n          >\n            ').concat(n.name,"\n          </a>\n        ")}(n),e.icon=function(n){return{className:"".concat(n,"-marker-icon"),iconSize:[25,41],iconAnchor:[12,41],type:"div"}}(function(n){var t=n.c8y_ActiveAlarmsStatus||{};return _.find(["critical","major","minor","warning"],function(n){return t[n]})||"normal"}(n)),i=e)),i}e.$watch("deviceId",function(n,t){n&&n!==t&&(c=[],a.length=0,u(n))}),e.markers=a,e.mapDefault={scrollWheelZoom:!1},e.cssToHide=function(){return e.withPosition&&e.withPosition.length?{}:{visibility:"hidden"}},e.paging={refresh:!0},e.realtime||(e.refresh=n),w.all([D.listByUser(),P.getMap("c8y-map-".concat(e.$id))]).then(function(n){var t=_slicedToArray(n,2),e=t[0],i=t[1];if(_.some(e,{contextPath:"openseamap"})){var r=L.tileLayer("/apps/openseamap/{z}/{x}/{y}.png");L.control.layers({},{openseamap:r}).addTo(i)}}),e.realtimeChannel="/managedobjects/*",p("".concat(e.$id,"-subscribed"),h),p("UPDATE",y),e.realtime&&(e.$on("$destroy",function(){N.stop(e.$id,e.realtimeChannel)}),N.start(e.$id,e.realtimeChannel)),n()},restrict:"E",scope:{deviceId:"=?",multipleDevices:"=",cssClass:"@",width:"=?",height:"=?",config:"=",realtime:"="},templateUrl:":::PLUGIN_PATH:::/ui/views/map.html"}}n.$inject=["$q","c8yInventory","c8yRealtime","leafletData","c8yBase","c8yGroups","c8yApplication"],angular.module("c8y.ui").directive("c8yMap",n)}();