"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function asyncGeneratorStep(e,t,n,r,i,a,o){try{var u=e[a](o),c=u.value}catch(e){return void n(e)}u.done?t(c):Promise.resolve(c).then(r,i)}function _asyncToGenerator(u){return function(){var e=this,o=arguments;return new Promise(function(t,n){var r=u.apply(e,o);function i(e){asyncGeneratorStep(r,t,n,i,a,"next",e)}function a(e){asyncGeneratorStep(r,t,n,i,a,"throw",e)}i(void 0)})}}!function(){function e(g,e,t,p,m,u){var i=e.MODBUS_DEVICE_FRAGMENT,a=e.PROFIBUS_DEVICE_FRAGMENT;return{getConfigModel:function(e){return n.apply(this,arguments)},updateConfigModel:function(e,t){_.set(e,"categoriesConfig",_.map(t,function(e){return{name:e.name,label:e.label,elements:_.compact(_.map(e.elements,function(e){return e.show?_.pick(e,["refId","label","type"]):void 0}))}})),_.unset(e,"coils"),_.unset(e,"registers")},getWidgetModel:function(e){return y.apply(this,arguments)},isAtLeastOneElementSelected:function(e){return _.some(e,function(e){return _.some(e.elements,"show")})},isDiscreteIOSelectedInConfig:window.c8y_testing&&d,isRegisterSelectedInConfig:window.c8y_testing&&f};function n(){return(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=_.get(t,"device"))return e.next=4,C(n);e.next=6;break;case 4:return r=e.sent,e.abrupt("return",o({fieldbusDevice:r,widgetConfig:t}));case 6:return e.abrupt("return",g.resolve([]));case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function o(e){return r.apply(this,arguments)}function r(){return(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.fieldbusDevice,r=t.widgetConfig,e.next=3,E(n);case 3:if(i=e.sent,a=h({fieldbusDevice:n,deviceType:i}),_.isEmpty(a))return e.abrupt("return",[]);e.next=7;break;case 7:return o=_.groupBy(a,T),e.abrupt("return",_(r).chain().get("categoriesConfig",[]).map(function(e){var t=_.get(o,e.name);_.defaults(e,{label:e.name||u("Uncategorized")});var n=_.flow([c,s])({categoryConfigElements:e.elements,deviceType:i,elements:a,categoryElements:t,widgetConfig:r}).categoryConfigElements;return e.elements=n,e}).thru(function(e){return I({categoriesConfig:e,categories:o,deviceType:i,widgetConfig:r})}).value());case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function c(e){var t=e.categoryConfigElements,i=e.deviceType,a=e.elements,n=e.categoryElements,r=e.widgetConfig;return{categoryConfigElements:_.map(t,function(e){var t=e.refId,n=e.type,r=m.findElementBestMatchingRefId(a,t,n);if(r)return _.defaults(e,{name:r.name,type:r.meta.type.value,typeLabel:m.getElementTypeLabel(r,i),show:!0,label:r.name})}),deviceType:i,elements:a,categoryElements:n,widgetConfig:r}}function s(e){var t=e.categoryConfigElements,n=e.deviceType,r=e.elements,i=e.categoryElements,a=e.widgetConfig;return{categoryConfigElements:[].concat(_toConsumableArray(t),_toConsumableArray(_(i).filter(function(e){return!_.find(t,{refId:m.getElementRefId(e)})}).map(function(e){return{refId:m.getElementRefId(e),label:e.name,show:l(e,a),name:e.name,type:e.meta.type.value,typeLabel:m.getElementTypeLabel(e,n)}}).value())),deviceType:n,elements:r,categoryElements:i,widgetConfig:a}}function l(e,t){return function(e){return e.meta.type===m.ElementType.REGISTER}(e)?f(e,t):d(e,t)}function f(e,t){var n=e.id,r=e.input,i=e.number,a=e.startBit,o=t.registers;return _.includes(o,n)||_.includes(o,[r,i,a].join(","))||_.includes(o,i)||!!_.find(o,{number:i,startBit:a})}function d(e,t){var n=e.id,r=e.input,i=e.number,a=t.coils;return _.includes(a,n)||_.includes(a,[r,i].join(","))||_.includes(a,i)}function y(){return(y=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,i,a,o,u,c,s,l,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=_.get(t,"device.id"),r=p.detailRealtime(n),i=r.then(E),a=v(n,t).then(function(e){return _.get(t,"categoriesConfig",e)}),e.next=6,g.all({fieldbusDevice:r,deviceType:i,categoriesConfig:a});case 6:return o=e.sent,u=o.fieldbusDevice,c=o.deviceType,s=o.categoriesConfig,l=h({fieldbusDevice:u,deviceType:c}),f=_.map(s,function(e){return _.defaults(_objectSpread({},e,{elements:_(e.elements).map(function(e){var t=m.findElementBestMatchingRefId(l,e.refId,e.type);return t?_.defaults(_objectSpread({},e,t),{label:t.name,show:!0}):e}).filter("show").value()}),{label:e.name})}),e.abrupt("return",{device:u,categories:f});case 13:case"end":return e.stop()}},e)}))).apply(this,arguments)}function v(e,t){return b.apply(this,arguments)}function b(){return(b=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C(t);case 2:return r=e.sent,e.next=5,E(r);case 5:return i=e.sent,a=h({fieldbusDevice:r,deviceType:i}),o=_.groupBy(a,T),e.abrupt("return",I({categoriesConfig:[],categories:o,deviceType:i,widgetConfig:n}));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}function h(e){var t=e.fieldbusDevice,n=e.deviceType,r=m.getElementsWithMeta(n);return _.has(t,i)||_.has(t,a)?r:_.filter(r,w)}function w(e){return e.meta.type===m.ElementType.REGISTER&&!e.input}function C(e){return m.isFieldbusDevice(e)?g.resolve(e):p.detail(t.getId(e)).then(t.getResData)}function E(e){return m.getDeviceTypeFromDevice(e)}function T(e){return _.get(e,"category","")}function I(e){var n=e.categoriesConfig,t=e.categories,r=e.deviceType,i=e.widgetConfig;return[].concat(_toConsumableArray(n),_toConsumableArray(_(t).pickBy(function(e,t){return!_.find(n,{name:t})}).map(function(e,t){return{name:t,label:t||u("Uncategorized"),elements:_.map(e,function(e){return{refId:m.getElementRefId(e),label:e.name,show:l(e,i),name:e.name,type:e.meta.type.value,typeLabel:m.getElementTypeLabel(e,r)}})}}).value()))}}e.$inject=["$q","fieldbusConstants","c8yBase","c8yDevices","c8yDeviceDatabase","gettext"],angular.module("c8y.modbusWidget4").factory("modbusWidgetSvc",e)}();