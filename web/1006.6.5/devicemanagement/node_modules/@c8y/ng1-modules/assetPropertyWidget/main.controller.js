"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var c,a=e[Symbol.iterator]();!(r=(c=a.next()).done)&&(n.push(c.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw o}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(r,e,t,i,n,o,c,a){var u=_.memoize(function(){return e.all({configProperties:function(){var e=g("properties",[]);return _.filter(e,"__active").map(function(e){return angular.copy(e)})}(),discoveredProperties:function(){if(g("allowDisplayAndEditKnownProperties",!1))return i.list().then(function(e){return _.filter(e,d)}).then(function(e){return _.filter(e,p)});return[]}()}).then(function(e){var t=e.configProperties,n=e.discoveredProperties;return _(t).concat(n).uniqBy(function(e){return"".concat(_.get(e,"id"),"_").concat(_.get(e,"config._id"))}).reject(m).value()})});function l(){u.cache.clear(),r.$emit("stopRealtime"),function(){var e=r.child.config.device.id;return t.detailRealtime(e,r).then(function(e){r.managedObject=e})}().then(f).then(s).then(h)}function f(){return u().then(function(e){n.attach(r.managedObject,e)})}function s(){return u().then(function(e){return i.getSchema(e)}).then(function(e){r.schema=e})}function d(e){return 1===e.keyPath.length}function p(e){return _.has(r.managedObject,e.keyPath[0])}function h(){y(!0)}function y(t){return e.all({properties:u(),options:function(e){var t={};e&&(t.readonly=e,t.feedback=!1,t.disableSuccessState=!0,t.disableErrorState=!0);return t}(t)}).then(function(e){var t=e.properties,n=e.options;return i.getForm(t,n)}).then(function(e){r.form=e,r.editable=!t})}function b(e){!function(e){_.forEach(e,function(e){var t=_slicedToArray(e.keyPath,1),n=t[0];_.isUndefined(r.managedObject[n])&&(r.managedObject[n]=null)})}(e),u.cache.clear(),s().then(function(){return y(!1)})}function g(e,t){return _.get(r.child.config.options,e,t)}function m(e){var t=g("hiddenPropertiesKeyPaths",[]);return!!_.includes(t,e.keyPath[0])}r.$watch("child.config.options",l),_.assign(r,{startEdit:function(){r.managedObject=_.cloneDeep(r.managedObject),f(),y(!1)},canAddProperties:function(){return g("allowDisplayAndEditKnownProperties",!1)},addProperties:function(){var e={includeTree:!1,includeTreeChildren:!1,showComputed:!1,showRootPropertiesOnly:!0,managedObject:r.managedObject,hideExistingInMO:!0};return a.openSelector(e).then(b)},save:function(){return u().then(function(e){return _.reject(e,{computed:!0})}).then(function(e){return _objectSpread({id:r.managedObject.id},_.pick(r.managedObject,_.map(e,"keyPath[0]")))}).then(t.save).then(function(){return o.success(c("Changes saved."))}).then(l)},cancelEdit:function(){l()}})}e.$inject=["$scope","$q","c8yInventory","c8yPropertiesLibrary","c8yComputedProperties","c8yAlert","gettext","SchemaPropertiesSvc"],angular.module("c8y.parts.assetPropertyWidget").controller("assetPropertyWidgetCtrl",e)}();