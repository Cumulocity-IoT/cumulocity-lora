"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,i=!1,a=void 0;try{for(var o,c=e[Symbol.iterator]();!(r=(o=c.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(i)throw a}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(i,e,t,c,n,a,s){return{doesSupportFile:function(e){return/\.eds$/.test(e.name)},parseFile:function(r){return i(function(n,t){var e=new FileReader;e.onload=function(e){var t=e.target;return n(t.result)},e.onerror=function(e){return t({feedback:{type:"error",summary:a("Could not read file."),details:e}})},e.readAsText(r)}).then(o).then(function(e){return _.defaults(e.deviceType,{name:r.name.replace(/\.eds$/,"")}),e})},parseString:o,parseObject:r};function o(e){var t;try{t=i.resolve(n.parse(e))}catch(e){t=i.reject({feedback:{type:"error",summary:a("Could not parse EDS content."),details:[{type:"error",text:e.toString()}]}})}return t.then(r)}function r(e){var t=function(e){return _.transform(e,function(e,t,n){e[function(e){var t=_slicedToArray(_.toString(e).match(/^([0-9A-Fa-f]+)(sub([0-9A-Fa-f]+)){0,1}$/)||[],4),n=t[1],r=t[3];if(_.isUndefined(n)&&_.isUndefined(r))return e;return"".concat(u(n)).concat(_.isUndefined(r)?"":"sub".concat(u(r)))}(n)]=function(e,t){var n=_slicedToArray(_.toString(t).match(/^([0-9A-Fa-f]+)(sub([0-9A-Fa-f]+)){0,1}$/)||[],4),r=n[1],i=n[3];return _.defaults(_.mapValues(e,function(e){return function(e){return/^0x[0-9A-Fa-f]+$/.test(e)}(e)?u(e):_.isNaN(_.toNumber(e))?e:_.toNumber(e)}),{id:t,Index:_.isUndefined(r)?void 0:u(r),SubIndex:_.isUndefined(i)?void 0:u(i)})}(t,n)},{})}(e),n={},r={details:[]};return function(e,t){t.name=function(e){var t=_.compact([_.get(e,"DeviceInfo.VendorName"),_.get(e,"DeviceInfo.ProductName"),_.get(e,"DeviceInfo.RevisionNumber")]);return 0<t.length?t.join("_"):void 0}(e)}(t,n),function(e,t){t.fieldbusType="canopen"}(0,n),function(e,t,n){t.deviceType=function(e){return _.get(e,[u("1000"),"DefaultValue"])}(e),t.deviceType||n.details.push({type:"warning",text:a("[DeviceType] - not found")})}(t,n,r),function(t,e,n){var r=function(e){return _(e).filter({ObjectType:7}).reject({SubIndex:0}).value()}(t),i=c.getDeviceTypeFeatures(e),a=[];_.forEach(r,function(e){return function(e,t,n,r,i){var a=i.holdingRegisters.dataType.choices.values(),o=i.holdingRegisters.accessType.choices.values(),c=_.omitBy({category:e.SubIndex?n[e.Index].ParameterName:void 0,name:e.ParameterName?"".concat(e.ParameterName," (").concat(d(e.Index),")"):void 0,index:e.Index,subIndex:e.SubIndex,dataType:function(e,t){var n=_.find(t,{edsValue:e.DataType});return _.get(n,"value")}(e,a),accessType:function(e,t){var n=_.find(t,{value:e.AccessType});return _.get(n,"value")}(e,o),min:e.LowLimit,max:e.HighLimit},_.isUndefined),u=!0;_.isUndefined(c.name)&&(u=!1,r.details.push({type:"warning",text:s.getString("[{{id}}] - missing ParameterName",e)}));_.isUndefined(c.dataType)&&(u=!1,r.details.push({type:"warning",text:s.getString("[{{id}}] - missing, invalid or unsupported DataType",e)}));_.isUndefined(c.accessType)&&(u=!1,r.details.push({type:"warning",text:s.getString("[{{id}}] - missing, invalid or unsupported AccessType",e)}));u&&(t.push(c),r.details.push({type:"info",text:s.getString("[{{id}}] - added as variable",e)}))}(e,a,t,n,i)});var o=_.sortBy(a,["index","subIndex"]);(function(e,t){var n=[];_.forEach(e,function(e){return function e(t,n,r,i){var a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1;if(_.includes(r,t.name)){var o=a+1;t.name="".concat(n," (").concat(o,")"),e(t,n,r,i,o)}else r.push(t.name),1<a&&i.details.push({type:"info",text:s.getString('Duplicate ParameterName "{{name}}" for object [{{id}}] renamed to "{{register.name}}".',{name:n,id:(c=t,"".concat(d(c.index)).concat(c.subIndex?"sub".concat(d(c.subIndex)):"")),register:t})});var c}(e,e.name,n,t)})})(o,n),e.c8y_Registers=o}(t,n,r),_.filter(r.details,{type:"error"}).length?(r.type="error",r.summary=a("EDS parsed with errors."),i.reject({feedback:r})):(_.filter(r.details,{type:"warning"}).length?(r.type="warning",r.summary=a("EDS parsed with warnings.")):(r.type="success",r.summary=a("EDS parsed successfully.")),i.resolve({deviceType:_.omitBy(n,_.isUndefined),feedback:r}))}function d(e){return _.toNumber(e).toString(16)}function u(e){return parseInt(_.toString(e).replace(/^0x/,""),16)}}e.$inject=["$q","$rootScope","c8yDeviceTypeParser","c8yDeviceDatabase","ini","gettext","gettextCatalog"],angular.module("c8y.deviceDatabase4").factory("c8yDeviceTypeParserEDS",e)}();