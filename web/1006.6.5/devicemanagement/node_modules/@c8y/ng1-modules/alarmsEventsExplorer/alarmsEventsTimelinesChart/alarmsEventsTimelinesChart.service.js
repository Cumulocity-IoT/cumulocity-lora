"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,c=t[Symbol.iterator]();!(r=(o=c.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(a)throw i}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(c,l,u,s,a,f){var i=u.createEnum([{name:"ALARM",value:"ALARM",label:f("Alarm")},{name:"EVENT",value:"EVENT",label:f("Event")}]);return{TIMELINE_TYPES:i,getSampleAlarmsAndEventsConfigsForDevice:function(t){return c.all([function(t){var e={source:t.id||t,pageSize:10};return s.list(e).then(function(t){return _.map(t,function(t){return{__active:!1,__target:_.pick(t.source,"id","name"),label:t.type,color:n(),timelineType:i.ALARM.value,filters:{type:t.type}}})})}(t),function(t){var e={source:t.id||t,pageSize:10};return a.list(e).then(function(t){return _.map(t,function(t){return{__active:!1,__target:_.pick(t.source,"id","name"),label:t.type,color:n(),timelineType:i.EVENT.value,filters:{type:t.type}}})})}(t)]).then(_.flatten).then(e)},getEmptyAlarmEventConfigForDevice:function(t){return{__active:!1,__target:_.pick(t,"id","name"),label:"",color:n(),timelineType:i.ALARM.value,filters:{type:""}}},fetchTimelinesForAlarmsEvents:function(t,n){var e=_.filter(t,{__active:!0}),r=_.map(e,function(e){return function(t,e){var n=c.when([]),r=_.assign({},e,t.filters,{source:t.__target.id});t.timelineType===i.EVENT.value?n=function(t,e){return a.list(e).then(function(t){return c.all(_.map(t,m))})}(0,r):t.timelineType===i.ALARM.value&&(n=function(t,e){var n=_.assign({},e,{dateFrom:moment(0).format(u.dateFullFormat),dateTo:e.dateFrom,revert:!0,pageSize:1}),r=e,a=_.assign({},e,{dateFrom:e.dateTo,dateTo:moment().format(u.dateFullFormat),pageSize:1}),i=[s.list(n),s.list(r),s.list(a)];return c.all(i).then(_.flatten).then(function(t){return c.all(_.map(t,o))})}(0,r));return n}(e,n).then(function(t){return function(t,e){return{label:t.label,color:t.color,events:e,alarmsEventsConfig:t}}(e,t)})});return c.all(r)},alarmMatchesConfig:function(t,e){return _.isMatch(e,{timelineType:"ALARM",__target:{id:t.source.id},filters:{type:t.type}})},eventMatchesConfig:function(t,e){return _.isMatch(e,{timelineType:"EVENT",__target:{id:t.source.id},filters:{type:t.type}})},transformAlarmToTimelineEvent:o,transformEventToTimelineEvent:m};function e(t){return _.uniqBy(t,function(t){return[t.__target.id,t.timelineType,t.filters.type].join(":")})}function o(o){return c.all([s.alarmDurationDiff(o),function(n){var r=l("absoluteDate"),a=l("translate"),i=l("humanize2");return s.statusText(n).then(function(t){var e=n.firstOccurrenceTime||n.time;return _.flatten(['<i class="fa fw fa-bell"></i> <b>'.concat(r(e),"</b>"),"".concat(a(f("Status")),": ").concat(t),_.map(s.getStandardKeys(n),function(t,e){return"".concat(_.escape(a(t)),": <b>").concat(_.escape(n[e]),"</b>")}),_.map(s.getNonStandardKeys(n),function(t){return"".concat(_.escape(i(t)),": <b>").concat(_.escape(JSON.stringify(n[t])),"</b>")})]).join("<br />")})}(o)]).then(function(t){var e=_slicedToArray(t,2),n=e[0],r=e[1],a=o.firstOccurrenceTime||o.time||o.creationTime,i=o.status!==s.status.ACTIVE&&n?moment(a).subtract(n).format(u.dateFullFormat):void 0;return{id:o.id,dateFrom:a,dateTo:i,tooltip:r}})}function m(e){return function(n){var t=l("absoluteDate"),r=l("translate"),e=l("humanize2");return c.when(_.flatten(['<i class="fa fw fa-rss"></i> <b>'.concat(t(n.time),"</b>"),_.map(a.getStandardKeys(n),function(t,e){return"".concat(_.escape(r(t)),": <b>").concat(_.escape(n[e]),"</b>")}),_.map(a.getNonStandardKeys(n),function(t){return"".concat(_.escape(e(t)),": <b>").concat(_.escape(JSON.stringify(n[t])),"</b>")})]).join("<br />"))}(e).then(function(t){return{id:e.id,date:e.time,tooltip:t}})}function n(){for(var t="#",e=0;e<3;e++)t+="0".concat((256*Math.random()|0).toString(16)).substr(-2);return t}}t.$inject=["$q","$filter","c8yBase","c8yAlarms","c8yEvents","gettext"],angular.module("c8y.alarmsEventsExplorer").factory("c8yAlarmsEventsTimelinesChartService",t)}();