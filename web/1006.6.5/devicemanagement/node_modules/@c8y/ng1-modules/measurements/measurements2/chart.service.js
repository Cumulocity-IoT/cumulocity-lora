"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var i=[],n=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(i.push(s.value),!t||i.length!==t);n=!0);}catch(e){r=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(r)throw o}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(u,c,e,l,t,i,n,r,h,o){var d,m=r,v=t,s=i,f=n,a=[{val:"min",text:o("Minimum")},{val:"max",text:o("Maximum")},{val:"area",text:o("Minimum and maximum")}],p=[{val:"line",text:o("Line")},{val:"points",text:o("Points")},{val:"linePoints",text:o("Line and points")},{val:"bars",text:o("Bars")},{val:"step-before",text:o("Step before")},{val:"step-after",text:o("Step after")}],g=[{val:void 0,text:o("Auto")},{val:"left",text:o("Left")},{val:"right",text:o("Right")}];function x(e,t){var i,n=this,r=$(e),o=r.find(".chart-container").length,s=function(e){var t=n.axisX.getDebouncePreference();i&&!e||(i=setTimeout(function(){i=void 0,n._render()},t.debounceTime)),(t.reset||e)&&(clearTimeout(i),i=void 0,n._render())},a=function e(){return e.result||(e.result=n._dimensions()),e.timerId||(e.timerId=setTimeout(function(){delete e.result,delete e.timerId},700)),e.result};n._hasContainer=o,n.el=o?r.find(".chart-container"):r,n.parentEl=n.el.parent(),n.items=[],n.dimensions=a,n.render=function(e){return s(e)},d&&(n.dimensions=function(){return d.runOutsideAngular(a)},n.render=function(e){return d.runOutsideAngular(function(){return s(e)})}),n.init(t)}return d3.selection.prototype.dblTap=function(i){var n=0;return this.each(function(){d3.select(this).on("touchstart",function(e){var t=function(){};return d3.event.timeStamp-n<500?(d3.event.preventDefault(),d3.event.stopPropagation(),t=i):n=d3.event.timeStamp,t(e)})})},e.has("ngZone")&&(d=e.get("ngZone")),x.prototype={sizes:{yAxisWidth:50},margins:{t:20,r:10,b:20,l:10},init:function(e){var t=this,i=t.parentEl,n=t.el,r=t._hasContainer?"25px":0,o=t._hasContainer?{position:"absolute",top:0,right:0,bottom:0,left:0}:{position:"relative"},s=n.parents(".panel-body"),a=n.parents(".grid-stack-item-content").length;if(s.length&&!a&&s.height("320px"),i.css(o),t._hasContainer){var c=i.parent().css("position");"absolute"!==c&&"fixed"!==c&&i.parent().css({position:"relative"})}n.addClass("c8y-chart"),n.css({display:"block",position:"absolute",top:e.showTime?"55px":r,right:0,bottom:"5px",left:0}),t._id=String(Math.random()).substr(2),t.svg=t.createSvg(),t.hoverBox(),t.svgSeries=t.createSeriesContainer(),t.axisX=new f(t),t.series=[],t.allowSelectPoint=e.allowSelectPoint,t.hoverInfo=new m(t),t.hoverItems=t.renderVerticalLine().concat([t.hoverInfo.el]),t.addEvents()},destroy:function(){this.hoverInfo.destroy()},renderVerticalLine:function(){var r=this,e=r.overline,t=r.selectLine,i=r.box().height-r.margins.t-r.margins.b,n=function(e,t,i,n){return r.svg.append("g").attr("transform",h.translate(r.margins.l,r.margins.t)).append("line").style({visibility:"hidden",stroke:e,"stroke-dasharray":t,opacity:n,"pointer-events":"none"}).attr({class:i})};e||(r.overline=n("#999999","3,3","overline",.5),e=r.overline),t||(r.selectLine=n("#333333",void 0,"selectline",0),t=r.selectLine);var o=[e,t];return _.forEach(o,function(e){e.attr({y1:0,y2:i})}),o},createSeriesContainer:function(){var e=this,t=e.svg,i=e.margins,n=e.box(),r=n.height-i.b-i.t;return e._clipPath=t.append("defs").append("svg:clipPath").attr({id:"clipmask".concat(e._id)}).append("svg:rect").attr({id:"clip-rect".concat(e._id),x:i.l,y:i.t,width:n.axisXwidth,height:0<r?r:0}),t.append("g").style({"z-index":10}).attr({class:"seriesContainer","clip-path":"url(#clipmask".concat(e._id,")")})},hoverBox:function(){var e=this,t=e.box(),i=e._hoverBox,n=t.height-e.margins.b-e.margins.t;return i||(e._hoverBox=e.svg.append("rect").style({fill:"transparent",opacity:.3,"z-index":void 0,"pointer-events":"all"}),i=e._hoverBox),i.attr({width:t.axisXwidth,height:0<n?n:0,transform:h.translate(t.leftSpace,e.margins.t)}),i},selectionBox:function(e){var t=this,i=t.box(),n=t._selBox,r=i.height-t.margins.b-t.margins.t,o=t._mouseSelectStart;if(r=0<r?r:0,n||(t._selBox=t.svg.append("rect").attr({"pointer-events":"none",fill:"rgba(200,200,200, 0.5)"}),n=t._selBox),o&&e){var s=_slicedToArray(o,1)[0],a=e[0]-i.leftSpace,c=s<a?s:a,l=a<s?s:a;n.attr({transform:h.translate(i.leftSpace+c,t.margins.t),height:r,width:l-c}).style({visibility:"visible"})}else n.style({visibility:"hidden"})},realtimeMeasurement:function(i){var n=!1;return _.forEach(this.series,function(e){var t=e.realtimeMeasurement(i);n=n||t}),n},getHoverItems:function(){var t=_.clone(this.hoverItems);return _.forEach(this.series,function(e){t=_.union(t,e.hoverItems)}),t},showHoverItems:function(e){var t=this.getHoverItems();this.hoverItemsVisible=!0,t="nolines"===e?_.without(t,this.overline):_.without(t,this.selectLine),_.forEach(t,function(e){e.style&&e.style("visibility","visible"),e.show&&e.show()})},showHoverItemsExceptLine:function(){this.showHoverItems("nolines")},hideHoverItems:function(){this.hoverItemsVisible=!1,_.forEach(this.getHoverItems(),function(e){e.style&&e.style("visibility","hidden"),e.hide&&e.hide()})},addEvents:function(){var t=this,i=this.hoverBox();i.on("mouseenter",function(){t.mouseIn=!0,t.showHoverItems()}),i.on("mouseleave",function(){var e=d3.event.relatedTarget;e&&"circle"===e.tagName||(t.hideHoverItems(),t.resetSelectLine(),_.invokeMap(t.series,"mouseleave"),t.mouseIn=!1)});var e=d3.behavior.drag();function n(){var e=d3.mouse(i.node());t.zoomOut(e[0])}e.call(i),e.on("dragstart",function(){t._mouseSelectStart=d3.mouse(i.node())}),e.on("dragend",function(){var e=d3.mouse(i.node());t._mouseSelectStart&&e[0]!==t._mouseSelectStart[0]&&t.makeSelection(t._mouseSelectStart,e),t.selectionBox()}),e.on("drag",_.bind(t.onDragSelection,t)),i.on("mousemove",_.bind(t.onMove,t)),i.on("dblclick",n),i.dblTap(n),window.addEventListener("resize",function(){t.render(!0)})},zoomOut:function(e){var t=this.box(),i=this.margins,n=this.axisX,r=n.scale(),o=n._from,s=n._to,a=moment(r.invert(e+t.leftSpace-i.l)),c=Math.round(2*a.diff(o)),l=Math.round(2*moment(s).diff(a)),h=moment(new Date(Math.max(Date.now(),s)));h=moment.min(h,a.clone().add(l,"ms")),n.updateDates(a.clone().subtract(c,"ms"),h,!0),u.$apply()},moveToCenter:function(e){var t=this.axisX,i=t._from,n=t._to,r=moment(n).diff(i)/2,o=moment(e).subtract(r),s=moment(e).add(r);t.updateDates(o,s),this.render()},makeSelection:function(e,t){var i=this.axisX,n=this.box(),r=i.scale(),o=this.margins,s=moment(r.invert(e[0]+n.leftSpace-o.l)),a=moment(r.invert(t[0]+n.leftSpace-o.l)),c=s.isBefore(a)?s:a,l=c===s?a:s;i.updateDates(c,l,!0),u.$apply()},onDragSelection:function(){this._mouseSelectStart&&this.selectionBox([d3.event.x,d3.event.y])},onMove:function(e){var t,i=this,n=i.box(),r=i.hoverBox().node(),o=i.margins;try{t=d3.mouse(r),i.axisX._xDragStart&&i.axisX.updateScaleOnDrag(d3.mouse(r)[0])}catch(e){t=i.__cachedMouse||[0,0]}finally{i.__cachedMouse=t}var s=n.leftSpace+t[0]-o.l;i.overline.attr({transform:h.translate(1+s,0)}),i.currentHoverTime=i.axisX.scale().invert(s);var a=i.currentHoverTime;if(i._selectTime&&"moveToNow"===e)i.resetSelectLine();else{_.forEach(i.series,function(e){e.onMove(a,s)});var c=_slicedToArray(t,2)[1];_.forEach(i.items,function(e){e.onMove&&e.onMove(a,s,c)})}},setSelectTimeWithMouse:function(e){var t=this.axisX.scale().invert(e);return this.setSelectLine(t),t},setSelectPoint:function(e){var t=this;(t.selectedPoint=e).date?(t.setSelectLine(moment(e.date).toDate()),t.onSelectPoint&&t.onSelectPoint(t.selectedPoint)):t.clearSelectPoint()},clearSelectPoint:function(){var e=this;e.onSelectPoint&&e.selectedPoint&&e.selectedPoint.date&&(delete e.selectedPoint,e.onSelectPoint({})),e.clearSelectLine()},setSelectLine:function(t,e){var i=this,n=i.box(),r=i.axisX.scale(),o=i.selectLine,s=r(t),a=!(!i._selectTime||!moment(i._selectTime).isSame(t)),c=s<n.rangeMin||s>n.rangeMax;i._selectTime=t,c?a?i.hideSelectLine():i.moveToCenter(t):(o.attr({transform:h.translate(s,0)}),o.style("visibility","visible"),o.style("opacity",.5),!0!==e&&(i.showHoverItemsExceptLine(),setTimeout(function(){_.forEach(i.series,function(e){e.onMove(t,s)}),_.forEach(i.items,function(e){e.onMove&&e.onMove(t,s)})})))},clearSelectLine:function(){this.hideSelectLine(),delete this._selectTime},hideSelectLine:function(){var e=this.selectLine;"hidden"!==e.style("visibility")&&(e.style("visibility","hidden"),this.hideHoverItems())},resetSelectLine:function(){return!!this._selectTime&&(this.setSelectLine(this._selectTime),!0)},createSvg:function(){return d3.select(this.el[0]).append("svg").style({position:"absolute",top:0,right:0,bottom:0,left:0})},_dimensions:function(){return{h:this.el.height(),w:this.el.width()}},box:function(){var e=this,t=e.dimensions(),i=t.h,n=t.w,r=e.getAxisYByOrientation("left"),o=e.getAxisYByOrientation("right"),s=r.length*e.sizes.yAxisWidth||0,a=o.length*e.sizes.yAxisWidth||0,c=e.margins.r+a||0,l=e.margins.l+s||0,h=n-(l+c);return h<0&&(h=0),e.chartBox={height:0<i?i:0,width:0<n?n:0,axisXwidth:h,leftSpace:l,rightSpace:c,rangeMin:s,rangeMax:n-e.margins.l-c},e.chartBox},_render:function(){var e=this;e.updateYaxis();var t=e.box(),i=e.margins;e.renderVerticalLine(),e.selectionBox(),e.hoverBox(),e.axisX.render(),_.invokeMap(e.items,"render"),_.invokeMap(e.series,"render");var n=t.height-i.b-i.t;e._clipPath.attr({x:t.leftSpace,width:t.axisXwidth,height:0<n?n:0}),e.resetSelectLine()||e.onMove()},addItem:function(e){_.isObjectLike(e)&&-1===this.items.indexOf(e)&&this.items.push(e)},removeItem:function(e){this.items=_.without(this.items,e)},updateSeries:function(t,n){var r=this,o=r.axisX._to,s=r.axisX._from,a=r._aggregation,e=_.remove(r.series,function(e){return-1===t.indexOf(e.dataPoint)});_.invokeMap(e,"destroy");var i=_.map(t,function(t){var e;if(!_.find(r.series,function(e){return e.dataPoint===t})){var i=new v(r,t);r.series.push(i),n&&s&&o&&(e=i.loadDataAndRender(s,o,a))}return e}).filter(_.identity);return(i.length?c.all(i):l()).finally(function(){r.render()})},loadData:function(t,i,n){var r=this;return r._aggregation=n,r.loading=!0,c.all(_.map(r.series,function(e){return e.loadData(t,i,n)})).then(function(e){r.truncated=_.some(e,{truncated:!0})}).finally(function(){r.loading=!1,r.render(!0)})},scaleY:function(){var e=this.box().height-this.margins.t-this.margins.b,t=this.margins.t;return d3.scale.linear().range([e,t]).nice()},getAxisY:function(){return _.filter(this.items,function(e){return e instanceof i})},getAxisYByOrientation:function(t){return _.filter(this.items,function(e){return e instanceof i&&e.orientation()===t})},updateYaxis:function(){var i=this,e=i.series,n=[],r=i.getAxisY();_.forEach(r,function(e){e.series.length=0}),_.forEach(e,function(t){var e=_.find(n,function(e){return _.find(e.series,function(e){return function(e,t){var i=e.dataPoint,n=t.dataPoint,r=e.scale().domain(),o=t.scale().domain();return i.yAxisType===n.yAxisType&&r[0]===o[0]&&r[1]===o[1]}(t,e)})});e||(e=r.length?r.shift():new s(i),n.push(e)),e.addSerie(t)}),_.invokeMap(r,"remove")},showDateSelection:function(){this.el.css({top:"55px"})},hideDateSelection:function(){this.el.css({top:"25px"})}},{Chart:x,renderTypes:a,lineTypes:p,axisTypes:g}}e.$inject=["$rootScope","$q","$injector","$timeout","c8ySeries","c8yAxisY","c8yAxisX","c8yHoverInfo","c8yChartCommon","gettext"],angular.module("c8y.core.measurements2").factory("c8yChart",e)}();