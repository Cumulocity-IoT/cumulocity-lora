"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],i=!0,r=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(i,o,c){function r(e,t,n,i,r){var a=r,s="NONE"!==i?i:void 0;return o.listForDataPoint(e,t,n,s,a)}function e(e,t){var n=this;return n.chart=e,n.dataPoint=t,n.hoverItems=[],n.values=[],n.implicitDomain={},n.bisect=d3.bisector(function(e){return e.time}).right,n.loadSeriesData=i.latest(r),n}return e.prototype={defaultRenderType:"min",defaultLineType:"line",loadDataAndRender:function(e,t,n){var i=this;i.loadData(e,t,n).finally(function(){i.chart.render()})},loadData:function(e,t,n){var i=this,r=i.dataPoint,a=i._aggregation;return this.loadSeriesData(r,e,t,n,i.chart).then(function(e){return a!==n&&(i.values.length=0,i._aggregation=n,i.resetImplicitDomain()),i.appendValues(e.values),e})},appendValues:function(e){var a=this,s=a.values,o=a.implicitDomain;return _.forEach(e,function(e){if(_.isFinite(e.min)&&_.isFinite(e.max)){var t=new Date(e.time),n=t.getTime(),i=_.find(s,function(e){return n===e.time.getTime()}),r={time:t,val:{min:e.min,max:e.max}};s.length&&_.last(s).time.getTime()>n&&(a._valuesSortingNeeded=!0),i?_.assign(i,r):s.push(r),(_.isUndefined(o.min)||e.min<o.min)&&(o.min=e.min),(_.isUndefined(o.max)||e.max>o.max)&&(o.max=e.max)}}),s},destroy:function(){this.svg&&this.svg.remove(),this.hoverItems=[],delete this.svg},resetImplicitDomain:function(){this.implicitDomain.min=void 0,this.implicitDomain.max=void 0},domain:function(){var e=this.dataPoint,t=this.implicitDomain,n=_.isUndefined(e.min)||""===e.min?t.min:Number(e.min),i=_.isUndefined(e.max)||""===e.max?t.max:Number(e.max);return(_.isUndefined(n)||Number.isNaN(n))&&(n=d3.min(this.values,function(e){return e.val.min}),_.isUndefined(n)||(t.min=n),n=n||0),(_.isUndefined(i)||Number.isNaN(i))&&(i=d3.max(this.values,function(e){return e.val.max}),_.isUndefined(i)||(t.max=i),i=i||0),n===i&&(n-=1,i+=1),[n,i]},scale:function(){return this.chart.scaleY().domain(this.domain())},getRenderType:function(){return this.dataPoint.renderType||this.renderType||this.defaultRenderType},getLineType:function(){return this.dataPoint.lineType||this.lineType||this.defaultLineType},render:function(){var e=this,t=e.chart.svgSeries,n=e.getRenderType(),i=e.getLineType(),r=e.values,a=e.svg;if(!a||a.minOrMax===n&&a.chartType===n||e.destroy(),!e.svg){var s=e.chart.margins;e.svg=t.append("g").attr("transform",c.translate(s.l,s.t)).attr("class","series"),(a=e.svg).minOrMax=n,a.chartType=i}e._valuesSortingNeeded&&(delete e._valuesSortingNeeded,r.sort(function(e,t){return e.time>t.time?1:e.time<t.time?-1:0})),e.chart.allowSelectFocusTime||e.removeOldHiddenValues(),"bars"===i?e._render_bars():"area"!==n?e._render_path(n):e._render_area()},removeOldHiddenValues:function(){var e=this.values,n=this.chart.axisX._from,i=0;_.forEach(e,function(e,t){return!moment(e.time).isSameOrAfter(n)||(i=t-1,!1)}),i&&e.splice(0,i)},_render_path:function(t){var n=this,e=n.svg._path;function i(e){return n.chart.axisX.scale()(e.time)}function r(e){return n.scale()(e.val[t])}function a(){return n.dataPoint.color}e||(n.svg._path=n.svg.append("path"),(e=n.svg._path).style({"pointer-events":"none"})),n._create_update_focusPoint(1),n._render_path_line(e,i,r,a),n._render_path_points(i,r,a)},_render_path_line:function(e,t,n,i){var r=this,a=r.getLineType()||"linear",s=d3.svg.line().interpolate(a).x(t).y(n);_.includes(["bars","points"],r.getLineType())?(e.remove(),r.svg._path=void 0):e.attr("d",function(){return s(r.values)}).style({fill:"transparent",stroke:i})},_render_path_points:function(e,t,n){if(_.includes(["points","linePoints"],this.getLineType())){var i=this.svg.selectAll("circle.point").data(this.values);i.enter().append("circle").attr("class","point"),i.exit().remove(),i.attr("cx",e).attr("cy",t).attr("r",4).attr("fill","transparent").attr("stroke",n)}else this.svg.selectAll("circle.point").remove()},_render_bars:function(){var r=this,e=_.filter(r.chart.series,function(e){return e.getLineType()===r.getLineType()}),i=e.length,a=_.findIndex(e,function(e){return e===r}),s=r.svg.minOrMax,t=function(){var n=r.chart.axisX.scale();if(r._aggregation)return function(e){var t=n(e.time)-i*c()/2;return t+a*c()};return function(e){return n(e.time)}}(),n=l(),o=m(n),c=function(){var e=1;if(r._aggregation){var t=function(e){var t=r.chart.axisX.scale(),n=_slicedToArray(t.domain(),1)[0],i=moment(n).add(1,{MINUTELY:"minute",HOURLY:"hour",DAILY:"day"}[e]).toDate();return t(i)-t(n)}(r._aggregation);20<(e=t/(i+1))&&(e=20),e<1&&(e=1)}return _.constant(e)}();function l(e){var t=r.scale(),n=e;return n||(n="area"===s?"max":s),function(e){return t(e.val[n])}}function u(n){var i=_.max(r.scale().range());return function(e){var t=n(e);return i<t?i:t}}function m(t){var n=r.scale().range();return function(e){return Math.abs(_.max(n)-t(e))}}var d={x:t,y:u(n),width:c,height:o,fill:function(){return r.dataPoint.color}},v=r.svg.selectAll(".bars").data(r.values),p=v.enter().append("g").style("pointer-events","none").attr("class",function(e,t){return"bar index".concat(t)});if(p.append("rect").attr("class","barmain"),v.exit().remove(),v.select(".barmain").attr(d),"area"===s&&r._aggregation){p.append("rect").attr("class","barmin").style("opacity","0.2");var f=l("min"),h=_.defaults({fill:"#000",y:u(f),height:m(f)},d);v.select(".barmin").attr(h)}r._aggregation||r._create_update_focusPoint(1)},hover:function(e){var t=this,n=t.getRenderType(),i=t.getLineType(),r=t.values[e];(t.overPoint=r)&&(t._focusPointTime=r.time,"bars"===i&&this._hover_bars(e)),t._render_focusPoint(1,"area"!==n?n:"max"),t._render_focusPoint(2,"area"!==n?n:"min")},_hover_bars:function(e){this.svg.select(".hover").classed("hover",!1).style({opacity:1}),this.svg.select(".index".concat(e," .barmain")).classed("hover",!0).style({opacity:.5})},mouseleave:function(){"bars"===this.getLineType()&&this.svg.select(".hover").classed("hover",!1).style({opacity:1})},_create_update_focusPoint:function(e){var t=this,n="focusPoint".concat(e),i=t.svg[n];i||(t.svg[n]=t.svg.append("circle").style({visibility:t.chart.hoverItemsVisible?"visible":"hidden","pointer-events":"all"}).attr({cx:0,cy:0,r:3}),i=t.svg[n],t.addFocusPointEvent(i),t.hoverItems.push(i)),i.attr({fill:function(){return t.dataPoint.color}})},_render_focusPoint:function(e,t){var n=this.chart.axisX.scale(),i=this.scale(),r=this.svg,a=this.overPoint,s=r&&r["focusPoint".concat(e)];if(s)if(a){var o=r.xFocusScale?r.xFocusScale(a):n(a.time),c=i(a.val[t]);s.attr({cx:o,cy:c})}else s.style("visibility","hidden")},_render_area:function(){var t=this,e=t.getLineType()||"linear";function n(e){return t.chart.axisX.scale()(e.time)}function i(e){return t.scale()(e.val.max)}function r(e){return t.scale()(e.val.min)}function a(){return t.dataPoint.color}var s=d3.svg.area().interpolate(e).x(n).y0(i).y1(r),o=t.svg._path;o||(t.svg._path=t.svg.append("path").style({"pointer-events":"none",opacity:.8})),o=t.svg._path,t._create_update_focusPoint(1),t._create_update_focusPoint(2),o.attr("d",function(){return s(t.values)}).style({"pointer-events":"none",stroke:a,fill:a}),_.includes(["points","linePoints"],t.getLineType())?(t.svg.selectAll("circle.point.max").data(t.values).enter().append("circle").attr("class","point max"),t.svg.selectAll("circle.point.min").data(t.values).enter().append("circle").attr("class","point min"),t.svg.selectAll("circle.point.max").attr("cx",n).attr("cy",i).attr("r",4).attr("fill","transparent").attr("stroke",a),t.svg.selectAll("circle.point.min").attr("cx",n).attr("cy",r).attr("r",4).attr("fill","transparent").attr("stroke",a)):t.svg.selectAll("circle.point").remove()},onMove:function(e,t){var n=this.getNearIndex(e);this.hover(n,e,t)},hoverValue:function(){var e=this.getRenderType(),t=this.overPoint,n=this.dataPoint.unit||"",i=" -- ";if(t){var r=t.val,a=r.min,s=r.max;"min"===e&&(i="".concat(a," ").concat(n)),"max"===e&&(i="".concat(s," ").concat(n)),"area"===e&&(i="".concat(a," - ").concat(s," ").concat(n))}return i},hoverTime:function(){var e=this.overPoint;return e?moment(e.time):"--"},getNearIndex:function(e){var t=e,n=this.values,i=n.length-1,r=this.bisect(n,e,1,i),a=n[r-1]&&n[r-1].time,s=n[r]&&n[r].time;return _.isUndefined(a)?r:_.isUndefined(s)?r-1:t-a<s-t?r-1:r},measurementFits:function(e){return o.rtMeasurementForDatapoint(this.dataPoint)(e)},addFocusPointEvent:function(e){var n=this,i=n.chart;e.on("click",function(){if(i.allowSelectFocusTime){var e={target:(n.dataPoint.__target||{}).id,date:moment(n._focusPointTime).format("YYYY-MM-DDTHH:mm:ss.SSSZ")},t=i.selectedPoint;t&&moment(e.date).isSame(moment(t.date))?i.clearSelectPoint():i.setSelectPoint(e)}}),e.on("mouseenter",function(){i.allowSelectFocusTime&&e.style({cursor:"pointer"}).attr({r:6})}),e.on("mouseleave",function(){i.allowSelectFocusTime&&e.style({cursor:"default"}).attr({r:3})})},realtimeMeasurement:function(e){var t=this,n=t.measurementFits(e);return n&&(t.__realtimeToAppend||(t.__realtimeToAppend=[]),t.__realtimeToAppend.push(n.values)),t.__realtimeToAppendTimout||(t.__realtimeToAppendTimout=setTimeout(function(){t.appendValues(_.flattenDeep(t.__realtimeToAppend)),t.__realtimeToAppend=[],t.__realtimeToAppendTimout=void 0,t.chart.render()},250)),n}},e}e.$inject=["c8yBase","c8yMeasurements","c8yChartCommon"],angular.module("c8y.core.measurements2").factory("c8ySeries",e)}();