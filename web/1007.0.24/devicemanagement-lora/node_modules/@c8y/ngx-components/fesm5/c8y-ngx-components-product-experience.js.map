{"version":3,"file":"c8y-ngx-components-product-experience.js","sources":["ng://@c8y/ngx-components/product-experience/gainsight.service.ts","ng://@c8y/ngx-components/product-experience/product-experience.module.ts","ng://@c8y/ngx-components/product-experience/c8y-ngx-components-product-experience.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { combineLatest, fromEvent, BehaviorSubject } from 'rxjs';\nimport { filter, delay, map, take } from 'rxjs/operators';\nimport { AppStateService, OptionsService } from '@c8y/ngx-components';\n\n/**\n * A service to manage the Gainsight integration. It allows to load the\n * tag and\n */\n@Injectable({\n  providedIn: 'root'\n})\nexport class GainsightService {\n  /**\n   * A subject that emits the tag function as soon as a new tag is set.\n   */\n  tagFunction$ = new BehaviorSubject(null);\n\n  private readonly GAINSIGHT_URL = 'web-sdk.aptrinsic.com/api/aptrinsic.js?a=';\n  private readonly GAINSIGHT_GLOBAL_SCOPE = 'aptrinsic';\n  private readonly SCRIPT_EXECUTION_WAIT_TIME = 500;\n  private readonly OPTIONS_KEY_CATEGORY = 'gainsight';\n  private readonly OPTIONS_KEY_NAME = 'api.key';\n\n  constructor(private appState: AppStateService, private options: OptionsService) {}\n\n  /**\n   * Returns the tag global function which can be used to identify user\n   * or add special events.\n   */\n  get tagFunction() {\n    return (window as any)[this.GAINSIGHT_GLOBAL_SCOPE];\n  }\n\n  /**\n   * Load the script tag and calls the identify function to start the tracking.\n   * @param accountId The account where the user is registered. Could be the name of the tenant.\n   * @param identify If set to false, only the tag is loaded.\n   */\n  async loadTag(accountId, identify = true) {\n    const scriptTag = document.createElement('script');\n    const key =\n      this.options.gainsightKey ||\n      (await this.options.getSystemOption(this.OPTIONS_KEY_CATEGORY, this.OPTIONS_KEY_NAME));\n\n    if (key) {\n      this.loadScriptTag(scriptTag, key);\n      combineLatest(\n        this.appState.currentUser,\n        fromEvent(scriptTag, 'load'),\n        this.appState.state$.pipe(\n          filter(({ versions }) => versions.backend),\n          map(({ versions }) => versions),\n          take(1)\n        )\n      )\n        .pipe(\n          delay(this.SCRIPT_EXECUTION_WAIT_TIME),\n          filter(([user, scriptEvent]) => !!(scriptEvent && user))\n        )\n        .subscribe(([user, scriptEvent, versions]) => {\n          const instanceId = this.getInstanceIdFromUrl();\n          if (identify) {\n            this.identify(user.id, accountId, instanceId, versions.ui.ngx, versions.backend);\n          }\n          this.tagFunction$.next(this.tagFunction);\n        });\n    }\n  }\n\n  /**\n   * Identifies the user/account at Gainsight.\n   * @param userId The user id which is given to Gainsight.\n   * @param accountId The account id which is given to Gainsight (e.g. the tenant name)\n   * @param versionUI The UI version used.\n   * @param versionBE The BE version used.\n   */\n  identify(userId, accountId, instanceId, versionUI?, versionBE?) {\n    const windowRef = window as any;\n    windowRef[this.GAINSIGHT_GLOBAL_SCOPE](\n      'identify',\n      {\n        id: `${userId}_${accountId}_${instanceId}`,\n        versionUI,\n        versionBE,\n        instanceId\n      },\n      {\n        id: `${accountId}_${instanceId}`,\n        instanceId\n      }\n    );\n  }\n\n  private loadScriptTag(scriptTag: HTMLScriptElement, key: string) {\n    try {\n      const windowRef = window as any;\n      const firstTag = document.getElementsByTagName('script')[0];\n      const protocol = location.protocol;\n      const gainsightGlobalScope = this.GAINSIGHT_GLOBAL_SCOPE;\n      scriptTag.src = `${protocol}//${this.GAINSIGHT_URL}${key}`;\n      (windowRef[this.GAINSIGHT_GLOBAL_SCOPE] =\n        windowRef[this.GAINSIGHT_GLOBAL_SCOPE] ||\n        // tslint:disable-next-line:only-arrow-functions\n        function() {\n          (windowRef[gainsightGlobalScope].q = windowRef[gainsightGlobalScope].q || []).push(\n            arguments\n          );\n        }),\n        (windowRef[gainsightGlobalScope].p = key);\n      scriptTag.async = true;\n      firstTag.parentNode.insertBefore(scriptTag, firstTag);\n    } catch (ex) {\n      console.warn('Failed to load Gainsight PX', ex);\n    }\n  }\n\n  private getInstanceIdFromUrl() {\n    const hostName = location.hostname;\n    return hostName.substring(hostName.indexOf('.') + 1);\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { CoreModule, AppStateService } from '@c8y/ngx-components';\nimport { filter } from 'rxjs/operators';\nimport { ICurrentTenant } from '@c8y/client';\nimport { GainsightService } from './gainsight.service';\n\n/**\n * This module enables an tenant to activate the product experience\n * software [Gainsight](https://www.gainsight.com/product-experience/) to help\n * and track user actions. Gainsight is only activated, if the tenant custom\n * property `gainsightEnabled` is set to true.\n */\n@NgModule({\n  declarations: [],\n  imports: [CoreModule],\n  exports: [],\n  providers: [GainsightService]\n})\nexport class ProductExperienceModule {\n  constructor(appState: AppStateService, gainsightService: GainsightService) {\n    appState.currentTenant\n      .pipe(filter<ICurrentTenant>(Boolean))\n      .subscribe(({ customProperties, name }) => {\n        if (customProperties && customProperties.gainsightEnabled) {\n          gainsightService.loadTag(name);\n        }\n      });\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}