import * as tslib_1 from "tslib";
import { Component, HostBinding, Inject, Input, OnDestroy, OnInit, Renderer2 } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { AlertService, DashboardChildChange, DashboardChildComponent, DashboardSettings, DynamicComponentDefinition, gettext, Widget, WidgetChange } from '@c8y/ngx-components';
import { cloneDeep, findIndex, get, keyBy, omit, values } from 'lodash-es';
import { BsModalService } from 'ngx-bootstrap/modal';
import { CONTEXT_DASHBOARD_CONFIG, WIDGET_HEADER_CLASSES } from './context-dashboard.model';
import { ContextDashboardService } from './context-dashboard.service';
import { DashboardDetailComponent } from './dashboard-detail.component';
import { WidgetConfigComponent } from './widget-config.component';
import { WidgetService } from './widget.service';
import { kebabCase } from 'lodash-es';
/**
 * The context dashboard is a dashboard which resolves it data from the current context (device or group)
 * it is displayed on. It usually uses the route.data for it, but you can pass
 * a different managedObject to the [mo] input parameter to change that behavior.
 */
var ContextDashboardComponent = /** @class */ (function () {
    function ContextDashboardComponent(route, router, contextDashboardService, alert, renderer, moduleConfig, widgetService, bsModal) {
        this.route = route;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.alert = alert;
        this.renderer = renderer;
        this.moduleConfig = moduleConfig;
        this.widgetService = widgetService;
        this.bsModal = bsModal;
        this.childrenClasses = '';
        this.setTitle = false;
        this.disabled = false;
        this.defaultWidgets = [];
        this.canDelete = true;
        this.isLoading = true;
        this.class = '';
        this.widgets = [];
    }
    ContextDashboardComponent.prototype.ngOnInit = function () {
        if (!this.name) {
            this.loadContextDashboard();
            return;
        }
        this.loadNamedDashboard();
    };
    /**
     * Applies the current context to the widget
     * @param widget The widget to apply the context to.
     */
    ContextDashboardComponent.prototype.applyDeviceTarget = function (widget) {
        if (widget.config.device) {
            widget.config.device = { id: this.context.id, name: this.context.name };
        }
    };
    /**
     * Removes the route listener.
     */
    ContextDashboardComponent.prototype.ngOnDestroy = function () {
        if (this.dataSub) {
            this.dataSub.unsubscribe();
        }
    };
    /**
     * Restores the dashboard widgets to the default widgets.
     */
    ContextDashboardComponent.prototype.restore = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isLoading = true;
                        this.mo.c8y_Dashboard.children = this.contextDashboardService.mapWidgets(this.defaultWidgets);
                        return [4 /*yield*/, this.contextDashboardService.update(this.mo)];
                    case 1:
                        _a.sent();
                        this.onLoad();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Updates all dashboards children's. Useful for position changes on the dashboard.
     * @param child The child to change.
     */
    ContextDashboardComponent.prototype.updateDashboardChildren = function (child) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var children, dashboardMO, mappedChildren;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                children = child.children;
                dashboardMO = this.mo;
                mappedChildren = keyBy(children.map(function (c) { return _this.componentToWidget(c); }), 'id');
                dashboardMO.c8y_Dashboard.children = mappedChildren;
                return [2 /*return*/, this.contextDashboardService.update(dashboardMO)];
            });
        });
    };
    /**
     * Remove the complete dashboard and navigate away.
     */
    ContextDashboardComponent.prototype.deleteDashboard = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var route;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.contextDashboardService.delete(this.mo)];
                    case 1:
                        _a.sent();
                        if (this.route.parent) {
                            route = this.route.parent.snapshot.url.map(function (segment) { return segment.path; }).join('/');
                            this.router.navigateByUrl(route);
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Edits the current dashboard
     */
    ContextDashboardComponent.prototype.editDashboard = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var initialState, modal, dashboardMO, _a, ex_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        initialState = {
                            dashboard: this.dashboard,
                            deviceType: this.context.type,
                            isNamedDashboard: this.contextDashboardService.isNamed(this.mo)
                        };
                        modal = this.bsModal.show(DashboardDetailComponent, {
                            class: 'modal-lg',
                            initialState: initialState,
                            ignoreBackdropClick: true
                        }).content;
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 5, , 6]);
                        dashboardMO = cloneDeep(this.mo);
                        _a = dashboardMO;
                        return [4 /*yield*/, modal.result];
                    case 2:
                        _a.c8y_Dashboard = _b.sent();
                        return [4 /*yield*/, this.contextDashboardService.update(dashboardMO)];
                    case 3:
                        _b.sent();
                        return [4 /*yield*/, this.contextDashboardService.refreshTabs(dashboardMO)];
                    case 4:
                        _b.sent();
                        this.onLoad();
                        modal.close();
                        return [3 /*break*/, 6];
                    case 5:
                        ex_1 = _b.sent();
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Edits a widget on the dashboard.
     * @param change The widget change event.
     */
    ContextDashboardComponent.prototype.editWidget = function (change) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, x, y, width, height, component;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = change.source, x = _a.x, y = _a.y, width = _a.width, height = _a.height;
                        return [4 /*yield*/, this.widgetService.getWidgetDefinition(change.widget.name || change.widget.componentId)];
                    case 1:
                        component = _b.sent();
                        if (!component) {
                            this.addWidget();
                            return [2 /*return*/];
                        }
                        return [4 /*yield*/, this.addWidget(tslib_1.__assign({}, component, { data: tslib_1.__assign({}, component.data, change.widget, { _x: x, _y: y, _width: width, _height: height }) }))];
                    case 2:
                        _b.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Adds a widget to the dashboard.
     * @param selected Define a selected component to switch to edit mode directly.
     */
    ContextDashboardComponent.prototype.addWidget = function (selected) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var initialState, modal, newWidget, ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        initialState = {
                            mo: this.mo,
                            context: this.context,
                            selected: cloneDeep(selected)
                        };
                        modal = this.bsModal.show(WidgetConfigComponent, {
                            class: 'modal-lg',
                            initialState: initialState,
                            ignoreBackdropClick: true
                        }).content;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 4, , 5]);
                        return [4 /*yield*/, modal.result];
                    case 2:
                        newWidget = _a.sent();
                        if (!this.mo.c8y_Dashboard.children) {
                            this.mo.c8y_Dashboard.children = {};
                        }
                        this.mo.c8y_Dashboard.children[newWidget.id] = newWidget;
                        this.contextDashboardService.update(this.mo);
                        newWidget.classes = this.mergeWidgetClasses(newWidget);
                        return [4 /*yield*/, this.updateWidget(newWidget)];
                    case 3:
                        _a.sent();
                        modal.close();
                        return [3 /*break*/, 5];
                    case 4:
                        ex_2 = _a.sent();
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Updates a widget or adds a new one if it doesn't exist on
     * the dashboard.
     * @param widget The new widget
     */
    ContextDashboardComponent.prototype.updateWidget = function (widget) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var index, isNew, mappedWidget;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        index = findIndex(this.widgets, { id: widget.id });
                        isNew = index === -1;
                        return [4 /*yield*/, this.mapLegacy(widget)];
                    case 1:
                        mappedWidget = _a.sent();
                        if (isNew) {
                            this.widgets.push(mappedWidget);
                        }
                        else {
                            this.widgets.splice(index, 1, mappedWidget);
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Removes a widget and rearranges the remaining ones
     * if necessary.
     * @param change The change event.
     */
    ContextDashboardComponent.prototype.deleteWidget = function (change) {
        var _this = this;
        var widget = change.widget, source = change.source;
        delete this.mo.c8y_Dashboard.children[widget.id];
        var removed = this.widgets.find(function (_a) {
            var id = _a.id;
            return id === widget.id;
        });
        this.widgets.splice(this.widgets.indexOf(removed), 1);
        // using setTimeout to give the component the chance to remove it.
        setTimeout(function () {
            var child = new DashboardChildChange(source);
            child.collapseUpAll();
            _this.updateDashboardChildren(child);
        });
    };
    /**
     * This is a workaround to ensure that the dragged-element
     * (which is attached to the body) has the right styling.
     */
    ContextDashboardComponent.prototype.addDashboardClassToBody = function () {
        var _this = this;
        this.class.split(' ').forEach(function (cssClass) {
            _this.renderer.addClass(document.body, cssClass);
        });
    };
    /**
     * This is a workaround to ensure that the dragged-element
     * (which is attached to the body) has the right styling.
     */
    ContextDashboardComponent.prototype.removeDashboardClassFromBody = function () {
        var _this = this;
        this.class.split(' ').forEach(function (cssClass) {
            _this.renderer.removeClass(document.body, cssClass);
        });
    };
    /**
     * Changes the dashboard settings to frozen or vice versa.
     * @param settings The current settings of the dashboard.
     */
    ContextDashboardComponent.prototype.toggleFreeze = function (settings) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_3;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.toggleIsFrozenFlag(settings);
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.contextDashboardService.update(this.mo)];
                    case 2:
                        _a.sent();
                        if (this.dashboard.isFrozen) {
                            this.alert.success(gettext('Your dashboard is locked now.'));
                        }
                        else {
                            this.alert.success(gettext('Your dashboard is unlocked now.'));
                        }
                        return [3 /*break*/, 4];
                    case 3:
                        ex_3 = _a.sent();
                        this.alert.addServerFailure(ex_3);
                        this.toggleIsFrozenFlag(settings);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ContextDashboardComponent.prototype.toggleIsFrozenFlag = function (settings) {
        settings.isFrozen = !settings.isFrozen;
        this.dashboard.isFrozen = settings.isFrozen;
    };
    ContextDashboardComponent.prototype.loadContextDashboard = function () {
        var _this = this;
        this.dataSub = this.route.data.subscribe(function (_a) {
            var dashboard = _a.dashboard;
            _this.context = _this.route.parent.snapshot.data.contextData;
            _this.mo = dashboard;
            _this.dashboard = _this.mo.c8y_Dashboard;
            _this.onLoad();
        });
    };
    ContextDashboardComponent.prototype.loadNamedDashboard = function () {
        var _this = this;
        this.dataSub = this.contextDashboardService
            .getNamedDashboardOrCreate(this.name, this.defaultWidgets)
            .subscribe(function (mo) {
            _this.context = _this.context || {};
            _this.mo = mo;
            _this.dashboard = _this.mo.c8y_Dashboard;
            _this.onLoad();
        });
    };
    ContextDashboardComponent.prototype.onLoad = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dashboardChildren, isDeviceType, dashboardClasses, _a;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.disabled = !this.contextDashboardService.hasPermission();
                        dashboardChildren = cloneDeep(this.mo.c8y_Dashboard.children);
                        isDeviceType = this.contextDashboardService.isDeviceType(this.mo);
                        dashboardClasses = tslib_1.__assign({ 'c8y-grid-dashboard': true, dashboard: true }, this.dashboard.classes);
                        _a = this;
                        return [4 /*yield*/, Promise.all(values(dashboardChildren).map(function (widget) {
                                widget.classes = _this.mergeWidgetClasses(widget);
                                if (isDeviceType) {
                                    _this.applyDeviceTarget(widget);
                                }
                                return _this.mapLegacy(widget);
                            }))];
                    case 1:
                        _a.widgets = _b.sent();
                        this.class = Object.keys(dashboardClasses).join(' ');
                        this.disabled = !this.contextDashboardService.hasPermission();
                        this.isLoading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    ContextDashboardComponent.prototype.mergeWidgetClasses = function (widget) {
        var _a;
        var hasHeaderClass = WIDGET_HEADER_CLASSES.find(function (el) { return widget.classes && widget.classes[el.class]; });
        var widgetClasses = hasHeaderClass
            ? tslib_1.__assign({}, widget.classes) : tslib_1.__assign({}, this.dashboard.widgetClasses, widget.classes);
        return tslib_1.__assign((_a = { card: true, 'card-dashboard': true }, _a[kebabCase(widget.componentId || widget.name)] = true, _a), widgetClasses);
    };
    ContextDashboardComponent.prototype.componentToWidget = function (child) {
        return tslib_1.__assign({}, omit(child.data, ['componentTransformConfigWithContext', 'transformConfigWithContext']), {
            _x: child.x,
            _y: child.y,
            _width: child.width,
            _height: child.height
        });
    };
    ContextDashboardComponent.prototype.mapLegacy = function (widget) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var cmp;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.widgetService.getWidgetDefinition(widget.componentId || widget.name)];
                    case 1:
                        cmp = _a.sent();
                        if (get(cmp, 'data.settings.upgrade')) {
                            widget.widgetComponent = cmp.data.settings.widgetComponent;
                            widget.configComponent = cmp.data.settings.configComponent;
                            widget.templateUrl = cmp.data.settings.templateUrl;
                            widget.configTemplateUrl = cmp.data.settings.configTemplateUrl;
                            widget.transformConfigWithContext =
                                cmp.data.settings.componentTransformConfigWithContext ||
                                    cmp.data.settings.transformConfigWithContext;
                        }
                        else {
                            delete widget.templateUrl;
                            delete widget.configTemplateUrl;
                        }
                        return [2 /*return*/, widget];
                }
            });
        });
    };
    ContextDashboardComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: Router },
        { type: ContextDashboardService },
        { type: AlertService },
        { type: Renderer2 },
        { type: undefined, decorators: [{ type: Inject, args: [CONTEXT_DASHBOARD_CONFIG,] }] },
        { type: WidgetService },
        { type: BsModalService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "name", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "childrenClasses", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "context", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "setTitle", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "disabled", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "defaultWidgets", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "canDelete", void 0);
    tslib_1.__decorate([
        Input()
    ], ContextDashboardComponent.prototype, "isLoading", void 0);
    tslib_1.__decorate([
        HostBinding('class')
    ], ContextDashboardComponent.prototype, "class", void 0);
    ContextDashboardComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-context-dashboard',
            template: "<c8y-action-bar-item [placement]=\"'more'\" *ngIf=\"defaultWidgets.length > 0\">\n  <button (click)=\"restore()\" [disabled]=\"dashboard?.isFrozen || disabled\">\n    <i c8yIcon=\"undo\"></i>&nbsp;<span translate>Restore dashboard</span>\n  </button>\n</c8y-action-bar-item>\n\n<c8y-widgets-dashboard\n  [context]=\"context\"\n  [contextDashboard]=\"dashboard\"\n  [widgets]=\"widgets\"\n  [settings]=\"{\n    isLoading: isLoading,\n    isFrozen: dashboard?.isFrozen,\n    isDisabled: disabled,\n    canDelete: canDelete,\n    translateWidgetTitle: dashboard?.translateWidgetTitle,\n    allowFullscreen: moduleConfig.allowFullscreen,\n    title: setTitle ? dashboard.name : undefined,\n    widgetMargin: dashboard?.widgetMargin\n  }\"\n  (onFreeze)=\"toggleFreeze($event)\"\n  (onChangeDashboard)=\"updateDashboardChildren($event)\"\n  (onAddWidget)=\"addWidget()\"\n  (onEditWidget)=\"editWidget($event)\"\n  (onDeleteWidget)=\"deleteWidget($event)\"\n  (onChangeStart)=\"addDashboardClassToBody()\"\n  (onChangeEnd)=\"removeDashboardClassFromBody()\"\n  (onEditDashboard)=\"editDashboard()\"\n  (onDeleteDashboard)=\"deleteDashboard()\"\n>\n</c8y-widgets-dashboard>\n",
            host: {
                style: "\n      display: block;\n    ",
                class: 'dashboard c8y-grid-dashboard'
            }
        }),
        tslib_1.__param(5, Inject(CONTEXT_DASHBOARD_CONFIG))
    ], ContextDashboardComponent);
    return ContextDashboardComponent;
}());
export { ContextDashboardComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1kYXNoYm9hcmQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9jb250ZXh0LWRhc2hib2FyZC8iLCJzb3VyY2VzIjpbImNvbnRleHQtZGFzaGJvYXJkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pELE9BQU8sRUFDTCxZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLHVCQUF1QixFQUN2QixpQkFBaUIsRUFDakIsMEJBQTBCLEVBQzFCLE9BQU8sRUFDUCxNQUFNLEVBQ04sWUFBWSxFQUNiLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVyRCxPQUFPLEVBSUwsd0JBQXdCLEVBQ3hCLHFCQUFxQixFQUN0QixNQUFNLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXRDOzs7O0dBSUc7QUFXSDtJQTJCRSxtQ0FD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aW5kaW5nLCBJbmplY3QsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7XG4gIEFsZXJ0U2VydmljZSxcbiAgRGFzaGJvYXJkQ2hpbGRDaGFuZ2UsXG4gIERhc2hib2FyZENoaWxkQ29tcG9uZW50LFxuICBEYXNoYm9hcmRTZXR0aW5ncyxcbiAgRHluYW1pY0NvbXBvbmVudERlZmluaXRpb24sXG4gIGdldHRleHQsXG4gIFdpZGdldCxcbiAgV2lkZ2V0Q2hhbmdlXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgY2xvbmVEZWVwLCBmaW5kSW5kZXgsIGdldCwga2V5QnksIG9taXQsIHZhbHVlcyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBDb250ZXh0RGFzaGJvYXJkLFxuICBDb250ZXh0RGFzaGJvYXJkQ29uZmlnLFxuICBDb250ZXh0RGFzaGJvYXJkTWFuYWdlZE9iamVjdCxcbiAgQ09OVEVYVF9EQVNIQk9BUkRfQ09ORklHLFxuICBXSURHRVRfSEVBREVSX0NMQVNTRVNcbn0gZnJvbSAnLi9jb250ZXh0LWRhc2hib2FyZC5tb2RlbCc7XG5pbXBvcnQgeyBDb250ZXh0RGFzaGJvYXJkU2VydmljZSB9IGZyb20gJy4vY29udGV4dC1kYXNoYm9hcmQuc2VydmljZSc7XG5pbXBvcnQgeyBEYXNoYm9hcmREZXRhaWxDb21wb25lbnQgfSBmcm9tICcuL2Rhc2hib2FyZC1kZXRhaWwuY29tcG9uZW50JztcbmltcG9ydCB7IFdpZGdldENvbmZpZ0NvbXBvbmVudCB9IGZyb20gJy4vd2lkZ2V0LWNvbmZpZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgV2lkZ2V0U2VydmljZSB9IGZyb20gJy4vd2lkZ2V0LnNlcnZpY2UnO1xuaW1wb3J0IHsga2ViYWJDYXNlIH0gZnJvbSAnbG9kYXNoLWVzJztcblxuLyoqXG4gKiBUaGUgY29udGV4dCBkYXNoYm9hcmQgaXMgYSBkYXNoYm9hcmQgd2hpY2ggcmVzb2x2ZXMgaXQgZGF0YSBmcm9tIHRoZSBjdXJyZW50IGNvbnRleHQgKGRldmljZSBvciBncm91cClcbiAqIGl0IGlzIGRpc3BsYXllZCBvbi4gSXQgdXN1YWxseSB1c2VzIHRoZSByb3V0ZS5kYXRhIGZvciBpdCwgYnV0IHlvdSBjYW4gcGFzc1xuICogYSBkaWZmZXJlbnQgbWFuYWdlZE9iamVjdCB0byB0aGUgW21vXSBpbnB1dCBwYXJhbWV0ZXIgdG8gY2hhbmdlIHRoYXQgYmVoYXZpb3IuXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1jb250ZXh0LWRhc2hib2FyZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9jb250ZXh0LWRhc2hib2FyZC5jb21wb25lbnQuaHRtbCcsXG4gIGhvc3Q6IHtcbiAgICBzdHlsZTogYFxuICAgICAgZGlzcGxheTogYmxvY2s7XG4gICAgYCxcbiAgICBjbGFzczogJ2Rhc2hib2FyZCBjOHktZ3JpZC1kYXNoYm9hcmQnXG4gIH1cbn0pXG5leHBvcnQgY2xhc3MgQ29udGV4dERhc2hib2FyZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KClcbiAgbmFtZTogc3RyaW5nO1xuICBASW5wdXQoKVxuICBjaGlsZHJlbkNsYXNzZXMgPSAnJztcbiAgQElucHV0KClcbiAgY29udGV4dDogYW55O1xuICBASW5wdXQoKVxuICBzZXRUaXRsZTogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBkaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBkZWZhdWx0V2lkZ2V0czogV2lkZ2V0W10gPSBbXTtcbiAgQElucHV0KClcbiAgY2FuRGVsZXRlOiBib29sZWFuID0gdHJ1ZTtcbiAgQElucHV0KClcbiAgaXNMb2FkaW5nOiBib29sZWFuID0gdHJ1ZTtcblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzJylcbiAgY2xhc3MgPSAnJztcblxuICB3aWRnZXRzOiBXaWRnZXRbXSA9IFtdO1xuICBtbzogQ29udGV4dERhc2hib2FyZE1hbmFnZWRPYmplY3Q7XG4gIGRhc2hib2FyZDogQ29udGV4dERhc2hib2FyZDtcblxuICBwcml2YXRlIGRhdGFTdWI6IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgY29udGV4dERhc2hib2FyZFNlcnZpY2U6IENvbnRleHREYXNoYm9hcmRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgQEluamVjdChDT05URVhUX0RBU0hCT0FSRF9DT05GSUcpIHB1YmxpYyBtb2R1bGVDb25maWc6IENvbnRleHREYXNoYm9hcmRDb25maWcsXG4gICAgcHJpdmF0ZSB3aWRnZXRTZXJ2aWNlOiBXaWRnZXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbDogQnNNb2RhbFNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5uYW1lKSB7XG4gICAgICB0aGlzLmxvYWRDb250ZXh0RGFzaGJvYXJkKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubG9hZE5hbWVkRGFzaGJvYXJkKCk7XG4gIH1cblxuICAvKipcbiAgICogQXBwbGllcyB0aGUgY3VycmVudCBjb250ZXh0IHRvIHRoZSB3aWRnZXRcbiAgICogQHBhcmFtIHdpZGdldCBUaGUgd2lkZ2V0IHRvIGFwcGx5IHRoZSBjb250ZXh0IHRvLlxuICAgKi9cbiAgYXBwbHlEZXZpY2VUYXJnZXQod2lkZ2V0KSB7XG4gICAgaWYgKHdpZGdldC5jb25maWcuZGV2aWNlKSB7XG4gICAgICB3aWRnZXQuY29uZmlnLmRldmljZSA9IHsgaWQ6IHRoaXMuY29udGV4dC5pZCwgbmFtZTogdGhpcy5jb250ZXh0Lm5hbWUgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyB0aGUgcm91dGUgbGlzdGVuZXIuXG4gICAqL1xuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5kYXRhU3ViKSB7XG4gICAgICB0aGlzLmRhdGFTdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVzdG9yZXMgdGhlIGRhc2hib2FyZCB3aWRnZXRzIHRvIHRoZSBkZWZhdWx0IHdpZGdldHMuXG4gICAqL1xuICBhc3luYyByZXN0b3JlKCkge1xuICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLm1vLmM4eV9EYXNoYm9hcmQuY2hpbGRyZW4gPSB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLm1hcFdpZGdldHModGhpcy5kZWZhdWx0V2lkZ2V0cyk7XG4gICAgYXdhaXQgdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS51cGRhdGUodGhpcy5tbyk7XG4gICAgdGhpcy5vbkxvYWQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIGFsbCBkYXNoYm9hcmRzIGNoaWxkcmVuJ3MuIFVzZWZ1bCBmb3IgcG9zaXRpb24gY2hhbmdlcyBvbiB0aGUgZGFzaGJvYXJkLlxuICAgKiBAcGFyYW0gY2hpbGQgVGhlIGNoaWxkIHRvIGNoYW5nZS5cbiAgICovXG4gIGFzeW5jIHVwZGF0ZURhc2hib2FyZENoaWxkcmVuKGNoaWxkOiBEYXNoYm9hcmRDaGlsZENoYW5nZSkge1xuICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IGNoaWxkO1xuICAgIGNvbnN0IGRhc2hib2FyZE1POiBDb250ZXh0RGFzaGJvYXJkTWFuYWdlZE9iamVjdCA9IHRoaXMubW87XG4gICAgY29uc3QgbWFwcGVkQ2hpbGRyZW46IHsgW2lkOiBzdHJpbmddOiBXaWRnZXQgfSA9IGtleUJ5KFxuICAgICAgY2hpbGRyZW4ubWFwKGMgPT4gdGhpcy5jb21wb25lbnRUb1dpZGdldChjKSksXG4gICAgICAnaWQnXG4gICAgKTtcbiAgICBkYXNoYm9hcmRNTy5jOHlfRGFzaGJvYXJkLmNoaWxkcmVuID0gbWFwcGVkQ2hpbGRyZW47XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UudXBkYXRlKGRhc2hib2FyZE1PKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdGhlIGNvbXBsZXRlIGRhc2hib2FyZCBhbmQgbmF2aWdhdGUgYXdheS5cbiAgICovXG4gIGFzeW5jIGRlbGV0ZURhc2hib2FyZCgpIHtcbiAgICBhd2FpdCB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmRlbGV0ZSh0aGlzLm1vKTtcbiAgICBpZiAodGhpcy5yb3V0ZS5wYXJlbnQpIHtcbiAgICAgIGNvbnN0IHJvdXRlID0gdGhpcy5yb3V0ZS5wYXJlbnQuc25hcHNob3QudXJsLm1hcChzZWdtZW50ID0+IHNlZ21lbnQucGF0aCkuam9pbignLycpO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChyb3V0ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVkaXRzIHRoZSBjdXJyZW50IGRhc2hib2FyZFxuICAgKi9cbiAgYXN5bmMgZWRpdERhc2hib2FyZCgpIHtcbiAgICBjb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gICAgICBkYXNoYm9hcmQ6IHRoaXMuZGFzaGJvYXJkLFxuICAgICAgZGV2aWNlVHlwZTogdGhpcy5jb250ZXh0LnR5cGUsXG4gICAgICBpc05hbWVkRGFzaGJvYXJkOiB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmlzTmFtZWQodGhpcy5tbylcbiAgICB9O1xuICAgIGNvbnN0IG1vZGFsID0gdGhpcy5ic01vZGFsLnNob3coRGFzaGJvYXJkRGV0YWlsQ29tcG9uZW50LCB7XG4gICAgICBjbGFzczogJ21vZGFsLWxnJyxcbiAgICAgIGluaXRpYWxTdGF0ZSxcbiAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWVcbiAgICB9KS5jb250ZW50IGFzIERhc2hib2FyZERldGFpbENvbXBvbmVudDtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGFzaGJvYXJkTU8gPSBjbG9uZURlZXAodGhpcy5tbyk7XG4gICAgICBkYXNoYm9hcmRNTy5jOHlfRGFzaGJvYXJkID0gYXdhaXQgbW9kYWwucmVzdWx0O1xuICAgICAgYXdhaXQgdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS51cGRhdGUoZGFzaGJvYXJkTU8pO1xuICAgICAgYXdhaXQgdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS5yZWZyZXNoVGFicyhkYXNoYm9hcmRNTyk7XG4gICAgICB0aGlzLm9uTG9hZCgpO1xuICAgICAgbW9kYWwuY2xvc2UoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaW50ZW5kZWQgZW1wdHlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRWRpdHMgYSB3aWRnZXQgb24gdGhlIGRhc2hib2FyZC5cbiAgICogQHBhcmFtIGNoYW5nZSBUaGUgd2lkZ2V0IGNoYW5nZSBldmVudC5cbiAgICovXG4gIGFzeW5jIGVkaXRXaWRnZXQoY2hhbmdlOiBXaWRnZXRDaGFuZ2UpIHtcbiAgICBjb25zdCB7IHgsIHksIHdpZHRoLCBoZWlnaHQgfSA9IGNoYW5nZS5zb3VyY2U7XG4gICAgY29uc3QgY29tcG9uZW50ID0gYXdhaXQgdGhpcy53aWRnZXRTZXJ2aWNlLmdldFdpZGdldERlZmluaXRpb24oXG4gICAgICBjaGFuZ2Uud2lkZ2V0Lm5hbWUgfHwgY2hhbmdlLndpZGdldC5jb21wb25lbnRJZFxuICAgICk7XG4gICAgaWYgKCFjb21wb25lbnQpIHtcbiAgICAgIHRoaXMuYWRkV2lkZ2V0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuYWRkV2lkZ2V0KHtcbiAgICAgIC4uLmNvbXBvbmVudCxcbiAgICAgIGRhdGE6IHsgLi4uY29tcG9uZW50LmRhdGEsIC4uLmNoYW5nZS53aWRnZXQsIF94OiB4LCBfeTogeSwgX3dpZHRoOiB3aWR0aCwgX2hlaWdodDogaGVpZ2h0IH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgd2lkZ2V0IHRvIHRoZSBkYXNoYm9hcmQuXG4gICAqIEBwYXJhbSBzZWxlY3RlZCBEZWZpbmUgYSBzZWxlY3RlZCBjb21wb25lbnQgdG8gc3dpdGNoIHRvIGVkaXQgbW9kZSBkaXJlY3RseS5cbiAgICovXG4gIGFzeW5jIGFkZFdpZGdldChzZWxlY3RlZD86IER5bmFtaWNDb21wb25lbnREZWZpbml0aW9uKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgbW86IHRoaXMubW8sXG4gICAgICBjb250ZXh0OiB0aGlzLmNvbnRleHQsXG4gICAgICBzZWxlY3RlZDogY2xvbmVEZWVwKHNlbGVjdGVkKVxuICAgIH07XG5cbiAgICBjb25zdCBtb2RhbCA9IHRoaXMuYnNNb2RhbC5zaG93KFdpZGdldENvbmZpZ0NvbXBvbmVudCwge1xuICAgICAgY2xhc3M6ICdtb2RhbC1sZycsXG4gICAgICBpbml0aWFsU3RhdGUsXG4gICAgICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlXG4gICAgfSkuY29udGVudCBhcyBXaWRnZXRDb25maWdDb21wb25lbnQ7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgbmV3V2lkZ2V0ID0gYXdhaXQgbW9kYWwucmVzdWx0O1xuICAgICAgaWYgKCF0aGlzLm1vLmM4eV9EYXNoYm9hcmQuY2hpbGRyZW4pIHtcbiAgICAgICAgdGhpcy5tby5jOHlfRGFzaGJvYXJkLmNoaWxkcmVuID0ge307XG4gICAgICB9XG4gICAgICB0aGlzLm1vLmM4eV9EYXNoYm9hcmQuY2hpbGRyZW5bbmV3V2lkZ2V0LmlkXSA9IG5ld1dpZGdldDtcbiAgICAgIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UudXBkYXRlKHRoaXMubW8pO1xuICAgICAgbmV3V2lkZ2V0LmNsYXNzZXMgPSB0aGlzLm1lcmdlV2lkZ2V0Q2xhc3NlcyhuZXdXaWRnZXQpO1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVXaWRnZXQobmV3V2lkZ2V0KTtcbiAgICAgIG1vZGFsLmNsb3NlKCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgYSB3aWRnZXQgb3IgYWRkcyBhIG5ldyBvbmUgaWYgaXQgZG9lc24ndCBleGlzdCBvblxuICAgKiB0aGUgZGFzaGJvYXJkLlxuICAgKiBAcGFyYW0gd2lkZ2V0IFRoZSBuZXcgd2lkZ2V0XG4gICAqL1xuICBhc3luYyB1cGRhdGVXaWRnZXQod2lkZ2V0KSB7XG4gICAgY29uc3QgaW5kZXggPSBmaW5kSW5kZXgodGhpcy53aWRnZXRzLCB7IGlkOiB3aWRnZXQuaWQgfSk7XG4gICAgY29uc3QgaXNOZXcgPSBpbmRleCA9PT0gLTE7XG4gICAgY29uc3QgbWFwcGVkV2lkZ2V0ID0gYXdhaXQgdGhpcy5tYXBMZWdhY3kod2lkZ2V0KTtcbiAgICBpZiAoaXNOZXcpIHtcbiAgICAgIHRoaXMud2lkZ2V0cy5wdXNoKG1hcHBlZFdpZGdldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2lkZ2V0cy5zcGxpY2UoaW5kZXgsIDEsIG1hcHBlZFdpZGdldCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYSB3aWRnZXQgYW5kIHJlYXJyYW5nZXMgdGhlIHJlbWFpbmluZyBvbmVzXG4gICAqIGlmIG5lY2Vzc2FyeS5cbiAgICogQHBhcmFtIGNoYW5nZSBUaGUgY2hhbmdlIGV2ZW50LlxuICAgKi9cbiAgZGVsZXRlV2lkZ2V0KGNoYW5nZTogV2lkZ2V0Q2hhbmdlKSB7XG4gICAgY29uc3QgeyB3aWRnZXQsIHNvdXJjZSB9ID0gY2hhbmdlO1xuICAgIGRlbGV0ZSB0aGlzLm1vLmM4eV9EYXNoYm9hcmQuY2hpbGRyZW5bd2lkZ2V0LmlkXTtcbiAgICBjb25zdCByZW1vdmVkID0gdGhpcy53aWRnZXRzLmZpbmQoKHsgaWQgfSkgPT4gaWQgPT09IHdpZGdldC5pZCk7XG4gICAgdGhpcy53aWRnZXRzLnNwbGljZSh0aGlzLndpZGdldHMuaW5kZXhPZihyZW1vdmVkKSwgMSk7XG5cbiAgICAvLyB1c2luZyBzZXRUaW1lb3V0IHRvIGdpdmUgdGhlIGNvbXBvbmVudCB0aGUgY2hhbmNlIHRvIHJlbW92ZSBpdC5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGNvbnN0IGNoaWxkID0gbmV3IERhc2hib2FyZENoaWxkQ2hhbmdlKHNvdXJjZSk7XG4gICAgICBjaGlsZC5jb2xsYXBzZVVwQWxsKCk7XG4gICAgICB0aGlzLnVwZGF0ZURhc2hib2FyZENoaWxkcmVuKGNoaWxkKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGlzIGEgd29ya2Fyb3VuZCB0byBlbnN1cmUgdGhhdCB0aGUgZHJhZ2dlZC1lbGVtZW50XG4gICAqICh3aGljaCBpcyBhdHRhY2hlZCB0byB0aGUgYm9keSkgaGFzIHRoZSByaWdodCBzdHlsaW5nLlxuICAgKi9cbiAgYWRkRGFzaGJvYXJkQ2xhc3NUb0JvZHkoKSB7XG4gICAgdGhpcy5jbGFzcy5zcGxpdCgnICcpLmZvckVhY2goY3NzQ2xhc3MgPT4ge1xuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhkb2N1bWVudC5ib2R5LCBjc3NDbGFzcyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBpcyBhIHdvcmthcm91bmQgdG8gZW5zdXJlIHRoYXQgdGhlIGRyYWdnZWQtZWxlbWVudFxuICAgKiAod2hpY2ggaXMgYXR0YWNoZWQgdG8gdGhlIGJvZHkpIGhhcyB0aGUgcmlnaHQgc3R5bGluZy5cbiAgICovXG4gIHJlbW92ZURhc2hib2FyZENsYXNzRnJvbUJvZHkoKSB7XG4gICAgdGhpcy5jbGFzcy5zcGxpdCgnICcpLmZvckVhY2goY3NzQ2xhc3MgPT4ge1xuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyhkb2N1bWVudC5ib2R5LCBjc3NDbGFzcyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hhbmdlcyB0aGUgZGFzaGJvYXJkIHNldHRpbmdzIHRvIGZyb3plbiBvciB2aWNlIHZlcnNhLlxuICAgKiBAcGFyYW0gc2V0dGluZ3MgVGhlIGN1cnJlbnQgc2V0dGluZ3Mgb2YgdGhlIGRhc2hib2FyZC5cbiAgICovXG4gIGFzeW5jIHRvZ2dsZUZyZWV6ZShzZXR0aW5nczogRGFzaGJvYXJkU2V0dGluZ3MpIHtcbiAgICB0aGlzLnRvZ2dsZUlzRnJvemVuRmxhZyhzZXR0aW5ncyk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UudXBkYXRlKHRoaXMubW8pO1xuICAgICAgaWYgKHRoaXMuZGFzaGJvYXJkLmlzRnJvemVuKSB7XG4gICAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdZb3VyIGRhc2hib2FyZCBpcyBsb2NrZWQgbm93LicpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdZb3VyIGRhc2hib2FyZCBpcyB1bmxvY2tlZCBub3cuJykpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgICAgdGhpcy50b2dnbGVJc0Zyb3plbkZsYWcoc2V0dGluZ3MpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlSXNGcm96ZW5GbGFnKHNldHRpbmdzOiBEYXNoYm9hcmRTZXR0aW5ncykge1xuICAgIHNldHRpbmdzLmlzRnJvemVuID0gIXNldHRpbmdzLmlzRnJvemVuO1xuICAgIHRoaXMuZGFzaGJvYXJkLmlzRnJvemVuID0gc2V0dGluZ3MuaXNGcm96ZW47XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb250ZXh0RGFzaGJvYXJkKCkge1xuICAgIHRoaXMuZGF0YVN1YiA9IHRoaXMucm91dGUuZGF0YS5zdWJzY3JpYmUoKHsgZGFzaGJvYXJkIH0pID0+IHtcbiAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMucm91dGUucGFyZW50LnNuYXBzaG90LmRhdGEuY29udGV4dERhdGE7XG4gICAgICB0aGlzLm1vID0gZGFzaGJvYXJkO1xuICAgICAgdGhpcy5kYXNoYm9hcmQgPSB0aGlzLm1vLmM4eV9EYXNoYm9hcmQ7XG4gICAgICB0aGlzLm9uTG9hZCgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkTmFtZWREYXNoYm9hcmQoKSB7XG4gICAgdGhpcy5kYXRhU3ViID0gdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZVxuICAgICAgLmdldE5hbWVkRGFzaGJvYXJkT3JDcmVhdGUodGhpcy5uYW1lLCB0aGlzLmRlZmF1bHRXaWRnZXRzKVxuICAgICAgLnN1YnNjcmliZShtbyA9PiB7XG4gICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY29udGV4dCB8fCB7fTtcbiAgICAgICAgdGhpcy5tbyA9IG1vO1xuICAgICAgICB0aGlzLmRhc2hib2FyZCA9IHRoaXMubW8uYzh5X0Rhc2hib2FyZDtcbiAgICAgICAgdGhpcy5vbkxvYWQoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBvbkxvYWQoKSB7XG4gICAgdGhpcy5kaXNhYmxlZCA9ICF0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmhhc1Blcm1pc3Npb24oKTtcbiAgICBjb25zdCBkYXNoYm9hcmRDaGlsZHJlbiA9IGNsb25lRGVlcCh0aGlzLm1vLmM4eV9EYXNoYm9hcmQuY2hpbGRyZW4pO1xuICAgIGNvbnN0IGlzRGV2aWNlVHlwZSA9IHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuaXNEZXZpY2VUeXBlKHRoaXMubW8pO1xuICAgIGNvbnN0IGRhc2hib2FyZENsYXNzZXMgPSB7XG4gICAgICAnYzh5LWdyaWQtZGFzaGJvYXJkJzogdHJ1ZSxcbiAgICAgIGRhc2hib2FyZDogdHJ1ZSxcbiAgICAgIC4uLnRoaXMuZGFzaGJvYXJkLmNsYXNzZXNcbiAgICB9O1xuXG4gICAgdGhpcy53aWRnZXRzID0gYXdhaXQgUHJvbWlzZS5hbGw8V2lkZ2V0PihcbiAgICAgIHZhbHVlcyhkYXNoYm9hcmRDaGlsZHJlbikubWFwKHdpZGdldCA9PiB7XG4gICAgICAgIHdpZGdldC5jbGFzc2VzID0gdGhpcy5tZXJnZVdpZGdldENsYXNzZXMod2lkZ2V0KTtcbiAgICAgICAgaWYgKGlzRGV2aWNlVHlwZSkge1xuICAgICAgICAgIHRoaXMuYXBwbHlEZXZpY2VUYXJnZXQod2lkZ2V0KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5tYXBMZWdhY3kod2lkZ2V0KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICB0aGlzLmNsYXNzID0gT2JqZWN0LmtleXMoZGFzaGJvYXJkQ2xhc3Nlcykuam9pbignICcpO1xuICAgIHRoaXMuZGlzYWJsZWQgPSAhdGhpcy5jb250ZXh0RGFzaGJvYXJkU2VydmljZS5oYXNQZXJtaXNzaW9uKCk7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VXaWRnZXRDbGFzc2VzKHdpZGdldDogV2lkZ2V0KSB7XG4gICAgY29uc3QgaGFzSGVhZGVyQ2xhc3MgPSBXSURHRVRfSEVBREVSX0NMQVNTRVMuZmluZChcbiAgICAgIGVsID0+IHdpZGdldC5jbGFzc2VzICYmIHdpZGdldC5jbGFzc2VzW2VsLmNsYXNzXVxuICAgICk7XG4gICAgY29uc3Qgd2lkZ2V0Q2xhc3NlcyA9IGhhc0hlYWRlckNsYXNzXG4gICAgICA/IHsgLi4ud2lkZ2V0LmNsYXNzZXMgfVxuICAgICAgOiB7IC4uLnRoaXMuZGFzaGJvYXJkLndpZGdldENsYXNzZXMsIC4uLndpZGdldC5jbGFzc2VzIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIGNhcmQ6IHRydWUsXG4gICAgICAnY2FyZC1kYXNoYm9hcmQnOiB0cnVlLFxuICAgICAgW2tlYmFiQ2FzZSh3aWRnZXQuY29tcG9uZW50SWQgfHwgd2lkZ2V0Lm5hbWUpXTogdHJ1ZSxcbiAgICAgIC4uLndpZGdldENsYXNzZXNcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjb21wb25lbnRUb1dpZGdldChjaGlsZDogRGFzaGJvYXJkQ2hpbGRDb21wb25lbnQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4ub21pdChjaGlsZC5kYXRhLCBbJ2NvbXBvbmVudFRyYW5zZm9ybUNvbmZpZ1dpdGhDb250ZXh0JywgJ3RyYW5zZm9ybUNvbmZpZ1dpdGhDb250ZXh0J10pLCAvLyByZW1vdmUgbGVnYWN5XG4gICAgICAuLi4oe1xuICAgICAgICBfeDogY2hpbGQueCxcbiAgICAgICAgX3k6IGNoaWxkLnksXG4gICAgICAgIF93aWR0aDogY2hpbGQud2lkdGgsXG4gICAgICAgIF9oZWlnaHQ6IGNoaWxkLmhlaWdodFxuICAgICAgfSBhcyBXaWRnZXQpXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbWFwTGVnYWN5KHdpZGdldCk6IFByb21pc2U8V2lkZ2V0PiB7XG4gICAgY29uc3QgY21wID0gYXdhaXQgdGhpcy53aWRnZXRTZXJ2aWNlLmdldFdpZGdldERlZmluaXRpb24od2lkZ2V0LmNvbXBvbmVudElkIHx8IHdpZGdldC5uYW1lKTtcbiAgICBpZiAoZ2V0KGNtcCwgJ2RhdGEuc2V0dGluZ3MudXBncmFkZScpKSB7XG4gICAgICB3aWRnZXQud2lkZ2V0Q29tcG9uZW50ID0gY21wLmRhdGEuc2V0dGluZ3Mud2lkZ2V0Q29tcG9uZW50O1xuICAgICAgd2lkZ2V0LmNvbmZpZ0NvbXBvbmVudCA9IGNtcC5kYXRhLnNldHRpbmdzLmNvbmZpZ0NvbXBvbmVudDtcbiAgICAgIHdpZGdldC50ZW1wbGF0ZVVybCA9IGNtcC5kYXRhLnNldHRpbmdzLnRlbXBsYXRlVXJsO1xuICAgICAgd2lkZ2V0LmNvbmZpZ1RlbXBsYXRlVXJsID0gY21wLmRhdGEuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmw7XG4gICAgICB3aWRnZXQudHJhbnNmb3JtQ29uZmlnV2l0aENvbnRleHQgPVxuICAgICAgICBjbXAuZGF0YS5zZXR0aW5ncy5jb21wb25lbnRUcmFuc2Zvcm1Db25maWdXaXRoQ29udGV4dCB8fFxuICAgICAgICBjbXAuZGF0YS5zZXR0aW5ncy50cmFuc2Zvcm1Db25maWdXaXRoQ29udGV4dDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVsZXRlIHdpZGdldC50ZW1wbGF0ZVVybDtcbiAgICAgIGRlbGV0ZSB3aWRnZXQuY29uZmlnVGVtcGxhdGVVcmw7XG4gICAgfVxuICAgIHJldHVybiB3aWRnZXQ7XG4gIH1cbn1cbiJdfQ==