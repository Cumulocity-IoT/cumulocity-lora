import * as tslib_1 from "tslib";
import { Component, Input, OnInit, ChangeDetectorRef } from '@angular/core';
import { gettext } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { GroupNode } from './group-node';
import { Subject } from 'rxjs';
import { takeUntil, filter } from 'rxjs/operators';
import { Action } from '../action.enum';
import { AssetSelectorComponent } from './asset-selector.component';
var AssetSelectorNodeComponent = /** @class */ (function () {
    /**
     * @ignore only di
     */
    function AssetSelectorNodeComponent(translateService, cd, parentNode) {
        this.translateService = translateService;
        this.cd = cd;
        this.parentNode = parentNode;
        /**
         * All preselected items
         */
        this.preselected = [];
        /**
         *  Should the path be shown
         */
        this.showPath = false;
        /**
         * @ignore
         */
        this.level = 0;
        /**
         * The selection status of the node
         */
        this.checked = false;
        /**
         * @ignore
         */
        this.unsubscribe$ = new Subject();
    }
    Object.defineProperty(AssetSelectorNodeComponent.prototype, "expandTitle", {
        /**
         * @ignore
         */
        get: function () {
            return !this.node.open ? gettext('Expand') : gettext('Collapse');
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @ignore
     */
    AssetSelectorNodeComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                this.breadcrumb = this.node.label;
                this.setupBreadcrumbsAndLevel(this.node);
                if (this.node instanceof GroupNode) {
                    this.node.hookEvents();
                }
                // open on startup
                if (this.node.root) {
                    this.click();
                }
                if (this.node.events) {
                    this.node.events
                        .pipe(takeUntil(this.unsubscribe$), filter(function (a) { return a === Action.LOADING_DONE; }))
                        .subscribe(function () {
                        _this.cd.markForCheck();
                    });
                }
                this.checked = this.isPreselected();
                return [2 /*return*/];
            });
        });
    };
    /**
     * Opens a node.
     */
    AssetSelectorNodeComponent.prototype.click = function () {
        this.node.open = !this.node.open;
        this.node.click({ open: this.node.open });
    };
    /**
     * TODO: Only level used. Breadcrumbs needs to be implemented.
     */
    AssetSelectorNodeComponent.prototype.setupBreadcrumbsAndLevel = function (node) {
        if (node.parents && node.parents.length) {
            var parent_1 = node.parents[0];
            this.breadcrumb = this.translateService.instant(parent_1.label) + ' > ' + this.breadcrumb;
            this.level++;
            this.setupBreadcrumbsAndLevel(parent_1);
        }
    };
    /**
     * Selects the node and emits a change on the parent component.
     * @param node The node to select.
     */
    AssetSelectorNodeComponent.prototype.selected = function (node) {
        this.checked = !this.checked;
        this.updateSelection(node.mo);
    };
    /**
     * @ignore
     */
    AssetSelectorNodeComponent.prototype.ngOnDestroy = function () {
        this.unsubscribe$.next(true);
        this.unsubscribe$.complete();
    };
    AssetSelectorNodeComponent.prototype.isPreselected = function () {
        if (this.node.root || !this.node.mo) {
            return false;
        }
        return this.parentNode.getIndexOfSelected(this.preselected, this.node.mo) > -1;
    };
    AssetSelectorNodeComponent.prototype.updateSelection = function (selectedMo) {
        if (this.checked) {
            this.parentNode.select(selectedMo);
            return;
        }
        this.parentNode.deselect(selectedMo);
    };
    AssetSelectorNodeComponent.ctorParameters = function () { return [
        { type: TranslateService },
        { type: ChangeDetectorRef },
        { type: AssetSelectorComponent }
    ]; };
    tslib_1.__decorate([
        Input()
    ], AssetSelectorNodeComponent.prototype, "node", void 0);
    tslib_1.__decorate([
        Input()
    ], AssetSelectorNodeComponent.prototype, "preselected", void 0);
    tslib_1.__decorate([
        Input()
    ], AssetSelectorNodeComponent.prototype, "showPath", void 0);
    AssetSelectorNodeComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-asset-selector-node',
            template: "<div\n  class=\"d-flex collapsible\"\n  [ngClass]=\"{ 'expanded separator-top': node.open }\"\n  title=\"{{ breadcrumb | translate }}\"\n  *ngIf=\"!node.root && !node.hidden\"\n>\n  <div\n    class=\"p-t-8 p-b-8 m-r-8\"\n    [ngStyle]=\"{ 'padding-left': level < 6 ? (level - 1) * 8 + 'px' : '24px' }\"\n    [style.visibility]=\"node.routerLinkExact ? 'hidden' : 'visible'\"\n  >\n    <label class=\"c8y-checkbox\" style=\"margin-top: 1px;\">\n      <input type=\"checkbox\" (change)=\"selected(node)\" [checked]=\"checked\" />\n      <span></span>\n    </label>\n  </div>\n  <div\n    class=\"flex-grow flex-item-middle p-t-8 p-b-8 text-truncate p-r-8\"\n    [style.cursor]=\"node.routerLinkExact ? 'pointer' : 'normal'\"\n    (click)=\"node.routerLinkExact ? node.click() : ''\"\n  >\n    <i\n      [c8yIcon]=\"node.icon\"\n      *ngIf=\"node.icon === 'c8y-group-smart'\"\n      [title]=\"'Smart group' | translate\"\n      class=\"c8y-icon c8y-icon-duocolor m-r-4 text-16\"\n    ></i>\n    <i\n      [c8yIcon]=\"node.icon\"\n      *ngIf=\"node.icon !== 'c8y-group-smart'\"\n      [title]=\"'Group' | translate\"\n      class=\"c8y-icon c8y-icon-duocolor m-r-4 text-16\"\n    ></i>\n    <span title=\"{{ breadcrumb }}\">\n      {{ node.label | translate }}\n      <!-- use just for search results to display the path -->\n      <p *ngIf=\"showPath\" class=\"text-truncate\">\n        <small class=\"text-muted\" title=\"{{ breadcrumb }}\">\n          <em>{{ breadcrumb }}</em>\n        </small>\n      </p>\n      <!-- up to here -->\n    </span>\n  </div>\n  <div>\n    <button\n      [title]=\"expandTitle\"\n      class=\"collapse-btn btn\"\n      (click)=\"click()\"\n      [attr.aria-expanded]=\"!node.open\"\n    >\n      <i c8yIcon=\"angle-down\" [ngClass]=\"{ 'text-primary': node.open }\"></i>\n    </button>\n  </div>\n</div>\n<div class=\"collapse\" [ngClass]=\"{ 'separator-bottom': node.open }\" [collapse]=\"!node.open\">\n  <c8y-asset-selector-node\n    *ngFor=\"let childNode of node.children\"\n    [node]=\"childNode\"\n    [preselected]=\"preselected || []\"\n  ></c8y-asset-selector-node>\n</div>\n"
        })
    ], AssetSelectorNodeComponent);
    return AssetSelectorNodeComponent;
}());
export { AssetSelectorNodeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtc2VsZWN0b3Itbm9kZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2Fzc2V0cy1uYXZpZ2F0b3IvIiwic291cmNlcyI6WyJhc3NldC1zZWxlY3Rvci9hc3NldC1zZWxlY3Rvci1ub2RlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFPcEU7SUFxQ0U7O09BRUc7SUFDSCxvQ0FDVSxnQkFBa0MsRUFDbEMsRUFBcUIsRUFDckIsVUFBa0M7UUFGbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQUNyQixlQUFVLEdBQVYsVUFBVSxDQUF3QjtRQXRDNUM7O1dBRUc7UUFDTSxnQkFBVyxHQUFtQyxFQUFFLENBQUM7UUFDMUQ7O1dBRUc7UUFDTSxhQUFRLEdBQVksS0FBSyxDQUFDO1FBS25DOztXQUVHO1FBQ0gsVUFBSyxHQUFXLENBQUMsQ0FBQztRQUNsQjs7V0FFRztRQUNILFlBQU8sR0FBWSxLQUFLLENBQUM7UUFDekI7O1dBRUc7UUFDSCxpQkFB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RSxFQUFFO1lBQ25DLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7SUFFTyxvREFBZSxHQUF2QixVQUF3QixVQUEwQjtRQUNoRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkMsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdkMsQ0FBQzs7Z0JBdEYyQixnQkFBZ0I7Z0JBQzlCLGlCQUFpQjtnQkFDVCxzQkFBc0I7O0lBdkNuQztRQUFSLEtBQUssRUFBRTs0REFBaUI7SUFJaEI7UUFBUixLQUFLLEVBQUU7bUVBQWtEO0lBSWpEO1FBQVIsS0FBSyxFQUFFO2dFQUEyQjtJQVp4QiwwQkFBMEI7UUFKdEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHlCQUF5QjtZQUNuQyxvbEVBQW1EO1NBQ3BELENBQUM7T0FDVywwQkFBMEIsQ0FnSXRDO0lBQUQsaUNBQUM7Q0FBQSxBQWhJRCxJQWdJQztTQWhJWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkluaXQsIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEdyb3VwTm9kZSB9IGZyb20gJy4vZ3JvdXAtbm9kZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gJy4uL2FjdGlvbi5lbnVtJztcbmltcG9ydCB7IEFzc2V0U2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICcuL2Fzc2V0LXNlbGVjdG9yLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFzc2V0LXNlbGVjdG9yLW5vZGUnLFxuICB0ZW1wbGF0ZVVybDogJy4vYXNzZXQtc2VsZWN0b3Itbm9kZS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQXNzZXRTZWxlY3Rvck5vZGVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAvKipcbiAgICogVGhlIGN1cnJlbnQgbm9kZS5cbiAgICovXG4gIEBJbnB1dCgpIG5vZGU6IEdyb3VwTm9kZTtcbiAgLyoqXG4gICAqIEFsbCBwcmVzZWxlY3RlZCBpdGVtc1xuICAgKi9cbiAgQElucHV0KCkgcHJlc2VsZWN0ZWQ6IEFycmF5PFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+PiA9IFtdO1xuICAvKipcbiAgICogIFNob3VsZCB0aGUgcGF0aCBiZSBzaG93blxuICAgKi9cbiAgQElucHV0KCkgc2hvd1BhdGg6IGJvb2xlYW4gPSBmYWxzZTtcbiAgLyoqXG4gICAqIFRoZSBjdXJyZW50IHBhdGggdG8gdGhlIG5vZGVcbiAgICovXG4gIGJyZWFkY3J1bWI6IHN0cmluZztcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGxldmVsOiBudW1iZXIgPSAwO1xuICAvKipcbiAgICogVGhlIHNlbGVjdGlvbiBzdGF0dXMgb2YgdGhlIG5vZGVcbiAgICovXG4gIGNoZWNrZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHVuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZ2V0IGV4cGFuZFRpdGxlKCkge1xuICAgIHJldHVybiAhdGhpcy5ub2RlLm9wZW4gPyBnZXR0ZXh0KCdFeHBhbmQnKSA6IGdldHRleHQoJ0NvbGxhcHNlJyk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZSBvbmx5IGRpXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBwYXJlbnROb2RlOiBBc3NldFNlbGVjdG9yQ29tcG9uZW50XG4gICkge31cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5icmVhZGNydW1iID0gdGhpcy5ub2RlLmxhYmVsO1xuICAgIHRoaXMuc2V0dXBCcmVhZGNydW1ic0FuZExldmVsKHRoaXMubm9kZSk7XG5cbiAgICBpZiAodGhpcy5ub2RlIGluc3RhbmNlb2YgR3JvdXBOb2RlKSB7XG4gICAgICB0aGlzLm5vZGUuaG9va0V2ZW50cygpO1xuICAgIH1cblxuICAgIC8vIG9wZW4gb24gc3RhcnR1cFxuICAgIGlmICh0aGlzLm5vZGUucm9vdCkge1xuICAgICAgdGhpcy5jbGljaygpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm5vZGUuZXZlbnRzKSB7XG4gICAgICB0aGlzLm5vZGUuZXZlbnRzXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCksXG4gICAgICAgICAgZmlsdGVyKChhOiBBY3Rpb24pID0+IGEgPT09IEFjdGlvbi5MT0FESU5HX0RPTkUpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5jaGVja2VkID0gdGhpcy5pc1ByZXNlbGVjdGVkKCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgYSBub2RlLlxuICAgKi9cbiAgY2xpY2soKSB7XG4gICAgdGhpcy5ub2RlLm9wZW4gPSAhdGhpcy5ub2RlLm9wZW47XG4gICAgdGhpcy5ub2RlLmNsaWNrKHsgb3BlbjogdGhpcy5ub2RlLm9wZW4gfSk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogT25seSBsZXZlbCB1c2VkLiBCcmVhZGNydW1icyBuZWVkcyB0byBiZSBpbXBsZW1lbnRlZC5cbiAgICovXG4gIHNldHVwQnJlYWRjcnVtYnNBbmRMZXZlbChub2RlOiBHcm91cE5vZGUpIHtcbiAgICBpZiAobm9kZS5wYXJlbnRzICYmIG5vZGUucGFyZW50cy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50c1swXSBhcyBHcm91cE5vZGU7XG4gICAgICB0aGlzLmJyZWFkY3J1bWIgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChwYXJlbnQubGFiZWwpICsgJyA+ICcgKyB0aGlzLmJyZWFkY3J1bWI7XG4gICAgICB0aGlzLmxldmVsKys7XG5cbiAgICAgIHRoaXMuc2V0dXBCcmVhZGNydW1ic0FuZExldmVsKHBhcmVudCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdHMgdGhlIG5vZGUgYW5kIGVtaXRzIGEgY2hhbmdlIG9uIHRoZSBwYXJlbnQgY29tcG9uZW50LlxuICAgKiBAcGFyYW0gbm9kZSBUaGUgbm9kZSB0byBzZWxlY3QuXG4gICAqL1xuICBzZWxlY3RlZChub2RlOiBHcm91cE5vZGUpIHtcbiAgICB0aGlzLmNoZWNrZWQgPSAhdGhpcy5jaGVja2VkO1xuICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKG5vZGUubW8pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQodHJ1ZSk7XG4gICAgdGhpcy51bnN1YnNjcmliZSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNQcmVzZWxlY3RlZCgpIHtcbiAgICBpZiAodGhpcy5ub2RlLnJvb3QgfHwgIXRoaXMubm9kZS5tbykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wYXJlbnROb2RlLmdldEluZGV4T2ZTZWxlY3RlZCh0aGlzLnByZXNlbGVjdGVkLCB0aGlzLm5vZGUubW8pID4gLTE7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVNlbGVjdGlvbihzZWxlY3RlZE1vOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGlmICh0aGlzLmNoZWNrZWQpIHtcbiAgICAgIHRoaXMucGFyZW50Tm9kZS5zZWxlY3Qoc2VsZWN0ZWRNbyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucGFyZW50Tm9kZS5kZXNlbGVjdChzZWxlY3RlZE1vKTtcbiAgfVxufVxuIl19