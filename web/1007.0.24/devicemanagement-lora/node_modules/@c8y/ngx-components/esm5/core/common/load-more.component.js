import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, HostBinding, Input, Output, TemplateRef } from '@angular/core';
var LoadMoreComponent = /** @class */ (function () {
    function LoadMoreComponent(element) {
        this.element = element;
        this.useIntersection = true;
        this.hidden = false;
        this.class = 'c8y-list__item bg-transparent';
        this.maxIterations = 10;
        this.onLoad = new EventEmitter();
        this.isLoading = false;
        this.counter = 0;
        this.showNoMoreDataHint = false;
        this.LOAD_SAME_PAGE_THRESHOLD = 50;
    }
    Object.defineProperty(LoadMoreComponent.prototype, "hostClass", {
        get: function () {
            return this.hidden || (!this.hasMore && !this.showNoMoreDataHint) ? '' : this.class;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LoadMoreComponent.prototype, "hasMore", {
        get: function () {
            return (this.paging && (this.paging.totalPages > this.paging.currentPage || !!this.paging.nextPage));
        },
        enumerable: true,
        configurable: true
    });
    LoadMoreComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        if (this.useIntersection && 'IntersectionObserver' in window) {
            this.intersectionObserver = new IntersectionObserver(function (event) { return _this.buttonInView(event[0]); }, {
                root: this.container ? this.container.nativeElement : null
            });
            this.intersectionObserver.observe(this.element.nativeElement);
        }
        this.showNoMoreDataHint = this.shouldShowNoMoreDataHint();
    };
    LoadMoreComponent.prototype.ngOnDestroy = function () {
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
        }
    };
    LoadMoreComponent.prototype.loadMore = function (event) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var result;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isLoading = true;
                        if (event) {
                            event.stopPropagation();
                        }
                        if (!this.hasMore) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.paging.next()];
                    case 1:
                        result = _a.sent();
                        this.counter++;
                        this.paging = result.paging;
                        this.onLoad.emit(result.data);
                        this.intersectionLoading();
                        this.showNoMoreDataHint = this.shouldShowNoMoreDataHint();
                        return [3 /*break*/, 3];
                    case 2:
                        this.counter = 0;
                        this.isLoading = false;
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    LoadMoreComponent.prototype.intersectionLoading = function () {
        var _this = this;
        if (this.useIntersection && this.hasMore && this.loadUntilIntersected !== null) {
            this.loadUntilIntersected = setTimeout(function () { return _this.loadMore(); }, this.getLoadingThreshold());
            this.useIntersection = this.shouldSwitchMode();
        }
        else {
            this.isLoading = false;
            this.loadUntilIntersected = undefined;
        }
    };
    LoadMoreComponent.prototype.getLoadingThreshold = function () {
        return this.LOAD_SAME_PAGE_THRESHOLD * this.counter;
    };
    LoadMoreComponent.prototype.shouldShowNoMoreDataHint = function () {
        return (this.counter !== 0 || this.noMoreDataHint) && !this.hasMore && !this.hidden;
    };
    LoadMoreComponent.prototype.shouldSwitchMode = function () {
        return this.counter < this.maxIterations || this.hidden;
    };
    LoadMoreComponent.prototype.buttonInView = function (event) {
        if (event.isIntersecting) {
            this.loadMore();
        }
        else if (this.loadUntilIntersected) {
            clearTimeout(this.loadUntilIntersected);
            this.loadUntilIntersected = null;
            this.isLoading = false;
        }
        else {
            // avoiding a race condition when timeout is faster
            // cleared then set
            this.loadUntilIntersected = null;
        }
    };
    LoadMoreComponent.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "paging", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "useIntersection", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "hidden", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "container", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "class", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "maxIterations", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "noMoreDataHint", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "loadNextLabel", void 0);
    tslib_1.__decorate([
        Input()
    ], LoadMoreComponent.prototype, "loadingLabel", void 0);
    tslib_1.__decorate([
        Output()
    ], LoadMoreComponent.prototype, "onLoad", void 0);
    tslib_1.__decorate([
        HostBinding('class')
    ], LoadMoreComponent.prototype, "hostClass", null);
    LoadMoreComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-load-more',
            template: "<button\n  class=\"btn btn-default btn-block text-center\"\n  (click)=\"loadMore($event)\"\n  [ngClass]=\"{ 'btn-pending': isLoading }\"\n  *ngIf=\"hasMore\"\n  [style.visibility]=\"hidden ? 'hidden' : 'visible'\"\n  [style.height]=\"hidden ? '1px' : null\"\n  title=\"{{ 'Load more' | translate }}\"\n>\n  <ng-container *ngIf=\"!isLoading\">\n    <span *ngIf=\"loadNextLabel; else loadPage\" [innerHTML]=\"loadNextLabel | translate\"></span>\n    <ng-template #loadPage>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Load page {{ pageNo }}</span\n      >\n    </ng-template>\n  </ng-container>\n  <ng-container *ngIf=\"isLoading\">\n    <span *ngIf=\"loadingLabel; else loading\" [innerHTML]=\"loadingLabel | translate\"></span>\n    <ng-template #loading>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Page {{ pageNo }} is loading\u2026\n      </span>\n    </ng-template>\n  </ng-container>\n</button>\n\n<ng-container *ngIf=\"showNoMoreDataHint\">\n  <ng-container *ngTemplateOutlet=\"noMoreDataHint || finishHint\"></ng-container>\n</ng-container>\n\n<ng-template #finishHint>\n  <div class=\"legend form-block center\">\n    <i [c8yIcon]=\"'flag-checkered'\" class=\"m-r-4\"></i>\n    {{ 'Last record' | translate }}\n  </div>\n</ng-template>\n"
        })
    ], LoadMoreComponent);
    return LoadMoreComponent;
}());
export { LoadMoreComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1tb3JlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2NvbW1vbi9sb2FkLW1vcmUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osV0FBVyxFQUNYLEtBQUssRUFDTCxNQUFNLEVBQ04sV0FBVyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBT3ZCO0lBd0NFLDJCQUFvQixPQUFtQjtRQUFuQixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBcEN2QyxvQkFBZSxHQUFHLElBQUksQ0FBQztRQUV2QixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBSWYsVUFBSyxHQUFXLCtCQUErQixDQUFDO1FBRWhELGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBUW5CLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFDbEIsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUNaLHVCQUFrQixHQUFHLEtBQUssQ0FBQztRQUVWLDZCQUF3QixHQUFHLEVBQUUsQ0FBQztJQWNMLENBQUM7SUFWM0Msc0JBQUksd0NBQVM7YUFBYjtZQUNFLE9BQU8sSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDdEYsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSxzQ0FBTzthQUFYO1lBQ0UsT0FBTyxDQUNMLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0s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dCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBIb3N0QmluZGluZyxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgVGVtcGxhdGVSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCwgUGFnaW5nIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktbG9hZC1tb3JlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xvYWQtbW9yZS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgTG9hZE1vcmVDb21wb25lbnQge1xuICBASW5wdXQoKVxuICBwYWdpbmc6IFBhZ2luZzxhbnk+O1xuICBASW5wdXQoKVxuICB1c2VJbnRlcnNlY3Rpb24gPSB0cnVlO1xuICBASW5wdXQoKVxuICBoaWRkZW4gPSBmYWxzZTtcbiAgQElucHV0KClcbiAgY29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBASW5wdXQoKVxuICBjbGFzczogc3RyaW5nID0gJ2M4eS1saXN0X19pdGVtIGJnLXRyYW5zcGFyZW50JztcbiAgQElucHV0KClcbiAgbWF4SXRlcmF0aW9ucyA9IDEwO1xuICBASW5wdXQoKVxuICBub01vcmVEYXRhSGludDogVGVtcGxhdGVSZWY8YW55PjtcbiAgQElucHV0KClcbiAgbG9hZE5leHRMYWJlbDogc3RyaW5nO1xuICBASW5wdXQoKVxuICBsb2FkaW5nTGFiZWw6IHN0cmluZztcbiAgQE91dHB1dCgpXG4gIG9uTG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8SUlkZW50aWZpZWQ+KCk7XG5cbiAgaXNMb2FkaW5nID0gZmFsc2U7XG4gIGNvdW50ZXIgPSAwO1xuICBzaG93Tm9Nb3JlRGF0YUhpbnQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBsb2FkVW50aWxJbnRlcnNlY3RlZDtcbiAgcHJpdmF0ZSByZWFkb25seSBMT0FEX1NBTUVfUEFHRV9USFJFU0hPTEQgPSA1MDtcbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXI7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXG4gIGdldCBob3N0Q2xhc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlkZGVuIHx8ICghdGhpcy5oYXNNb3JlICYmICF0aGlzLnNob3dOb01vcmVEYXRhSGludCkgPyAnJyA6IHRoaXMuY2xhc3M7XG4gIH1cblxuICBnZXQgaGFzTW9yZSgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5wYWdpbmcgJiYgKHRoaXMucGFnaW5nLnRvdGFsUGFnZXMgPiB0aGlzLnBhZ2luZy5jdXJyZW50UGFnZSB8fCAhIXRoaXMucGFnaW5nLm5leHRQYWdlKVxuICAgICk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYpIHt9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnVzZUludGVyc2VjdGlvbiAmJiAnSW50ZXJzZWN0aW9uT2JzZXJ2ZXInIGluIHdpbmRvdykge1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihldmVudCA9PiB0aGlzLmJ1dHRvbkluVmlldyhldmVudFswXSksIHtcbiAgICAgICAgcm9vdDogdGhpcy5jb250YWluZXIgPyB0aGlzLmNvbnRhaW5lci5uYXRpdmVFbGVtZW50IDogbnVsbFxuICAgICAgfSk7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLm9ic2VydmUodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgICB0aGlzLnNob3dOb01vcmVEYXRhSGludCA9IHRoaXMuc2hvdWxkU2hvd05vTW9yZURhdGFIaW50KCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlcikge1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZE1vcmUoZXZlbnQ/KSB7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIGlmIChldmVudCkge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmhhc01vcmUpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucGFnaW5nLm5leHQoKTtcbiAgICAgIHRoaXMuY291bnRlcisrO1xuICAgICAgdGhpcy5wYWdpbmcgPSByZXN1bHQucGFnaW5nO1xuICAgICAgdGhpcy5vbkxvYWQuZW1pdChyZXN1bHQuZGF0YSk7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbkxvYWRpbmcoKTtcbiAgICAgIHRoaXMuc2hvd05vTW9yZURhdGFIaW50ID0gdGhpcy5zaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jb3VudGVyID0gMDtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25Mb2FkaW5nKCkge1xuICAgIGlmICh0aGlzLnVzZUludGVyc2VjdGlvbiAmJiB0aGlzLmhhc01vcmUgJiYgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5sb2FkTW9yZSgpLCB0aGlzLmdldExvYWRpbmdUaHJlc2hvbGQoKSk7XG4gICAgICB0aGlzLnVzZUludGVyc2VjdGlvbiA9IHRoaXMuc2hvdWxkU3dpdGNoTW9kZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldExvYWRpbmdUaHJlc2hvbGQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5MT0FEX1NBTUVfUEFHRV9USFJFU0hPTEQgKiB0aGlzLmNvdW50ZXI7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFNob3dOb01vcmVEYXRhSGludCgpIHtcbiAgICByZXR1cm4gKHRoaXMuY291bnRlciAhPT0gMCB8fCB0aGlzLm5vTW9yZURhdGFIaW50KSAmJiAhdGhpcy5oYXNNb3JlICYmICF0aGlzLmhpZGRlbjtcbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkU3dpdGNoTW9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb3VudGVyIDwgdGhpcy5tYXhJdGVyYXRpb25zIHx8IHRoaXMuaGlkZGVuO1xuICB9XG5cbiAgcHJpdmF0ZSBidXR0b25JblZpZXcoZXZlbnQpIHtcbiAgICBpZiAoZXZlbnQuaXNJbnRlcnNlY3RpbmcpIHtcbiAgICAgIHRoaXMubG9hZE1vcmUoKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMubG9hZFVudGlsSW50ZXJzZWN0ZWQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkKTtcbiAgICAgIHRoaXMubG9hZFVudGlsSW50ZXJzZWN0ZWQgPSBudWxsO1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYXZvaWRpbmcgYSByYWNlIGNvbmRpdGlvbiB3aGVuIHRpbWVvdXQgaXMgZmFzdGVyXG4gICAgICAvLyBjbGVhcmVkIHRoZW4gc2V0XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==