import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter, Input } from '@angular/core';
import { LoginService } from '../login/login.service';
import { AlertService } from '../alert/alert.service';
import { LoginViews } from '../login/login.model';
import { ICredentials, UserService } from '@c8y/client';
var ProvidePhoneNumberComponent = /** @class */ (function () {
    function ProvidePhoneNumberComponent(loginService, alert, userService) {
        this.loginService = loginService;
        this.alert = alert;
        this.userService = userService;
        this.onCancel = new EventEmitter();
        this.onChangeView = new EventEmitter();
        this.requestInProgress = false;
        this.sendTfa = '0';
    }
    ProvidePhoneNumberComponent.prototype.sendTFASms = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.userService.verifyTFACode(this.sendTfa)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 3];
                    case 2:
                        e_1 = _a.sent();
                        if (e_1.res.status === 403) {
                            this.loginService.cleanMessages();
                            this.loginService.addSuccessMessage('send_sms');
                        }
                        else {
                            throw e_1;
                        }
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    ProvidePhoneNumberComponent.prototype.save = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, 4, 5]);
                        this.requestInProgress = true;
                        return [4 /*yield*/, this.userService.savePhoneNumber(this.phoneNumber)];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.sendTFASms()];
                    case 2:
                        _a.sent();
                        this.onChangeView.emit({
                            view: LoginViews.SmsChallenge,
                            credentials: this.credentials
                        });
                        return [3 /*break*/, 5];
                    case 3:
                        e_2 = _a.sent();
                        this.alert.addServerFailure(e_2);
                        return [3 /*break*/, 5];
                    case 4:
                        this.requestInProgress = false;
                        return [7 /*endfinally*/];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    ProvidePhoneNumberComponent.ctorParameters = function () { return [
        { type: LoginService },
        { type: AlertService },
        { type: UserService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], ProvidePhoneNumberComponent.prototype, "credentials", void 0);
    tslib_1.__decorate([
        Output()
    ], ProvidePhoneNumberComponent.prototype, "onCancel", void 0);
    tslib_1.__decorate([
        Output()
    ], ProvidePhoneNumberComponent.prototype, "onChangeView", void 0);
    ProvidePhoneNumberComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-provide-phone-number',
            template: "<form\n  #twoFactorForm=\"ngForm\"\n  role=\"form\"\n  class=\"loginForm\"\n  (ngSubmit)=\"save()\"\n  novalidate\n>\n  <c8y-form-group>\n    <label translate>Provide your phone number</label>\n\n    <input\n      class=\"form-control\"\n      [(ngModel)]=\"phoneNumber\"\n      #contactPhone=\"ngModel\"\n      type=\"text\"\n      name=\"phone\"\n      autocomplete=\"off\"\n      placeholder=\"{{ 'e.g. +49 9 876 543 210`LOCALIZE`' | translate }}\"\n      c8yPhoneValidation\n      c8yDefaultValidation=\"phoneNumber\"\n      required\n    />\n  </c8y-form-group>\n\n  <button\n    title=\"{{ 'Save and continue' | translate }}\"\n    type=\"submit\"\n    class=\"btn btn-primary btn-lg btn-block form-group\"\n    [disabled]=\"requestInProgress || twoFactorForm.invalid\"\n  >\n    {{ 'Save and continue' | translate }}\n  </button>\n\n  <div class=\"\u201Dm-t-16\u201D\">\n    <a\n      title=\"{{ 'Login' | translate }}\"\n      class=\"btn btn-link pull-right\"\n      href=\"#\"\n      (click)=\"onCancel.emit()\"\n    >\n      {{ 'Login' | translate }}\n    </a>\n  </div>\n</form>\n"
        })
    ], ProvidePhoneNumberComponent);
    return ProvidePhoneNumberComponent;
}());
export { ProvidePhoneNumberComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZS1waG9uZS1udW1iZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvYXV0aGVudGljYXRpb24vcHJvdmlkZS1waG9uZS1udW1iZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBTXhEO0lBU0UscUNBQ1MsWUFBMEIsRUFDMUIsS0FBbUIsRUFDbEIsV0FBd0I7UUFGekIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNsQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQVZ4QixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM5QixpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFHNUMsc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLFlBQU8sR0FBVyxHQUFHLENBQUM7SUFNM0IsQ0FBQztJQUVFLGdEQUFVLEdBQWhCOzs7Ozs7O3dCQUVJLHFCQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBQTs7d0JBQWxELFNBQWtELENBQUM7Ozs7d0JBRW5ELElBQUksR0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFOzRCQUN4QixJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDOzRCQUNsQyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO3lCQUNqRDs2QkFBTTs0QkFDTCxNQUFNLEdBQUMsQ0FBQzt5QkFDVDs7Ozs7O0tBRUo7SUFFSywwQ0FBSSxHQUFWOzs7Ozs7O3dCQUVJLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7d0JBQzlCLHFCQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQTs7d0JBQXhELFNBQXdELENBQUM7d0JBQ3pELHFCQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsRUFBQTs7d0JBQXZCLFNBQXVCLENBQUM7d0JBQ3hCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDOzRCQUNyQixJQUFJLEVBQUUsVUFBVSxDQUFDLFlBQVk7NEJBQzdCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVzt5QkFDOUIsQ0FBQyxDQUFDOzs7O3dCQUVILElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBQyxDQUFDLENBQUM7Ozt3QkFFL0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQzs7Ozs7O0tBRWxDOztnQkFoQ3NCLFlBQVk7Z0JBQ25CLFlBQVk7Z0JBQ0wsV0FBVzs7SUFYekI7UUFBUixLQUFLLEVBQUU7b0VBQTJCO0lBQ3pCO1FBQVQsTUFBTSxFQUFFO2lFQUErQjtJQUM5QjtRQUFULE1BQU0sRUFBRTtxRUFBbUM7SUFIakMsMkJBQTJCO1FBSnZDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSwwQkFBMEI7WUFDcEMsZ2xDQUFvRDtTQUNyRCxDQUFDO09BQ1csMkJBQTJCLENBMkN2QztJQUFELGtDQUFDO0NBQUEsQUEzQ0QsSUEyQ0M7U0EzQ1ksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExvZ2luU2VydmljZSB9IGZyb20gJy4uL2xvZ2luL2xvZ2luLnNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vYWxlcnQvYWxlcnQuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dpblZpZXdzIH0gZnJvbSAnLi4vbG9naW4vbG9naW4ubW9kZWwnO1xuaW1wb3J0IHsgSUNyZWRlbnRpYWxzLCBVc2VyU2VydmljZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXByb3ZpZGUtcGhvbmUtbnVtYmVyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3Byb3ZpZGUtcGhvbmUtbnVtYmVyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQcm92aWRlUGhvbmVOdW1iZXJDb21wb25lbnQge1xuICBASW5wdXQoKSBjcmVkZW50aWFsczogSUNyZWRlbnRpYWxzO1xuICBAT3V0cHV0KCkgb25DYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBvbkNoYW5nZVZpZXcgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcGhvbmVOdW1iZXI6IHN0cmluZztcbiAgcmVxdWVzdEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzZW5kVGZhOiBzdHJpbmcgPSAnMCc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGxvZ2luU2VydmljZTogTG9naW5TZXJ2aWNlLFxuICAgIHB1YmxpYyBhbGVydDogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdXNlclNlcnZpY2U6IFVzZXJTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBzZW5kVEZBU21zKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnVzZXJTZXJ2aWNlLnZlcmlmeVRGQUNvZGUodGhpcy5zZW5kVGZhKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5yZXMuc3RhdHVzID09PSA0MDMpIHtcbiAgICAgICAgdGhpcy5sb2dpblNlcnZpY2UuY2xlYW5NZXNzYWdlcygpO1xuICAgICAgICB0aGlzLmxvZ2luU2VydmljZS5hZGRTdWNjZXNzTWVzc2FnZSgnc2VuZF9zbXMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5yZXF1ZXN0SW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgICBhd2FpdCB0aGlzLnVzZXJTZXJ2aWNlLnNhdmVQaG9uZU51bWJlcih0aGlzLnBob25lTnVtYmVyKTtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZFRGQVNtcygpO1xuICAgICAgdGhpcy5vbkNoYW5nZVZpZXcuZW1pdCh7XG4gICAgICAgIHZpZXc6IExvZ2luVmlld3MuU21zQ2hhbGxlbmdlLFxuICAgICAgICBjcmVkZW50aWFsczogdGhpcy5jcmVkZW50aWFsc1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGUpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLnJlcXVlc3RJblByb2dyZXNzID0gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXX0=