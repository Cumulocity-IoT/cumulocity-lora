import * as tslib_1 from "tslib";
import { Component, Input, EventEmitter, Output } from '@angular/core';
import { gettext } from '../i18n/gettext';
import { BsModalRef } from 'ngx-bootstrap';
import { ModalSelectionMode } from './select-modal.model';
import { assign } from 'lodash-es';
import { Subject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
var SelectModalComponent = /** @class */ (function () {
    function SelectModalComponent(bsModalRef) {
        var _this = this;
        this.bsModalRef = bsModalRef;
        this.subTitle = gettext('Select from the list of items matching the device type');
        this.mode = ModalSelectionMode.MULTI;
        this.disableSelected = true;
        this.showFilter = true;
        this.areMoreEntries = false;
        this.result = new EventEmitter();
        this.search = new EventEmitter();
        this.selected = false;
        this.filterTerm = '';
        this.listItems = [];
        this.debouncer = new Subject();
        this._labels = { ok: gettext('Confirm'), cancel: gettext('Cancel') };
        this.debouncer.pipe(debounceTime(500)).subscribe(function (value) {
            _this.search.emit(value);
        });
    }
    Object.defineProperty(SelectModalComponent.prototype, "labels", {
        get: function () {
            return this._labels;
        },
        set: function (labels) {
            var _a = labels || {}, _b = _a.ok, ok = _b === void 0 ? this.labels.ok : _b, _c = _a.cancel, cancel = _c === void 0 ? this.labels.cancel : _c;
            this._labels = { ok: ok, cancel: cancel };
        },
        enumerable: true,
        configurable: true
    });
    SelectModalComponent.prototype.ngOnChanges = function (changes) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var itemsPromise, _a;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!(changes.items && changes.items.currentValue)) return [3 /*break*/, 2];
                        itemsPromise = changes.items.currentValue.map(function (item) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                            var _a, selected;
                            return tslib_1.__generator(this, function (_b) {
                                switch (_b.label) {
                                    case 0:
                                        _a = item;
                                        return [4 /*yield*/, item.options];
                                    case 1:
                                        _a.options = _b.sent();
                                        selected = item.options.find(function (option) { return option.selected; });
                                        if (selected) {
                                            item.selectedId = selected.obj.id;
                                            if (this.disableSelected) {
                                                item.options.map(function (option) { return assign(option, { disabled: true }); });
                                            }
                                        }
                                        return [2 /*return*/, item];
                                }
                            });
                        }); });
                        _a = this;
                        return [4 /*yield*/, Promise.all(itemsPromise)];
                    case 1:
                        _a.listItems = _b.sent();
                        _b.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    SelectModalComponent.prototype.updatePipe = function (filterTerm) {
        this.debouncer.next(filterTerm);
        this.filterTerm = filterTerm;
    };
    SelectModalComponent.prototype.updateChoice = function (_a) {
        var item = _a.item, id = _a.id;
        if (this.mode === 'single') {
            this.listItems.map(function (value) { return (value.selectedId = undefined); });
        }
        item.selectedId = id;
        this.selected = true;
    };
    SelectModalComponent.prototype.dismiss = function () {
        this.bsModalRef.hide();
    };
    SelectModalComponent.prototype.select = function () {
        var outputArray = this.getOutput();
        var output = this.mode === 'single' ? outputArray[0] : outputArray;
        this.result.emit(output);
        this.bsModalRef.hide();
    };
    SelectModalComponent.prototype.ngOnDestroy = function () {
        this.debouncer.complete();
        this.result.complete();
        this.search.complete();
    };
    SelectModalComponent.prototype.getOutput = function () {
        return this.listItems
            .filter(function (item) { return item.selectedId; })
            .map(function (item) { return item.options.find(function (option) { return item.selectedId === option.obj.id; }); })
            .map(function (selectedOption) { return selectedOption.obj; });
    };
    SelectModalComponent.ctorParameters = function () { return [
        { type: BsModalRef }
    ]; };
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "icon", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "title", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "subTitle", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "items", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "mode", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "disableSelected", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "showFilter", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "areMoreEntries", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectModalComponent.prototype, "labels", null);
    tslib_1.__decorate([
        Output()
    ], SelectModalComponent.prototype, "result", void 0);
    tslib_1.__decorate([
        Output()
    ], SelectModalComponent.prototype, "search", void 0);
    SelectModalComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-select-modal',
            template: "<div class=\"viewport-modal\">\n  <div class=\"modal-header dialog-header\">\n    <span c8yIcon=\"{{ icon }}\"></span>\n    <h4 class=\"text-uppercase\">\n      {{ title | translate }}\n    </h4>\n  </div>\n  <div class=\"p-16 text-center separator-bottom\">\n    <p class=\"m-b-8\">{{ subTitle | translate }}</p>\n    <c8y-filter *ngIf=\"showFilter\" [icon]=\"'search'\" (onSearch)=\"updatePipe($event)\"></c8y-filter>\n  </div>\n  <div class=\"modal-inner-scroll\">\n    <div class=\"p-l-16 p-r-16\">\n      <div class=\"panel m-t-8 m-b-8\" *ngIf=\"!items || items.length === 0\">\n        <div class=\"c8y-empty-state text-left\">\n          <h1 c8yIcon=\"{{ icon }} \" class=\"c8y-icon-duocolor\"></h1>\n          <p translate>No items to display.</p>\n        </div>\n      </div>\n    </div>\n    <c8y-list-group>\n      <c8y-li *ngFor=\"let item of listItems | selectModalFilterPipe: filterTerm\">\n        <c8y-li-icon>\n          <i c8yIcon=\"{{ icon }}\"></i>\n        </c8y-li-icon>\n\n        <c8y-li-body class=\"content-flex-30\">\n          <div class=\"col-9\">\n            <div *ngFor=\"let bodyPart of item.body\" [ngClass]=\"bodyPart.class\">\n              <c8y-highlight\n                [title]=\"bodyPart.value\"\n                [pattern]=\"filterTerm\"\n                [text]=\"bodyPart.value\"\n              ></c8y-highlight>\n            </div>\n          </div>\n\n          <div class=\"col-3 text-right\" *ngIf=\"item.additionalInformation\">\n            <div [ngClass]=\"item.additionalInformation.class\">\n              {{ item.additionalInformation.value }}\n            </div>\n          </div>\n        </c8y-li-body>\n\n        <c8y-li-collapse>\n          <c8y-list-group>\n            <c8y-li *ngFor=\"let option of item.options\">\n              <c8y-li-radio\n                [name]=\"mode === 'single' ? 'single' : item.groupId\"\n                [selected]=\"option.selected\"\n                (onSelect)=\"updateChoice({ item: item, id: option.obj.id })\"\n                [disabled]=\"option.disabled\"\n              >\n              </c8y-li-radio>\n              <c8y-li-body class=\"content-flex-50\">\n                <div\n                  *ngFor=\"let optionPart of option.body; let i = index\"\n                  [ngClass]=\"optionPart.class\"\n                >\n                  <c8y-highlight [pattern]=\"filterTerm\" [text]=\"optionPart.value\"></c8y-highlight>\n                </div>\n              </c8y-li-body>\n            </c8y-li>\n          </c8y-list-group>\n        </c8y-li-collapse>\n      </c8y-li>\n      <div *ngIf=\"areMoreEntries\">\n        <div class=\"alert alert-info m-t-16 m-r-8 m-l-8\" translate>\n          Some entries might not be shown. Try narrowing search criteria.\n        </div>\n      </div>\n    </c8y-list-group>\n  </div>\n\n  <div class=\"modal-footer\">\n    <button\n      title=\"{{ labels.cancel | translate }}\"\n      *ngIf=\"labels.cancel\"\n      class=\"btn btn-default\"\n      (click)=\"dismiss()\"\n    >\n      {{ labels.cancel | translate }}\n    </button>\n    <button\n      title=\"{{ labels.ok | translate }}\"\n      class=\"btn btn-primary\"\n      (click)=\"select()\"\n      [disabled]=\"!selected\"\n    >\n      {{ labels.ok | translate }}\n    </button>\n  </div>\n</div>\n"
        })
    ], SelectModalComponent);
    return SelectModalComponent;
}());
export { SelectModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL3NlbGVjdC1tb2RhbC9zZWxlY3QtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQWlCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0RixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBRUwsa0JBQWtCLEVBRW5CLE1BQU0sc0JBQXNCLENBQUM7QUFDOUIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVc5QztJQTBCRSw4QkFBb0IsVUFBc0I7UUFBMUMsaUJBSUM7UUFKbUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQXZCakMsYUFBUSxHQUFXLE9BQU8sQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO1FBRXJGLFNBQUksR0FBdUIsa0JBQWtCLENBQUMsS0FBSyxDQUFDO1FBQ3BELG9CQUFlLEdBQVksSUFBSSxDQUFDO1FBQ2hDLGVBQVUsR0FBWSxJQUFJLENBQUM7UUFDM0IsbUJBQWMsR0FBWSxLQUFLLENBQUM7UUFRL0IsV0FBTSxHQUE4QyxJQUFJLFlBQVksRUFFM0UsQ0FBQztRQUNNLFdBQU0sR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUNwRSxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLGVBQVUsR0FBVyxFQUFFLENBQUM7UUFDeEIsY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNQLGNBQVMsR0FBb0IsSUFBSSxPQUFP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Q3BEO1FBQVIsS0FBSyxFQUFFO2lFQUFpQztJQUNoQztRQUFSLEtBQUssRUFBRTs0REFBNEI7SUFDM0I7UUFBUixLQUFLLEVBQUU7Z0VBQWlDO0lBQ2hDO1FBQVIsS0FBSyxFQUFFO3NEQUdQO0lBSVM7UUFBVCxNQUFNLEVBQUU7d0RBRUw7SUFDTTtRQUFULE1BQU0sRUFBRTt3REFBMkQ7SUFuQnpELG9CQUFvQjtRQUpoQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsa0JBQWtCO1lBQzVCLGd2R0FBNEM7U0FDN0MsQ0FBQztPQUNXLG9CQUFvQixDQXFGaEM7SUFBRCwyQkFBQztDQUFBLEFBckZELElBcUZDO1NBckZZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIEV2ZW50RW1pdHRlciwgU2ltcGxlQ2hhbmdlcywgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcbmltcG9ydCB7IEJzTW9kYWxSZWYgfSBmcm9tICduZ3gtYm9vdHN0cmFwJztcbmltcG9ydCB7XG4gIElTZWxlY3RNb2RhbE9iamVjdCxcbiAgTW9kYWxTZWxlY3Rpb25Nb2RlLFxuICBNb2RhbExhYmVsc1xufSBmcm9tICcuL3NlbGVjdC1tb2RhbC5tb2RlbCc7XG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSUlkZW50aWZpZWQgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbmludGVyZmFjZSBJU2VsZWN0TW9kYWxJbnRlcm5hbE9iamVjdCBleHRlbmRzIElTZWxlY3RNb2RhbE9iamVjdCB7XG4gIHNlbGVjdGVkSWQ6IHN0cmluZyB8IG51bWJlcjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNlbGVjdC1tb2RhbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWxlY3QtbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNlbGVjdE1vZGFsQ29tcG9uZW50IHtcbiAgQElucHV0KCkgaWNvbjogc3RyaW5nO1xuICBASW5wdXQoKSB0aXRsZTogc3RyaW5nO1xuICBASW5wdXQoKSBzdWJUaXRsZTogc3RyaW5nID0gZ2V0dGV4dCgnU2VsZWN0IGZyb20gdGhlIGxpc3Qgb2YgaXRlbXMgbWF0Y2hpbmcgdGhlIGRldmljZSB0eXBlJyk7XG4gIEBJbnB1dCgpIGl0ZW1zOiBJU2VsZWN0TW9kYWxJbnRlcm5hbE9iamVjdFtdO1xuICBASW5wdXQoKSBtb2RlOiBNb2RhbFNlbGVjdGlvbk1vZGUgPSBNb2RhbFNlbGVjdGlvbk1vZGUuTVVMVEk7XG4gIEBJbnB1dCgpIGRpc2FibGVTZWxlY3RlZDogYm9vbGVhbiA9IHRydWU7XG4gIEBJbnB1dCgpIHNob3dGaWx0ZXI6IGJvb2xlYW4gPSB0cnVlO1xuICBASW5wdXQoKSBhcmVNb3JlRW50cmllczogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXQoKSBzZXQgbGFiZWxzKGxhYmVsczogTW9kYWxMYWJlbHMpIHtcbiAgICBjb25zdCB7IG9rID0gdGhpcy5sYWJlbHMub2ssIGNhbmNlbCA9IHRoaXMubGFiZWxzLmNhbmNlbCB9ID0gbGFiZWxzIHx8IHt9O1xuICAgIHRoaXMuX2xhYmVscyA9IHsgb2ssIGNhbmNlbCB9O1xuICB9XG4gIGdldCBsYWJlbHMoKTogTW9kYWxMYWJlbHMge1xuICAgIHJldHVybiB0aGlzLl9sYWJlbHM7XG4gIH1cbiAgQE91dHB1dCgpIHJlc3VsdDogRXZlbnRFbWl0dGVyPElJZGVudGlmaWVkIHwgSUlkZW50aWZpZWRbXT4gPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIElJZGVudGlmaWVkIHwgSUlkZW50aWZpZWRbXVxuICA+KCk7XG4gIEBPdXRwdXQoKSBzZWFyY2g6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gIHNlbGVjdGVkID0gZmFsc2U7XG4gIGZpbHRlclRlcm06IHN0cmluZyA9ICcnO1xuICBsaXN0SXRlbXMgPSBbXTtcbiAgcHJpdmF0ZSBkZWJvdW5jZXI6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBfbGFiZWxzOiBNb2RhbExhYmVscyA9IHsgb2s6IGdldHRleHQoJ0NvbmZpcm0nKSwgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKSB9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYnNNb2RhbFJlZjogQnNNb2RhbFJlZikge1xuICAgIHRoaXMuZGVib3VuY2VyLnBpcGUoZGVib3VuY2VUaW1lKDUwMCkpLnN1YnNjcmliZSh2YWx1ZSA9PiB7XG4gICAgICB0aGlzLnNlYXJjaC5lbWl0KHZhbHVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5pdGVtcyAmJiBjaGFuZ2VzLml0ZW1zLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgY29uc3QgaXRlbXNQcm9taXNlID0gY2hhbmdlcy5pdGVtcy5jdXJyZW50VmFsdWUubWFwKGFzeW5jIGl0ZW0gPT4ge1xuICAgICAgICBpdGVtLm9wdGlvbnMgPSBhd2FpdCBpdGVtLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gaXRlbS5vcHRpb25zLmZpbmQob3B0aW9uID0+IG9wdGlvbi5zZWxlY3RlZCk7XG4gICAgICAgIGlmIChzZWxlY3RlZCkge1xuICAgICAgICAgIGl0ZW0uc2VsZWN0ZWRJZCA9IHNlbGVjdGVkLm9iai5pZDtcbiAgICAgICAgICBpZiAodGhpcy5kaXNhYmxlU2VsZWN0ZWQpIHtcbiAgICAgICAgICAgIGl0ZW0ub3B0aW9ucy5tYXAob3B0aW9uID0+IGFzc2lnbihvcHRpb24sIHsgZGlzYWJsZWQ6IHRydWUgfSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5saXN0SXRlbXMgPSBhd2FpdCBQcm9taXNlLmFsbChpdGVtc1Byb21pc2UpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVBpcGUoZmlsdGVyVGVybTogc3RyaW5nKSB7XG4gICAgdGhpcy5kZWJvdW5jZXIubmV4dChmaWx0ZXJUZXJtKTtcbiAgICB0aGlzLmZpbHRlclRlcm0gPSBmaWx0ZXJUZXJtO1xuICB9XG5cbiAgdXBkYXRlQ2hvaWNlKHsgaXRlbSwgaWQgfSkge1xuICAgIGlmICh0aGlzLm1vZGUgPT09ICdzaW5nbGUnKSB7XG4gICAgICB0aGlzLmxpc3RJdGVtcy5tYXAodmFsdWUgPT4gKHZhbHVlLnNlbGVjdGVkSWQgPSB1bmRlZmluZWQpKTtcbiAgICB9XG4gICAgaXRlbS5zZWxlY3RlZElkID0gaWQ7XG4gICAgdGhpcy5zZWxlY3RlZCA9IHRydWU7XG4gIH1cblxuICBkaXNtaXNzKCkge1xuICAgIHRoaXMuYnNNb2RhbFJlZi5oaWRlKCk7XG4gIH1cblxuICBzZWxlY3QoKSB7XG4gICAgY29uc3Qgb3V0cHV0QXJyYXkgPSB0aGlzLmdldE91dHB1dCgpO1xuICAgIGNvbnN0IG91dHB1dCA9IHRoaXMubW9kZSA9PT0gJ3NpbmdsZScgPyBvdXRwdXRBcnJheVswXSA6IG91dHB1dEFycmF5O1xuICAgIHRoaXMucmVzdWx0LmVtaXQob3V0cHV0KTtcbiAgICB0aGlzLmJzTW9kYWxSZWYuaGlkZSgpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZWJvdW5jZXIuY29tcGxldGUoKTtcbiAgICB0aGlzLnJlc3VsdC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuc2VhcmNoLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIGdldE91dHB1dCgpOiBJSWRlbnRpZmllZCB8IElJZGVudGlmaWVkW10ge1xuICAgIHJldHVybiB0aGlzLmxpc3RJdGVtc1xuICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0uc2VsZWN0ZWRJZClcbiAgICAgIC5tYXAoaXRlbSA9PiBpdGVtLm9wdGlvbnMuZmluZChvcHRpb24gPT4gaXRlbS5zZWxlY3RlZElkID09PSBvcHRpb24ub2JqLmlkKSlcbiAgICAgIC5tYXAoc2VsZWN0ZWRPcHRpb24gPT4gc2VsZWN0ZWRPcHRpb24ub2JqKTtcbiAgfVxufVxuIl19