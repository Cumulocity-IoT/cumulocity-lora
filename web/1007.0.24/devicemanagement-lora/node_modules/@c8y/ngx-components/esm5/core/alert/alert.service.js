import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
var AlertService = /** @class */ (function (_super) {
    tslib_1.__extends(AlertService, _super);
    function AlertService() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.state$ = new BehaviorSubject([]);
        _this.MAX_ALERTS = 3;
        _this.ALERT_TIMEOUT = 3000;
        return _this;
    }
    Object.defineProperty(AlertService.prototype, "state", {
        /**
         * Returns all alerts.
         * @readonly
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Adds a new alert to the current state.
     */
    AlertService.prototype.add = function (alert) {
        this.addAlert(alert);
    };
    /**
     * Adds a alert by text.
     */
    AlertService.prototype.addByText = function (type, txt, detailedData) {
        this.addAlert({ text: txt, type: type, detailedData: detailedData });
    };
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    AlertService.prototype.list = function () {
        return this.state;
    };
    /**
     * Remove an alert from the current state.
     */
    AlertService.prototype.remove = function (alert) {
        var _this = this;
        this.changeAlerts(this.state.filter(function (item) { return !_this.areSame(alert, item); }));
    };
    /**
     * Updates matching alert with provided values.
     */
    AlertService.prototype.update = function (alert, fieldsToUpdate) {
        var _this = this;
        this.changeAlerts(this.state.map(function (item) {
            if (_this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    };
    /**
     * Removes last danger alert. Replacement for silentError.
     *
     * @example
     * ```typescript
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alarmService.removeLastDanger();
     *  }
     * ```
     */
    AlertService.prototype.removeLastDanger = function () {
        var firstDangerAlarm = this.state.reverse().find(function (_a) {
            var type = _a.type;
            return type === 'danger';
        });
        this.changeAlerts(this.state.filter(function (alarm) { return alarm !== firstDangerAlarm; }));
    };
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.saveSuccess = function (savedObject) {
        var _this = this;
        return function () {
            var text = savedObject + " saved successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.createSuccess = function (createdObject) {
        var _this = this;
        return function () {
            var text = createdObject + " created successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Clears all alerts.
     */
    AlertService.prototype.clearAll = function () {
        this.changeAlerts([]);
    };
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.success = function (text, detailedData) {
        this.addByText('success', text, detailedData);
    };
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.danger = function (text, detailedData) {
        this.addByText('danger', text, detailedData);
    };
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.info = function (text, detailedData) {
        this.addByText('info', text, detailedData);
    };
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.warning = function (text, detailedData) {
        this.addByText('warning', text, detailedData);
    };
    AlertService.prototype.addServerFailure = function (error, type) {
        if (type === void 0) { type = 'danger'; }
        var data = error.data, res = error.res;
        var text = data && data.message ? data.message : null;
        var detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        var hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type: type,
            text: text,
            detailedData: detailedData
        });
    };
    AlertService.prototype.areSame = function (alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            alert1.detailedData === alert2.detailedData &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    };
    AlertService.prototype.changeAlerts = function (newAlerts) {
        this.state$.next(newAlerts);
    };
    AlertService.prototype.addAlert = function (alert) {
        var _this = this;
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        var alertAlreadyAdded = this.state.find(function (item) { return _this.areSame(alert, item); });
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts(tslib_1.__spread(this.state, [alert]));
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    };
    AlertService.prototype.hideAutomaticallyIfNeeded = function (alert) {
        var _this = this;
        var isSuccess = alert.type === 'success';
        var noDetails = !alert.detailedData;
        var alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(function () { return _this.remove(alert); }, alertTimeout);
        }
    };
    AlertService.prototype.removeOldestIfMax = function () {
        if (this.state.length > this.MAX_ALERTS) {
            var _a = tslib_1.__read(this.state), firstRemoved = _a.slice(1);
            this.changeAlerts(firstRemoved);
        }
    };
    AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
    AlertService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        })
    ], AlertService);
    return AlertService;
}(StateService));
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDOztBQUcxQzs7R0FFRztBQUlIO0lBQWtDLHdDQUFZO0lBSDlDO1FBQUEscUVBNE5DO1FBak5DLFlBQU0sR0FBRyxJQUFJLGVBQWUsQ0FBVSxFQUFFLENBQUMsQ0FBQztRQUVsQyxnQkFBVSxHQUFHLENBQUMsQ0FBQztRQUNmLG1CQUFhLEdBQUcsSUFBSSxDQUFDOztLQThNOUI7SUFwTkMsc0JBQUksK0JBQUs7UUFKVDs7O1dBR0c7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDM0IsQ0FBQzs7O09BQUE7SUFNRDs7T0FFRztJQUNILDBCQUFHLEdBQUgsVUFBSSxLQUFZO1FBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQ0FBUyxHQUFULFVBQVUsSUFBZSxFQUFFLEdBQVcsRUFBRSxZQUFxQjtRQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLE1BQUEsRUFBRSxZQUFZLGNBQUEsRUFBRSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVEOzs7T0FHRztJQUNILDJCQUFJLEdBQUo7UUFDRSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsNkJBQU0s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QUFLLENBQUMsT0FBTyxDQUFDO1NBQzlCO1FBQ0QsSUFBSSxZQUFZLEVBQUU7WUFDaEIsVUFBVSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFsQixDQUFrQixFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztJQUVPLHdDQUFpQixHQUF6QjtRQUNFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxJQUFBLCtCQUFnQyxFQUE3QiwwQkFBNkIsQ0FBQztZQUN2QyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQzs7SUF4TlUsWUFBWTtRQUh4QixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1csWUFBWSxDQXlOeEI7dUJBdE9EO0NBc09DLEFBek5ELENBQWtDLFlBQVksR0F5TjdDO1NBek5ZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbGVydCB9IGZyb20gJy4vYWxlcnQubW9kZWwnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcblxudHlwZSBhbGVydFR5cGUgPSAnc3VjY2VzcycgfCAnd2FybmluZycgfCAnZGFuZ2VyJyB8ICdpbmZvJyB8ICdzeXN0ZW0nO1xuLyoqXG4gKiBBIHNlcnZpY2Ugd2hpY2ggYWxsb3dzIHRvIGRpc3BsYXkgYWxlcnRzLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBbGVydFNlcnZpY2UgZXh0ZW5kcyBTdGF0ZVNlcnZpY2Uge1xuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cbiAgc3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxBbGVydFtdPihbXSk7XG5cbiAgcHJpdmF0ZSBNQVhfQUxFUlRTID0gMztcbiAgcHJpdmF0ZSBBTEVSVF9USU1FT1VUID0gMzAwMDtcblxuICAvKipcbiAgICogQWRkcyBhIG5ldyBhbGVydCB0byB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIGFkZChhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmFkZEFsZXJ0KGFsZXJ0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgYWxlcnQgYnkgdGV4dC5cbiAgICovXG4gIGFkZEJ5VGV4dCh0eXBlOiBhbGVydFR5cGUsIHR4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmFkZEFsZXJ0KHsgdGV4dDogdHh0LCB0eXBlLCBkZXRhaWxlZERhdGEgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYWxlcnRTZXJ2aWNlLmFsZXJ0cyBpbnN0ZWFkLlxuICAgKi9cbiAgbGlzdCgpOiBBbGVydFtdIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYW4gYWxlcnQgZnJvbSB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIHJlbW92ZShhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcihpdGVtID0+ICF0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKSk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyBtYXRjaGluZyBhbGVydCB3aXRoIHByb3ZpZGVkIHZhbHVlcy5cbiAgICovXG4gIHVwZGF0ZShhbGVydDogQWxlcnQsIGZpZWxkc1RvVXBkYXRlOiBQYXJ0aWFsPEFsZXJ0Pikge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKFxuICAgICAgdGhpcy5zdGF0ZS5tYXAoaXRlbSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKSB7XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihpdGVtLCBmaWVsZHNUb1VwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBsYXN0IGRhbmdlciBhbGVydC4gUmVwbGFjZW1lbnQgZm9yIHNpbGVudEVycm9yLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqICB0cnkge1xuICAgKiAgICAvLyBzb21ldGhpbmcgdGhhdCBtaWdodCB0aHJvdyBhIGRhbmdlciBzZXJ2ZXIgbXNnXG4gICAqICB9IGNhdGNoIChleCkge1xuICAgKiAgIHRoaXMuYWxhcm1TZXJ2aWNlLnJlbW92ZUxhc3REYW5nZXIoKTtcbiAgICogIH1cbiAgICogYGBgXG4gICAqL1xuICByZW1vdmVMYXN0RGFuZ2VyKCkge1xuICAgIGNvbnN0IGZpcnN0RGFuZ2VyQWxhcm0gPSB0aGlzLnN0YXRlLnJldmVyc2UoKS5maW5kKCh7IHR5cGUgfSkgPT4gdHlwZSA9PT0gJ2RhbmdlcicpO1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKHRoaXMuc3RhdGUuZmlsdGVyKGFsYXJtID0+IGFsYXJtICE9PSBmaXJzdERhbmdlckFsYXJtKSk7XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIHNhdmUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIHNhdmVkT2JqZWN0IFRoZSBvYmplY3Qgd2hpY2ggd2FzIHNhdmVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgc2F2ZVN1Y2Nlc3Moc2F2ZWRPYmplY3Q6IHN0cmluZykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7c2F2ZWRPYmplY3R9IHNhdmVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIGNyZWF0ZSBzdWNjZXNzZnVsIGFsZXJ0LlxuICAgKiBAcGFyYW0gY3JlYXRlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBjcmVhdGVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgY3JlYXRlU3VjY2VzcyhjcmVhdGVkT2JqZWN0KSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRleHQgPSBgJHtjcmVhdGVkT2JqZWN0fSBjcmVhdGVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIGFsbCBhbGVydHMuXG4gICAqL1xuICBjbGVhckFsbCgpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbXSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBzdWNjZXNzIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBzdWNjZXNzIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgc3VjY2Vzcyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIGRhbmdlciBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgZGFuZ2VyIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgZGFuZ2VyKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ2RhbmdlcicsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBpbmZvIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBpbmZvIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgaW5mbyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdpbmZvJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIHdhcm5pbmcgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIHdhcm5pbmcgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICB3YXJuaW5nKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ3dhcm5pbmcnLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgYWRkU2VydmVyRmFpbHVyZShlcnJvcjogYW55LCB0eXBlOiBhbGVydFR5cGUgPSAnZGFuZ2VyJykge1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBlcnJvcjtcbiAgICBsZXQgdGV4dCA9IGRhdGEgJiYgZGF0YS5tZXNzYWdlID8gZGF0YS5tZXNzYWdlIDogbnVsbDtcbiAgICBsZXQgZGV0YWlsZWREYXRhO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGEuZXhjZXB0aW9uTWVzc2FnZTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGE7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhc1JlbGV2YW50TWVzc2FnZSA9ICEhKHRleHQgfHwgZGV0YWlsZWREYXRhKTtcbiAgICBpZiAoIXRleHQpIHtcbiAgICAgIHRleHQgPSBnZXR0ZXh0KCdBIHNlcnZlciBlcnJvciBvY2N1cnJlZC4nKTtcbiAgICB9XG4gICAgaWYgKCFoYXNSZWxldmFudE1lc3NhZ2UpIHtcbiAgICAgIGRldGFpbGVkRGF0YSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiByZXMuc3RhdHVzVGV4dCxcbiAgICAgICAgdXJsOiByZXMudXJsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuYWRkQWxlcnQoe1xuICAgICAgdHlwZSxcbiAgICAgIHRleHQsXG4gICAgICBkZXRhaWxlZERhdGFcbiAgICB9KTtcbiAgfVxuXG4gIGFyZVNhbWUoYWxlcnQxOiBBbGVydCwgYWxlcnQyOiBBbGVydCkge1xuICAgIHJldHVybiAoXG4gICAgICBhbGVydDEudGV4dCA9PT0gYWxlcnQyLnRleHQgJiZcbiAgICAgIGFsZXJ0MS50eXBlID09PSBhbGVydDIudHlwZSAmJlxuICAgICAgYWxlcnQxLmRldGFpbGVkRGF0YSA9PT0gYWxlcnQyLmRldGFpbGVkRGF0YSAmJlxuICAgICAgYWxlcnQxLm9uQ2xvc2UgPT09IGFsZXJ0Mi5vbkNsb3NlICYmXG4gICAgICBhbGVydDEub25EZXRhaWwgPT09IGFsZXJ0Mi5vbkRldGFpbFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNoYW5nZUFsZXJ0cyhuZXdBbGVydHM6IEFsZXJ0W10pIHtcbiAgICB0aGlzLnN0YXRlJC5uZXh0KG5ld0FsZXJ0cyk7XG4gIH1cblxuICBwcml2YXRlIGFkZEFsZXJ0KGFsZXJ0OiBBbGVydCk6IHZvaWQge1xuICAgIGlmICghYWxlcnQudGV4dCAmJiAhYWxlcnQudHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYWRkIGVtcHR5IGFsZXJ0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgYWxlcnRBbHJlYWR5QWRkZWQgPSB0aGlzLnN0YXRlLmZpbmQoaXRlbSA9PiB0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKTtcbiAgICBpZiAoYWxlcnRBbHJlYWR5QWRkZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbLi4udGhpcy5zdGF0ZSwgYWxlcnRdKTtcbiAgICB0aGlzLmhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQpO1xuICAgIHRoaXMucmVtb3ZlT2xkZXN0SWZNYXgoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGlkZUF1dG9tYXRpY2FsbHlJZk5lZWRlZChhbGVydDogQWxlcnQpIHtcbiAgICBjb25zdCBpc1N1Y2Nlc3MgPSBhbGVydC50eXBlID09PSAnc3VjY2Vzcyc7XG4gICAgY29uc3Qgbm9EZXRhaWxzID0gIWFsZXJ0LmRldGFpbGVkRGF0YTtcbiAgICBsZXQgYWxlcnRUaW1lb3V0ID0gaXNTdWNjZXNzICYmIG5vRGV0YWlscyA/IHRoaXMuQUxFUlRfVElNRU9VVCA6IDA7XG4gICAgaWYgKHR5cGVvZiBhbGVydC50aW1lb3V0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgYWxlcnRUaW1lb3V0ID0gYWxlcnQudGltZW91dDtcbiAgICB9XG4gICAgaWYgKGFsZXJ0VGltZW91dCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlbW92ZShhbGVydCksIGFsZXJ0VGltZW91dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVPbGRlc3RJZk1heCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiB0aGlzLk1BWF9BTEVSVFMpIHtcbiAgICAgIGNvbnN0IFssIC4uLmZpcnN0UmVtb3ZlZF0gPSB0aGlzLnN0YXRlO1xuICAgICAgdGhpcy5jaGFuZ2VBbGVydHMoZmlyc3RSZW1vdmVkKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==