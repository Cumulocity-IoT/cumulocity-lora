import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { IManagedObject, Realtime } from '@c8y/client';
import { DeviceConfigurationService } from './device-configuration.service';
import { RepositoryType, DeviceConfigurationOperation } from '../repository.model';
import { gettext } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
var DeviceConfigurationComponent = /** @class */ (function () {
    function DeviceConfigurationComponent(route, deviceConfigurationService, realtime, repositoryService) {
        var _this = this;
        this.route = route;
        this.deviceConfigurationService = deviceConfigurationService;
        this.realtime = realtime;
        this.repositoryService = repositoryService;
        this.supportedConfigurations = [];
        this.configSnapshot = {};
        this.reloading = false;
        this.deviceConfigurationService.configurationsUpdated.subscribe(function (repositorySnapsOnly) {
            _this.updateSnapshots(repositorySnapsOnly);
        });
    }
    DeviceConfigurationComponent.prototype.ngOnInit = function () {
        this.device = this.route.snapshot.parent.data.contextData;
        if (this.device.c8y_SupportedConfigurations) {
            this.supportedConfigurations = this.device.c8y_SupportedConfigurations.map(function (item) { return ({
                name: item
            }); });
        }
        if (this.deviceConfigurationService.hasAnySupportedOperation(this.device, [
            DeviceConfigurationOperation.DOWNLOAD_CONFIG,
            DeviceConfigurationOperation.UPLOAD_CONFIG
        ])) {
            this.supportedConfigurations.push({
                name: gettext('Legacy configuration snapshot'),
                isLegacy: true
            });
        }
        this.repositorySnapshotsEmptyState = {
            icon: 'gears',
            title: gettext('No configurations available.'),
            text: gettext('Add configuration to configuration repository')
        };
    };
    DeviceConfigurationComponent.prototype.onConfigTypeSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                this.configurationType = config.name;
                this.isLegacy = config.isLegacy;
                this.updateSnapshots();
                return [2 /*return*/];
            });
        });
    };
    DeviceConfigurationComponent.prototype.onRepositoryConfigSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binary, _a, ex_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.repositorySnapshot = {
                            id: config.id,
                            time: config.creationTime,
                            name: config.name,
                            binaryUrl: config.url,
                            deviceType: config.deviceType,
                            configurationType: config.configurationType
                        };
                        if (!config.url) return [3 /*break*/, 6];
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 5, , 6]);
                        return [4 /*yield*/, this.repositoryService.getBinaryFile(config.url, {
                                allowExternal: false
                            })];
                    case 2:
                        binary = _b.sent();
                        if (!binary) return [3 /*break*/, 4];
                        _a = this.repositorySnapshot;
                        return [4 /*yield*/, binary.text()];
                    case 3:
                        _a.binary = _b.sent();
                        _b.label = 4;
                    case 4: return [3 /*break*/, 6];
                    case 5:
                        ex_1 = _b.sent();
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.updateSnapshots = function (repositorySnapsOnly) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        this.reloading = true;
                        this.repositorySnapshot = undefined;
                        _a = this;
                        return [4 /*yield*/, this.getSnapshotsFromRepository(this.device, this.configurationType)];
                    case 1:
                        _a.repositorySnapshots = _d.sent();
                        if (!!repositorySnapsOnly) return [3 /*break*/, 6];
                        _b = this;
                        if (!this.isLegacy) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.repositoryService.getLegacyConfigSnapshot(this.device)];
                    case 2:
                        _c = _d.sent();
                        return [3 /*break*/, 5];
                    case 3: return [4 /*yield*/, this.repositoryService.getConfigSnapshot(this.device, this.configurationType)];
                    case 4:
                        _c = _d.sent();
                        _d.label = 5;
                    case 5:
                        _b.configSnapshot = _c;
                        _d.label = 6;
                    case 6:
                        this.reloading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.getSnapshotsFromRepository = function (device, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var searchQuery, res;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        searchQuery = this.repositoryService.getConfigurationTypeQuery(device, configurationType);
                        return [4 /*yield*/, this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION, {
                                query: searchQuery,
                                params: { pageSize: 100 }
                            })];
                    case 1:
                        res = _a.sent();
                        return [2 /*return*/, res.data];
                }
            });
        });
    };
    DeviceConfigurationComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: DeviceConfigurationService },
        { type: Realtime },
        { type: RepositoryService }
    ]; };
    DeviceConfigurationComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-device-configuration',
            template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"updateSnapshots()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class=\"card card--grid card--grid--fullpage grid__col--4-8 grid__row--6-6\">\n  <!-- DEVICE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-header separator\">\n      <h4 class=\"card-title\" translate>Configurations</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Device-supported configurations</span></h5>\n    </div>\n    <div class=\"p-r-16\">\n      <c8y-device-configuration-list\n        [items]=\"supportedConfigurations\"\n        [itemIcon]=\"'gears'\"\n        (configSelected)=\"onConfigTypeSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-header separator bg-gray-lighter hidden-xs hidden-sm\">\n      <h4>&nbsp;</h4>\n    </div>\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\"><span translate>Preview</span></h5>\n\n      <!-- EMPTY STATE -->\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small translate>Select a configuration to preview</small>\n        </p>\n      </div>\n\n      <!-- PREVIEW AVAILABLE STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"configurationType\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"configSnapshot\"\n        [canSaveSnapshot]=\"true\"\n        [operationToTrigger]=\"'c8y_UploadConfigFile'\"\n        [actionButtonText]=\"'Get snapshot from device' | translate\"\n        [actionButtonIcon]=\"'download'\"\n        [isLegacy]=\"isLegacy\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n\n  <!-- AVAILABLE SUPPORTED CONFIGURATIONS -->\n  <div class=\"card--grid__inner-scroll\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Available supported configurations</h5>\n    </div>\n\n    <!-- EMPTY STATE -->\n    <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n      <h1 [c8yIcon]=\"'gears'\"></h1>\n      <p>\n        <strong translate>No selection</strong><br />\n        <small translate>Select a configuration from the device-supported configuration list</small>\n      </p>\n    </div>\n    <div class=\"p-r-16\" *ngIf=\"configurationType\">\n      <c8y-device-configuration-list\n        [items]=\"repositorySnapshots\"\n        [itemIcon]=\"'file-text'\"\n        [emptyState]=\"repositorySnapshotsEmptyState\"\n        [isFilterEnabled]=\"true\"\n        (configSelected)=\"onRepositoryConfigSelected($event)\"\n      ></c8y-device-configuration-list>\n    </div>\n  </div>\n\n  <!-- CONFIGURATION PREVIEW -->\n  <div class=\"card--grid__inner-scroll bg-gray-lighter\">\n    <div class=\"card-block\">\n      <h5 class=\"legend form-block\" translate>Preview</h5>\n\n      <!-- EMPTY STATE -->\n\n      <div class=\"c8y-empty-state text-left\" *ngIf=\"!repositorySnapshot\">\n        <h1 [c8yIcon]=\"'file-text'\"></h1>\n        <p>\n          <strong translate>No configuration selected.</strong><br />\n          <small *ngIf=\"!configurationType; else noSnapshot\" translate\n            >Select a configuration to preview</small\n          >\n          <ng-template #noSnapshot>\n            <small translate>Select the configuration you want to preview</small>\n          </ng-template>\n        </p>\n      </div>\n\n      <!-- CONFIGURATION SELECTED STATE -->\n      <c8y-device-configuration-preview\n        *ngIf=\"repositorySnapshot\"\n        [device]=\"device\"\n        [configurationType]=\"configurationType\"\n        [configSnapshot]=\"repositorySnapshot\"\n        [operationToTrigger]=\"'c8y_DownloadConfigFile'\"\n        [actionButtonText]=\"'Send configuration to device' | translate\"\n        [actionButtonIcon]=\"'upload'\"\n        [isLegacy]=\"isLegacy\"\n      ></c8y-device-configuration-preview>\n    </div>\n  </div>\n</div>\n"
        })
    ], DeviceConfigurationComponent);
    return DeviceConfigurationComponent;
}());
export { DeviceConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5LyIsInNvdXJjZXMiOlsiY29uZmlndXJhdGlvbi1kZXZpY2UtdGFiL2RldmljZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDNUUsT0FBTyxFQUlMLGNBQWMsRUFDZCw0QkFBNEIsRUFDN0IsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFNMUQ7SUFXRSxzQ0FDVSxLQUFxQixFQUNyQiwwQkFBc0QsRUFDdEQsUUFBa0IsRUFDbEIsaUJBQW9DO1FBSjlDLGlCQVNDO1FBUlMsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFDckIsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFkOUMsNEJBQXVCLEdBQWlDLEVBQUUsQ0FBQztRQUUzRCxtQkFBYyxHQUFtQyxFQUFFLENBQUM7UUFNcEQsY0FBUyxHQUFZLEtBQUssQ0FBQztRQVF6QixJQUFJLENBQUMsMEJBQTBCLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLFVBQUEsbUJBQW1CO1lBQ2pGLEtBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQUMs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d0JBQy9CLHFCQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUE7O3dCQUFqRSxLQUFBLFNBQWlFLENBQUE7OzRCQUNqRSxxQkFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBQTs7d0JBQW5GLEtBQUEsU0FBbUYsQ0FBQTs7O3dCQUZ2RixHQUFLLGNBQWMsS0FFb0UsQ0FBQzs7O3dCQUUxRixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQzs7Ozs7S0FDeEI7SUFFYSxpRUFBMEIsR0FBeEMsVUFBeUMsTUFBTSxFQUFFLGlCQUFpQjs7Ozs7O3dCQUMxRCxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO3dCQUNwRixxQkFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMscUJBQXFCLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRTtnQ0FDM0YsS0FBSyxFQUFFLFdBQVc7Z0NBQ2xCLE1BQU0sRUFBRSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUU7NkJBQzFCLENBQUMsRUFBQTs7d0JBSEksR0FBRyxHQUFHLFNBR1Y7d0JBQ0Ysc0JBQU8sR0FBRyxDQUFDLElBQUksRUFBQzs7OztLQUNqQjs7Z0JBeEZnQixjQUFjO2dCQUNPLDBCQUEwQjtnQkFDNUMsUUFBUTtnQkFDQyxpQkFBaUI7O0lBZm5DLDRCQUE0QjtRQUp4QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsMEJBQTBCO1lBQ3BDLHUxSUFBb0Q7U0FDckQsQ0FBQztPQUNXLDRCQUE0QixDQXFHeEM7SUFBRCxtQ0FBQztDQUFBLEFBckdELElBcUdDO1NBckdZLDRCQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgUmVhbHRpbWUgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uc2VydmljZSc7XG5pbXBvcnQge1xuICBEZXZpY2VDb25maWd1cmF0aW9uTGlzdEVtcHR5U3RhdGUsXG4gIENvbmZpZ3VyYXRpb25TbmFwc2hvdCxcbiAgU3VwcG9ydGVkQ29uZmlndXJhdGlvbkl0ZW0sXG4gIFJlcG9zaXRvcnlUeXBlLFxuICBEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uXG59IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktZGV2aWNlLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERldmljZUNvbmZpZ3VyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBzdXBwb3J0ZWRDb25maWd1cmF0aW9uczogU3VwcG9ydGVkQ29uZmlndXJhdGlvbkl0ZW1bXSA9IFtdO1xuICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nO1xuICBjb25maWdTbmFwc2hvdDogUGFydGlhbDxDb25maWd1cmF0aW9uU25hcHNob3Q+ID0ge307XG4gIHJlcG9zaXRvcnlTbmFwc2hvdHM6IElNYW5hZ2VkT2JqZWN0W107XG4gIHJlcG9zaXRvcnlTbmFwc2hvdDogQ29uZmlndXJhdGlvblNuYXBzaG90O1xuICByZXBvc2l0b3J5U25hcHNob3RzRW1wdHlTdGF0ZTogRGV2aWNlQ29uZmlndXJhdGlvbkxpc3RFbXB0eVN0YXRlO1xuICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuICBpc0xlZ2FjeTogYm9vbGVhbjtcbiAgcmVsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBkZXZpY2VDb25maWd1cmF0aW9uU2VydmljZTogRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFsdGltZTogUmVhbHRpbWUsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5jb25maWd1cmF0aW9uc1VwZGF0ZWQuc3Vic2NyaWJlKHJlcG9zaXRvcnlTbmFwc09ubHkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVTbmFwc2hvdHMocmVwb3NpdG9yeVNuYXBzT25seSk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmRldmljZSA9IHRoaXMucm91dGUuc25hcHNob3QucGFyZW50LmRhdGEuY29udGV4dERhdGE7XG4gICAgaWYgKHRoaXMuZGV2aWNlLmM4eV9TdXBwb3J0ZWRDb25maWd1cmF0aW9ucykge1xuICAgICAgdGhpcy5zdXBwb3J0ZWRDb25maWd1cmF0aW9ucyA9IHRoaXMuZGV2aWNlLmM4eV9TdXBwb3J0ZWRDb25maWd1cmF0aW9ucy5tYXAoaXRlbSA9PiAoe1xuICAgICAgICBuYW1lOiBpdGVtXG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5oYXNBbnlTdXBwb3J0ZWRPcGVyYXRpb24odGhpcy5kZXZpY2UsIFtcbiAgICAgICAgRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbi5ET1dOTE9BRF9DT05GSUcsXG4gICAgICAgIERldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uVVBMT0FEX0NPTkZJR1xuICAgICAgXSlcbiAgICApIHtcbiAgICAgIHRoaXMuc3VwcG9ydGVkQ29uZmlndXJhdGlvbnMucHVzaCh7XG4gICAgICAgIG5hbWU6IGdldHRleHQoJ0xlZ2FjeSBjb25maWd1cmF0aW9uIHNuYXBzaG90JyksXG4gICAgICAgIGlzTGVnYWN5OiB0cnVlXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdHNFbXB0eVN0YXRlID0ge1xuICAgICAgaWNvbjogJ2dlYXJzJyxcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdObyBjb25maWd1cmF0aW9ucyBhdmFpbGFibGUuJyksXG4gICAgICB0ZXh0OiBnZXR0ZXh0KCdBZGQgY29uZmlndXJhdGlvbiB0byBjb25maWd1cmF0aW9uIHJlcG9zaXRvcnknKVxuICAgIH07XG4gIH1cblxuICBhc3luYyBvbkNvbmZpZ1R5cGVTZWxlY3RlZChjb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25UeXBlID0gY29uZmlnLm5hbWU7XG4gICAgdGhpcy5pc0xlZ2FjeSA9IGNvbmZpZy5pc0xlZ2FjeTtcbiAgICB0aGlzLnVwZGF0ZVNuYXBzaG90cygpO1xuICB9XG5cbiAgYXN5bmMgb25SZXBvc2l0b3J5Q29uZmlnU2VsZWN0ZWQoY29uZmlnKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3QgPSB7XG4gICAgICBpZDogY29uZmlnLmlkLFxuICAgICAgdGltZTogY29uZmlnLmNyZWF0aW9uVGltZSxcbiAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLFxuICAgICAgYmluYXJ5VXJsOiBjb25maWcudXJsLFxuICAgICAgZGV2aWNlVHlwZTogY29uZmlnLmRldmljZVR5cGUsXG4gICAgICBjb25maWd1cmF0aW9uVHlwZTogY29uZmlnLmNvbmZpZ3VyYXRpb25UeXBlXG4gICAgfTtcbiAgICBpZiAoY29uZmlnLnVybCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYmluYXJ5ID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRCaW5hcnlGaWxlKGNvbmZpZy51cmwsIHtcbiAgICAgICAgICBhbGxvd0V4dGVybmFsOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGJpbmFyeSkge1xuICAgICAgICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90LmJpbmFyeSA9IGF3YWl0IChiaW5hcnkgYXMgYW55KS50ZXh0KCk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGVTbmFwc2hvdHMocmVwb3NpdG9yeVNuYXBzT25seT86IGJvb2xlYW4pIHtcbiAgICB0aGlzLnJlbG9hZGluZyA9IHRydWU7XG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3QgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3RzID0gYXdhaXQgdGhpcy5nZXRTbmFwc2hvdHNGcm9tUmVwb3NpdG9yeShcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgdGhpcy5jb25maWd1cmF0aW9uVHlwZVxuICAgICk7XG4gICAgaWYgKCFyZXBvc2l0b3J5U25hcHNPbmx5KSB7XG4gICAgICB0aGlzLmNvbmZpZ1NuYXBzaG90ID0gdGhpcy5pc0xlZ2FjeVxuICAgICAgICA/IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0TGVnYWN5Q29uZmlnU25hcHNob3QodGhpcy5kZXZpY2UpXG4gICAgICAgIDogYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRDb25maWdTbmFwc2hvdCh0aGlzLmRldmljZSwgdGhpcy5jb25maWd1cmF0aW9uVHlwZSk7XG4gICAgfVxuICAgIHRoaXMucmVsb2FkaW5nID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFNuYXBzaG90c0Zyb21SZXBvc2l0b3J5KGRldmljZSwgY29uZmlndXJhdGlvblR5cGUpIHtcbiAgICBjb25zdCBzZWFyY2hRdWVyeSA9IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0Q29uZmlndXJhdGlvblR5cGVRdWVyeShkZXZpY2UsIGNvbmZpZ3VyYXRpb25UeXBlKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmxpc3RSZXBvc2l0b3J5RW50cmllcyhSZXBvc2l0b3J5VHlwZS5DT05GSUdVUkFUSU9OLCB7XG4gICAgICBxdWVyeTogc2VhcmNoUXVlcnksXG4gICAgICBwYXJhbXM6IHsgcGFnZVNpemU6IDEwMCB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcy5kYXRhO1xuICB9XG59XG4iXX0=