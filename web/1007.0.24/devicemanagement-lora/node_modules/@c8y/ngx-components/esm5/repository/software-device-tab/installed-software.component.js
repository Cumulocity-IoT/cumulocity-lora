import * as tslib_1 from "tslib";
import { Component, Output, Input, EventEmitter } from '@angular/core';
import { from, of } from 'rxjs';
import { shareReplay, map, switchMap, distinctUntilChanged } from 'rxjs/operators';
import { BsModalService } from 'ngx-bootstrap/modal';
import { IManagedObject, InventoryService, IOperation } from '@c8y/client';
import { gettext, ModalSelectionMode } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
import { RepositoryType } from './../repository.model';
import { RepositorySelectModalComponent } from '../select-modal/repository-select-modal.component';
var InstalledSoftwareComponent = /** @class */ (function () {
    function InstalledSoftwareComponent(repository, inventory, bsModal) {
        this.repository = repository;
        this.inventory = inventory;
        this.bsModal = bsModal;
        this.changes = new EventEmitter();
    }
    InstalledSoftwareComponent.prototype.installSoftware = function () {
        var _this = this;
        this.displaySoftwareSelectModal({
            title: gettext('Install software'),
            labels: { ok: gettext('Install') },
            repositoryEntriesWithVersions$: of([]),
            repositoryEntriesWithVersionsFn$: function (modal) {
                return _this.getAllSoftwaresWithVersions$(modal.content.searchTerm);
            }
        }).subscribe(function (softwareToInstall) {
            _this.emitSoftwareInstall(softwareToInstall);
        });
    };
    InstalledSoftwareComponent.prototype.updateSoftware = function (softwareToRemove) {
        var _this = this;
        this.displaySoftwareSelectModal({
            title: gettext('Update software'),
            labels: { ok: gettext('Update') },
            showFilter: false,
            repositoryEntriesWithVersions$: this.getSingleSoftwareWithVersions$(softwareToRemove)
        }).subscribe(function (softwareToInstall) {
            _this.emitSoftwareUpdate(softwareToRemove, softwareToInstall);
        });
    };
    InstalledSoftwareComponent.prototype.removeSoftware = function (softwareToRemove) {
        this.emitSoftwareRemoval(softwareToRemove);
    };
    InstalledSoftwareComponent.prototype.getAllSoftwaresWithVersions$ = function (searchTerm$) {
        var _this = this;
        return searchTerm$.pipe(distinctUntilChanged(), switchMap(function (searchTerm) {
            return _this.repository.listRepositoryEntries(RepositoryType.SOFTWARE, {
                query: _this.deviceTypeQuery,
                partialName: searchTerm,
                params: { pageSize: 100 }
            });
        }), map(function (_a) {
            var data = _a.data;
            return data;
        }), map(function (softwares) { return _this.attachVersions(softwares); }), shareReplay(1));
    };
    InstalledSoftwareComponent.prototype.getSingleSoftwareWithVersions$ = function (software) {
        var _this = this;
        return from(this.repository.listRepositoryEntries(RepositoryType.SOFTWARE, {
            query: { name: software.name }
        })).pipe(map(function (_a) {
            var data = _a.data;
            return data;
        }), map(function (softwares) { return _this.attachVersions(softwares); }), shareReplay(1));
    };
    InstalledSoftwareComponent.prototype.attachVersions = function (softwares) {
        var _this = this;
        softwares.forEach(function (software) {
            software.versions = _this.repository.listBaseVersions(software);
        });
        return softwares;
    };
    InstalledSoftwareComponent.prototype.displaySoftwareSelectModal = function (initialStateOverrides) {
        var initialState = tslib_1.__assign({ repositoryType: RepositoryType.SOFTWARE, subTitle: gettext('Available softwares matching the device type'), mode: ModalSelectionMode.SINGLE, icon: 'c8y-tools', disableSelected: false, selected: this.softwareList }, initialStateOverrides);
        var modal = this.bsModal.show(RepositorySelectModalComponent, {
            ignoreBackdropClick: true,
            class: 'modal-sm',
            initialState: initialState
        });
        if (initialStateOverrides.repositoryEntriesWithVersionsFn$) {
            modal.content.repositoryEntriesWithVersions$ = initialStateOverrides.repositoryEntriesWithVersionsFn$(modal);
        }
        modal.content.load.next();
        return modal.content.resultEmitter;
    };
    InstalledSoftwareComponent.prototype.emitSoftwareInstall = function (_a) {
        var name = _a.name, version = _a.version, url = _a.url;
        this.changes.emit([{ name: name, version: version, url: url, action: 'install' }]);
    };
    InstalledSoftwareComponent.prototype.emitSoftwareUpdate = function (softwareToRemove, softwareToInstall) {
        this.emitSoftwareRemoval(softwareToRemove);
        this.emitSoftwareInstall(softwareToInstall);
    };
    InstalledSoftwareComponent.prototype.emitSoftwareRemoval = function (_a) {
        var name = _a.name, version = _a.version, url = _a.url;
        this.changes.emit([{ name: name, version: version, url: url, action: 'delete' }]);
    };
    InstalledSoftwareComponent.ctorParameters = function () { return [
        { type: RepositoryService },
        { type: InventoryService },
        { type: BsModalService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], InstalledSoftwareComponent.prototype, "softwareList", void 0);
    tslib_1.__decorate([
        Input()
    ], InstalledSoftwareComponent.prototype, "deviceSoftwareChanges", void 0);
    tslib_1.__decorate([
        Input()
    ], InstalledSoftwareComponent.prototype, "deviceSoftwareChangesOperation", void 0);
    tslib_1.__decorate([
        Input()
    ], InstalledSoftwareComponent.prototype, "deviceSoftwareChangesInProgress", void 0);
    tslib_1.__decorate([
        Input()
    ], InstalledSoftwareComponent.prototype, "deviceTypeQuery", void 0);
    tslib_1.__decorate([
        Output()
    ], InstalledSoftwareComponent.prototype, "changes", void 0);
    InstalledSoftwareComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-installed-software',
            template: "<div class=\"card\">\n  <div class=\"card-header separator\">\n    <h4 class=\"card-title\" translate>Installed software</h4>\n  </div>\n\n  <fieldset *ngIf=\"deviceSoftwareChangesOperation\" class=\"card-block bg-gray-white\">\n    <c8y-single-operation [operation]=\"deviceSoftwareChangesOperation\"></c8y-single-operation>\n  </fieldset>\n\n  <fieldset>\n    <!-- EMPTY STATE -->\n    <div class=\"card-block\" *ngIf=\"softwareList.length === 0\">\n      <div class=\"c8y-empty-state text-center m-t-16\">\n        <h1 class=\"c8y-icon c8y-icon-tools c8y-icon-duocolor\"></h1>\n        <p>\n          <strong translate>No software installed.</strong> <br />\n          <small translate>Click below to install software into this device.</small>\n        </p>\n      </div>\n    </div>\n\n    <!-- NOT EMPTY STATE -->\n    <ng-container *ngIf=\"softwareList.length > 0\">\n      <c8y-device-software-list\n        [softwareList]=\"softwareList\"\n        [deviceSoftwareChanges]=\"deviceSoftwareChanges\"\n        (update)=\"updateSoftware($event)\"\n        (remove)=\"removeSoftware($event)\"\n        class=\"d-block p-l-16 p-r-16\"\n      >\n      </c8y-device-software-list>\n    </ng-container>\n  </fieldset>\n\n  <!-- INSTALL SOFTWARE-->\n  <div class=\"card-footer\">\n    <button\n      class=\"btn btn-add-block m-0\"\n      title=\"{{ 'Install software' | translate }}\"\n      (click)=\"installSoftware()\"\n      [disabled]=\"deviceSoftwareChangesInProgress\"\n    >\n      <i c8yIcon=\"plus-circle\"></i>\n      {{ 'Install software' | translate }}\n    </button>\n  </div>\n</div>\n"
        })
    ], InstalledSoftwareComponent);
    return InstalledSoftwareComponent;
}());
export { InstalledSoftwareComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVkLXNvZnR3YXJlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbInNvZnR3YXJlLWRldmljZS10YWIvaW5zdGFsbGVkLXNvZnR3YXJlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBbUIsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQXdDLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzdGLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBTW5HO0lBUUUsb0NBQ1UsVUFBNkIsRUFDN0IsU0FBMkIsRUFDM0IsT0FBdUI7UUFGdkIsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7UUFDN0IsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFMdkIsWUFBTyxHQUFHLElBQUksWUFBWSxFQUEwQixDQUFDO0lBTTVELENBQUM7SUFFSixvREFBZSxHQUFmO1FBQUEsaUJBVUM7UUFUQyxJQUFJ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QixHQUFsQixVQUFtQixnQkFBZ0IsRUFBRSxpQkFBaUI7UUFDcEQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELHdEQUFtQixHQUFuQixVQUFvQixFQUFzQjtZQUFwQixjQUFJLEVBQUUsb0JBQU8sRUFBRSxZQUFHO1FBQ3RDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLE1BQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxHQUFHLEtBQUEsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7O2dCQXhHcUIsaUJBQWlCO2dCQUNsQixnQkFBZ0I7Z0JBQ2xCLGNBQWM7O0lBVnhCO1FBQVIsS0FBSyxFQUFFO29FQUFnQztJQUMvQjtRQUFSLEtBQUssRUFBRTs2RUFBK0M7SUFDOUM7UUFBUixLQUFLLEVBQUU7c0ZBQTRDO0lBQzNDO1FBQVIsS0FBSyxFQUFFO3VGQUEwQztJQUN6QztRQUFSLEtBQUssRUFBRTt1RUFBeUI7SUFDdkI7UUFBVCxNQUFNLEVBQUU7K0RBQXNEO0lBTnBELDBCQUEwQjtRQUp0QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsd0JBQXdCO1lBQ2xDLDJrREFBZ0Q7U0FDakQsQ0FBQztPQUNXLDBCQUEwQixDQWtIdEM7SUFBRCxpQ0FBQztDQUFBLEFBbEhELElBa0hDO1NBbEhZLDBCQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT3V0cHV0LCBJbnB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tLCBvZiwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzaGFyZVJlcGxheSwgbWFwLCBzd2l0Y2hNYXAsIGRpc3RpbmN0VW50aWxDaGFuZ2VkIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlLCBJT3BlcmF0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCwgTW9kYWxTZWxlY3Rpb25Nb2RlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5U2VydmljZSB9IGZyb20gJy4uL3JlcG9zaXRvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBEZXZpY2VTb2Z0d2FyZSwgRGV2aWNlU29mdHdhcmVDaGFuZ2UsIFJlcG9zaXRvcnlUeXBlIH0gZnJvbSAnLi8uLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCB9IGZyb20gJy4uL3NlbGVjdC1tb2RhbC9yZXBvc2l0b3J5LXNlbGVjdC1tb2RhbC5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktaW5zdGFsbGVkLXNvZnR3YXJlJyxcbiAgdGVtcGxhdGVVcmw6ICdpbnN0YWxsZWQtc29mdHdhcmUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEluc3RhbGxlZFNvZnR3YXJlQ29tcG9uZW50IHtcbiAgQElucHV0KCkgc29mdHdhcmVMaXN0OiBEZXZpY2VTb2Z0d2FyZVtdO1xuICBASW5wdXQoKSBkZXZpY2VTb2Z0d2FyZUNoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW107XG4gIEBJbnB1dCgpIGRldmljZVNvZnR3YXJlQ2hhbmdlc09wZXJhdGlvbjogSU9wZXJhdGlvbjtcbiAgQElucHV0KCkgZGV2aWNlU29mdHdhcmVDaGFuZ2VzSW5Qcm9ncmVzczogYm9vbGVhbjtcbiAgQElucHV0KCkgZGV2aWNlVHlwZVF1ZXJ5OiBvYmplY3Q7XG4gIEBPdXRwdXQoKSBjaGFuZ2VzID0gbmV3IEV2ZW50RW1pdHRlcjxEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsOiBCc01vZGFsU2VydmljZVxuICApIHt9XG5cbiAgaW5zdGFsbFNvZnR3YXJlKCkge1xuICAgIHRoaXMuZGlzcGxheVNvZnR3YXJlU2VsZWN0TW9kYWwoe1xuICAgICAgdGl0bGU6IGdldHRleHQoJ0luc3RhbGwgc29mdHdhcmUnKSxcbiAgICAgIGxhYmVsczogeyBvazogZ2V0dGV4dCgnSW5zdGFsbCcpIH0sXG4gICAgICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IG9mKFtdKSxcbiAgICAgIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zRm4kOiBtb2RhbCA9PlxuICAgICAgICB0aGlzLmdldEFsbFNvZnR3YXJlc1dpdGhWZXJzaW9ucyQobW9kYWwuY29udGVudC5zZWFyY2hUZXJtKVxuICAgIH0pLnN1YnNjcmliZShzb2Z0d2FyZVRvSW5zdGFsbCA9PiB7XG4gICAgICB0aGlzLmVtaXRTb2Z0d2FyZUluc3RhbGwoc29mdHdhcmVUb0luc3RhbGwpO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlU29mdHdhcmUoc29mdHdhcmVUb1JlbW92ZSkge1xuICAgIHRoaXMuZGlzcGxheVNvZnR3YXJlU2VsZWN0TW9kYWwoe1xuICAgICAgdGl0bGU6IGdldHRleHQoJ1VwZGF0ZSBzb2Z0d2FyZScpLFxuICAgICAgbGFiZWxzOiB7IG9rOiBnZXR0ZXh0KCdVcGRhdGUnKSB9LFxuICAgICAgc2hvd0ZpbHRlcjogZmFsc2UsXG4gICAgICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IHRoaXMuZ2V0U2luZ2xlU29mdHdhcmVXaXRoVmVyc2lvbnMkKHNvZnR3YXJlVG9SZW1vdmUpXG4gICAgfSkuc3Vic2NyaWJlKHNvZnR3YXJlVG9JbnN0YWxsID0+IHtcbiAgICAgIHRoaXMuZW1pdFNvZnR3YXJlVXBkYXRlKHNvZnR3YXJlVG9SZW1vdmUsIHNvZnR3YXJlVG9JbnN0YWxsKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJlbW92ZVNvZnR3YXJlKHNvZnR3YXJlVG9SZW1vdmUpIHtcbiAgICB0aGlzLmVtaXRTb2Z0d2FyZVJlbW92YWwoc29mdHdhcmVUb1JlbW92ZSk7XG4gIH1cblxuICBnZXRBbGxTb2Z0d2FyZXNXaXRoVmVyc2lvbnMkKHNlYXJjaFRlcm0kOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPikge1xuICAgIHJldHVybiBzZWFyY2hUZXJtJC5waXBlKFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHN3aXRjaE1hcChzZWFyY2hUZXJtID0+XG4gICAgICAgIHRoaXMucmVwb3NpdG9yeS5saXN0UmVwb3NpdG9yeUVudHJpZXMoUmVwb3NpdG9yeVR5cGUuU09GVFdBUkUsIHtcbiAgICAgICAgICBxdWVyeTogdGhpcy5kZXZpY2VUeXBlUXVlcnksXG4gICAgICAgICAgcGFydGlhbE5hbWU6IHNlYXJjaFRlcm0sXG4gICAgICAgICAgcGFyYW1zOiB7IHBhZ2VTaXplOiAxMDAgfVxuICAgICAgICB9KVxuICAgICAgKSxcbiAgICAgIG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpLFxuICAgICAgbWFwKHNvZnR3YXJlcyA9PiB0aGlzLmF0dGFjaFZlcnNpb25zKHNvZnR3YXJlcykpLFxuICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICApO1xuICB9XG5cbiAgZ2V0U2luZ2xlU29mdHdhcmVXaXRoVmVyc2lvbnMkKHNvZnR3YXJlOiBEZXZpY2VTb2Z0d2FyZSkge1xuICAgIHJldHVybiBmcm9tKFxuICAgICAgdGhpcy5yZXBvc2l0b3J5Lmxpc3RSZXBvc2l0b3J5RW50cmllcyhSZXBvc2l0b3J5VHlwZS5TT0ZUV0FSRSwge1xuICAgICAgICBxdWVyeTogeyBuYW1lOiBzb2Z0d2FyZS5uYW1lIH1cbiAgICAgIH0pXG4gICAgKS5waXBlKFxuICAgICAgbWFwKCh7IGRhdGEgfSkgPT4gZGF0YSksXG4gICAgICBtYXAoc29mdHdhcmVzID0+IHRoaXMuYXR0YWNoVmVyc2lvbnMoc29mdHdhcmVzKSksXG4gICAgICBzaGFyZVJlcGxheSgxKVxuICAgICk7XG4gIH1cblxuICBhdHRhY2hWZXJzaW9ucyhzb2Z0d2FyZXM6IElNYW5hZ2VkT2JqZWN0W10pIHtcbiAgICBzb2Z0d2FyZXMuZm9yRWFjaChzb2Z0d2FyZSA9PiB7XG4gICAgICBzb2Z0d2FyZS52ZXJzaW9ucyA9IHRoaXMucmVwb3NpdG9yeS5saXN0QmFzZVZlcnNpb25zKHNvZnR3YXJlKTtcbiAgICB9KTtcbiAgICByZXR1cm4gc29mdHdhcmVzO1xuICB9XG5cbiAgZGlzcGxheVNvZnR3YXJlU2VsZWN0TW9kYWwoaW5pdGlhbFN0YXRlT3ZlcnJpZGVzKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLlNPRlRXQVJFLFxuICAgICAgc3ViVGl0bGU6IGdldHRleHQoJ0F2YWlsYWJsZSBzb2Z0d2FyZXMgbWF0Y2hpbmcgdGhlIGRldmljZSB0eXBlJyksXG4gICAgICBtb2RlOiBNb2RhbFNlbGVjdGlvbk1vZGUuU0lOR0xFLFxuICAgICAgaWNvbjogJ2M4eS10b29scycsXG4gICAgICBkaXNhYmxlU2VsZWN0ZWQ6IGZhbHNlLFxuICAgICAgc2VsZWN0ZWQ6IHRoaXMuc29mdHdhcmVMaXN0LFxuICAgICAgLi4uaW5pdGlhbFN0YXRlT3ZlcnJpZGVzXG4gICAgfTtcbiAgICBjb25zdCBtb2RhbCA9IHRoaXMuYnNNb2RhbC5zaG93KFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCwge1xuICAgICAgaWdub3JlQmFja2Ryb3BDbGljazogdHJ1ZSxcbiAgICAgIGNsYXNzOiAnbW9kYWwtc20nLFxuICAgICAgaW5pdGlhbFN0YXRlXG4gICAgfSk7XG5cbiAgICBpZiAoaW5pdGlhbFN0YXRlT3ZlcnJpZGVzLnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zRm4kKSB7XG4gICAgICBtb2RhbC5jb250ZW50LnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCA9IGluaXRpYWxTdGF0ZU92ZXJyaWRlcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9uc0ZuJChcbiAgICAgICAgbW9kYWxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbW9kYWwuY29udGVudC5sb2FkLm5leHQoKTtcbiAgICByZXR1cm4gbW9kYWwuY29udGVudC5yZXN1bHRFbWl0dGVyO1xuICB9XG5cbiAgZW1pdFNvZnR3YXJlSW5zdGFsbCh7IG5hbWUsIHZlcnNpb24sIHVybCB9KSB7XG4gICAgdGhpcy5jaGFuZ2VzLmVtaXQoW3sgbmFtZSwgdmVyc2lvbiwgdXJsLCBhY3Rpb246ICdpbnN0YWxsJyB9XSk7XG4gIH1cblxuICBlbWl0U29mdHdhcmVVcGRhdGUoc29mdHdhcmVUb1JlbW92ZSwgc29mdHdhcmVUb0luc3RhbGwpIHtcbiAgICB0aGlzLmVtaXRTb2Z0d2FyZVJlbW92YWwoc29mdHdhcmVUb1JlbW92ZSk7XG4gICAgdGhpcy5lbWl0U29mdHdhcmVJbnN0YWxsKHNvZnR3YXJlVG9JbnN0YWxsKTtcbiAgfVxuXG4gIGVtaXRTb2Z0d2FyZVJlbW92YWwoeyBuYW1lLCB2ZXJzaW9uLCB1cmwgfSkge1xuICAgIHRoaXMuY2hhbmdlcy5lbWl0KFt7IG5hbWUsIHZlcnNpb24sIHVybCwgYWN0aW9uOiAnZGVsZXRlJyB9XSk7XG4gIH1cbn1cbiJdfQ==