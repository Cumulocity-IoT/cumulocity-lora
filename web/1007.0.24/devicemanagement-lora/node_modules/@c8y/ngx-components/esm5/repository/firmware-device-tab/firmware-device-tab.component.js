import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { assign, isEmpty } from 'lodash-es';
import { BsModalService } from 'ngx-bootstrap/modal';
import { BehaviorSubject, combineLatest, from, of } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, switchMap, take } from 'rxjs/operators';
import { ModalSelectionMode, gettext } from '@c8y/ngx-components';
import { IManagedObject, IOperation, InventoryService, OperationStatus } from '@c8y/client';
import { RepositoryService } from '../repository.service';
import { RepositoryType } from '../repository.model';
import { RepositorySelectModalComponent } from '../select-modal/repository-select-modal.component';
var FirmwareDeviceTabComponent = /** @class */ (function () {
    function FirmwareDeviceTabComponent(route, repository, inventory, bsModal) {
        var _this = this;
        this.route = route;
        this.repository = repository;
        this.inventory = inventory;
        this.bsModal = bsModal;
        this.device$ = new BehaviorSubject(this.route.parent.snapshot.data.contextData);
        this.reloading = false;
        this.deviceFirmwareFragment$ = this.device$.pipe(map(function (device) { return device.c8y_Firmware; }));
        this.firmwareBinary$ = this.deviceFirmwareFragment$.pipe(filter(function (deviceFirmwareFragment) { return !isEmpty(deviceFirmwareFragment); }), switchMap(function (deviceFirmwareFragment) {
            return from(_this.repository.getRepositoryBinaryMoByVersion(deviceFirmwareFragment, RepositoryType.FIRMWARE));
        }), shareReplay(1));
        this.repositoryEntry$ = this.firmwareBinary$.pipe(switchMap(function (mo) { return _this.repository.getRepositoryEntryMO$(mo); }), shareReplay(1));
        this.patches$ = combineLatest(this.firmwareBinary$, this.repositoryEntry$).pipe(switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 2), firmwareBinary = _b[0], repositoryEntry = _b[1];
            if (repositoryEntry && firmwareBinary) {
                var version = _this.repository.getBaseVersionFromMO(firmwareBinary);
                return from(_this.repository.listPatchVersions(repositoryEntry, version)).pipe(map(function (_a) {
                    var data = _a.data;
                    return data;
                }));
            }
            else {
                return of([]);
            }
        }), shareReplay(1));
        this.changesOperation$ = new BehaviorSubject(null);
        this.changesInProgress$ = this.changesOperation$.pipe(map(function (operation) { return _this.isInProgress(operation); }));
    }
    FirmwareDeviceTabComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: 
                    // TODO check route snapshot, why is not refreshing device.
                    // Scanario: missing deviceFirmwareFragment => install new version => switch tabs.
                    // Expected: device should be set.
                    return [4 /*yield*/, this.loadDevice()];
                    case 1:
                        // TODO check route snapshot, why is not refreshing device.
                        // Scanario: missing deviceFirmwareFragment => install new version => switch tabs.
                        // Expected: device should be set.
                        _a.sent();
                        return [4 /*yield*/, this.loadOperation()];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    FirmwareDeviceTabComponent.prototype.installFirmware = function () {
        var _this = this;
        var initialState = {
            repositoryEntriesWithVersions$: of([]),
            repositoryEntriesWithVersionsFn$: function (modal) {
                return _this.getRepositoryEntriesWithVersions$(modal.content.searchTerm);
            },
            repositoryType: RepositoryType.FIRMWARE,
            title: gettext('Install firmware'),
            subTitle: gettext('Available firmwares matching the device type'),
            icon: 'c8y-firmware',
            mode: ModalSelectionMode.SINGLE,
            labels: { ok: gettext('Install') },
            disableSelected: false
        };
        this.deviceFirmwareFragment$
            .pipe(take(1), switchMap(function (deviceFirmwareFragment) {
            if (deviceFirmwareFragment) {
                var name_1 = deviceFirmwareFragment.name, version = deviceFirmwareFragment.version;
                var selected = [{ name: name_1, version: version }];
                assign(initialState, { selected: selected });
            }
            var modal = _this.bsModal.show(RepositorySelectModalComponent, {
                ignoreBackdropClick: true,
                initialState: initialState
            });
            if (initialState.repositoryEntriesWithVersionsFn$) {
                modal.content.repositoryEntriesWithVersions$ = initialState.repositoryEntriesWithVersionsFn$(modal);
            }
            modal.content.load.next();
            return modal.content.resultEmitter;
        }))
            .subscribe(function (selectedOption) {
            _this.handleOperation(selectedOption);
        });
    };
    FirmwareDeviceTabComponent.prototype.getRepositoryEntriesWithVersions$ = function (searchTerm$) {
        var _this = this;
        return searchTerm$.pipe(distinctUntilChanged(), switchMap(function (searchTerm) {
            return _this.repository.listRepositoryEntries(RepositoryType.FIRMWARE, {
                query: _this.repository.getDeviceTypeQuery(RepositoryType.FIRMWARE, _this.device$.value),
                partialName: searchTerm,
                params: { pageSize: 100 }
            });
        }), map(function (_a) {
            var data = _a.data;
            return data;
        }), map(function (mos) { return _this.getAndAssignRepositoryBinaries(mos); }), shareReplay(1));
    };
    FirmwareDeviceTabComponent.prototype.getAndAssignRepositoryBinaries = function (mos) {
        var _this = this;
        mos.forEach(function (mo) {
            mo.versions = _this.repository.listBaseVersions(mo);
        });
        return mos;
    };
    FirmwareDeviceTabComponent.prototype.addPatch = function () {
        var _this = this;
        var initialState = {
            repositoryType: RepositoryType.FIRMWARE,
            repositoryEntriesWithVersions$: this.getRepositoryEntryWithPatches$(),
            title: gettext('Install firmware'),
            subTitle: gettext('Available firmwares matching the device type'),
            icon: 'c8y-firmware',
            mode: ModalSelectionMode.SINGLE,
            labels: { ok: gettext('Install') },
            disableSelected: false
        };
        this.deviceFirmwareFragment$
            .pipe(take(1), switchMap(function (deviceFirmwareFragment) {
            if (deviceFirmwareFragment) {
                var name_2 = deviceFirmwareFragment.name, version = deviceFirmwareFragment.version;
                var selected = [{ name: name_2, version: version }];
                assign(initialState, { selected: selected });
            }
            var modal = _this.bsModal.show(RepositorySelectModalComponent, {
                ignoreBackdropClick: true,
                initialState: initialState
            });
            modal.content.load.next();
            return modal.content.resultEmitter;
        }))
            .subscribe(function (selectedOption) {
            _this.handleOperation(selectedOption);
        });
    };
    FirmwareDeviceTabComponent.prototype.getRepositoryEntryWithPatches$ = function () {
        return combineLatest(this.repositoryEntry$, this.patches$).pipe(map(function (_a) {
            var _b = tslib_1.__read(_a, 2), repositoryEntry = _b[0], patches = _b[1];
            return [tslib_1.__assign({}, repositoryEntry, { versions: patches })];
        }));
    };
    FirmwareDeviceTabComponent.prototype.loadDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var deviceId, device;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.reloading = true;
                        deviceId = this.device$.value.id;
                        return [4 /*yield*/, this.inventory.detail(deviceId, { withChildren: false })];
                    case 1:
                        device = (_a.sent()).data;
                        this.device$.next(device);
                        this.reloading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    FirmwareDeviceTabComponent.prototype.handleOperation = function (selectedOption) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repository.createFirmwareUpdateOperation(this.device$.value, selectedOption)];
                    case 1:
                        operation = _a.sent();
                        this.trackOperation(operation);
                        return [2 /*return*/];
                }
            });
        });
    };
    FirmwareDeviceTabComponent.prototype.loadOperation = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var deviceId, operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        deviceId = this.device$.value.id;
                        return [4 /*yield*/, this.repository.getLastFirmwareUpdateOperation(deviceId)];
                    case 1:
                        operation = _a.sent();
                        this.trackOperation(operation);
                        return [2 /*return*/];
                }
            });
        });
    };
    FirmwareDeviceTabComponent.prototype.trackOperation = function (operation) {
        var _this = this;
        this.changesOperation$.next(operation);
        if (this.isInProgress(operation)) {
            this.repository.observeOperation(operation).subscribe(function (operationUpdate) {
                _this.changesOperation$.next(operationUpdate);
                if (operationUpdate.status === OperationStatus.SUCCESSFUL) {
                    _this.loadDevice();
                }
            }, function (operationUpdate) {
                _this.changesOperation$.next(operationUpdate);
            });
        }
    };
    FirmwareDeviceTabComponent.prototype.isInProgress = function (operation) {
        return (operation && [OperationStatus.PENDING, OperationStatus.EXECUTING].includes(operation.status));
    };
    FirmwareDeviceTabComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: RepositoryService },
        { type: InventoryService },
        { type: BsModalService }
    ]; };
    FirmwareDeviceTabComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-firmware-device-tab',
            template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"loadDevice()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class=\"card\">\n  <div class=\"card-header separator\">\n    <h4 class=\"card-title\" translate>Current firmware</h4>\n  </div>\n  <fieldset *ngIf=\"changesOperation$ | async\" class=\"card-block bg-gray-white\">\n    <c8y-single-operation [operation]=\"changesOperation$ | async\"></c8y-single-operation>\n  </fieldset>\n  <div class=\"card-block p-t-0\">\n    <!-- EMPTY STATE -->\n    <ng-container *ngIf=\"!(deviceFirmwareFragment$ | async); else firmwareBlock\">\n      <div class=\"c8y-empty-state text-center\">\n        <h1 c8yIcon=\"c8y-firmware\" class=\"c8y-icon-duocolor\"></h1>\n        <p>\n          <strong translate>No firmware installed.</strong> <br /><small translate\n            >Click below to install firmware into this device.</small\n          >\n        </p>\n      </div>\n\n      <!-- INSTALL FIRMWARE-->\n      <div class=\"m-t-16\">\n        <button class=\"btn btn-primary\" (click)=\"installFirmware()\" translate>\n          Install firmware\n        </button>\n      </div>\n    </ng-container>\n\n    <!-- FIRMWARE -->\n    <ng-template #firmwareBlock>\n      <c8y-list-group class=\"m-b-16\">\n        <c8y-li>\n          <c8y-li-icon>\n            <i c8yIcon=\"c8y-firmware\"></i>\n          </c8y-li-icon>\n\n          <c8y-li-body\n            *ngIf=\"deviceFirmwareFragment$ | async as deviceFirmwareFragment\"\n            class=\"content-flex-50\"\n          >\n            <div title=\"{{ deviceFirmwareFragment.name }}\" class=\"col-3\">\n              <p class=\"text-truncate\">{{ deviceFirmwareFragment.name }}</p>\n            </div>\n\n            <!-- BASE/PATCH VERSION -->\n            <div class=\"col-3\">\n              <p class=\"text-truncate\">\n                <span class=\"text-label-small m-r-8\" translate>\n                  Version\n                </span>\n                <span\n                  *ngIf=\"deviceFirmwareFragment.version; else versionNotSpecified\"\n                  title=\"{{ deviceFirmwareFragment.version }}\"\n                >\n                  {{ deviceFirmwareFragment.version }}\n                </span>\n                <ng-template #versionNotSpecified>\n                  <span class=\"text-muted\" title=\"({{ 'not specified`version`' | translate }})\">\n                    ({{ 'not specified`version`' | translate }})\n                  </span>\n                </ng-template>\n              </p>\n            </div>\n\n            <div *ngIf=\"repositoryEntry$ | async as repositoryEntry\" class=\"col-4\">\n              <p class=\"text-truncate\">\n                <span class=\"text-label-small m-r-8\" translate>\n                  Description\n                </span>\n                <span title=\"{{ repositoryEntry.description }}\">\n                  {{ repositoryEntry.description }}\n                </span>\n              </p>\n            </div>\n\n            <!-- ADD PATCH -->\n            <div class=\"col-2\">\n              <button\n                *ngIf=\"(this.patches$ | async)?.length > 0\"\n                (click)=\"addPatch()\"\n                class=\"btn btn-xs btn-primary\"\n                [disabled]=\"changesInProgress$ | async\"\n                translate\n              >\n                Patches available\n              </button>\n            </div>\n          </c8y-li-body>\n        </c8y-li>\n      </c8y-list-group>\n\n      <!-- REPLACE FIRMWARE -->\n      <div class=\"m-t-16\">\n        <button\n          class=\"btn btn-primary\"\n          (click)=\"installFirmware()\"\n          [disabled]=\"changesInProgress$ | async\"\n          translate\n        >\n          Replace firmware\n        </button>\n      </div>\n    </ng-template>\n  </div>\n</div>\n"
        })
    ], FirmwareDeviceTabComponent);
    return FirmwareDeviceTabComponent;
}());
export { FirmwareDeviceTabComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlybXdhcmUtZGV2aWNlLXRhYi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnkvIiwic291cmNlcyI6WyJmaXJtd2FyZS1kZXZpY2UtdGFiL2Zpcm13YXJlLWRldmljZS10YWIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFFLGVBQWUsRUFBYyxhQUFhLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpHLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsY0FBYyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFNUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFrQyxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQU1uRztJQWdERSxvQ0FDVSxLQUFxQixFQUNyQixVQUE2QixFQUM3QixTQUEyQixFQUMzQixPQUF1QjtRQUpqQyxpQkFLSTtRQUpNLFVBQUssR0FBTCxLQUFLLENBQWdC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QUp0QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUseUJBQXlCO1lBQ25DLHc2SEFBaUQ7U0FDbEQsQ0FBQztPQUNXLDBCQUEwQixDQTROdEM7SUFBRCxpQ0FBQztDQUFBLEFBNU5ELElBNE5DO1NBNU5ZLDBCQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgYXNzaWduLCBpc0VtcHR5IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIGNvbWJpbmVMYXRlc3QsIGZyb20sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IE1vZGFsU2VsZWN0aW9uTW9kZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIElPcGVyYXRpb24sIEludmVudG9yeVNlcnZpY2UsIE9wZXJhdGlvblN0YXR1cyB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRGV2aWNlRmlybXdhcmUsIEZpcm13YXJlQmluYXJ5LCBSZXBvc2l0b3J5VHlwZSB9IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlbGVjdE1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi4vc2VsZWN0LW1vZGFsL3JlcG9zaXRvcnktc2VsZWN0LW1vZGFsLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1maXJtd2FyZS1kZXZpY2UtdGFiJyxcbiAgdGVtcGxhdGVVcmw6ICdmaXJtd2FyZS1kZXZpY2UtdGFiLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBGaXJtd2FyZURldmljZVRhYkNvbXBvbmVudCB7XG4gIGRldmljZSQ6IEJlaGF2aW9yU3ViamVjdDxJTWFuYWdlZE9iamVjdD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFxuICAgIHRoaXMucm91dGUucGFyZW50LnNuYXBzaG90LmRhdGEuY29udGV4dERhdGFcbiAgKTtcbiAgcmVsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIGRldmljZUZpcm13YXJlRnJhZ21lbnQkOiBPYnNlcnZhYmxlPERldmljZUZpcm13YXJlPiA9IHRoaXMuZGV2aWNlJC5waXBlKFxuICAgIG1hcChkZXZpY2UgPT4gZGV2aWNlLmM4eV9GaXJtd2FyZSlcbiAgKTtcbiAgZmlybXdhcmVCaW5hcnkkOiBPYnNlcnZhYmxlPElNYW5hZ2VkT2JqZWN0PiA9IHRoaXMuZGV2aWNlRmlybXdhcmVGcmFnbWVudCQucGlwZShcbiAgICBmaWx0ZXIoZGV2aWNlRmlybXdhcmVGcmFnbWVudCA9PiAhaXNFbXB0eShkZXZpY2VGaXJtd2FyZUZyYWdtZW50KSksXG4gICAgc3dpdGNoTWFwKGRldmljZUZpcm13YXJlRnJhZ21lbnQgPT5cbiAgICAgIGZyb20oXG4gICAgICAgIHRoaXMucmVwb3NpdG9yeS5nZXRSZXBvc2l0b3J5QmluYXJ5TW9CeVZlcnNpb24oXG4gICAgICAgICAgZGV2aWNlRmlybXdhcmVGcmFnbWVudCxcbiAgICAgICAgICBSZXBvc2l0b3J5VHlwZS5GSVJNV0FSRVxuICAgICAgICApXG4gICAgICApXG4gICAgKSxcbiAgICBzaGFyZVJlcGxheSgxKVxuICApO1xuICByZXBvc2l0b3J5RW50cnkkOiBPYnNlcnZhYmxlPElNYW5hZ2VkT2JqZWN0PiA9IHRoaXMuZmlybXdhcmVCaW5hcnkkLnBpcGUoXG4gICAgc3dpdGNoTWFwKG1vID0+IHRoaXMucmVwb3NpdG9yeS5nZXRSZXBvc2l0b3J5RW50cnlNTyQobW8pKSxcbiAgICBzaGFyZVJlcGxheSgxKVxuICApO1xuICBwYXRjaGVzJDogT2JzZXJ2YWJsZTxJTWFuYWdlZE9iamVjdFtdPiA9IGNvbWJpbmVMYXRlc3QoXG4gICAgdGhpcy5maXJtd2FyZUJpbmFyeSQsXG4gICAgdGhpcy5yZXBvc2l0b3J5RW50cnkkXG4gICkucGlwZShcbiAgICBzd2l0Y2hNYXAoKFtmaXJtd2FyZUJpbmFyeSwgcmVwb3NpdG9yeUVudHJ5XSkgPT4ge1xuICAgICAgaWYgKHJlcG9zaXRvcnlFbnRyeSAmJiBmaXJtd2FyZUJpbmFyeSkge1xuICAgICAgICBjb25zdCB2ZXJzaW9uOiBzdHJpbmcgPSB0aGlzLnJlcG9zaXRvcnkuZ2V0QmFzZVZlcnNpb25Gcm9tTU8oXG4gICAgICAgICAgZmlybXdhcmVCaW5hcnkgYXMgRmlybXdhcmVCaW5hcnlcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnJlcG9zaXRvcnkubGlzdFBhdGNoVmVyc2lvbnMocmVwb3NpdG9yeUVudHJ5LCB2ZXJzaW9uKSkucGlwZShcbiAgICAgICAgICBtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgIH1cbiAgICB9KSxcbiAgICBzaGFyZVJlcGxheSgxKVxuICApO1xuICBjaGFuZ2VzT3BlcmF0aW9uJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SU9wZXJhdGlvbj4obnVsbCk7XG4gIGNoYW5nZXNJblByb2dyZXNzJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuY2hhbmdlc09wZXJhdGlvbiQucGlwZShcbiAgICBtYXAob3BlcmF0aW9uID0+IHRoaXMuaXNJblByb2dyZXNzKG9wZXJhdGlvbikpXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGJzTW9kYWw6IEJzTW9kYWxTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICAvLyBUT0RPIGNoZWNrIHJvdXRlIHNuYXBzaG90LCB3aHkgaXMgbm90IHJlZnJlc2hpbmcgZGV2aWNlLlxuICAgIC8vIFNjYW5hcmlvOiBtaXNzaW5nIGRldmljZUZpcm13YXJlRnJhZ21lbnQgPT4gaW5zdGFsbCBuZXcgdmVyc2lvbiA9PiBzd2l0Y2ggdGFicy5cbiAgICAvLyBFeHBlY3RlZDogZGV2aWNlIHNob3VsZCBiZSBzZXQuXG4gICAgYXdhaXQgdGhpcy5sb2FkRGV2aWNlKCk7XG4gICAgYXdhaXQgdGhpcy5sb2FkT3BlcmF0aW9uKCk7XG4gIH1cblxuICBpbnN0YWxsRmlybXdhcmUoKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiBvZihbXSksXG4gICAgICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9uc0ZuJDogbW9kYWwgPT5cbiAgICAgICAgdGhpcy5nZXRSZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQobW9kYWwuY29udGVudC5zZWFyY2hUZXJtKSxcbiAgICAgIHJlcG9zaXRvcnlUeXBlOiBSZXBvc2l0b3J5VHlwZS5GSVJNV0FSRSxcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdJbnN0YWxsIGZpcm13YXJlJyksXG4gICAgICBzdWJUaXRsZTogZ2V0dGV4dCgnQXZhaWxhYmxlIGZpcm13YXJlcyBtYXRjaGluZyB0aGUgZGV2aWNlIHR5cGUnKSxcbiAgICAgIGljb246ICdjOHktZmlybXdhcmUnLFxuICAgICAgbW9kZTogTW9kYWxTZWxlY3Rpb25Nb2RlLlNJTkdMRSxcbiAgICAgIGxhYmVsczogeyBvazogZ2V0dGV4dCgnSW5zdGFsbCcpIH0sXG4gICAgICBkaXNhYmxlU2VsZWN0ZWQ6IGZhbHNlXG4gICAgfTtcblxuICAgIHRoaXMuZGV2aWNlRmlybXdhcmVGcmFnbWVudCRcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlKDEpLFxuICAgICAgICBzd2l0Y2hNYXAoZGV2aWNlRmlybXdhcmVGcmFnbWVudCA9PiB7XG4gICAgICAgICAgaWYgKGRldmljZUZpcm13YXJlRnJhZ21lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgbmFtZSwgdmVyc2lvbiB9ID0gZGV2aWNlRmlybXdhcmVGcmFnbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gW3sgbmFtZSwgdmVyc2lvbiB9XTtcbiAgICAgICAgICAgIGFzc2lnbihpbml0aWFsU3RhdGUsIHsgc2VsZWN0ZWQgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgbW9kYWwgPSB0aGlzLmJzTW9kYWwuc2hvdyhSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQsIHtcbiAgICAgICAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWUsXG4gICAgICAgICAgICBpbml0aWFsU3RhdGVcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGlmIChpbml0aWFsU3RhdGUucmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnNGbiQpIHtcbiAgICAgICAgICAgIG1vZGFsLmNvbnRlbnQucmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkID0gaW5pdGlhbFN0YXRlLnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zRm4kKFxuICAgICAgICAgICAgICBtb2RhbFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBtb2RhbC5jb250ZW50LmxvYWQubmV4dCgpO1xuXG4gICAgICAgICAgcmV0dXJuIG1vZGFsLmNvbnRlbnQucmVzdWx0RW1pdHRlcjtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoc2VsZWN0ZWRPcHRpb24gPT4ge1xuICAgICAgICB0aGlzLmhhbmRsZU9wZXJhdGlvbihzZWxlY3RlZE9wdGlvbik7XG4gICAgICB9KTtcbiAgfVxuXG4gIGdldFJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJChzZWFyY2hUZXJtJDogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4pIHtcbiAgICByZXR1cm4gc2VhcmNoVGVybSQucGlwZShcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAoc2VhcmNoVGVybSA9PlxuICAgICAgICB0aGlzLnJlcG9zaXRvcnkubGlzdFJlcG9zaXRvcnlFbnRyaWVzKFJlcG9zaXRvcnlUeXBlLkZJUk1XQVJFLCB7XG4gICAgICAgICAgcXVlcnk6IHRoaXMucmVwb3NpdG9yeS5nZXREZXZpY2VUeXBlUXVlcnkoUmVwb3NpdG9yeVR5cGUuRklSTVdBUkUsIHRoaXMuZGV2aWNlJC52YWx1ZSksXG4gICAgICAgICAgcGFydGlhbE5hbWU6IHNlYXJjaFRlcm0sXG4gICAgICAgICAgcGFyYW1zOiB7IHBhZ2VTaXplOiAxMDAgfVxuICAgICAgICB9KVxuICAgICAgKSxcbiAgICAgIG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpLFxuICAgICAgbWFwKG1vcyA9PiB0aGlzLmdldEFuZEFzc2lnblJlcG9zaXRvcnlCaW5hcmllcyhtb3MpKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcbiAgfVxuXG4gIGdldEFuZEFzc2lnblJlcG9zaXRvcnlCaW5hcmllcyhtb3M6IElNYW5hZ2VkT2JqZWN0W10pIHtcbiAgICBtb3MuZm9yRWFjaChtbyA9PiB7XG4gICAgICBtby52ZXJzaW9ucyA9IHRoaXMucmVwb3NpdG9yeS5saXN0QmFzZVZlcnNpb25zKG1vKTtcbiAgICB9KTtcbiAgICByZXR1cm4gbW9zO1xuICB9XG5cbiAgYWRkUGF0Y2goKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLkZJUk1XQVJFLFxuICAgICAgcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiB0aGlzLmdldFJlcG9zaXRvcnlFbnRyeVdpdGhQYXRjaGVzJCgpLFxuICAgICAgdGl0bGU6IGdldHRleHQoJ0luc3RhbGwgZmlybXdhcmUnKSxcbiAgICAgIHN1YlRpdGxlOiBnZXR0ZXh0KCdBdmFpbGFibGUgZmlybXdhcmVzIG1hdGNoaW5nIHRoZSBkZXZpY2UgdHlwZScpLFxuICAgICAgaWNvbjogJ2M4eS1maXJtd2FyZScsXG4gICAgICBtb2RlOiBNb2RhbFNlbGVjdGlvbk1vZGUuU0lOR0xFLFxuICAgICAgbGFiZWxzOiB7IG9rOiBnZXR0ZXh0KCdJbnN0YWxsJykgfSxcbiAgICAgIGRpc2FibGVTZWxlY3RlZDogZmFsc2VcbiAgICB9O1xuXG4gICAgdGhpcy5kZXZpY2VGaXJtd2FyZUZyYWdtZW50JFxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIHN3aXRjaE1hcChkZXZpY2VGaXJtd2FyZUZyYWdtZW50ID0+IHtcbiAgICAgICAgICBpZiAoZGV2aWNlRmlybXdhcmVGcmFnbWVudCkge1xuICAgICAgICAgICAgY29uc3QgeyBuYW1lLCB2ZXJzaW9uIH0gPSBkZXZpY2VGaXJtd2FyZUZyYWdtZW50O1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBbeyBuYW1lLCB2ZXJzaW9uIH1dO1xuICAgICAgICAgICAgYXNzaWduKGluaXRpYWxTdGF0ZSwgeyBzZWxlY3RlZCB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBtb2RhbCA9IHRoaXMuYnNNb2RhbC5zaG93KFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCwge1xuICAgICAgICAgICAgaWdub3JlQmFja2Ryb3BDbGljazogdHJ1ZSxcbiAgICAgICAgICAgIGluaXRpYWxTdGF0ZVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIG1vZGFsLmNvbnRlbnQubG9hZC5uZXh0KCk7XG5cbiAgICAgICAgICByZXR1cm4gbW9kYWwuY29udGVudC5yZXN1bHRFbWl0dGVyO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShzZWxlY3RlZE9wdGlvbiA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlT3BlcmF0aW9uKHNlbGVjdGVkT3B0aW9uKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZ2V0UmVwb3NpdG9yeUVudHJ5V2l0aFBhdGNoZXMkKCkge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHRoaXMucmVwb3NpdG9yeUVudHJ5JCwgdGhpcy5wYXRjaGVzJCkucGlwZShcbiAgICAgIG1hcCgoW3JlcG9zaXRvcnlFbnRyeSwgcGF0Y2hlc10pID0+IHtcbiAgICAgICAgcmV0dXJuIFt7IC4uLnJlcG9zaXRvcnlFbnRyeSwgdmVyc2lvbnM6IHBhdGNoZXMgfV07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBhc3luYyBsb2FkRGV2aWNlKCkge1xuICAgIHRoaXMucmVsb2FkaW5nID0gdHJ1ZTtcbiAgICBjb25zdCBkZXZpY2VJZCA9IHRoaXMuZGV2aWNlJC52YWx1ZS5pZDtcbiAgICBjb25zdCBkZXZpY2UgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnkuZGV0YWlsKGRldmljZUlkLCB7IHdpdGhDaGlsZHJlbjogZmFsc2UgfSkpLmRhdGE7XG4gICAgdGhpcy5kZXZpY2UkLm5leHQoZGV2aWNlKTtcbiAgICB0aGlzLnJlbG9hZGluZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVPcGVyYXRpb24oc2VsZWN0ZWRPcHRpb24pIHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnkuY3JlYXRlRmlybXdhcmVVcGRhdGVPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSQudmFsdWUsXG4gICAgICBzZWxlY3RlZE9wdGlvblxuICAgICk7XG4gICAgdGhpcy50cmFja09wZXJhdGlvbihvcGVyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkT3BlcmF0aW9uKCkge1xuICAgIGNvbnN0IGRldmljZUlkID0gdGhpcy5kZXZpY2UkLnZhbHVlLmlkO1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5nZXRMYXN0RmlybXdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlSWQpO1xuICAgIHRoaXMudHJhY2tPcGVyYXRpb24ob3BlcmF0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhY2tPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgdGhpcy5jaGFuZ2VzT3BlcmF0aW9uJC5uZXh0KG9wZXJhdGlvbik7XG5cbiAgICBpZiAodGhpcy5pc0luUHJvZ3Jlc3Mob3BlcmF0aW9uKSkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5Lm9ic2VydmVPcGVyYXRpb24ob3BlcmF0aW9uKS5zdWJzY3JpYmUoXG4gICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VzT3BlcmF0aW9uJC5uZXh0KG9wZXJhdGlvblVwZGF0ZSk7XG4gICAgICAgICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VzT3BlcmF0aW9uJC5uZXh0KG9wZXJhdGlvblVwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc0luUHJvZ3Jlc3Mob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIG9wZXJhdGlvbiAmJiBbT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcsIE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkddLmluY2x1ZGVzKG9wZXJhdGlvbi5zdGF0dXMpXG4gICAgKTtcbiAgfVxufVxuIl19