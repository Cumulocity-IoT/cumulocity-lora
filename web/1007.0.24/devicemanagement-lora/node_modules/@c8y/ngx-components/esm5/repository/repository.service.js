import * as tslib_1 from "tslib";
import { of, from, throwError, merge } from 'rxjs';
import { map, switchMap, takeWhile, take, filter, withLatestFrom } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { isNil, isUndefined, assign, set, head, get, isString, pick, cloneDeep, remove, find, forEach, map as _map } from 'lodash-es';
import { AlertService, gettext } from '@c8y/ngx-components';
import { InventoryService, InventoryBinaryService, IResult, IManagedObject, IManagedObjectBinary, IIdentified, QueriesUtil, IResultList, IFetchResponse, IOperation, OperationService, Realtime, OperationStatus, IEvent, EventService, EventBinaryService } from '@c8y/client';
import { RepositoryType, REPOSITORY_BINARY_TYPES } from './repository.model';
var RepositoryService = /** @class */ (function () {
    function RepositoryService(inventory, inventoryBinary, operation, alert, event, realtime, eventBinary) {
        this.inventory = inventory;
        this.inventoryBinary = inventoryBinary;
        this.operation = operation;
        this.alert = alert;
        this.event = event;
        this.realtime = realtime;
        this.eventBinary = eventBinary;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.queriesUtil = new QueriesUtil();
    }
    /**
     * Lists repository entries of given type.
     * @param type The type of repository entries to list.
     * @param options Extra listing options.
     */
    RepositoryService.prototype.listRepositoryEntries = function (type, options) {
        var defaultOrder = [{ name: 1 }];
        var defaultFilters = { type: type };
        var legacyFilters = { __has: "url" };
        var fullQuery = (options && options.query) || {};
        fullQuery = this.queriesUtil.addOrderbys(fullQuery, defaultOrder, 'prepend');
        fullQuery = this.queriesUtil.addAndFilter(fullQuery, defaultFilters);
        if (options && options.partialName) {
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { name: "*" + options.partialName + "*" });
        }
        if (options && options.skipLegacy) {
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { __not: legacyFilters });
        }
        var filters = tslib_1.__assign({ query: this.queriesUtil.buildQuery(fullQuery), pageSize: 50, withTotalPages: true }, ((options && options.params) || {}));
        return this.inventory.list(filters);
    };
    // TODO: merge with create()
    RepositoryService.prototype.save = function (data, type, mo) {
        if (mo === void 0) { mo = {}; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var existingUrl, response;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        switch (type) {
                            case RepositoryType.CONFIGURATION: {
                                Object.assign(mo, {
                                    type: RepositoryType.CONFIGURATION,
                                    configurationType: data.selected ? data.selected.configurationType : undefined,
                                    name: data.version,
                                    description: data.description,
                                    deviceType: data.deviceType,
                                    c8y_Global: {}
                                });
                                break;
                            }
                        }
                        existingUrl = mo.url;
                        if (!data.binary.url) return [3 /*break*/, 1];
                        mo.url = data.binary.url;
                        return [3 /*break*/, 3];
                    case 1:
                        if (!data.binary.file) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.inventoryBinary.create(data.binary.file, {
                                c8y_Global: {}
                            })];
                    case 2:
                        response = _a.sent();
                        mo.url = response.data.self;
                        _a.label = 3;
                    case 3:
                        if (mo.id) {
                            return [2 /*return*/, this.updateEntry(mo, existingUrl)];
                        }
                        return [2 /*return*/, this.createEntry(mo)];
                }
            });
        });
    };
    RepositoryService.prototype.create = function (modal, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (type) {
                    case RepositoryType.FIRMWARE:
                    case RepositoryType.SOFTWARE:
                        return [2 /*return*/, this.createFirmwareOrSoftware(modal, type)];
                }
                return [2 /*return*/];
            });
        });
    };
    RepositoryService.prototype.createFirmwareOrSoftware = function (modal, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binary, binaryURL, repositoryEntry, repositoryBinary, mos, selectedId, _a, file, url, error_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        mos = [];
                        selectedId = modal.selected.id, _a = modal.binary, file = _a.file, url = _a.url;
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 9, , 10]);
                        if (!file) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.saveBinary(file)];
                    case 2:
                        (binary = (_b.sent()).data);
                        (binaryURL = binary.self);
                        mos.push(binary);
                        return [3 /*break*/, 4];
                    case 3:
                        binaryURL = url;
                        _b.label = 4;
                    case 4: return [4 /*yield*/, this.createOrUpdateRepositoryEntry(modal, type)];
                    case 5:
                        (repositoryEntry = (_b.sent()).data);
                        if (isNil(selectedId)) {
                            mos.push(repositoryEntry);
                        }
                        return [4 /*yield*/, this.createRepositoryBinary(modal, binaryURL, type, repositoryEntry)];
                    case 6:
                        (repositoryBinary = (_b.sent()).data);
                        mos.push(repositoryBinary);
                        if (!file) return [3 /*break*/, 8];
                        return [4 /*yield*/, this.linkBinary(repositoryBinary, binary)];
                    case 7:
                        _b.sent();
                        _b.label = 8;
                    case 8: return [2 /*return*/, repositoryEntry];
                    case 9:
                        error_1 = _b.sent();
                        this.cleanUp(mos);
                        this.errorMsg();
                        // Propagate error
                        throw error_1;
                    case 10: return [2 /*return*/];
                }
            });
        });
    };
    RepositoryService.prototype.saveBinary = function (file) {
        return this.inventoryBinary.create(file, { c8y_Global: {} });
    };
    RepositoryService.prototype.createOrUpdateRepositoryEntry = function (modal, type) {
        var _a = modal.selected, id = _a.id, name = _a.name, description = modal.description;
        var mo = {
            id: id,
            name: id ? undefined : name,
            description: description,
            type: id ? undefined : type,
            c8y_Global: {}
        };
        return id
            ? this.inventory.update(mo)
            : this.inventory.create(mo);
    };
    RepositoryService.prototype.createRepositoryBinary = function (modal, binaryURL, type, parent) {
        var mo = this.prepareRepositoryBinaryMO(modal, binaryURL, type);
        return this.inventory.childAdditionsCreate(mo, parent);
    };
    RepositoryService.prototype.prepareRepositoryBinaryMO = function (modal, binaryURL, type) {
        var _a;
        var version = modal.version, patchVersion = modal.patchVersion, dependency = modal.dependency;
        var result = (_a = {
                type: REPOSITORY_BINARY_TYPES[type]
            },
            _a[type] = {
                url: binaryURL
            },
            _a.c8y_Global = {},
            _a);
        if (dependency) {
            set(result, [type, 'version'], patchVersion);
            assign(result, {
                c8y_Patch: {
                    dependency: dependency.c8y_Firmware.version
                }
            });
        }
        else {
            set(result, [type, 'version'], version);
        }
        return result;
    };
    RepositoryService.prototype.linkBinary = function (repositoryBinary, binary) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var repositoryBinaryId, binaryId;
            return tslib_1.__generator(this, function (_a) {
                repositoryBinaryId = repositoryBinary.id;
                if (binary) {
                    binaryId = binary.id;
                    return [2 /*return*/, this.inventory.childAdditionsAdd(binaryId, repositoryBinaryId)];
                }
                return [2 /*return*/];
            });
        });
    };
    RepositoryService.prototype.cleanUp = function (mosToDelete) {
        var _this = this;
        mosToDelete.forEach(function (mo) {
            var c8y_IsBinary = mo.c8y_IsBinary;
            isUndefined(c8y_IsBinary) ? _this.delete(mo) : _this.inventoryBinary.delete(mo);
        });
    };
    RepositoryService.prototype.delete = function (entity) {
        return this.inventory.delete(entity, { forceCascade: true });
    };
    RepositoryService.prototype.errorMsg = function () {
        var msg = gettext('Failed to save');
        this.alert.danger(msg);
    };
    RepositoryService.prototype.getBaseVersionsCount$ = function (entry) {
        if (this.isLegacyEntry(entry)) {
            return of(1);
        }
        return from(this.listBaseVersions(entry, { pageSize: 1, withTotalPages: true })).pipe(map(function (_a) {
            var paging = _a.paging;
            return paging.totalPages;
        }));
    };
    RepositoryService.prototype.getBaseVersionFromMO = function (mo) {
        return this.isPatch(mo) ? get(mo, 'c8y_Patch.dependency') : get(mo, 'c8y_Firmware.version');
    };
    RepositoryService.prototype.isPatch = function (mo) {
        return !!get(mo, 'c8y_Patch.dependency');
    };
    RepositoryService.prototype.getPatchVersionsCount$ = function (entry, baseVersion) {
        if (this.isLegacyEntry(baseVersion)) {
            return of(0);
        }
        return from(this.listPatchVersions(entry, baseVersion, { pageSize: 1, withTotalPages: true })).pipe(map(function (_a) {
            var paging = _a.paging;
            return paging.totalPages;
        }));
    };
    RepositoryService.prototype.isLegacyEntry = function (entry) {
        return Boolean(entry.url);
    };
    /**
     * Lists all versions (base and patch ones) of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    RepositoryService.prototype.listAllVersions = function (entry, params) {
        if (params === void 0) { params = {}; }
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        var VERSION_FILTER_ORDER = {
            __filter: {},
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, VERSION_FILTER_ORDER, params);
    };
    /**
     * Lists base versions of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    RepositoryService.prototype.listBaseVersions = function (entry, params) {
        if (params === void 0) { params = {}; }
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        var NO_PATCH_FILTER_ORDER = {
            __filter: {
                __not: { __has: 'c8y_Patch' }
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, NO_PATCH_FILTER_ORDER, params);
    };
    /**
     * Lists patch versions of given base version under the entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    RepositoryService.prototype.listPatchVersions = function (entry, baseVersion, params) {
        if (params === void 0) { params = {}; }
        var version = isString(baseVersion) ? baseVersion : get(baseVersion, 'c8y_Firmware.version');
        var PATCH_FILTER_ORDER = {
            __filter: {
                'c8y_Patch.dependency': version
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    };
    /**
     * Lists patch versions of given base version under the entry including the base version.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * In terms of legacy base version the entry gets transformed to fit the needed data model.
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    RepositoryService.prototype.listBaseVersionAndPatches = function (entry, baseVersion, params) {
        if (params === void 0) { params = {}; }
        if (this.isLegacyEntry(entry)) {
            return Promise.resolve({
                data: [
                    Object.assign({
                        c8y_Firmware: {
                            version: entry.version,
                            url: entry.url
                        }
                    }, entry)
                ]
            });
        }
        var PATCH_FILTER_ORDER = {
            __filter: {
                __or: {
                    'c8y_Patch.dependency': baseVersion.c8y_Firmware.version,
                    'c8y_Firmware.version': baseVersion.c8y_Firmware.version
                }
            },
            __orderby: [{ 'c8y_Patch.dependency': 1 }, { 'c8y_Firmware.version': 1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    };
    RepositoryService.prototype.listChildren = function (entry, filters, params) {
        if (filters === void 0) { filters = {}; }
        if (params === void 0) { params = {}; }
        var childrenFilters = { __bygroupid: entry.id };
        var query = this.queriesUtil.addAndFilter(filters, childrenFilters);
        // FIXME: needed because of issue in forOf directive (...)
        params.withTotalPages = true;
        return this.inventory.listQuery(query, params);
    };
    /**
     * Fetches all items from the list starting with the provided page.
     * @param firstPage The first page of the list to fetch all items for.
     */
    RepositoryService.prototype.fetchAllItemsFromList = function (firstPage) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var allItems, _a, paging, items;
            var _b;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        if (!!firstPage.then) return [3 /*break*/, 1];
                        allItems = tslib_1.__spread(firstPage);
                        return [3 /*break*/, 5];
                    case 1: return [4 /*yield*/, firstPage];
                    case 2:
                        _a = _c.sent(), paging = _a.paging, items = _a.data;
                        allItems = tslib_1.__spread(items);
                        _c.label = 3;
                    case 3:
                        if (!(paging && paging.nextPage)) return [3 /*break*/, 5];
                        return [4 /*yield*/, paging.next()];
                    case 4:
                        (_b = _c.sent(), paging = _b.paging, items = _b.data);
                        allItems = tslib_1.__spread(allItems, items);
                        return [3 /*break*/, 3];
                    case 5: return [2 /*return*/, allItems];
                }
            });
        });
    };
    /**
     * Gets top level repository entry managed object for base or patch version.
     * @param mo Base or patch version managed object with parents.
     */
    RepositoryService.prototype.getRepositoryEntryMO$ = function (mo) {
        if (!mo) {
            return of(undefined);
        }
        var _a = tslib_1.__read(get(mo, 'additionParents.references'), 1), reference = _a[0];
        var id = get(reference, 'managedObject.id');
        return id
            ? from(this.inventory.detail(id, { withChildren: false })).pipe(map(function (_a) {
                var data = _a.data;
                return data;
            }))
            : of(undefined);
    };
    /**
     * Gets base or patch version managed object.
     * @param deviceRepositoryFragment Device repository fragment.
     * @param type Top level repository entry type.
     * @param configuration Configuration object with options:
     * - **skipLegacy** - `boolean` - Exclude legacy entries.
     * - **filters** - `object` - Filter object.
     *
     * @deprecated as it doesn't support 'missing url' case
     */
    RepositoryService.prototype.getRepositoryBinaryMoByVersion = function (deviceRepositoryFragment, type, _a) {
        var _b;
        var _c = _a === void 0 ? {} : _a, _d = _c.skipLegacy, skipLegacy = _d === void 0 ? false : _d, _e = _c.filters, filters = _e === void 0 ? {} : _e;
        var version = deviceRepositoryFragment.version, url = deviceRepositoryFragment.url, name = deviceRepositoryFragment.name;
        var repositoryBinaryType = REPOSITORY_BINARY_TYPES[type];
        var query;
        var newModelBaseVersionQuery = (_b = {},
            _b[type + ".version"] = version,
            _b[type + ".url"] = url,
            _b.type = repositoryBinaryType,
            _b);
        var legacyVersionQuery = { url: url, type: type, name: name };
        filters = tslib_1.__assign({ withChildren: false, withParents: true }, filters);
        if (skipLegacy) {
            query = {
                __and: tslib_1.__assign({}, newModelBaseVersionQuery)
            };
        }
        else {
            query = {
                __or: [{ __and: tslib_1.__assign({}, newModelBaseVersionQuery) }, { __and: tslib_1.__assign({}, legacyVersionQuery) }]
            };
        }
        return this.inventory.listQuery(query, filters).then(function (_a) {
            var data = _a.data;
            return head(data);
        });
    };
    RepositoryService.prototype.getBinaryName$ = function (binaryUrl) {
        if (!binaryUrl) {
            return of('---');
        }
        var binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
        if (!binaryId) {
            return of(binaryUrl);
        }
        return this.inventory.detail$(binaryId).pipe(map(function (mo) { return mo.name; }));
    };
    /**
     * Generates an inventory query object which can be used to find
     * repository entries of specified type matching the type of provided device.
     * @param repositoryType The type of repository entries which will be queried with the generated query.
     * @param device The device for which matching repository entries will be queried with the generated query.
     */
    RepositoryService.prototype.getDeviceTypeQuery = function (repositoryType, device) {
        var result = { type: repositoryType };
        if (device.type) {
            if (repositoryType === RepositoryType.CONFIGURATION) {
                result = this.queriesUtil.addAndFilter(result, {
                    __or: [{ deviceType: device.type }, { __not: { __has: "deviceType" } }]
                });
            }
            else {
                result = this.queriesUtil.addAndFilter(result, {
                    __or: [{ 'c8y_Filter.type': device.type }, { __not: { __has: "c8y_Filter.type" } }]
                });
            }
        }
        return result;
    };
    /**
     * Generates an inventory query object which can be used to find configuration repository entries
     * matching the type of provided device and specified configuration type.
     * @param device The device for which matching repository entries will be queried with the generated query.
     * @param configurationType Configuration type for which matching repository entries will be queried with the generated query.
     */
    RepositoryService.prototype.getConfigurationTypeQuery = function (device, configurationType) {
        var query = this.getDeviceTypeQuery(RepositoryType.CONFIGURATION, device);
        return this.queriesUtil.addAndFilter(query, {
            __or: [{ configurationType: configurationType }, { __not: { __has: "configurationType" } }]
        });
    };
    /**
     * Gets the list of software installed in the device in the uniform format.
     * Supports c8y_SoftwareList and c8y_Software fragments.
     * @param device The device whose software list should be returned.
     */
    RepositoryService.prototype.getDeviceSoftwareList = function (device) {
        if (device.c8y_SoftwareList) {
            return cloneDeep(device.c8y_SoftwareList);
        }
        if (device.c8y_Software) {
            return _map(device.c8y_Software, function (version, name) { return ({ name: name, version: version }); });
        }
        return [];
    };
    /**
     * Prepares a software update operation for given device and the list of changes, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param changes The list of software changes which should be applied.
     */
    RepositoryService.prototype.createSoftwareUpdateOperation = function (device, changes) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        operation = this.getSoftwareUpdateOperation(device, changes);
                        return [4 /*yield*/, this.operation.create(operation)];
                    case 1: return [2 /*return*/, (_a.sent()).data];
                }
            });
        });
    };
    /**
     * Prepares a software update operation for given device and changes.
     * Returned operation type depends on device's supported operations.
     * Supports c8y_SoftwareUpdate, c8y_SoftwareList, and c8y_Software operations.
     * @param device The device for which operation should be prepared.
     * @param changes The list of software changes which should be applied.
     */
    RepositoryService.prototype.getSoftwareUpdateOperation = function (device, changes) {
        var operation = {
            deviceId: device.id,
            description: "Apply software changes: " + changes
                .map(function (change) {
                return change.action + " \"" + change.name + "\"" + (change.version ? " (version: " + change.version + ")" : '');
            })
                .join(', ')
        };
        if (device.c8y_SupportedOperations.includes('c8y_SoftwareUpdate')) {
            operation.c8y_SoftwareUpdate = cloneDeep(changes);
        }
        else if (device.c8y_SupportedOperations.includes('c8y_SoftwareList')) {
            operation.c8y_SoftwareList = cloneDeep(device.c8y_SoftwareList) || [];
            changes.forEach(function (change) {
                var deviceSoftware = pick(change, ['name', 'version', 'url']);
                if (change.action === 'delete') {
                    remove(operation.c8y_SoftwareList, deviceSoftware);
                }
                if (change.action === 'install') {
                    operation.c8y_SoftwareList.push(deviceSoftware);
                }
            });
        }
        else if (device.c8y_SupportedOperations.includes('c8y_Software')) {
            operation.c8y_Software = cloneDeep(device.c8y_Software) || {};
            changes.forEach(function (change) {
                if (change.action === 'delete') {
                    delete operation.c8y_Software[change.name];
                }
                if (change.action === 'install') {
                    operation.c8y_Software[change.name] = change.version;
                }
            });
        }
        return operation;
    };
    /**
     * Extracts the list of device software changes from given operation in the context of given device.
     * @param operation The operation from which the list should be extracted.
     * @param device The target device of the operation.
     */
    RepositoryService.prototype.getDeviceSoftwareChangesFromOperation = function (operation, device) {
        if (operation.c8y_SoftwareUpdate) {
            return cloneDeep(operation.c8y_SoftwareUpdate);
        }
        if (operation.c8y_SoftwareList) {
            return this.getDeviceSoftwareChangesFromSoftwareListOperation(operation, device);
        }
        if (operation.c8y_Software) {
            return this.getDeviceSoftwareChangesFromSoftwareOperation(operation, device);
        }
        return [];
    };
    /**
     * Prepares a firmware update operation for given device and the selected repository binary, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param selectedOption The selected repository binary option.
     */
    RepositoryService.prototype.createFirmwareUpdateOperation = function (device, selectedOption) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        operation = this.getFirmwareUpdateOperation(device, selectedOption);
                        return [4 /*yield*/, this.operation.create(operation)];
                    case 1: return [2 /*return*/, (_a.sent()).data];
                }
            });
        });
    };
    /**
     * Prepares a firmware update operation for given device and selected version.
     * Supports c8y_Firmware operation.
     * @param device The device for which operation should be prepared.
     * @param selectedOption Selected firmware version.
     */
    RepositoryService.prototype.getFirmwareUpdateOperation = function (device, selectedOption) {
        delete selectedOption.id;
        var operation = {
            deviceId: device.id,
            description: "Update firmware to: \"" + selectedOption.name + "\"" + (selectedOption.version ? " (version: " + selectedOption.version + ")" : ''),
            c8y_Firmware: tslib_1.__assign({}, selectedOption)
        };
        return operation;
    };
    /**
     * Prepares a configuration file upload operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param isLegacy  A legacy operation is created without a configurationType.
     */
    RepositoryService.prototype.getUploadConfigurationFileOperation = function (device, configurationType, isLegacy) {
        if (isLegacy === void 0) { isLegacy = false; }
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: "Retrieve configuration snapshot from device " + device.name,
                c8y_UploadConfigFile: {}
            };
        }
        return {
            deviceId: device.id,
            description: "Retrieve " + configurationType + " configuration snapshot from device " + device.name,
            c8y_UploadConfigFile: {
                type: configurationType
            }
        };
    };
    /**
     * Prepares a configuration file download operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param binaryUrl The url of a binary to be downloaded.
     * @param isLegacy A legacy operation is created without a configurationType.
     */
    RepositoryService.prototype.getDownloadConfigurationFileOperation = function (device, configurationType, configSnapshot, isLegacy) {
        if (isLegacy === void 0) { isLegacy = false; }
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: "Send configuration snapshot " + configSnapshot.name + " to device " + device.name,
                c8y_DownloadConfigFile: {
                    url: configSnapshot.binaryUrl,
                    c8y_ConfigurationDump: {
                        id: configSnapshot.id
                    }
                }
            };
        }
        return {
            deviceId: device.id,
            description: "Send configuration snapshot " + configSnapshot.name + " of configuration type " + configurationType + " to device " + device.name,
            c8y_DownloadConfigFile: {
                url: configSnapshot.binaryUrl,
                type: configurationType
            }
        };
    };
    /**
     * Gets the last firmware update operation for given device.
     * Looks for c8y_Firmware operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    RepositoryService.prototype.getLastFirmwareUpdateOperation = function (deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filters;
            return tslib_1.__generator(this, function (_a) {
                filters = {
                    deviceId: deviceId,
                    dateFrom: new Date(0).toISOString(),
                    dateTo: new Date(Date.now()).toISOString(),
                    revert: true,
                    pageSize: 1
                };
                return [2 /*return*/, this.getFirstMatchingOperation([tslib_1.__assign({}, filters, { fragmentType: 'c8y_Firmware' })])];
            });
        });
    };
    /**
     * Gets the last software update operation for given device.
     * Looks for c8y_SoftwareUpdate, c8y_SoftwareList, or c8y_Software operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    RepositoryService.prototype.getLastSoftwareUpdateOperation = function (deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filters;
            return tslib_1.__generator(this, function (_a) {
                filters = {
                    deviceId: deviceId,
                    dateFrom: new Date(0).toISOString(),
                    dateTo: new Date(Date.now()).toISOString(),
                    revert: true,
                    pageSize: 1
                };
                return [2 /*return*/, this.getFirstMatchingOperation([
                        tslib_1.__assign({}, filters, { fragmentType: 'c8y_SoftwareUpdate' }),
                        tslib_1.__assign({}, filters, { fragmentType: 'c8y_SoftwareList' }),
                        tslib_1.__assign({}, filters, { fragmentType: 'c8y_Software' })
                    ])];
            });
        });
    };
    /**
     * Iterates over the list of filters and queries the operations.
     * If a query returns at least one operation, the first one will be returned.
     * Otherwise the next query will be performed.
     * If none of the queries returns any operation, null will be returned.
     * @param filtersList The list of filters for the queries.
     */
    RepositoryService.prototype.getFirstMatchingOperation = function (filtersList) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var matchingOperation, filtersList_1, filtersList_1_1, filters, operations, e_1_1;
            var e_1, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        matchingOperation = null;
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 6, 7, 8]);
                        filtersList_1 = tslib_1.__values(filtersList), filtersList_1_1 = filtersList_1.next();
                        _b.label = 2;
                    case 2:
                        if (!!filtersList_1_1.done) return [3 /*break*/, 5];
                        filters = filtersList_1_1.value;
                        return [4 /*yield*/, this.operation.list(filters)];
                    case 3:
                        operations = (_b.sent()).data;
                        if (operations.length) {
                            matchingOperation = operations[0];
                            return [3 /*break*/, 5];
                        }
                        _b.label = 4;
                    case 4:
                        filtersList_1_1 = filtersList_1.next();
                        return [3 /*break*/, 2];
                    case 5: return [3 /*break*/, 8];
                    case 6:
                        e_1_1 = _b.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 8];
                    case 7:
                        try {
                            if (filtersList_1_1 && !filtersList_1_1.done && (_a = filtersList_1.return)) _a.call(filtersList_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                        return [7 /*endfinally*/];
                    case 8: return [2 /*return*/, matchingOperation];
                }
            });
        });
    };
    /**
     * Creates the operation and returns an observable to track its progress.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to create and track.
     */
    RepositoryService.prototype.createObservedOperation = function (operation) {
        var _this = this;
        return from(this.operation.create(operation)).pipe(map(function (_a) {
            var data = _a.data;
            return data;
        }), take(1), switchMap(function (createdOperation) { return _this.observeOperation(createdOperation); }));
    };
    /**
     * Returns an observable to track progress of given operation.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to be observed.
     */
    RepositoryService.prototype.observeOperation = function (operation) {
        var _this = this;
        var observedOperation$ = of(operation);
        var operationUpdates$ = observedOperation$.pipe(switchMap(function (observedOperation) {
            return _this.realtime.observable("/operations/" + observedOperation.deviceId);
        }), map(function (_a) {
            var data = _a.data;
            return data;
        }), withLatestFrom(observedOperation$), filter(function (_a) {
            var _b = tslib_1.__read(_a, 2), operationUpdate = _b[0], observedOperation = _b[1];
            return operationUpdate.id === observedOperation.id;
        }), switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 1), operationUpdate = _b[0];
            if (operationUpdate.status === OperationStatus.FAILED) {
                return throwError(operationUpdate);
            }
            return of(operationUpdate);
        }), takeWhile(function (operationUpdate) { return operationUpdate.status !== OperationStatus.SUCCESSFUL; }, true));
        return merge(observedOperation$, operationUpdates$);
    };
    /**
     * Gets a single event with latest creationTime for the given device Id and event type.
     * @param deviceId The device Id for which the events should be queried.
     * @param type Event type.
     */
    RepositoryService.prototype.getLatestConfigurationEvent = function (deviceId, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var eventFilter, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        eventFilter = {
                            source: deviceId,
                            type: type,
                            dateFrom: this.dateFrom.toISOString(),
                            dateTo: this.dateTo.toISOString(),
                            pageSize: 1
                        };
                        return [4 /*yield*/, this.event.list(eventFilter)];
                    case 1:
                        data = (_a.sent()).data;
                        return [2 /*return*/, data[0]];
                }
            });
        });
    };
    /**
     * Gets a list of operations for the given device Id, and operation type.
     * @param deviceId The device Id for which the operation should be queried.
     * @param operationType Operation type fragment.
     */
    RepositoryService.prototype.getConfigFileOperationList = function (deviceId, operationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operationFilter;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        operationFilter = {
                            deviceId: deviceId,
                            fragmentType: operationType,
                            dateFrom: this.dateFrom.toISOString(),
                            dateTo: this.dateTo.toISOString(),
                            revert: true,
                            pageSize: 2000
                        };
                        return [4 /*yield*/, this.operation.list(operationFilter)];
                    case 1: return [2 /*return*/, (_a.sent()).data];
                }
            });
        });
    };
    /**
     * Gets latest uploaded configuration snapshot for the given device, and configuration type.
     * @param device The device for which the configuration snapshot was uploaded.
     * @param configurationType Selected configuration type.
     */
    RepositoryService.prototype.getConfigSnapshot = function (device, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var event, configSnapshot, _a, ex_1, msg;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.getLatestConfigurationEvent(device.id, configurationType)];
                    case 1:
                        event = _b.sent();
                        if (!event) return [3 /*break*/, 6];
                        configSnapshot = {
                            time: event.time,
                            name: event.text,
                            deviceType: device.type,
                            configurationType: configurationType
                        };
                        _b.label = 2;
                    case 2:
                        _b.trys.push([2, 5, , 6]);
                        _a = configSnapshot;
                        return [4 /*yield*/, this.eventBinary.download(event)];
                    case 3: return [4 /*yield*/, (_b.sent()).text()];
                    case 4:
                        _a.binary = _b.sent();
                        if (event.c8y_IsBinary) {
                            configSnapshot.binaryType = event.c8y_IsBinary.type;
                        }
                        return [3 /*break*/, 6];
                    case 5:
                        ex_1 = _b.sent();
                        msg = gettext('Could not get the binary.');
                        this.alert.danger(msg);
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/, configSnapshot];
                }
            });
        });
    };
    RepositoryService.prototype.getLegacyConfigSnapshot = function (deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var configSnapshot, mo, device, snapshotId, ex_2, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.inventory.detail(deviceId, { withChildren: false })];
                    case 1:
                        device = (_b.sent()).data;
                        snapshotId = device.c8y_ConfigurationDump && device.c8y_ConfigurationDump.id;
                        if (!snapshotId) {
                            return [2 /*return*/];
                        }
                        _b.label = 2;
                    case 2:
                        _b.trys.push([2, 4, , 5]);
                        return [4 /*yield*/, this.inventory.detail(snapshotId)];
                    case 3:
                        mo = (_b.sent()).data;
                        return [3 /*break*/, 5];
                    case 4:
                        ex_2 = _b.sent();
                        return [3 /*break*/, 5];
                    case 5:
                        if (!mo) return [3 /*break*/, 7];
                        configSnapshot = {
                            time: mo.creationTime,
                            name: mo.name
                        };
                        _a = configSnapshot;
                        return [4 /*yield*/, this.getBinaryText(mo.url, { allowExternal: false })];
                    case 6:
                        _a.binary = _b.sent();
                        _b.label = 7;
                    case 7: return [2 /*return*/, configSnapshot];
                }
            });
        });
    };
    RepositoryService.prototype.getBinaryFile = function (binaryUrl, options) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binaryId, data, binary, _a, fileBinary;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
                        if (!binaryId && !options.allowExternal) {
                            return [2 /*return*/];
                        }
                        return [4 /*yield*/, this.inventory.detail(binaryId)];
                    case 1:
                        data = (_b.sent()).data;
                        if (!!!binaryId) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.getBinary(binaryId)];
                    case 2:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        _a = this.fetchExternalBinary(binaryUrl);
                        _b.label = 4;
                    case 4:
                        binary = _a;
                        fileBinary = new File([binary], data.name, { type: data.contentType });
                        return [2 /*return*/, fileBinary];
                }
            });
        });
    };
    RepositoryService.prototype.getBinaryText = function (binaryUrl, options) {
        var binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
        if (!binaryId && options.allowExternal) {
            return this.fetchExternalBinary(binaryUrl);
        }
        return this.getBinary(binaryId);
    };
    RepositoryService.prototype.getBinary = function (binaryId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binary, res, ex_3, msg;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.inventoryBinary.download(binaryId)];
                    case 1:
                        res = _a.sent();
                        return [4 /*yield*/, res.text()];
                    case 2:
                        binary = _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_3 = _a.sent();
                        msg = gettext('Could not get the binary.');
                        this.alert.danger(msg);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/, binary];
                }
            });
        });
    };
    RepositoryService.prototype.fetchExternalBinary = function (url) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var configBinary, res, ex_4, msg;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 4, , 5]);
                        return [4 /*yield*/, fetch(url)];
                    case 1:
                        res = _a.sent();
                        if (!(res.status === 200)) return [3 /*break*/, 3];
                        return [4 /*yield*/, res.text()];
                    case 2:
                        configBinary = _a.sent();
                        _a.label = 3;
                    case 3: return [3 /*break*/, 5];
                    case 4:
                        ex_4 = _a.sent();
                        msg = gettext('Could not get the external binary.');
                        this.alert.danger(msg);
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/, configBinary];
                }
            });
        });
    };
    RepositoryService.prototype.createEntry = function (mo) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binaryId, newMo;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.inventoryBinary.getIdFromUrl(mo.url)];
                    case 1:
                        binaryId = _a.sent();
                        return [4 /*yield*/, this.inventory.create(mo)];
                    case 2:
                        newMo = _a.sent();
                        if (!binaryId) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.inventory.childAdditionsAdd(binaryId, newMo.data)];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4: return [2 /*return*/, newMo];
                }
            });
        });
    };
    RepositoryService.prototype.updateEntry = function (mo, url) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var existingBinaryId, newBinaryId, id;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.inventoryBinary.getIdFromUrl(url)];
                    case 1:
                        existingBinaryId = _a.sent();
                        return [4 /*yield*/, this.inventoryBinary.getIdFromUrl(mo.url)];
                    case 2:
                        newBinaryId = _a.sent();
                        if (!(existingBinaryId && existingBinaryId !== newBinaryId)) return [3 /*break*/, 4];
                        id = this.inventoryBinary.getIdFromUrl(url);
                        return [4 /*yield*/, this.inventoryBinary.delete(id)];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        if (!newBinaryId) return [3 /*break*/, 6];
                        return [4 /*yield*/, this.inventory.childAdditionsAdd(newBinaryId, mo)];
                    case 5:
                        _a.sent();
                        _a.label = 6;
                    case 6: return [2 /*return*/, this.inventory.update(mo)];
                }
            });
        });
    };
    RepositoryService.prototype.getBaseVersionResultListForLegacyEntry = function (entry) {
        var _a;
        return Promise.resolve({
            res: {},
            data: [
                tslib_1.__assign({}, entry, (_a = {}, _a[entry.type] = {
                    version: entry.version,
                    url: entry.url
                }, _a))
            ]
        });
    };
    RepositoryService.prototype.getDeviceSoftwareChangesFromSoftwareListOperation = function (operation, device) {
        var changes = [];
        forEach(device.c8y_SoftwareList, function (deviceSoftware) {
            var operationSoftware = find(operation.c8y_SoftwareList, { name: deviceSoftware.name });
            if (deviceSoftware.version !== operationSoftware.version) {
                changes.push(tslib_1.__assign({}, deviceSoftware, { action: 'delete' }));
            }
        });
        forEach(operation.c8y_SoftwareList, function (operationSoftware) {
            var deviceSoftware = find(device.c8y_SoftwareList, { name: operationSoftware.name });
            if (operationSoftware.version !== deviceSoftware.version) {
                changes.push(tslib_1.__assign({}, operationSoftware, { action: 'install' }));
            }
        });
        return changes;
    };
    RepositoryService.prototype.getDeviceSoftwareChangesFromSoftwareOperation = function (operation, device) {
        var changes = [];
        forEach(device.c8y_Software, function (deviceSoftwareVersion, deviceSoftwareName) {
            if (operation.c8y_Software[deviceSoftwareName] !== deviceSoftwareVersion) {
                changes.push({
                    name: deviceSoftwareName,
                    version: deviceSoftwareVersion,
                    action: 'delete'
                });
            }
        });
        forEach(operation.c8y_Software, function (operationSoftwareVersion, operationSoftwareName) {
            if (device.c8y_Software[operationSoftwareName] !== operationSoftwareVersion) {
                changes.push({
                    name: operationSoftwareName,
                    version: operationSoftwareVersion,
                    action: 'install'
                });
            }
        });
        return changes;
    };
    RepositoryService.ctorParameters = function () { return [
        { type: InventoryService },
        { type: InventoryBinaryService },
        { type: OperationService },
        { type: AlertService },
        { type: EventService },
        { type: Realtime },
        { type: EventBinaryService }
    ]; };
    RepositoryService = tslib_1.__decorate([
        Injectable()
    ], RepositoryService);
    return RepositoryService;
}());
export { RepositoryService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5LyIsInNvdXJjZXMiOlsicmVwb3NpdG9yeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNMLEtBQUssRUFDTCxXQUFXLEVBQ1gsTUFBTSxFQUNOLEdBQUcsRUFDSCxJQUFJLEVBQ0osR0FBRyxFQUNILFFBQVEsRUFDUixJQUFJLEVBQ0osU0FBUyxFQUNULE1BQU0sRUFDTixJQUFJLEVBQ0osT0FBTyxFQUNQLEdBQUcsSUFBSSxJQUFJLEVBQ1osTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLHNCQUFzQixFQUN0QixPQUFPLEVBQ1AsY0FBYyxFQUNkLG9CQUFvQixFQUNwQixXQUFXLEVBQ1gsV0FBVyxFQUNYLFdBQVcsRUFDWCxjQUFjLEVBQ2QsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixRQUFRLEVBQ1IsZUFBZSxFQUNmLE1BQU0sRUFDTixZQUFZLEVBQ1osa0JBQWtCLEVBQ25CLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFPTCxjQUFjLEVBQ2QsdUJBQXVCLEVBTXhCLE1BQU0sb0JBQW9CLENBQUM7QUFHNUI7SUFLRSwyQkFDVSxTQUEyQixFQUMzQixlQUF1QyxFQUN2QyxTQUEyQixFQUMzQixL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QUM7YUFDNUI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7O2dCQXAvQm9CLGdCQUFnQjtnQkFDVixzQkFBc0I7Z0JBQzVCLGdCQUFnQjtnQkFDcEIsWUFBWTtnQkFDWixZQUFZO2dCQUNULFFBQVE7Z0JBQ0wsa0JBQWtCOztJQVo5QixpQkFBaUI7UUFEN0IsVUFBVSxFQUFFO09BQ0EsaUJBQWlCLENBMi9CN0I7SUFBRCx3QkFBQztDQUFBLEFBMy9CRCxJQTIvQkM7U0EzL0JZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tLCB0aHJvd0Vycm9yLCBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAsIHRha2VXaGlsZSwgdGFrZSwgZmlsdGVyLCB3aXRoTGF0ZXN0RnJvbSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIGlzTmlsLFxuICBpc1VuZGVmaW5lZCxcbiAgYXNzaWduLFxuICBzZXQsXG4gIGhlYWQsXG4gIGdldCxcbiAgaXNTdHJpbmcsXG4gIHBpY2ssXG4gIGNsb25lRGVlcCxcbiAgcmVtb3ZlLFxuICBmaW5kLFxuICBmb3JFYWNoLFxuICBtYXAgYXMgX21hcFxufSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJbnZlbnRvcnlCaW5hcnlTZXJ2aWNlLFxuICBJUmVzdWx0LFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSU1hbmFnZWRPYmplY3RCaW5hcnksXG4gIElJZGVudGlmaWVkLFxuICBRdWVyaWVzVXRpbCxcbiAgSVJlc3VsdExpc3QsXG4gIElGZXRjaFJlc3BvbnNlLFxuICBJT3BlcmF0aW9uLFxuICBPcGVyYXRpb25TZXJ2aWNlLFxuICBSZWFsdGltZSxcbiAgT3BlcmF0aW9uU3RhdHVzLFxuICBJRXZlbnQsXG4gIEV2ZW50U2VydmljZSxcbiAgRXZlbnRCaW5hcnlTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7XG4gIFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgUmVwb3NpdG9yeUJpbmFyeSxcbiAgRmlybXdhcmVCaW5hcnksXG4gIFNvZnR3YXJlQmluYXJ5LFxuICBGaXJtd2FyZVBhdGNoQmluYXJ5LFxuICBNb2RhbE1vZGVsLFxuICBSZXBvc2l0b3J5VHlwZSxcbiAgUkVQT1NJVE9SWV9CSU5BUllfVFlQRVMsXG4gIERldmljZUZpcm13YXJlLFxuICBEZXZpY2VTb2Z0d2FyZSxcbiAgRGV2aWNlU29mdHdhcmVDaGFuZ2UsXG4gIFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeSxcbiAgQ29uZmlndXJhdGlvblNuYXBzaG90XG59IGZyb20gJy4vcmVwb3NpdG9yeS5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXBvc2l0b3J5U2VydmljZSB7XG4gIHJlYWRvbmx5IGRhdGVGcm9tID0gbmV3IERhdGUoMCk7XG4gIHJlYWRvbmx5IGRhdGVUbyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyA4NjQwMDAwMCk7IC8vIDEgZGF5IGluIHRoZSBmdXR1cmVcbiAgcHJpdmF0ZSBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlCaW5hcnk6IEludmVudG9yeUJpbmFyeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb246IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXZlbnQ6IEV2ZW50U2VydmljZSxcbiAgICBwcml2YXRlIHJlYWx0aW1lOiBSZWFsdGltZSxcbiAgICBwcml2YXRlIGV2ZW50QmluYXJ5OiBFdmVudEJpbmFyeVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIHJlcG9zaXRvcnkgZW50cmllcyBvZiBnaXZlbiB0eXBlLlxuICAgKiBAcGFyYW0gdHlwZSBUaGUgdHlwZSBvZiByZXBvc2l0b3J5IGVudHJpZXMgdG8gbGlzdC5cbiAgICogQHBhcmFtIG9wdGlvbnMgRXh0cmEgbGlzdGluZyBvcHRpb25zLlxuICAgKi9cbiAgbGlzdFJlcG9zaXRvcnlFbnRyaWVzKFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLFxuICAgIG9wdGlvbnM/OiB7XG4gICAgICAvKiogQWRkaXRpb25hbCBxdWVyeS4gKi9cbiAgICAgIHF1ZXJ5PzogYW55O1xuICAgICAgLyoqIE9ubHkgaW5jbHVkZSBlbnRyaWVzIHdpdGggbWF0Y2hpbmcgcGFydGlhbCBuYW1lcy4gKi9cbiAgICAgIHBhcnRpYWxOYW1lPzogc3RyaW5nO1xuICAgICAgLyoqIEV4Y2x1ZGUgbGVnYWN5IGVudHJpZXMuICovXG4gICAgICBza2lwTGVnYWN5PzogYm9vbGVhbjtcbiAgICAgIC8qKiBPdGhlciByZXF1ZXN0IHBhcmFtcy4gKi9cbiAgICAgIHBhcmFtcz86IGFueTtcbiAgICB9XG4gICkge1xuICAgIGNvbnN0IGRlZmF1bHRPcmRlciA9IFt7IG5hbWU6IDEgfV07XG4gICAgY29uc3QgZGVmYXVsdEZpbHRlcnMgPSB7IHR5cGUgfTtcbiAgICBjb25zdCBsZWdhY3lGaWx0ZXJzID0geyBfX2hhczogYHVybGAgfTtcblxuICAgIGxldCBmdWxsUXVlcnkgPSAob3B0aW9ucyAmJiBvcHRpb25zLnF1ZXJ5KSB8fCB7fTtcbiAgICBmdWxsUXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZE9yZGVyYnlzKGZ1bGxRdWVyeSwgZGVmYXVsdE9yZGVyLCAncHJlcGVuZCcpO1xuICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZ1bGxRdWVyeSwgZGVmYXVsdEZpbHRlcnMpO1xuICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFydGlhbE5hbWUpIHtcbiAgICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZ1bGxRdWVyeSwgeyBuYW1lOiBgKiR7b3B0aW9ucy5wYXJ0aWFsTmFtZX0qYCB9KTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5za2lwTGVnYWN5KSB7XG4gICAgICBmdWxsUXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihmdWxsUXVlcnksIHsgX19ub3Q6IGxlZ2FjeUZpbHRlcnMgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIHF1ZXJ5OiB0aGlzLnF1ZXJpZXNVdGlsLmJ1aWxkUXVlcnkoZnVsbFF1ZXJ5KSxcbiAgICAgIHBhZ2VTaXplOiA1MCxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgLi4uKChvcHRpb25zICYmIG9wdGlvbnMucGFyYW1zKSB8fCB7fSlcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5saXN0KGZpbHRlcnMpO1xuICB9XG5cbiAgLy8gVE9ETzogbWVyZ2Ugd2l0aCBjcmVhdGUoKVxuICBhc3luYyBzYXZlKGRhdGE6IE1vZGFsTW9kZWwsIHR5cGU6IFJlcG9zaXRvcnlUeXBlLCBtbzogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7fSkge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBSZXBvc2l0b3J5VHlwZS5DT05GSUdVUkFUSU9OOiB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24obW8sIHtcbiAgICAgICAgICB0eXBlOiBSZXBvc2l0b3J5VHlwZS5DT05GSUdVUkFUSU9OLFxuICAgICAgICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBkYXRhLnNlbGVjdGVkID8gZGF0YS5zZWxlY3RlZC5jb25maWd1cmF0aW9uVHlwZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICBuYW1lOiBkYXRhLnZlcnNpb24sXG4gICAgICAgICAgZGVzY3JpcHRpb246IGRhdGEuZGVzY3JpcHRpb24sXG4gICAgICAgICAgZGV2aWNlVHlwZTogZGF0YS5kZXZpY2VUeXBlLFxuICAgICAgICAgIGM4eV9HbG9iYWw6IHt9XG4gICAgICAgIH0pO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBleGlzdGluZ1VybCA9IG1vLnVybDtcbiAgICBpZiAoZGF0YS5iaW5hcnkudXJsKSB7XG4gICAgICBtby51cmwgPSBkYXRhLmJpbmFyeS51cmw7XG4gICAgfSBlbHNlIGlmIChkYXRhLmJpbmFyeS5maWxlKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmNyZWF0ZShkYXRhLmJpbmFyeS5maWxlLCB7XG4gICAgICAgIGM4eV9HbG9iYWw6IHt9XG4gICAgICB9IGFzIFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KTtcbiAgICAgIG1vLnVybCA9IHJlc3BvbnNlLmRhdGEuc2VsZjtcbiAgICB9XG5cbiAgICBpZiAobW8uaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUVudHJ5KG1vLCBleGlzdGluZ1VybCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNyZWF0ZUVudHJ5KG1vKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZShtb2RhbDogTW9kYWxNb2RlbCwgdHlwZTogUmVwb3NpdG9yeVR5cGUpIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgUmVwb3NpdG9yeVR5cGUuRklSTVdBUkU6XG4gICAgICBjYXNlIFJlcG9zaXRvcnlUeXBlLlNPRlRXQVJFOlxuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGaXJtd2FyZU9yU29mdHdhcmUobW9kYWwsIHR5cGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUZpcm13YXJlT3JTb2Z0d2FyZShcbiAgICBtb2RhbDogTW9kYWxNb2RlbCxcbiAgICB0eXBlOiBSZXBvc2l0b3J5VHlwZVxuICApOiBQcm9taXNlPFJlcG9zaXRvcnlDYXRlZ29yeT4ge1xuICAgIGxldCBiaW5hcnk6IElNYW5hZ2VkT2JqZWN0QmluYXJ5O1xuICAgIGxldCBiaW5hcnlVUkw6IHN0cmluZztcbiAgICBsZXQgcmVwb3NpdG9yeUVudHJ5OiBSZXBvc2l0b3J5Q2F0ZWdvcnk7XG4gICAgbGV0IHJlcG9zaXRvcnlCaW5hcnk6IEZpcm13YXJlQmluYXJ5IHwgU29mdHdhcmVCaW5hcnk7XG4gICAgY29uc3QgbW9zID0gW107XG4gICAgY29uc3Qge1xuICAgICAgc2VsZWN0ZWQ6IHsgaWQ6IHNlbGVjdGVkSWQgfSxcbiAgICAgIGJpbmFyeTogeyBmaWxlLCB1cmwgfVxuICAgIH0gPSBtb2RhbDtcbiAgICB0cnkge1xuICAgICAgaWYgKGZpbGUpIHtcbiAgICAgICAgKHsgZGF0YTogYmluYXJ5IH0gPSBhd2FpdCB0aGlzLnNhdmVCaW5hcnkoZmlsZSkpO1xuICAgICAgICAoeyBzZWxmOiBiaW5hcnlVUkwgfSA9IGJpbmFyeSk7XG4gICAgICAgIG1vcy5wdXNoKGJpbmFyeSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBiaW5hcnlVUkwgPSB1cmw7XG4gICAgICB9XG5cbiAgICAgICh7IGRhdGE6IHJlcG9zaXRvcnlFbnRyeSB9ID0gYXdhaXQgdGhpcy5jcmVhdGVPclVwZGF0ZVJlcG9zaXRvcnlFbnRyeShtb2RhbCwgdHlwZSkpO1xuICAgICAgaWYgKGlzTmlsKHNlbGVjdGVkSWQpKSB7XG4gICAgICAgIG1vcy5wdXNoKHJlcG9zaXRvcnlFbnRyeSk7XG4gICAgICB9XG5cbiAgICAgICh7IGRhdGE6IHJlcG9zaXRvcnlCaW5hcnkgfSA9IGF3YWl0IHRoaXMuY3JlYXRlUmVwb3NpdG9yeUJpbmFyeShcbiAgICAgICAgbW9kYWwsXG4gICAgICAgIGJpbmFyeVVSTCxcbiAgICAgICAgdHlwZSxcbiAgICAgICAgcmVwb3NpdG9yeUVudHJ5XG4gICAgICApKTtcbiAgICAgIG1vcy5wdXNoKHJlcG9zaXRvcnlCaW5hcnkpO1xuXG4gICAgICBpZiAoZmlsZSkge1xuICAgICAgICBhd2FpdCB0aGlzLmxpbmtCaW5hcnkocmVwb3NpdG9yeUJpbmFyeSwgYmluYXJ5KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcG9zaXRvcnlFbnRyeTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5jbGVhblVwKG1vcyk7XG4gICAgICB0aGlzLmVycm9yTXNnKCk7XG5cbiAgICAgIC8vIFByb3BhZ2F0ZSBlcnJvclxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgc2F2ZUJpbmFyeShmaWxlOiBGaWxlKTogUHJvbWlzZTxJUmVzdWx0PElNYW5hZ2VkT2JqZWN0QmluYXJ5Pj4ge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeUJpbmFyeS5jcmVhdGUoZmlsZSwgeyBjOHlfR2xvYmFsOiB7fSB9IGFzIFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KTtcbiAgfVxuXG4gIGNyZWF0ZU9yVXBkYXRlUmVwb3NpdG9yeUVudHJ5KFxuICAgIG1vZGFsOiBNb2RhbE1vZGVsLFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlXG4gICk6IFByb21pc2U8SVJlc3VsdDxSZXBvc2l0b3J5Q2F0ZWdvcnk+PiB7XG4gICAgY29uc3Qge1xuICAgICAgc2VsZWN0ZWQ6IHsgaWQsIG5hbWUgfSxcbiAgICAgIGRlc2NyaXB0aW9uXG4gICAgfSA9IG1vZGFsO1xuXG4gICAgY29uc3QgbW8gPSB7XG4gICAgICBpZCxcbiAgICAgIG5hbWU6IGlkID8gdW5kZWZpbmVkIDogbmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgdHlwZTogaWQgPyB1bmRlZmluZWQgOiB0eXBlLFxuICAgICAgYzh5X0dsb2JhbDoge31cbiAgICB9O1xuXG4gICAgcmV0dXJuIGlkXG4gICAgICA/ICh0aGlzLmludmVudG9yeS51cGRhdGUobW8pIGFzIFByb21pc2U8SVJlc3VsdDxSZXBvc2l0b3J5Q2F0ZWdvcnk+PilcbiAgICAgIDogKHRoaXMuaW52ZW50b3J5LmNyZWF0ZShtbykgYXMgUHJvbWlzZTxJUmVzdWx0PFJlcG9zaXRvcnlDYXRlZ29yeT4+KTtcbiAgfVxuXG4gIGNyZWF0ZVJlcG9zaXRvcnlCaW5hcnkoXG4gICAgbW9kYWw6IE1vZGFsTW9kZWwsXG4gICAgYmluYXJ5VVJMOiBzdHJpbmcsXG4gICAgdHlwZTogUmVwb3NpdG9yeVR5cGUsXG4gICAgcGFyZW50OiBSZXBvc2l0b3J5Q2F0ZWdvcnlcbiAgKTogUHJvbWlzZTxJUmVzdWx0PEZpcm13YXJlQmluYXJ5IHwgU29mdHdhcmVCaW5hcnkgfCBGaXJtd2FyZVBhdGNoQmluYXJ5Pj4ge1xuICAgIGNvbnN0IG1vID0gdGhpcy5wcmVwYXJlUmVwb3NpdG9yeUJpbmFyeU1PKG1vZGFsLCBiaW5hcnlVUkwsIHR5cGUpO1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LmNoaWxkQWRkaXRpb25zQ3JlYXRlKG1vLCBwYXJlbnQpIGFzIFByb21pc2U8XG4gICAgICBJUmVzdWx0PEZpcm13YXJlQmluYXJ5IHwgU29mdHdhcmVCaW5hcnkgfCBGaXJtd2FyZVBhdGNoQmluYXJ5PlxuICAgID47XG4gIH1cblxuICBwcmVwYXJlUmVwb3NpdG9yeUJpbmFyeU1PKG1vZGFsOiBNb2RhbE1vZGVsLCBiaW5hcnlVUkw6IHN0cmluZywgdHlwZTogUmVwb3NpdG9yeVR5cGUpIHtcbiAgICBjb25zdCB7IHZlcnNpb24sIHBhdGNoVmVyc2lvbiwgZGVwZW5kZW5jeSB9ID0gbW9kYWw7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgdHlwZTogUkVQT1NJVE9SWV9CSU5BUllfVFlQRVNbdHlwZV0sXG4gICAgICBbdHlwZV06IHtcbiAgICAgICAgdXJsOiBiaW5hcnlVUkxcbiAgICAgIH0sXG4gICAgICBjOHlfR2xvYmFsOiB7fVxuICAgIH07XG5cbiAgICBpZiAoZGVwZW5kZW5jeSkge1xuICAgICAgc2V0KHJlc3VsdCwgW3R5cGUsICd2ZXJzaW9uJ10sIHBhdGNoVmVyc2lvbik7XG4gICAgICBhc3NpZ24ocmVzdWx0LCB7XG4gICAgICAgIGM4eV9QYXRjaDoge1xuICAgICAgICAgIGRlcGVuZGVuY3k6IGRlcGVuZGVuY3kuYzh5X0Zpcm13YXJlLnZlcnNpb25cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNldChyZXN1bHQsIFt0eXBlLCAndmVyc2lvbiddLCB2ZXJzaW9uKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIGxpbmtCaW5hcnkoXG4gICAgcmVwb3NpdG9yeUJpbmFyeTogRmlybXdhcmVCaW5hcnkgfCBTb2Z0d2FyZUJpbmFyeSxcbiAgICBiaW5hcnk6IElNYW5hZ2VkT2JqZWN0QmluYXJ5XG4gICkge1xuICAgIGNvbnN0IHsgaWQ6IHJlcG9zaXRvcnlCaW5hcnlJZCB9ID0gcmVwb3NpdG9yeUJpbmFyeTtcbiAgICBpZiAoYmluYXJ5KSB7XG4gICAgICBjb25zdCB7IGlkOiBiaW5hcnlJZCB9ID0gYmluYXJ5O1xuICAgICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LmNoaWxkQWRkaXRpb25zQWRkKGJpbmFyeUlkLCByZXBvc2l0b3J5QmluYXJ5SWQpO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFuVXAobW9zVG9EZWxldGU6IElJZGVudGlmaWVkW10pIHtcbiAgICBtb3NUb0RlbGV0ZS5mb3JFYWNoKG1vID0+IHtcbiAgICAgIGNvbnN0IHsgYzh5X0lzQmluYXJ5IH0gPSBtbztcbiAgICAgIGlzVW5kZWZpbmVkKGM4eV9Jc0JpbmFyeSkgPyB0aGlzLmRlbGV0ZShtbykgOiB0aGlzLmludmVudG9yeUJpbmFyeS5kZWxldGUobW8pO1xuICAgIH0pO1xuICB9XG5cbiAgZGVsZXRlKGVudGl0eTogSUlkZW50aWZpZWQpOiBQcm9taXNlPElSZXN1bHQ8bnVsbD4+IHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkuZGVsZXRlKGVudGl0eSwgeyBmb3JjZUNhc2NhZGU6IHRydWUgfSk7XG4gIH1cblxuICBlcnJvck1zZygpIHtcbiAgICBjb25zdCBtc2cgPSBnZXR0ZXh0KCdGYWlsZWQgdG8gc2F2ZScpO1xuICAgIHRoaXMuYWxlcnQuZGFuZ2VyKG1zZyk7XG4gIH1cblxuICBnZXRCYXNlVmVyc2lvbnNDb3VudCQoZW50cnk6IElNYW5hZ2VkT2JqZWN0KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBpZiAodGhpcy5pc0xlZ2FjeUVudHJ5KGVudHJ5KSkge1xuICAgICAgcmV0dXJuIG9mKDEpO1xuICAgIH1cbiAgICByZXR1cm4gZnJvbSh0aGlzLmxpc3RCYXNlVmVyc2lvbnMoZW50cnksIHsgcGFnZVNpemU6IDEsIHdpdGhUb3RhbFBhZ2VzOiB0cnVlIH0pKS5waXBlKFxuICAgICAgbWFwKCh7IHBhZ2luZyB9KSA9PiBwYWdpbmcudG90YWxQYWdlcylcbiAgICApO1xuICB9XG5cbiAgZ2V0QmFzZVZlcnNpb25Gcm9tTU8obW86IFJlcG9zaXRvcnlCaW5hcnkpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmlzUGF0Y2gobW8pID8gZ2V0KG1vLCAnYzh5X1BhdGNoLmRlcGVuZGVuY3knKSA6IGdldChtbywgJ2M4eV9GaXJtd2FyZS52ZXJzaW9uJyk7XG4gIH1cblxuICBpc1BhdGNoKG1vOiBSZXBvc2l0b3J5QmluYXJ5KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhZ2V0KG1vLCAnYzh5X1BhdGNoLmRlcGVuZGVuY3knKTtcbiAgfVxuXG4gIGdldFBhdGNoVmVyc2lvbnNDb3VudCQoZW50cnk6IElNYW5hZ2VkT2JqZWN0LCBiYXNlVmVyc2lvbjogRmlybXdhcmVCaW5hcnkpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIGlmICh0aGlzLmlzTGVnYWN5RW50cnkoYmFzZVZlcnNpb24pKSB7XG4gICAgICByZXR1cm4gb2YoMCk7XG4gICAgfVxuICAgIHJldHVybiBmcm9tKFxuICAgICAgdGhpcy5saXN0UGF0Y2hWZXJzaW9ucyhlbnRyeSwgYmFzZVZlcnNpb24sIHsgcGFnZVNpemU6IDEsIHdpdGhUb3RhbFBhZ2VzOiB0cnVlIH0pXG4gICAgKS5waXBlKG1hcCgoeyBwYWdpbmcgfSkgPT4gcGFnaW5nLnRvdGFsUGFnZXMpKTtcbiAgfVxuXG4gIGlzTGVnYWN5RW50cnkoZW50cnk6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIEJvb2xlYW4oZW50cnkudXJsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBhbGwgdmVyc2lvbnMgKGJhc2UgYW5kIHBhdGNoIG9uZXMpIG9mIGdpdmVuIHRvcCBsZXZlbCBlbnRyeS5cbiAgICogVmVyc2lvbnMgYXJlIG9yZGVyZWQgYnkgY3JlYXRpb24gdGltZSAoYXNzdW1pbmcgdGhlIGVhcmxpZXIgY3JlYXRlZCwgdGhlIG9sZGVyIHRoZSB2ZXJzaW9uKS5cbiAgICogQHBhcmFtIGVudHJ5IFRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5LlxuICAgKiBAcGFyYW0gcGFyYW1zIEFkZGl0aW9uYWwgcXVlcnkgcGFyYW1zLlxuICAgKi9cbiAgbGlzdEFsbFZlcnNpb25zKGVudHJ5OiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiwgcGFyYW1zID0ge30pIHtcbiAgICBpZiAodGhpcy5pc0xlZ2FjeUVudHJ5KGVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0QmFzZVZlcnNpb25SZXN1bHRMaXN0Rm9yTGVnYWN5RW50cnkoZW50cnkpO1xuICAgIH1cblxuICAgIGNvbnN0IFZFUlNJT05fRklMVEVSX09SREVSID0ge1xuICAgICAgX19maWx0ZXI6IHt9LFxuICAgICAgX19vcmRlcmJ5OiBbeyAnY3JlYXRpb25UaW1lLmRhdGUnOiAtMSB9LCB7IGNyZWF0aW9uVGltZTogLTEgfV1cbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmxpc3RDaGlsZHJlbihlbnRyeSwgVkVSU0lPTl9GSUxURVJfT1JERVIsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYmFzZSB2ZXJzaW9ucyBvZiBnaXZlbiB0b3AgbGV2ZWwgZW50cnkuXG4gICAqIFZlcnNpb25zIGFyZSBvcmRlcmVkIGJ5IGNyZWF0aW9uIHRpbWUgKGFzc3VtaW5nIHRoZSBlYXJsaWVyIGNyZWF0ZWQsIHRoZSBvbGRlciB0aGUgdmVyc2lvbikuXG4gICAqIEBwYXJhbSBlbnRyeSBUb3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeS5cbiAgICogQHBhcmFtIHBhcmFtcyBBZGRpdGlvbmFsIHF1ZXJ5IHBhcmFtcy5cbiAgICovXG4gIGxpc3RCYXNlVmVyc2lvbnMoZW50cnk6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+LCBwYXJhbXMgPSB7fSkge1xuICAgIGlmICh0aGlzLmlzTGVnYWN5RW50cnkoZW50cnkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRCYXNlVmVyc2lvblJlc3VsdExpc3RGb3JMZWdhY3lFbnRyeShlbnRyeSk7XG4gICAgfVxuXG4gICAgY29uc3QgTk9fUEFUQ0hfRklMVEVSX09SREVSID0ge1xuICAgICAgX19maWx0ZXI6IHtcbiAgICAgICAgX19ub3Q6IHsgX19oYXM6ICdjOHlfUGF0Y2gnIH1cbiAgICAgIH0sXG4gICAgICBfX29yZGVyYnk6IFt7ICdjcmVhdGlvblRpbWUuZGF0ZSc6IC0xIH0sIHsgY3JlYXRpb25UaW1lOiAtMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMubGlzdENoaWxkcmVuKGVudHJ5LCBOT19QQVRDSF9GSUxURVJfT1JERVIsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgcGF0Y2ggdmVyc2lvbnMgb2YgZ2l2ZW4gYmFzZSB2ZXJzaW9uIHVuZGVyIHRoZSBlbnRyeS5cbiAgICogVmVyc2lvbnMgYXJlIG9yZGVyZWQgYnkgY3JlYXRpb24gdGltZSAoYXNzdW1pbmcgdGhlIGVhcmxpZXIgY3JlYXRlZCwgdGhlIG9sZGVyIHRoZSB2ZXJzaW9uKS5cbiAgICogQHBhcmFtIGVudHJ5IFRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5LlxuICAgKiBAcGFyYW0gYmFzZVZlcnNpb24gQmFzZSB2ZXJzaW9uLlxuICAgKiBAcGFyYW0gcGFyYW1zIEFkZGl0aW9uYWwgcXVlcnkgcGFyYW1zLlxuICAgKi9cbiAgbGlzdFBhdGNoVmVyc2lvbnMoZW50cnk6IElNYW5hZ2VkT2JqZWN0LCBiYXNlVmVyc2lvbjogRmlybXdhcmVCaW5hcnkgfCBzdHJpbmcsIHBhcmFtcyA9IHt9KSB7XG4gICAgY29uc3QgdmVyc2lvbiA9IGlzU3RyaW5nKGJhc2VWZXJzaW9uKSA/IGJhc2VWZXJzaW9uIDogZ2V0KGJhc2VWZXJzaW9uLCAnYzh5X0Zpcm13YXJlLnZlcnNpb24nKTtcbiAgICBjb25zdCBQQVRDSF9GSUxURVJfT1JERVIgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICAnYzh5X1BhdGNoLmRlcGVuZGVuY3knOiB2ZXJzaW9uXG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyAnY3JlYXRpb25UaW1lLmRhdGUnOiAtMSB9LCB7IGNyZWF0aW9uVGltZTogLTEgfV1cbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmxpc3RDaGlsZHJlbihlbnRyeSwgUEFUQ0hfRklMVEVSX09SREVSLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIHBhdGNoIHZlcnNpb25zIG9mIGdpdmVuIGJhc2UgdmVyc2lvbiB1bmRlciB0aGUgZW50cnkgaW5jbHVkaW5nIHRoZSBiYXNlIHZlcnNpb24uXG4gICAqIFZlcnNpb25zIGFyZSBvcmRlcmVkIGJ5IGNyZWF0aW9uIHRpbWUgKGFzc3VtaW5nIHRoZSBlYXJsaWVyIGNyZWF0ZWQsIHRoZSBvbGRlciB0aGUgdmVyc2lvbikuXG4gICAqIEluIHRlcm1zIG9mIGxlZ2FjeSBiYXNlIHZlcnNpb24gdGhlIGVudHJ5IGdldHMgdHJhbnNmb3JtZWQgdG8gZml0IHRoZSBuZWVkZWQgZGF0YSBtb2RlbC5cbiAgICogQHBhcmFtIGVudHJ5IFRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5LlxuICAgKiBAcGFyYW0gYmFzZVZlcnNpb24gQmFzZSB2ZXJzaW9uLlxuICAgKiBAcGFyYW0gcGFyYW1zIEFkZGl0aW9uYWwgcXVlcnkgcGFyYW1zLlxuICAgKi9cbiAgbGlzdEJhc2VWZXJzaW9uQW5kUGF0Y2hlcyhlbnRyeTogSU1hbmFnZWRPYmplY3QsIGJhc2VWZXJzaW9uOiBJTWFuYWdlZE9iamVjdCwgcGFyYW1zID0ge30pIHtcbiAgICBpZiAodGhpcy5pc0xlZ2FjeUVudHJ5KGVudHJ5KSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIGRhdGE6IFtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBjOHlfRmlybXdhcmU6IHtcbiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBlbnRyeS52ZXJzaW9uLFxuICAgICAgICAgICAgICAgIHVybDogZW50cnkudXJsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbnRyeVxuICAgICAgICAgIClcbiAgICAgICAgXVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgUEFUQ0hfRklMVEVSX09SREVSID0ge1xuICAgICAgX19maWx0ZXI6IHtcbiAgICAgICAgX19vcjoge1xuICAgICAgICAgICdjOHlfUGF0Y2guZGVwZW5kZW5jeSc6IGJhc2VWZXJzaW9uLmM4eV9GaXJtd2FyZS52ZXJzaW9uLFxuICAgICAgICAgICdjOHlfRmlybXdhcmUudmVyc2lvbic6IGJhc2VWZXJzaW9uLmM4eV9GaXJtd2FyZS52ZXJzaW9uXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBfX29yZGVyYnk6IFt7ICdjOHlfUGF0Y2guZGVwZW5kZW5jeSc6IDEgfSwgeyAnYzh5X0Zpcm13YXJlLnZlcnNpb24nOiAxIH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5saXN0Q2hpbGRyZW4oZW50cnksIFBBVENIX0ZJTFRFUl9PUkRFUiwgcGFyYW1zKTtcbiAgfVxuXG4gIGxpc3RDaGlsZHJlbihlbnRyeTogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4sIGZpbHRlcnMgPSB7fSwgcGFyYW1zOiBhbnkgPSB7fSkge1xuICAgIGNvbnN0IGNoaWxkcmVuRmlsdGVycyA9IHsgX19ieWdyb3VwaWQ6IGVudHJ5LmlkIH07XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihmaWx0ZXJzLCBjaGlsZHJlbkZpbHRlcnMpO1xuICAgIC8vIEZJWE1FOiBuZWVkZWQgYmVjYXVzZSBvZiBpc3N1ZSBpbiBmb3JPZiBkaXJlY3RpdmUgKC4uLilcbiAgICBwYXJhbXMud2l0aFRvdGFsUGFnZXMgPSB0cnVlO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5saXN0UXVlcnkocXVlcnksIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2hlcyBhbGwgaXRlbXMgZnJvbSB0aGUgbGlzdCBzdGFydGluZyB3aXRoIHRoZSBwcm92aWRlZCBwYWdlLlxuICAgKiBAcGFyYW0gZmlyc3RQYWdlIFRoZSBmaXJzdCBwYWdlIG9mIHRoZSBsaXN0IHRvIGZldGNoIGFsbCBpdGVtcyBmb3IuXG4gICAqL1xuICBhc3luYyBmZXRjaEFsbEl0ZW1zRnJvbUxpc3QoZmlyc3RQYWdlKSB7XG4gICAgbGV0IGFsbEl0ZW1zO1xuXG4gICAgaWYgKCFmaXJzdFBhZ2UudGhlbikge1xuICAgICAgYWxsSXRlbXMgPSBbLi4uZmlyc3RQYWdlXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHsgcGFnaW5nLCBkYXRhOiBpdGVtcyB9ID0gYXdhaXQgZmlyc3RQYWdlO1xuICAgICAgYWxsSXRlbXMgPSBbLi4uaXRlbXNdO1xuXG4gICAgICB3aGlsZSAocGFnaW5nICYmIHBhZ2luZy5uZXh0UGFnZSkge1xuICAgICAgICAoeyBwYWdpbmcsIGRhdGE6IGl0ZW1zIH0gPSBhd2FpdCBwYWdpbmcubmV4dCgpKTtcbiAgICAgICAgYWxsSXRlbXMgPSBbLi4uYWxsSXRlbXMsIC4uLml0ZW1zXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYWxsSXRlbXM7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyB0b3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeSBtYW5hZ2VkIG9iamVjdCBmb3IgYmFzZSBvciBwYXRjaCB2ZXJzaW9uLlxuICAgKiBAcGFyYW0gbW8gQmFzZSBvciBwYXRjaCB2ZXJzaW9uIG1hbmFnZWQgb2JqZWN0IHdpdGggcGFyZW50cy5cbiAgICovXG4gIGdldFJlcG9zaXRvcnlFbnRyeU1PJChtbzogSU1hbmFnZWRPYmplY3QpOiBPYnNlcnZhYmxlPElNYW5hZ2VkT2JqZWN0IHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKCFtbykge1xuICAgICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgfVxuICAgIGNvbnN0IFtyZWZlcmVuY2VdID0gZ2V0KG1vLCAnYWRkaXRpb25QYXJlbnRzLnJlZmVyZW5jZXMnKTtcbiAgICBjb25zdCBpZCA9IGdldChyZWZlcmVuY2UsICdtYW5hZ2VkT2JqZWN0LmlkJyk7XG4gICAgcmV0dXJuIGlkXG4gICAgICA/IGZyb20odGhpcy5pbnZlbnRvcnkuZGV0YWlsKGlkLCB7IHdpdGhDaGlsZHJlbjogZmFsc2UgfSkpLnBpcGUobWFwKCh7IGRhdGEgfSkgPT4gZGF0YSkpXG4gICAgICA6IG9mKHVuZGVmaW5lZCk7XG4gIH1cbiAgLyoqXG4gICAqIEdldHMgYmFzZSBvciBwYXRjaCB2ZXJzaW9uIG1hbmFnZWQgb2JqZWN0LlxuICAgKiBAcGFyYW0gZGV2aWNlUmVwb3NpdG9yeUZyYWdtZW50IERldmljZSByZXBvc2l0b3J5IGZyYWdtZW50LlxuICAgKiBAcGFyYW0gdHlwZSBUb3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeSB0eXBlLlxuICAgKiBAcGFyYW0gY29uZmlndXJhdGlvbiBDb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIG9wdGlvbnM6XG4gICAqIC0gKipza2lwTGVnYWN5KiogLSBgYm9vbGVhbmAgLSBFeGNsdWRlIGxlZ2FjeSBlbnRyaWVzLlxuICAgKiAtICoqZmlsdGVycyoqIC0gYG9iamVjdGAgLSBGaWx0ZXIgb2JqZWN0LlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBhcyBpdCBkb2Vzbid0IHN1cHBvcnQgJ21pc3NpbmcgdXJsJyBjYXNlXG4gICAqL1xuICBnZXRSZXBvc2l0b3J5QmluYXJ5TW9CeVZlcnNpb24oXG4gICAgZGV2aWNlUmVwb3NpdG9yeUZyYWdtZW50OiBEZXZpY2VGaXJtd2FyZSB8IERldmljZVNvZnR3YXJlLFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLFxuICAgIHsgc2tpcExlZ2FjeSA9IGZhbHNlLCBmaWx0ZXJzID0ge30gfTogeyBza2lwTGVnYWN5PzogYm9vbGVhbjsgZmlsdGVycz86IG9iamVjdCB9ID0ge31cbiAgKTogUHJvbWlzZTxJTWFuYWdlZE9iamVjdD4ge1xuICAgIGNvbnN0IHsgdmVyc2lvbiwgdXJsLCBuYW1lIH0gPSBkZXZpY2VSZXBvc2l0b3J5RnJhZ21lbnQ7XG4gICAgY29uc3QgcmVwb3NpdG9yeUJpbmFyeVR5cGUgPSBSRVBPU0lUT1JZX0JJTkFSWV9UWVBFU1t0eXBlXTtcbiAgICBsZXQgcXVlcnk7XG4gICAgY29uc3QgbmV3TW9kZWxCYXNlVmVyc2lvblF1ZXJ5ID0ge1xuICAgICAgW2Ake3R5cGV9LnZlcnNpb25gXTogdmVyc2lvbixcbiAgICAgIFtgJHt0eXBlfS51cmxgXTogdXJsLFxuICAgICAgdHlwZTogcmVwb3NpdG9yeUJpbmFyeVR5cGVcbiAgICB9O1xuICAgIGNvbnN0IGxlZ2FjeVZlcnNpb25RdWVyeSA9IHsgdXJsLCB0eXBlLCBuYW1lIH07XG4gICAgZmlsdGVycyA9IHsgd2l0aENoaWxkcmVuOiBmYWxzZSwgd2l0aFBhcmVudHM6IHRydWUsIC4uLmZpbHRlcnMgfTtcblxuICAgIGlmIChza2lwTGVnYWN5KSB7XG4gICAgICBxdWVyeSA9IHtcbiAgICAgICAgX19hbmQ6IHtcbiAgICAgICAgICAuLi5uZXdNb2RlbEJhc2VWZXJzaW9uUXVlcnlcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcXVlcnkgPSB7XG4gICAgICAgIF9fb3I6IFt7IF9fYW5kOiB7IC4uLm5ld01vZGVsQmFzZVZlcnNpb25RdWVyeSB9IH0sIHsgX19hbmQ6IHsgLi4ubGVnYWN5VmVyc2lvblF1ZXJ5IH0gfV1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5Lmxpc3RRdWVyeShxdWVyeSwgZmlsdGVycykudGhlbigoeyBkYXRhIH0pID0+IGhlYWQoZGF0YSkpO1xuICB9XG5cbiAgZ2V0QmluYXJ5TmFtZSQoYmluYXJ5VXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGlmICghYmluYXJ5VXJsKSB7XG4gICAgICByZXR1cm4gb2YoJy0tLScpO1xuICAgIH1cblxuICAgIGNvbnN0IGJpbmFyeUlkID0gdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKGJpbmFyeVVybCk7XG4gICAgaWYgKCFiaW5hcnlJZCkge1xuICAgICAgcmV0dXJuIG9mKGJpbmFyeVVybCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5kZXRhaWwkKGJpbmFyeUlkKS5waXBlKG1hcChtbyA9PiBtby5uYW1lKSk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFuIGludmVudG9yeSBxdWVyeSBvYmplY3Qgd2hpY2ggY2FuIGJlIHVzZWQgdG8gZmluZFxuICAgKiByZXBvc2l0b3J5IGVudHJpZXMgb2Ygc3BlY2lmaWVkIHR5cGUgbWF0Y2hpbmcgdGhlIHR5cGUgb2YgcHJvdmlkZWQgZGV2aWNlLlxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeVR5cGUgVGhlIHR5cGUgb2YgcmVwb3NpdG9yeSBlbnRyaWVzIHdoaWNoIHdpbGwgYmUgcXVlcmllZCB3aXRoIHRoZSBnZW5lcmF0ZWQgcXVlcnkuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggbWF0Y2hpbmcgcmVwb3NpdG9yeSBlbnRyaWVzIHdpbGwgYmUgcXVlcmllZCB3aXRoIHRoZSBnZW5lcmF0ZWQgcXVlcnkuXG4gICAqL1xuICBnZXREZXZpY2VUeXBlUXVlcnkocmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLCBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogb2JqZWN0IHtcbiAgICBsZXQgcmVzdWx0ID0geyB0eXBlOiByZXBvc2l0b3J5VHlwZSB9O1xuICAgIGlmIChkZXZpY2UudHlwZSkge1xuICAgICAgaWYgKHJlcG9zaXRvcnlUeXBlID09PSBSZXBvc2l0b3J5VHlwZS5DT05GSUdVUkFUSU9OKSB7XG4gICAgICAgIHJlc3VsdCA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHJlc3VsdCwge1xuICAgICAgICAgIF9fb3I6IFt7IGRldmljZVR5cGU6IGRldmljZS50eXBlIH0sIHsgX19ub3Q6IHsgX19oYXM6IGBkZXZpY2VUeXBlYCB9IH1dXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIocmVzdWx0LCB7XG4gICAgICAgICAgX19vcjogW3sgJ2M4eV9GaWx0ZXIudHlwZSc6IGRldmljZS50eXBlIH0sIHsgX19ub3Q6IHsgX19oYXM6IGBjOHlfRmlsdGVyLnR5cGVgIH0gfV1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFuIGludmVudG9yeSBxdWVyeSBvYmplY3Qgd2hpY2ggY2FuIGJlIHVzZWQgdG8gZmluZCBjb25maWd1cmF0aW9uIHJlcG9zaXRvcnkgZW50cmllc1xuICAgKiBtYXRjaGluZyB0aGUgdHlwZSBvZiBwcm92aWRlZCBkZXZpY2UgYW5kIHNwZWNpZmllZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggbWF0Y2hpbmcgcmVwb3NpdG9yeSBlbnRyaWVzIHdpbGwgYmUgcXVlcmllZCB3aXRoIHRoZSBnZW5lcmF0ZWQgcXVlcnkuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBDb25maWd1cmF0aW9uIHR5cGUgZm9yIHdoaWNoIG1hdGNoaW5nIHJlcG9zaXRvcnkgZW50cmllcyB3aWxsIGJlIHF1ZXJpZWQgd2l0aCB0aGUgZ2VuZXJhdGVkIHF1ZXJ5LlxuICAgKi9cbiAgZ2V0Q29uZmlndXJhdGlvblR5cGVRdWVyeShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nKTogb2JqZWN0IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMuZ2V0RGV2aWNlVHlwZVF1ZXJ5KFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sIGRldmljZSk7XG4gICAgcmV0dXJuIHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHF1ZXJ5LCB7XG4gICAgICBfX29yOiBbeyBjb25maWd1cmF0aW9uVHlwZSB9LCB7IF9fbm90OiB7IF9faGFzOiBgY29uZmlndXJhdGlvblR5cGVgIH0gfV1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsaXN0IG9mIHNvZnR3YXJlIGluc3RhbGxlZCBpbiB0aGUgZGV2aWNlIGluIHRoZSB1bmlmb3JtIGZvcm1hdC5cbiAgICogU3VwcG9ydHMgYzh5X1NvZnR3YXJlTGlzdCBhbmQgYzh5X1NvZnR3YXJlIGZyYWdtZW50cy5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIHdob3NlIHNvZnR3YXJlIGxpc3Qgc2hvdWxkIGJlIHJldHVybmVkLlxuICAgKi9cbiAgZ2V0RGV2aWNlU29mdHdhcmVMaXN0KGRldmljZTogSU1hbmFnZWRPYmplY3QpOiBEZXZpY2VTb2Z0d2FyZVtdIHtcbiAgICBpZiAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpIHtcbiAgICAgIHJldHVybiBjbG9uZURlZXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpO1xuICAgIH1cbiAgICBpZiAoZGV2aWNlLmM4eV9Tb2Z0d2FyZSkge1xuICAgICAgcmV0dXJuIF9tYXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZSwgKHZlcnNpb24sIG5hbWUpID0+ICh7IG5hbWUsIHZlcnNpb24gfSkpO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBzb2Z0d2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIHRoZSBsaXN0IG9mIGNoYW5nZXMsIGFuZCBzZW5kcyBpdCB0byB0aGUgZGV2aWNlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2Ugd2hpY2ggdGhlIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQgZm9yIGFuZCBzZW50IHRvLlxuICAgKiBAcGFyYW0gY2hhbmdlcyBUaGUgbGlzdCBvZiBzb2Z0d2FyZSBjaGFuZ2VzIHdoaWNoIHNob3VsZCBiZSBhcHBsaWVkLlxuICAgKi9cbiAgYXN5bmMgY3JlYXRlU29mdHdhcmVVcGRhdGVPcGVyYXRpb24oXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdXG4gICk6IFByb21pc2U8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMuZ2V0U29mdHdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlLCBjaGFuZ2VzKTtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMub3BlcmF0aW9uLmNyZWF0ZShvcGVyYXRpb24pKS5kYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgc29mdHdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCBjaGFuZ2VzLlxuICAgKiBSZXR1cm5lZCBvcGVyYXRpb24gdHlwZSBkZXBlbmRzIG9uIGRldmljZSdzIHN1cHBvcnRlZCBvcGVyYXRpb25zLlxuICAgKiBTdXBwb3J0cyBjOHlfU29mdHdhcmVVcGRhdGUsIGM4eV9Tb2Z0d2FyZUxpc3QsIGFuZCBjOHlfU29mdHdhcmUgb3BlcmF0aW9ucy5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCBvcGVyYXRpb24gc2hvdWxkIGJlIHByZXBhcmVkLlxuICAgKiBAcGFyYW0gY2hhbmdlcyBUaGUgbGlzdCBvZiBzb2Z0d2FyZSBjaGFuZ2VzIHdoaWNoIHNob3VsZCBiZSBhcHBsaWVkLlxuICAgKi9cbiAgZ2V0U29mdHdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgY2hhbmdlczogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSk6IElPcGVyYXRpb24ge1xuICAgIGNvbnN0IG9wZXJhdGlvbjogSU9wZXJhdGlvbiA9IHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBkZXNjcmlwdGlvbjogYEFwcGx5IHNvZnR3YXJlIGNoYW5nZXM6ICR7Y2hhbmdlc1xuICAgICAgICAubWFwKFxuICAgICAgICAgIGNoYW5nZSA9PlxuICAgICAgICAgICAgYCR7Y2hhbmdlLmFjdGlvbn0gXCIke2NoYW5nZS5uYW1lfVwiJHtcbiAgICAgICAgICAgICAgY2hhbmdlLnZlcnNpb24gPyBgICh2ZXJzaW9uOiAke2NoYW5nZS52ZXJzaW9ufSlgIDogJydcbiAgICAgICAgICAgIH1gXG4gICAgICAgIClcbiAgICAgICAgLmpvaW4oJywgJyl9YFxuICAgIH07XG4gICAgaWYgKGRldmljZS5jOHlfU3VwcG9ydGVkT3BlcmF0aW9ucy5pbmNsdWRlcygnYzh5X1NvZnR3YXJlVXBkYXRlJykpIHtcbiAgICAgIG9wZXJhdGlvbi5jOHlfU29mdHdhcmVVcGRhdGUgPSBjbG9uZURlZXAoY2hhbmdlcyk7XG4gICAgfSBlbHNlIGlmIChkZXZpY2UuYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMuaW5jbHVkZXMoJ2M4eV9Tb2Z0d2FyZUxpc3QnKSkge1xuICAgICAgb3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QgPSBjbG9uZURlZXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpIHx8IFtdO1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKGNoYW5nZSA9PiB7XG4gICAgICAgIGNvbnN0IGRldmljZVNvZnR3YXJlOiBEZXZpY2VTb2Z0d2FyZSA9IHBpY2soY2hhbmdlLCBbJ25hbWUnLCAndmVyc2lvbicsICd1cmwnXSk7XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnZGVsZXRlJykge1xuICAgICAgICAgIHJlbW92ZShvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCwgZGV2aWNlU29mdHdhcmUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnaW5zdGFsbCcpIHtcbiAgICAgICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdC5wdXNoKGRldmljZVNvZnR3YXJlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChkZXZpY2UuYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMuaW5jbHVkZXMoJ2M4eV9Tb2Z0d2FyZScpKSB7XG4gICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlID0gY2xvbmVEZWVwKGRldmljZS5jOHlfU29mdHdhcmUpIHx8IHt9O1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKGNoYW5nZSA9PiB7XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnZGVsZXRlJykge1xuICAgICAgICAgIGRlbGV0ZSBvcGVyYXRpb24uYzh5X1NvZnR3YXJlW2NoYW5nZS5uYW1lXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhbmdlLmFjdGlvbiA9PT0gJ2luc3RhbGwnKSB7XG4gICAgICAgICAgb3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZVtjaGFuZ2UubmFtZV0gPSBjaGFuZ2UudmVyc2lvbjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgdGhlIGxpc3Qgb2YgZGV2aWNlIHNvZnR3YXJlIGNoYW5nZXMgZnJvbSBnaXZlbiBvcGVyYXRpb24gaW4gdGhlIGNvbnRleHQgb2YgZ2l2ZW4gZGV2aWNlLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gZnJvbSB3aGljaCB0aGUgbGlzdCBzaG91bGQgYmUgZXh0cmFjdGVkLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSB0YXJnZXQgZGV2aWNlIG9mIHRoZSBvcGVyYXRpb24uXG4gICAqL1xuICBnZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tT3BlcmF0aW9uKFxuICAgIG9wZXJhdGlvbjogSU9wZXJhdGlvbixcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0XG4gICk6IERldmljZVNvZnR3YXJlQ2hhbmdlW10ge1xuICAgIGlmIChvcGVyYXRpb24uYzh5X1NvZnR3YXJlVXBkYXRlKSB7XG4gICAgICByZXR1cm4gY2xvbmVEZWVwKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVVcGRhdGUpO1xuICAgIH1cbiAgICBpZiAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21Tb2Z0d2FyZUxpc3RPcGVyYXRpb24ob3BlcmF0aW9uLCBkZXZpY2UpO1xuICAgIH1cbiAgICBpZiAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlU29mdHdhcmVDaGFuZ2VzRnJvbVNvZnR3YXJlT3BlcmF0aW9uKG9wZXJhdGlvbiwgZGV2aWNlKTtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgZmlybXdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCB0aGUgc2VsZWN0ZWQgcmVwb3NpdG9yeSBiaW5hcnksIGFuZCBzZW5kcyBpdCB0byB0aGUgZGV2aWNlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2Ugd2hpY2ggdGhlIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQgZm9yIGFuZCBzZW50IHRvLlxuICAgKiBAcGFyYW0gc2VsZWN0ZWRPcHRpb24gVGhlIHNlbGVjdGVkIHJlcG9zaXRvcnkgYmluYXJ5IG9wdGlvbi5cbiAgICovXG4gIGFzeW5jIGNyZWF0ZUZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRPcHRpb246IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVxuICApOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSB0aGlzLmdldEZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKGRldmljZSwgc2VsZWN0ZWRPcHRpb24pO1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5vcGVyYXRpb24uY3JlYXRlKG9wZXJhdGlvbikpLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBmaXJtd2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIHNlbGVjdGVkIHZlcnNpb24uXG4gICAqIFN1cHBvcnRzIGM4eV9GaXJtd2FyZSBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICogQHBhcmFtIHNlbGVjdGVkT3B0aW9uIFNlbGVjdGVkIGZpcm13YXJlIHZlcnNpb24uXG4gICAqL1xuICBnZXRGaXJtd2FyZVVwZGF0ZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkT3B0aW9uOiBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlcbiAgKTogSU9wZXJhdGlvbiB7XG4gICAgZGVsZXRlIHNlbGVjdGVkT3B0aW9uLmlkO1xuXG4gICAgY29uc3Qgb3BlcmF0aW9uOiBJT3BlcmF0aW9uID0ge1xuICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgIGRlc2NyaXB0aW9uOiBgVXBkYXRlIGZpcm13YXJlIHRvOiBcIiR7c2VsZWN0ZWRPcHRpb24ubmFtZX1cIiR7XG4gICAgICAgIHNlbGVjdGVkT3B0aW9uLnZlcnNpb24gPyBgICh2ZXJzaW9uOiAke3NlbGVjdGVkT3B0aW9uLnZlcnNpb259KWAgOiAnJ1xuICAgICAgfWAsXG4gICAgICBjOHlfRmlybXdhcmU6IHsgLi4uc2VsZWN0ZWRPcHRpb24gfVxuICAgIH07XG5cbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgY29uZmlndXJhdGlvbiBmaWxlIHVwbG9hZCBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBTZWxlY3RlZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBpc0xlZ2FjeSAgQSBsZWdhY3kgb3BlcmF0aW9uIGlzIGNyZWF0ZWQgd2l0aG91dCBhIGNvbmZpZ3VyYXRpb25UeXBlLlxuICAgKi9cbiAgZ2V0VXBsb2FkQ29uZmlndXJhdGlvbkZpbGVPcGVyYXRpb24oXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nLFxuICAgIGlzTGVnYWN5OiBib29sZWFuID0gZmFsc2VcbiAgKTogSU9wZXJhdGlvbiB7XG4gICAgaWYgKGlzTGVnYWN5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFJldHJpZXZlIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZnJvbSBkZXZpY2UgJHtkZXZpY2UubmFtZX1gLFxuICAgICAgICBjOHlfVXBsb2FkQ29uZmlnRmlsZToge31cbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGBSZXRyaWV2ZSAke2NvbmZpZ3VyYXRpb25UeXBlfSBjb25maWd1cmF0aW9uIHNuYXBzaG90IGZyb20gZGV2aWNlICR7XG4gICAgICAgIGRldmljZS5uYW1lXG4gICAgICB9YCxcbiAgICAgIGM4eV9VcGxvYWRDb25maWdGaWxlOiB7XG4gICAgICAgIHR5cGU6IGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyBhIGNvbmZpZ3VyYXRpb24gZmlsZSBkb3dubG9hZCBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBTZWxlY3RlZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBiaW5hcnlVcmwgVGhlIHVybCBvZiBhIGJpbmFyeSB0byBiZSBkb3dubG9hZGVkLlxuICAgKiBAcGFyYW0gaXNMZWdhY3kgQSBsZWdhY3kgb3BlcmF0aW9uIGlzIGNyZWF0ZWQgd2l0aG91dCBhIGNvbmZpZ3VyYXRpb25UeXBlLlxuICAgKi9cbiAgZ2V0RG93bmxvYWRDb25maWd1cmF0aW9uRmlsZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBzdHJpbmcsXG4gICAgY29uZmlnU25hcHNob3Q6IENvbmZpZ3VyYXRpb25TbmFwc2hvdCxcbiAgICBpc0xlZ2FjeTogYm9vbGVhbiA9IGZhbHNlXG4gICk6IElPcGVyYXRpb24ge1xuICAgIGlmIChpc0xlZ2FjeSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgICAgZGVzY3JpcHRpb246IGBTZW5kIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgJHtjb25maWdTbmFwc2hvdC5uYW1lfSB0byBkZXZpY2UgJHtkZXZpY2UubmFtZX1gLFxuICAgICAgICBjOHlfRG93bmxvYWRDb25maWdGaWxlOiB7XG4gICAgICAgICAgdXJsOiBjb25maWdTbmFwc2hvdC5iaW5hcnlVcmwsXG4gICAgICAgICAgYzh5X0NvbmZpZ3VyYXRpb25EdW1wOiB7XG4gICAgICAgICAgICBpZDogY29uZmlnU25hcHNob3QuaWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGBTZW5kIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgJHtcbiAgICAgICAgY29uZmlnU25hcHNob3QubmFtZVxuICAgICAgfSBvZiBjb25maWd1cmF0aW9uIHR5cGUgJHtjb25maWd1cmF0aW9uVHlwZX0gdG8gZGV2aWNlICR7ZGV2aWNlLm5hbWV9YCxcbiAgICAgIGM4eV9Eb3dubG9hZENvbmZpZ0ZpbGU6IHtcbiAgICAgICAgdXJsOiBjb25maWdTbmFwc2hvdC5iaW5hcnlVcmwsXG4gICAgICAgIHR5cGU6IGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsYXN0IGZpcm13YXJlIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZS5cbiAgICogTG9va3MgZm9yIGM4eV9GaXJtd2FyZSBvcGVyYXRpb25zLlxuICAgKiBAcGFyYW0gZGV2aWNlSWQgVGhlIElEIG9mIHRoZSBkZXZpY2UgdG8gZmluZCBhbiBvcGVyYXRpb24gZm9yLlxuICAgKi9cbiAgYXN5bmMgZ2V0TGFzdEZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBkYXRlRnJvbTogbmV3IERhdGUoMCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRGaXJzdE1hdGNoaW5nT3BlcmF0aW9uKFt7IC4uLmZpbHRlcnMsIGZyYWdtZW50VHlwZTogJ2M4eV9GaXJtd2FyZScgfV0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxhc3Qgc29mdHdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlLlxuICAgKiBMb29rcyBmb3IgYzh5X1NvZnR3YXJlVXBkYXRlLCBjOHlfU29mdHdhcmVMaXN0LCBvciBjOHlfU29mdHdhcmUgb3BlcmF0aW9ucy5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBJRCBvZiB0aGUgZGV2aWNlIHRvIGZpbmQgYW4gb3BlcmF0aW9uIGZvci5cbiAgICovXG4gIGFzeW5jIGdldExhc3RTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZGF0ZUZyb206IG5ldyBEYXRlKDApLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IG5ldyBEYXRlKERhdGUubm93KCkpLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0Rmlyc3RNYXRjaGluZ09wZXJhdGlvbihbXG4gICAgICB7IC4uLmZpbHRlcnMsIGZyYWdtZW50VHlwZTogJ2M4eV9Tb2Z0d2FyZVVwZGF0ZScgfSxcbiAgICAgIHsgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X1NvZnR3YXJlTGlzdCcgfSxcbiAgICAgIHsgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X1NvZnR3YXJlJyB9XG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogSXRlcmF0ZXMgb3ZlciB0aGUgbGlzdCBvZiBmaWx0ZXJzIGFuZCBxdWVyaWVzIHRoZSBvcGVyYXRpb25zLlxuICAgKiBJZiBhIHF1ZXJ5IHJldHVybnMgYXQgbGVhc3Qgb25lIG9wZXJhdGlvbiwgdGhlIGZpcnN0IG9uZSB3aWxsIGJlIHJldHVybmVkLlxuICAgKiBPdGhlcndpc2UgdGhlIG5leHQgcXVlcnkgd2lsbCBiZSBwZXJmb3JtZWQuXG4gICAqIElmIG5vbmUgb2YgdGhlIHF1ZXJpZXMgcmV0dXJucyBhbnkgb3BlcmF0aW9uLCBudWxsIHdpbGwgYmUgcmV0dXJuZWQuXG4gICAqIEBwYXJhbSBmaWx0ZXJzTGlzdCBUaGUgbGlzdCBvZiBmaWx0ZXJzIGZvciB0aGUgcXVlcmllcy5cbiAgICovXG4gIGFzeW5jIGdldEZpcnN0TWF0Y2hpbmdPcGVyYXRpb24oZmlsdGVyc0xpc3Q6IGFueVtdKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgbGV0IG1hdGNoaW5nT3BlcmF0aW9uID0gbnVsbDtcblxuICAgIGZvciAoY29uc3QgZmlsdGVycyBvZiBmaWx0ZXJzTGlzdCkge1xuICAgICAgY29uc3Qgb3BlcmF0aW9ucyA9IChhd2FpdCB0aGlzLm9wZXJhdGlvbi5saXN0KGZpbHRlcnMpKS5kYXRhO1xuICAgICAgaWYgKG9wZXJhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgIG1hdGNoaW5nT3BlcmF0aW9uID0gb3BlcmF0aW9uc1swXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hdGNoaW5nT3BlcmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgdGhlIG9wZXJhdGlvbiBhbmQgcmV0dXJucyBhbiBvYnNlcnZhYmxlIHRvIHRyYWNrIGl0cyBwcm9ncmVzcy5cbiAgICogRmFpbHMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgRkFJTEVEIHN0YXR1cy5cbiAgICogQ29tcGxldGVzIHRoZSBvYnNlcnZhYmxlIHdoZW4gdGhlIG9wZXJhdGlvbiByZXR1cm5zIFNVQ0NFU1NGVUwgc3RhdHVzLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gdG8gY3JlYXRlIGFuZCB0cmFjay5cbiAgICovXG4gIGNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IE9ic2VydmFibGU8SU9wZXJhdGlvbj4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMub3BlcmF0aW9uLmNyZWF0ZShvcGVyYXRpb24pKS5waXBlKFxuICAgICAgbWFwKCh7IGRhdGEgfSkgPT4gZGF0YSksXG4gICAgICB0YWtlKDEpLFxuICAgICAgc3dpdGNoTWFwKGNyZWF0ZWRPcGVyYXRpb24gPT4gdGhpcy5vYnNlcnZlT3BlcmF0aW9uKGNyZWF0ZWRPcGVyYXRpb24pKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBvYnNlcnZhYmxlIHRvIHRyYWNrIHByb2dyZXNzIG9mIGdpdmVuIG9wZXJhdGlvbi5cbiAgICogRmFpbHMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgRkFJTEVEIHN0YXR1cy5cbiAgICogQ29tcGxldGVzIHRoZSBvYnNlcnZhYmxlIHdoZW4gdGhlIG9wZXJhdGlvbiByZXR1cm5zIFNVQ0NFU1NGVUwgc3RhdHVzLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gdG8gYmUgb2JzZXJ2ZWQuXG4gICAqL1xuICBvYnNlcnZlT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IE9ic2VydmFibGU8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IG9ic2VydmVkT3BlcmF0aW9uJCA9IG9mKG9wZXJhdGlvbik7XG4gICAgY29uc3Qgb3BlcmF0aW9uVXBkYXRlcyQgPSBvYnNlcnZlZE9wZXJhdGlvbiQucGlwZShcbiAgICAgIHN3aXRjaE1hcChvYnNlcnZlZE9wZXJhdGlvbiA9PlxuICAgICAgICB0aGlzLnJlYWx0aW1lLm9ic2VydmFibGUoYC9vcGVyYXRpb25zLyR7b2JzZXJ2ZWRPcGVyYXRpb24uZGV2aWNlSWR9YClcbiAgICAgICksXG4gICAgICBtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKSxcbiAgICAgIHdpdGhMYXRlc3RGcm9tKG9ic2VydmVkT3BlcmF0aW9uJCksXG4gICAgICBmaWx0ZXIoKFtvcGVyYXRpb25VcGRhdGUsIG9ic2VydmVkT3BlcmF0aW9uXSkgPT4gb3BlcmF0aW9uVXBkYXRlLmlkID09PSBvYnNlcnZlZE9wZXJhdGlvbi5pZCksXG4gICAgICBzd2l0Y2hNYXAoKFtvcGVyYXRpb25VcGRhdGVdKSA9PiB7XG4gICAgICAgIGlmIChvcGVyYXRpb25VcGRhdGUuc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuRkFJTEVEKSB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3Iob3BlcmF0aW9uVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb2Yob3BlcmF0aW9uVXBkYXRlKTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVdoaWxlKG9wZXJhdGlvblVwZGF0ZSA9PiBvcGVyYXRpb25VcGRhdGUuc3RhdHVzICE9PSBPcGVyYXRpb25TdGF0dXMuU1VDQ0VTU0ZVTCwgdHJ1ZSlcbiAgICApO1xuICAgIHJldHVybiBtZXJnZShvYnNlcnZlZE9wZXJhdGlvbiQsIG9wZXJhdGlvblVwZGF0ZXMkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGEgc2luZ2xlIGV2ZW50IHdpdGggbGF0ZXN0IGNyZWF0aW9uVGltZSBmb3IgdGhlIGdpdmVuIGRldmljZSBJZCBhbmQgZXZlbnQgdHlwZS5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBkZXZpY2UgSWQgZm9yIHdoaWNoIHRoZSBldmVudHMgc2hvdWxkIGJlIHF1ZXJpZWQuXG4gICAqIEBwYXJhbSB0eXBlIEV2ZW50IHR5cGUuXG4gICAqL1xuICBhc3luYyBnZXRMYXRlc3RDb25maWd1cmF0aW9uRXZlbnQoXG4gICAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlcixcbiAgICB0eXBlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJRXZlbnQgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBldmVudEZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgc291cmNlOiBkZXZpY2VJZCxcbiAgICAgIHR5cGUsXG4gICAgICBkYXRlRnJvbTogdGhpcy5kYXRlRnJvbS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0ZVRvOiB0aGlzLmRhdGVUby50b0lTT1N0cmluZygpLFxuICAgICAgcGFnZVNpemU6IDFcbiAgICB9O1xuXG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmV2ZW50Lmxpc3QoZXZlbnRGaWx0ZXIpO1xuICAgIHJldHVybiBkYXRhWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYSBsaXN0IG9mIG9wZXJhdGlvbnMgZm9yIHRoZSBnaXZlbiBkZXZpY2UgSWQsIGFuZCBvcGVyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBkZXZpY2UgSWQgZm9yIHdoaWNoIHRoZSBvcGVyYXRpb24gc2hvdWxkIGJlIHF1ZXJpZWQuXG4gICAqIEBwYXJhbSBvcGVyYXRpb25UeXBlIE9wZXJhdGlvbiB0eXBlIGZyYWdtZW50LlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnRmlsZU9wZXJhdGlvbkxpc3QoXG4gICAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlcixcbiAgICBvcGVyYXRpb25UeXBlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJT3BlcmF0aW9uW10+IHtcbiAgICBjb25zdCBvcGVyYXRpb25GaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZnJhZ21lbnRUeXBlOiBvcGVyYXRpb25UeXBlLFxuICAgICAgZGF0ZUZyb206IHRoaXMuZGF0ZUZyb20udG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogdGhpcy5kYXRlVG8udG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAyMDAwXG4gICAgfTtcblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5vcGVyYXRpb24ubGlzdChvcGVyYXRpb25GaWx0ZXIpKS5kYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgbGF0ZXN0IHVwbG9hZGVkIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZm9yIHRoZSBnaXZlbiBkZXZpY2UsIGFuZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggdGhlIGNvbmZpZ3VyYXRpb24gc25hcHNob3Qgd2FzIHVwbG9hZGVkLlxuICAgKiBAcGFyYW0gY29uZmlndXJhdGlvblR5cGUgU2VsZWN0ZWQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnU25hcHNob3QoXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nXG4gICk6IFByb21pc2U8Q29uZmlndXJhdGlvblNuYXBzaG90IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgZXZlbnQ6IElFdmVudCA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0Q29uZmlndXJhdGlvbkV2ZW50KGRldmljZS5pZCwgY29uZmlndXJhdGlvblR5cGUpO1xuICAgIGxldCBjb25maWdTbmFwc2hvdDogQ29uZmlndXJhdGlvblNuYXBzaG90O1xuICAgIGlmIChldmVudCkge1xuICAgICAgY29uZmlnU25hcHNob3QgPSB7XG4gICAgICAgIHRpbWU6IGV2ZW50LnRpbWUsXG4gICAgICAgIG5hbWU6IGV2ZW50LnRleHQsXG4gICAgICAgIGRldmljZVR5cGU6IGRldmljZS50eXBlLFxuICAgICAgICBjb25maWd1cmF0aW9uVHlwZVxuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbmZpZ1NuYXBzaG90LmJpbmFyeSA9IGF3YWl0IChhd2FpdCB0aGlzLmV2ZW50QmluYXJ5LmRvd25sb2FkKGV2ZW50KSkudGV4dCgpO1xuICAgICAgICBpZiAoZXZlbnQuYzh5X0lzQmluYXJ5KSB7XG4gICAgICAgICAgY29uZmlnU25hcHNob3QuYmluYXJ5VHlwZSA9IGV2ZW50LmM4eV9Jc0JpbmFyeS50eXBlO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICBjb25zdCBtc2cgPSBnZXR0ZXh0KCdDb3VsZCBub3QgZ2V0IHRoZSBiaW5hcnkuJyk7XG4gICAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKG1zZyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBjb25maWdTbmFwc2hvdDtcbiAgfVxuXG4gIGFzeW5jIGdldExlZ2FjeUNvbmZpZ1NuYXBzaG90KGRldmljZUlkKSB7XG4gICAgbGV0IGNvbmZpZ1NuYXBzaG90OiBDb25maWd1cmF0aW9uU25hcHNob3Q7XG4gICAgbGV0IG1vO1xuICAgIGNvbnN0IGRldmljZSA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoZGV2aWNlSWQsIHsgd2l0aENoaWxkcmVuOiBmYWxzZSB9KSkuZGF0YTtcbiAgICBjb25zdCBzbmFwc2hvdElkID0gZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uRHVtcCAmJiBkZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb25EdW1wLmlkO1xuICAgIGlmICghc25hcHNob3RJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBtbyA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoc25hcHNob3RJZCkpLmRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gICAgaWYgKG1vKSB7XG4gICAgICBjb25maWdTbmFwc2hvdCA9IHtcbiAgICAgICAgdGltZTogbW8uY3JlYXRpb25UaW1lLFxuICAgICAgICBuYW1lOiBtby5uYW1lXG4gICAgICB9O1xuICAgICAgY29uZmlnU25hcHNob3QuYmluYXJ5ID0gYXdhaXQgdGhpcy5nZXRCaW5hcnlUZXh0KG1vLnVybCwgeyBhbGxvd0V4dGVybmFsOiBmYWxzZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ1NuYXBzaG90O1xuICB9XG5cbiAgYXN5bmMgZ2V0QmluYXJ5RmlsZShiaW5hcnlVcmw6IHN0cmluZywgb3B0aW9uczogeyBhbGxvd0V4dGVybmFsOiBib29sZWFuIH0pOiBQcm9taXNlPEZpbGU+IHtcbiAgICBjb25zdCBiaW5hcnlJZCA9IHRoaXMuaW52ZW50b3J5QmluYXJ5LmdldElkRnJvbVVybChiaW5hcnlVcmwpO1xuXG4gICAgaWYgKCFiaW5hcnlJZCAmJiAhb3B0aW9ucy5hbGxvd0V4dGVybmFsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkuZGV0YWlsKGJpbmFyeUlkKTtcbiAgICBjb25zdCBiaW5hcnkgPSAhIWJpbmFyeUlkXG4gICAgICA/IGF3YWl0IHRoaXMuZ2V0QmluYXJ5KGJpbmFyeUlkKVxuICAgICAgOiB0aGlzLmZldGNoRXh0ZXJuYWxCaW5hcnkoYmluYXJ5VXJsKTtcbiAgICBjb25zdCBmaWxlQmluYXJ5ID0gbmV3IEZpbGUoW2JpbmFyeV0sIGRhdGEubmFtZSwgeyB0eXBlOiBkYXRhLmNvbnRlbnRUeXBlIH0pO1xuICAgIHJldHVybiBmaWxlQmluYXJ5O1xuICB9XG5cbiAgZ2V0QmluYXJ5VGV4dChiaW5hcnlVcmw6IHN0cmluZywgb3B0aW9uczogeyBhbGxvd0V4dGVybmFsOiBib29sZWFuIH0pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGJpbmFyeUlkID0gdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKGJpbmFyeVVybCk7XG4gICAgaWYgKCFiaW5hcnlJZCAmJiBvcHRpb25zLmFsbG93RXh0ZXJuYWwpIHtcbiAgICAgIHJldHVybiB0aGlzLmZldGNoRXh0ZXJuYWxCaW5hcnkoYmluYXJ5VXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0QmluYXJ5KGJpbmFyeUlkKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QmluYXJ5KGJpbmFyeUlkKSB7XG4gICAgbGV0IGJpbmFyeTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZG93bmxvYWQoYmluYXJ5SWQpO1xuICAgICAgYmluYXJ5ID0gYXdhaXQgcmVzLnRleHQoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnQ291bGQgbm90IGdldCB0aGUgYmluYXJ5LicpO1xuICAgICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYmluYXJ5O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmZXRjaEV4dGVybmFsQmluYXJ5KHVybCkge1xuICAgIGxldCBjb25maWdCaW5hcnk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgIGNvbmZpZ0JpbmFyeSA9IGF3YWl0IHJlcy50ZXh0KCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGNvbnN0IG1zZyA9IGdldHRleHQoJ0NvdWxkIG5vdCBnZXQgdGhlIGV4dGVybmFsIGJpbmFyeS4nKTtcbiAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKG1zZyk7XG4gICAgfVxuICAgIHJldHVybiBjb25maWdCaW5hcnk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUVudHJ5KG1vOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0Pikge1xuICAgIGNvbnN0IGJpbmFyeUlkID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKG1vLnVybCk7XG4gICAgY29uc3QgbmV3TW8gPSBhd2FpdCB0aGlzLmludmVudG9yeS5jcmVhdGUobW8pO1xuICAgIGlmIChiaW5hcnlJZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQoYmluYXJ5SWQsIG5ld01vLmRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3TW87XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZUVudHJ5KG1vOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiwgdXJsKSB7XG4gICAgY29uc3QgZXhpc3RpbmdCaW5hcnlJZCA9IGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmdldElkRnJvbVVybCh1cmwpO1xuICAgIGNvbnN0IG5ld0JpbmFyeUlkID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKG1vLnVybCk7XG4gICAgaWYgKGV4aXN0aW5nQmluYXJ5SWQgJiYgZXhpc3RpbmdCaW5hcnlJZCAhPT0gbmV3QmluYXJ5SWQpIHtcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKHVybCk7XG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5kZWxldGUoaWQpO1xuICAgIH1cbiAgICBpZiAobmV3QmluYXJ5SWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5LmNoaWxkQWRkaXRpb25zQWRkKG5ld0JpbmFyeUlkLCBtbyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmludmVudG9yeS51cGRhdGUobW8pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRCYXNlVmVyc2lvblJlc3VsdExpc3RGb3JMZWdhY3lFbnRyeShlbnRyeSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgcmVzOiB7fSBhcyBJRmV0Y2hSZXNwb25zZSxcbiAgICAgIGRhdGE6IFtcbiAgICAgICAge1xuICAgICAgICAgIC4uLmVudHJ5LFxuICAgICAgICAgIFtlbnRyeS50eXBlXToge1xuICAgICAgICAgICAgdmVyc2lvbjogZW50cnkudmVyc2lvbixcbiAgICAgICAgICAgIHVybDogZW50cnkudXJsXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfSBhcyBJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tU29mdHdhcmVMaXN0T3BlcmF0aW9uKFxuICAgIG9wZXJhdGlvbjogSU9wZXJhdGlvbixcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0XG4gICk6IERldmljZVNvZnR3YXJlQ2hhbmdlW10ge1xuICAgIGNvbnN0IGNoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW10gPSBbXTtcbiAgICBmb3JFYWNoKGRldmljZS5jOHlfU29mdHdhcmVMaXN0LCBkZXZpY2VTb2Z0d2FyZSA9PiB7XG4gICAgICBjb25zdCBvcGVyYXRpb25Tb2Z0d2FyZSA9IGZpbmQob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QsIHsgbmFtZTogZGV2aWNlU29mdHdhcmUubmFtZSB9KTtcbiAgICAgIGlmIChkZXZpY2VTb2Z0d2FyZS52ZXJzaW9uICE9PSBvcGVyYXRpb25Tb2Z0d2FyZS52ZXJzaW9uKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgLi4uZGV2aWNlU29mdHdhcmUsXG4gICAgICAgICAgYWN0aW9uOiAnZGVsZXRlJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBmb3JFYWNoKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVMaXN0LCBvcGVyYXRpb25Tb2Z0d2FyZSA9PiB7XG4gICAgICBjb25zdCBkZXZpY2VTb2Z0d2FyZSA9IGZpbmQoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QsIHsgbmFtZTogb3BlcmF0aW9uU29mdHdhcmUubmFtZSB9KTtcbiAgICAgIGlmIChvcGVyYXRpb25Tb2Z0d2FyZS52ZXJzaW9uICE9PSBkZXZpY2VTb2Z0d2FyZS52ZXJzaW9uKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgLi4ub3BlcmF0aW9uU29mdHdhcmUsXG4gICAgICAgICAgYWN0aW9uOiAnaW5zdGFsbCdcbiAgICAgICAgfSBhcyBEZXZpY2VTb2Z0d2FyZUNoYW5nZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNoYW5nZXM7XG4gIH1cblxuICBwcml2YXRlIGdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21Tb2Z0d2FyZU9wZXJhdGlvbihcbiAgICBvcGVyYXRpb246IElPcGVyYXRpb24sXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdFxuICApOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdIHtcbiAgICBjb25zdCBjaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdID0gW107XG4gICAgZm9yRWFjaChkZXZpY2UuYzh5X1NvZnR3YXJlLCAoZGV2aWNlU29mdHdhcmVWZXJzaW9uLCBkZXZpY2VTb2Z0d2FyZU5hbWUpID0+IHtcbiAgICAgIGlmIChvcGVyYXRpb24uYzh5X1NvZnR3YXJlW2RldmljZVNvZnR3YXJlTmFtZV0gIT09IGRldmljZVNvZnR3YXJlVmVyc2lvbikge1xuICAgICAgICBjaGFuZ2VzLnB1c2goe1xuICAgICAgICAgIG5hbWU6IGRldmljZVNvZnR3YXJlTmFtZSxcbiAgICAgICAgICB2ZXJzaW9uOiBkZXZpY2VTb2Z0d2FyZVZlcnNpb24sXG4gICAgICAgICAgYWN0aW9uOiAnZGVsZXRlJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBmb3JFYWNoKG9wZXJhdGlvbi5jOHlfU29mdHdhcmUsIChvcGVyYXRpb25Tb2Z0d2FyZVZlcnNpb24sIG9wZXJhdGlvblNvZnR3YXJlTmFtZSkgPT4ge1xuICAgICAgaWYgKGRldmljZS5jOHlfU29mdHdhcmVbb3BlcmF0aW9uU29mdHdhcmVOYW1lXSAhPT0gb3BlcmF0aW9uU29mdHdhcmVWZXJzaW9uKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgbmFtZTogb3BlcmF0aW9uU29mdHdhcmVOYW1lLFxuICAgICAgICAgIHZlcnNpb246IG9wZXJhdGlvblNvZnR3YXJlVmVyc2lvbixcbiAgICAgICAgICBhY3Rpb246ICdpbnN0YWxsJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY2hhbmdlcztcbiAgfVxufVxuIl19