import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IManagedObject, InventoryService, IOperation, IResultList, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService } from '@c8y/ngx-components';
import { sortBy, toArray, get } from 'lodash-es';
var DeviceProfileService = /** @class */ (function () {
    function DeviceProfileService(inventoryService, operationService, alertService) {
        this.inventoryService = inventoryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.queriesUtil = new QueriesUtil();
    }
    DeviceProfileService.prototype.createDeviceProfile = function (deviceProfile) {
        return this.inventoryService.create(deviceProfile);
    };
    DeviceProfileService.prototype.getDeviceProfilesByDeviceType = function (deviceType) {
        var deviceTypeFilter = {
            __or: [{ 'c8y_Filter.type': deviceType }, { __not: { __has: 'c8y_Filter.type' } }]
        };
        return this.getDeviceProfiles(deviceTypeFilter);
    };
    DeviceProfileService.prototype.getDeviceProfiles = function (andQuery) {
        var query = {
            type: 'c8y_Profile'
        };
        var filter = {
            pageSize: 100,
            withTotalPages: true
        };
        query = this.queriesUtil.addAndFilter(query, andQuery || {});
        return this.inventoryService.listQuery(query, filter);
    };
    DeviceProfileService.prototype.getProfileOperation = function (deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filter, operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        filter = {
                            deviceId: deviceId,
                            fragmentType: 'c8y_DeviceProfile',
                            dateFrom: this.dateFrom.toISOString(),
                            dateTo: this.dateTo.toISOString(),
                            revert: true,
                            pageSize: 1
                        };
                        return [4 /*yield*/, this.operationService.list(filter)];
                    case 1:
                        operation = (_a.sent()).data[0];
                        return [2 /*return*/, operation && operation.status !== OperationStatus.SUCCESSFUL ? operation : undefined];
                }
            });
        });
    };
    DeviceProfileService.prototype.createProfileOperation = function (device, deviceProfile) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation, operationCfg, data, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        operationCfg = {
                            deviceId: device.id,
                            profileId: deviceProfile.id,
                            profileName: deviceProfile.name,
                            c8y_DeviceProfile: deviceProfile.c8y_DeviceProfile,
                            description: "Assign device profile " + deviceProfile.name + " to device " + device.name
                        };
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.operationService.create(operationCfg)];
                    case 2:
                        data = (_a.sent()).data;
                        operation = data;
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        this.alertService.addServerFailure(ex_1);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/, operation];
                }
            });
        });
    };
    DeviceProfileService.prototype.getFirmwareItems = function (device, selectedProfile) {
        var deviceFirmware = device.c8y_Firmware;
        var profileFirmware = get(selectedProfile, 'c8y_DeviceProfile.firmware');
        var deviceItems = [];
        var profileItems = [];
        if (deviceFirmware) {
            deviceItems.push(deviceFirmware);
        }
        if (profileFirmware) {
            profileItems.push(profileFirmware);
        }
        return this.createProfileComparison(deviceItems, profileItems, 'version');
    };
    DeviceProfileService.prototype.getSoftwareItems = function (device, selectedProfile) {
        var deviceSoftware = device.c8y_SoftwareList;
        var profileSoftware = get(selectedProfile, 'c8y_DeviceProfile.software');
        return this.createProfileComparison(deviceSoftware, profileSoftware, 'version');
    };
    DeviceProfileService.prototype.getConfigurationItems = function (device, selectedProfile) {
        var deviceConfiguration = [];
        Object.keys(device).forEach(function (key) {
            if (key.slice(0, 18) === 'c8y_Configuration_') {
                deviceConfiguration.push(device[key]);
            }
        });
        var profileConfiguration = get(selectedProfile, 'c8y_DeviceProfile.configuration');
        return this.createProfileComparison(deviceConfiguration, profileConfiguration, 'type');
    };
    DeviceProfileService.prototype.createProfileComparison = function (deviceItems, profileItems, propToCompare) {
        if (deviceItems === void 0) { deviceItems = []; }
        if (profileItems === void 0) { profileItems = []; }
        var comparisonObj = this.createProfileComparisonFromDeviceItems(deviceItems, propToCompare);
        var extendedComparisonObj = this.extendProfileComparisonWithProfileItems(comparisonObj, profileItems, propToCompare);
        return sortBy(toArray(extendedComparisonObj), 'name');
    };
    DeviceProfileService.prototype.createProfileComparisonFromDeviceItems = function (deviceItems, propToCompare) {
        var deviceItemsObject = {};
        deviceItems.forEach(function (item) {
            var _a;
            Object.assign(deviceItemsObject, (_a = {},
                _a[item.name] = {
                    name: item.name,
                    profileVersion: undefined,
                    deviceVersion: item[propToCompare]
                },
                _a));
        });
        return deviceItemsObject;
    };
    DeviceProfileService.prototype.extendProfileComparisonWithProfileItems = function (comparisonObj, profileItems, propToCompare) {
        profileItems.forEach(function (item) {
            var _a;
            if (comparisonObj[item.name]) {
                comparisonObj[item.name].profileVersion = item[propToCompare];
            }
            else {
                Object.assign(comparisonObj, (_a = {},
                    _a[item.name] = {
                        name: item.name,
                        profileVersion: item[propToCompare],
                        deviceVersion: undefined
                    },
                    _a));
            }
        });
        return comparisonObj;
    };
    DeviceProfileService.ctorParameters = function () { return [
        { type: InventoryService },
        { type: OperationService },
        { type: AlertService }
    ]; };
    DeviceProfileService = tslib_1.__decorate([
        Injectable()
    ], DeviceProfileService);
    return DeviceProfileService;
}());
export { DeviceProfileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLXByb2ZpbGUvIiwic291cmNlcyI6WyJkZXZpY2UtcHJvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDZixXQUFXLEVBQ1osTUFBTSxhQUFhLENBQUM7QUFPckIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUdqRDtJQUtFLDhCQUNVLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsWUFBMEI7UUFGMUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUDNCLGFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixXQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsc0JBQXNCO1FBUXZFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRUQsa0RBQW1CLEdBQW5CLFVBQW9CLGFBQXFDO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxhQUErQixDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVELDREQUE2QixHQUE3QixVQUE4QixVQUFrQjtRQUM5QyxJQUFNLGdCQUFnQixHQUFHO1lB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QUFhLENBQUM7SUFDdkIsQ0FBQzs7Z0JBaEoyQixnQkFBZ0I7Z0JBQ2hCLGdCQUFnQjtnQkFDcEIsWUFBWTs7SUFSekIsb0JBQW9CO1FBRGhDLFVBQVUsRUFBRTtPQUNBLG9CQUFvQixDQXVKaEM7SUFBRCwyQkFBQztDQUFBLEFBdkpELElBdUpDO1NBdkpZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJUmVzdWx0TGlzdCxcbiAgT3BlcmF0aW9uU2VydmljZSxcbiAgT3BlcmF0aW9uU3RhdHVzLFxuICBRdWVyaWVzVXRpbFxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBEZXZpY2VQcm9maWxlLFxuICBEZXZpY2VQcm9maWxlRmlybXdhcmUsXG4gIERldmljZVByb2ZpbGVTb2Z0d2FyZSxcbiAgUHJvZmlsZUl0ZW1cbn0gZnJvbSAnLi9kZXZpY2UtcHJvZmlsZS5tb2RlbCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IHNvcnRCeSwgdG9BcnJheSwgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERldmljZVByb2ZpbGVTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZGF0ZUZyb20gPSBuZXcgRGF0ZSgwKTtcbiAgcmVhZG9ubHkgZGF0ZVRvID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDg2NDAwMDAwKTsgLy8gMSBkYXkgaW4gdGhlIGZ1dHVyZVxuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgY3JlYXRlRGV2aWNlUHJvZmlsZShkZXZpY2VQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZGV2aWNlUHJvZmlsZSBhcyBJTWFuYWdlZE9iamVjdCk7XG4gIH1cblxuICBnZXREZXZpY2VQcm9maWxlc0J5RGV2aWNlVHlwZShkZXZpY2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pj4ge1xuICAgIGNvbnN0IGRldmljZVR5cGVGaWx0ZXIgPSB7XG4gICAgICBfX29yOiBbeyAnYzh5X0ZpbHRlci50eXBlJzogZGV2aWNlVHlwZSB9LCB7IF9fbm90OiB7IF9faGFzOiAnYzh5X0ZpbHRlci50eXBlJyB9IH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXREZXZpY2VQcm9maWxlcyhkZXZpY2VUeXBlRmlsdGVyKTtcbiAgfVxuXG4gIGdldERldmljZVByb2ZpbGVzKGFuZFF1ZXJ5PzogYW55KTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBsZXQgcXVlcnk6IG9iamVjdCA9IHtcbiAgICAgIHR5cGU6ICdjOHlfUHJvZmlsZSdcbiAgICB9O1xuICAgIGNvbnN0IGZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgcGFnZVNpemU6IDEwMCxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlXG4gICAgfTtcbiAgICBxdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHF1ZXJ5LCBhbmRRdWVyeSB8fCB7fSk7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIGZpbHRlcik7XG4gIH1cblxuICBhc3luYyBnZXRQcm9maWxlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICBjb25zdCBmaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZnJhZ21lbnRUeXBlOiAnYzh5X0RldmljZVByb2ZpbGUnLFxuICAgICAgZGF0ZUZyb206IHRoaXMuZGF0ZUZyb20udG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogdGhpcy5kYXRlVG8udG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcblxuICAgIGNvbnN0IG9wZXJhdGlvbiA9IChhd2FpdCB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpKS5kYXRhWzBdO1xuICAgIHJldHVybiBvcGVyYXRpb24gJiYgb3BlcmF0aW9uLnN0YXR1cyAhPT0gT3BlcmF0aW9uU3RhdHVzLlNVQ0NFU1NGVUwgPyBvcGVyYXRpb24gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBhc3luYyBjcmVhdGVQcm9maWxlT3BlcmF0aW9uKGRldmljZTogSU1hbmFnZWRPYmplY3QsIGRldmljZVByb2ZpbGU6IFBhcnRpYWw8RGV2aWNlUHJvZmlsZT4pIHtcbiAgICBsZXQgb3BlcmF0aW9uO1xuICAgIGNvbnN0IG9wZXJhdGlvbkNmZzogSU9wZXJhdGlvbiA9IHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBwcm9maWxlSWQ6IGRldmljZVByb2ZpbGUuaWQsXG4gICAgICBwcm9maWxlTmFtZTogZGV2aWNlUHJvZmlsZS5uYW1lLFxuICAgICAgYzh5X0RldmljZVByb2ZpbGU6IGRldmljZVByb2ZpbGUuYzh5X0RldmljZVByb2ZpbGUsXG4gICAgICBkZXNjcmlwdGlvbjogYEFzc2lnbiBkZXZpY2UgcHJvZmlsZSAke2RldmljZVByb2ZpbGUubmFtZX0gdG8gZGV2aWNlICR7ZGV2aWNlLm5hbWV9YFxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb25DZmcpO1xuICAgICAgb3BlcmF0aW9uID0gZGF0YTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICBnZXRGaXJtd2FyZUl0ZW1zKGRldmljZTogSU1hbmFnZWRPYmplY3QsIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPik6IFByb2ZpbGVJdGVtW10ge1xuICAgIGNvbnN0IGRldmljZUZpcm13YXJlID0gZGV2aWNlLmM4eV9GaXJtd2FyZTtcbiAgICBjb25zdCBwcm9maWxlRmlybXdhcmUgPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuZmlybXdhcmUnKTtcbiAgICBjb25zdCBkZXZpY2VJdGVtcyA9IFtdO1xuICAgIGNvbnN0IHByb2ZpbGVJdGVtcyA9IFtdO1xuXG4gICAgaWYgKGRldmljZUZpcm13YXJlKSB7XG4gICAgICBkZXZpY2VJdGVtcy5wdXNoKGRldmljZUZpcm13YXJlKTtcbiAgICB9XG4gICAgaWYgKHByb2ZpbGVGaXJtd2FyZSkge1xuICAgICAgcHJvZmlsZUl0ZW1zLnB1c2gocHJvZmlsZUZpcm13YXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oZGV2aWNlSXRlbXMsIHByb2ZpbGVJdGVtcywgJ3ZlcnNpb24nKTtcbiAgfVxuXG4gIGdldFNvZnR3YXJlSXRlbXMoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KTogUHJvZmlsZUl0ZW1bXSB7XG4gICAgY29uc3QgZGV2aWNlU29mdHdhcmUgPSBkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdDtcbiAgICBjb25zdCBwcm9maWxlU29mdHdhcmUgPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuc29mdHdhcmUnKTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9maWxlQ29tcGFyaXNvbihkZXZpY2VTb2Z0d2FyZSwgcHJvZmlsZVNvZnR3YXJlLCAndmVyc2lvbicpO1xuICB9XG5cbiAgZ2V0Q29uZmlndXJhdGlvbkl0ZW1zKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+XG4gICk6IFByb2ZpbGVJdGVtW10ge1xuICAgIGNvbnN0IGRldmljZUNvbmZpZ3VyYXRpb24gPSBbXTtcbiAgICBPYmplY3Qua2V5cyhkZXZpY2UpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChrZXkuc2xpY2UoMCwgMTgpID09PSAnYzh5X0NvbmZpZ3VyYXRpb25fJykge1xuICAgICAgICBkZXZpY2VDb25maWd1cmF0aW9uLnB1c2goZGV2aWNlW2tleV0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHByb2ZpbGVDb25maWd1cmF0aW9uID0gZ2V0KHNlbGVjdGVkUHJvZmlsZSwgJ2M4eV9EZXZpY2VQcm9maWxlLmNvbmZpZ3VyYXRpb24nKTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9maWxlQ29tcGFyaXNvbihkZXZpY2VDb25maWd1cmF0aW9uLCBwcm9maWxlQ29uZmlndXJhdGlvbiwgJ3R5cGUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oXG4gICAgZGV2aWNlSXRlbXM6IGFueVtdID0gW10sXG4gICAgcHJvZmlsZUl0ZW1zOiBBcnJheTxEZXZpY2VQcm9maWxlU29mdHdhcmUgfCBEZXZpY2VQcm9maWxlRmlybXdhcmU+ID0gW10sXG4gICAgcHJvcFRvQ29tcGFyZTogc3RyaW5nXG4gICk6IFByb2ZpbGVJdGVtW10ge1xuICAgIGNvbnN0IGNvbXBhcmlzb25PYmogPSB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uRnJvbURldmljZUl0ZW1zKGRldmljZUl0ZW1zLCBwcm9wVG9Db21wYXJlKTtcbiAgICBjb25zdCBleHRlbmRlZENvbXBhcmlzb25PYmogPSB0aGlzLmV4dGVuZFByb2ZpbGVDb21wYXJpc29uV2l0aFByb2ZpbGVJdGVtcyhcbiAgICAgIGNvbXBhcmlzb25PYmosXG4gICAgICBwcm9maWxlSXRlbXMsXG4gICAgICBwcm9wVG9Db21wYXJlXG4gICAgKTtcbiAgICByZXR1cm4gc29ydEJ5KHRvQXJyYXkoZXh0ZW5kZWRDb21wYXJpc29uT2JqKSwgJ25hbWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvZmlsZUNvbXBhcmlzb25Gcm9tRGV2aWNlSXRlbXMoZGV2aWNlSXRlbXM6IGFueVtdLCBwcm9wVG9Db21wYXJlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkZXZpY2VJdGVtc09iamVjdCA9IHt9O1xuICAgIGRldmljZUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBPYmplY3QuYXNzaWduKGRldmljZUl0ZW1zT2JqZWN0LCB7XG4gICAgICAgIFtpdGVtLm5hbWVdOiB7XG4gICAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICAgIHByb2ZpbGVWZXJzaW9uOiB1bmRlZmluZWQsXG4gICAgICAgICAgZGV2aWNlVmVyc2lvbjogaXRlbVtwcm9wVG9Db21wYXJlXVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGV2aWNlSXRlbXNPYmplY3Q7XG4gIH1cblxuICBwcml2YXRlIGV4dGVuZFByb2ZpbGVDb21wYXJpc29uV2l0aFByb2ZpbGVJdGVtcyhcbiAgICBjb21wYXJpc29uT2JqOiBvYmplY3QsXG4gICAgcHJvZmlsZUl0ZW1zOiBBcnJheTxEZXZpY2VQcm9maWxlU29mdHdhcmUgfCBEZXZpY2VQcm9maWxlRmlybXdhcmU+LFxuICAgIHByb3BUb0NvbXBhcmU6IHN0cmluZ1xuICApIHtcbiAgICBwcm9maWxlSXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChjb21wYXJpc29uT2JqW2l0ZW0ubmFtZV0pIHtcbiAgICAgICAgY29tcGFyaXNvbk9ialtpdGVtLm5hbWVdLnByb2ZpbGVWZXJzaW9uID0gaXRlbVtwcm9wVG9Db21wYXJlXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oY29tcGFyaXNvbk9iaiwge1xuICAgICAgICAgIFtpdGVtLm5hbWVdOiB7XG4gICAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgICAgICAgICBwcm9maWxlVmVyc2lvbjogaXRlbVtwcm9wVG9Db21wYXJlXSxcbiAgICAgICAgICAgIGRldmljZVZlcnNpb246IHVuZGVmaW5lZFxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbXBhcmlzb25PYmo7XG4gIH1cbn1cbiJdfQ==