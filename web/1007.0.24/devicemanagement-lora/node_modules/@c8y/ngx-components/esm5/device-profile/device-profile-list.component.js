import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { IManagedObject, InventoryService, IResultList } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import { AlertService, gettext, ModalService, Status } from '@c8y/ngx-components';
import { cloneDeep } from 'lodash-es';
import { BsModalService } from 'ngx-bootstrap';
import { AddDeviceProfileComponent } from './add-device-profile.component';
import { DeviceProfileService } from './device-profile.service';
import { Router } from '@angular/router';
import { BehaviorSubject } from 'rxjs';
import { tap, switchMap } from 'rxjs/operators';
var DeviceProfileListComponent = /** @class */ (function () {
    function DeviceProfileListComponent(inventoryService, translateService, modalService, alertService, bsModalService, router, deviceProfileService) {
        var _this = this;
        this.inventoryService = inventoryService;
        this.translateService = translateService;
        this.modalService = modalService;
        this.alertService = alertService;
        this.bsModalService = bsModalService;
        this.router = router;
        this.deviceProfileService = deviceProfileService;
        this.reloading = false;
        this.reload = new BehaviorSubject(null);
        this.deviceProfiles$ = this.reload.pipe(tap(function () { return (_this.reloading = true); }), switchMap(function () { return _this.deviceProfileService.getDeviceProfiles(); }), tap(function () { return (_this.reloading = false); }));
    }
    DeviceProfileListComponent.prototype.ngOnInit = function () {
        this.loadDeviceProfiles();
    };
    DeviceProfileListComponent.prototype.loadDeviceProfiles = function () {
        this.reload.next();
    };
    DeviceProfileListComponent.prototype.createDeviceProfile = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var modal, profileId, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        modal = this.bsModalService.show(AddDeviceProfileComponent, {
                            class: 'modal-sm'
                        }).content;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, modal.result];
                    case 2:
                        profileId = _a.sent();
                        modal.close();
                        this.router.navigateByUrl("/device-profiles/" + profileId);
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    DeviceProfileListComponent.prototype.duplicateDeviceProfile = function (deviceProfile) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var copy, mo;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        copy = cloneDeep(deviceProfile);
                        copy.id = null;
                        copy.name = 'Duplicate of ' + deviceProfile.name;
                        return [4 /*yield*/, this.deviceProfileService.createDeviceProfile(copy)];
                    case 1:
                        mo = (_a.sent()).data;
                        this.router.navigateByUrl("/device-profiles/" + mo.id);
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceProfileListComponent.prototype.deleteDeviceProfile = function (deviceProfile) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var deviceProfileName, title, confirmationText, finalQuestion, ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        deviceProfileName = deviceProfile.name;
                        title = gettext('Delete device profile');
                        confirmationText = this.translateService.instant(gettext('You are about to delete a device profile "{{ deviceProfileName }}".'), { deviceProfileName: deviceProfileName });
                        finalQuestion = this.translateService.instant(gettext('Do you want to proceed?'));
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 4, , 5]);
                        return [4 /*yield*/, this.modalService.confirm(title, confirmationText + " " + finalQuestion, Status.DANGER, {
                                ok: gettext('Delete')
                            })];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.delete(deviceProfile.id)];
                    case 3:
                        _a.sent();
                        this.reload.next();
                        return [3 /*break*/, 5];
                    case 4:
                        ex_2 = _a.sent();
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    DeviceProfileListComponent.prototype.delete = function (profileId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_3;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.inventoryService.delete(profileId)];
                    case 1:
                        _a.sent();
                        this.alertService.success(gettext('Device profile deleted.'));
                        return [3 /*break*/, 3];
                    case 2:
                        ex_3 = _a.sent();
                        this.alertService.addServerFailure(ex_3);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    DeviceProfileListComponent.ctorParameters = function () { return [
        { type: InventoryService },
        { type: TranslateService },
        { type: ModalService },
        { type: AlertService },
        { type: BsModalService },
        { type: Router },
        { type: DeviceProfileService }
    ]; };
    DeviceProfileListComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-device-profile-list',
            template: "<c8y-title>{{ 'Device profiles' | translate }}</c8y-title>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button\n    class=\"btn btn-link\"\n    (click)=\"createDeviceProfile()\"\n    title=\"{{ 'Add device profile' | translate }}\"\n  >\n    <i c8yIcon=\"plus-square\"></i> {{ 'Add device profile' | translate }}\n  </button>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" (click)=\"loadDeviceProfiles()\" title=\"{{ 'Reload' | translate }}\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<!-- EMPTY STATE -->\n<div class=\"c8y-empty-state text-left\" *ngIf=\"(deviceProfiles$ | async)?.data.length === 0\">\n  <h1 [c8yIcon]=\"'c8y-device-profile'\" class=\"c8y-icon-duocolor\"></h1>\n  <h3 translate>No device profiles available.</h3>\n  <p translate>Add a new device profile by clicking below.</p>\n  <p>\n    <button\n      title=\"{{ 'Add device profile' | translate }}\"\n      (click)=\"createDeviceProfile()\"\n      class=\"btn btn-primary\"\n      translate\n    >\n      Add device profile\n    </button>\n  </p>\n</div>\n\n<!-- DEVICE PROFILES LIST -->\n<c8y-list-group>\n  <c8y-li *c8yFor=\"let deviceProfile of deviceProfiles$\">\n    <c8y-li-icon>\n      <i c8yIcon=\"c8y-device-profile\"></i>\n    </c8y-li-icon>\n\n    <c8y-li-body class=\"content-flex-50\">\n      <div class=\"col-6\" title=\"{{ deviceProfile.name }}\">\n        <button class=\"btn-clean\" routerLink=\"/device-profiles/{{ deviceProfile.id }}\" style=\"max-width: inherit;\">\n          <span class=\"text-truncate\">{{ deviceProfile.name }}</span>\n        </button>\n      </div>\n      <div class=\"col-6\" title=\"{{ deviceProfile.c8y_Filter?.type || '-' }}\">\n        <span class=\"text-label-small m-r-4\" translate>Device type</span>\n        {{ deviceProfile.c8y_Filter?.type || '-' }}\n      </div>\n    </c8y-li-body>\n\n    <c8y-li-action\n      routerLink=\"/device-profiles/{{ deviceProfile.id }}\"\n      icon=\"pencil\"\n      label=\"{{ 'Edit' | translate }}\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      (click)=\"duplicateDeviceProfile(deviceProfile)\"\n      icon=\"copy\"\n      label=\"{{ 'Duplicate' | translate }}\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      (click)=\"deleteDeviceProfile(deviceProfile)\"\n      icon=\"trash\"\n      label=\"{{ 'Delete' | translate }}\"\n    >\n    </c8y-li-action>\n  </c8y-li>\n</c8y-list-group>\n"
        })
    ], DeviceProfileListComponent);
    return DeviceProfileListComponent;
}());
export { DeviceProfileListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUtbGlzdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2RldmljZS1wcm9maWxlLyIsInNvdXJjZXMiOlsiZGV2aWNlLXByb2ZpbGUtbGlzdC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUMzRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTWhEO0lBU0Usb0NBQ1UsZ0JBQWtDLEVBQ2xDLGdCQUFrQyxFQUNsQyxZQUEwQixFQUMxQixZQUEwQixFQUMxQixjQUE4QixFQUM5QixNQUFjLEVBQ2Qsb0JBQTBDO1FBUHBELGlCQVFJO1FBUE0scUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVos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QyxFQUFBOzt3QkFBbkMsU0FBbUMsQ0FBQzt3QkFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7Ozs7Ozs7O0tBSXRCO0lBRWEsMkNBQU0sR0FBcEIsVUFBcUIsU0FBUzs7Ozs7Ozt3QkFFMUIscUJBQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBQTs7d0JBQTdDLFNBQTZDLENBQUM7d0JBQzlDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7Ozs7d0JBRTlELElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsSUFBRSxDQUFDLENBQUM7Ozs7OztLQUUxQzs7Z0JBckUyQixnQkFBZ0I7Z0JBQ2hCLGdCQUFnQjtnQkFDcEIsWUFBWTtnQkFDWixZQUFZO2dCQUNWLGNBQWM7Z0JBQ3RCLE1BQU07Z0JBQ1Esb0JBQW9COztJQWhCekMsMEJBQTBCO1FBSnRDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx5QkFBeUI7WUFDbkMsay9FQUFtRDtTQUNwRCxDQUFDO09BQ1csMEJBQTBCLENBZ0Z0QztJQUFELGlDQUFDO0NBQUEsQUFoRkQsSUFnRkM7U0FoRlksMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlLCBJUmVzdWx0TGlzdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSB9IGZyb20gJ25neC1ib290c3RyYXAnO1xuaW1wb3J0IHsgQWRkRGV2aWNlUHJvZmlsZUNvbXBvbmVudCB9IGZyb20gJy4vYWRkLWRldmljZS1wcm9maWxlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBEZXZpY2VQcm9maWxlU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLXByb2ZpbGUuc2VydmljZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRldmljZS1wcm9maWxlLWxpc3QnLFxuICB0ZW1wbGF0ZVVybDogJy4vZGV2aWNlLXByb2ZpbGUtbGlzdC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgRGV2aWNlUHJvZmlsZUxpc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICByZWxvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcmVsb2FkOiBCZWhhdmlvclN1YmplY3Q8dm9pZD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBkZXZpY2VQcm9maWxlcyQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiA9IHRoaXMucmVsb2FkLnBpcGUoXG4gICAgdGFwKCgpID0+ICh0aGlzLnJlbG9hZGluZyA9IHRydWUpKSxcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5kZXZpY2VQcm9maWxlU2VydmljZS5nZXREZXZpY2VQcm9maWxlcygpKSxcbiAgICB0YXAoKCkgPT4gKHRoaXMucmVsb2FkaW5nID0gZmFsc2UpKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBkZXZpY2VQcm9maWxlU2VydmljZTogRGV2aWNlUHJvZmlsZVNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMubG9hZERldmljZVByb2ZpbGVzKCk7XG4gIH1cblxuICBsb2FkRGV2aWNlUHJvZmlsZXMoKSB7XG4gICAgdGhpcy5yZWxvYWQubmV4dCgpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlRGV2aWNlUHJvZmlsZSgpIHtcbiAgICBjb25zdCBtb2RhbCA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhBZGREZXZpY2VQcm9maWxlQ29tcG9uZW50LCB7XG4gICAgICBjbGFzczogJ21vZGFsLXNtJ1xuICAgIH0pLmNvbnRlbnQgYXMgQWRkRGV2aWNlUHJvZmlsZUNvbXBvbmVudDtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJvZmlsZUlkID0gYXdhaXQgbW9kYWwucmVzdWx0O1xuICAgICAgbW9kYWwuY2xvc2UoKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwoYC9kZXZpY2UtcHJvZmlsZXMvJHtwcm9maWxlSWR9YCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gIH1cblxuICBhc3luYyBkdXBsaWNhdGVEZXZpY2VQcm9maWxlKGRldmljZVByb2ZpbGUpIHtcbiAgICBjb25zdCBjb3B5ID0gY2xvbmVEZWVwKGRldmljZVByb2ZpbGUpO1xuICAgIGNvcHkuaWQgPSBudWxsO1xuICAgIGNvcHkubmFtZSA9ICdEdXBsaWNhdGUgb2YgJyArIGRldmljZVByb2ZpbGUubmFtZTtcbiAgICBjb25zdCBtbyA9IChhd2FpdCB0aGlzLmRldmljZVByb2ZpbGVTZXJ2aWNlLmNyZWF0ZURldmljZVByb2ZpbGUoY29weSkpLmRhdGE7XG4gICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChgL2RldmljZS1wcm9maWxlcy8ke21vLmlkfWApO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlRGV2aWNlUHJvZmlsZShkZXZpY2VQcm9maWxlKSB7XG4gICAgY29uc3QgZGV2aWNlUHJvZmlsZU5hbWUgPSBkZXZpY2VQcm9maWxlLm5hbWU7XG4gICAgY29uc3QgdGl0bGUgPSBnZXR0ZXh0KCdEZWxldGUgZGV2aWNlIHByb2ZpbGUnKTtcbiAgICBjb25zdCBjb25maXJtYXRpb25UZXh0ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICBnZXR0ZXh0KCdZb3UgYXJlIGFib3V0IHRvIGRlbGV0ZSBhIGRldmljZSBwcm9maWxlIFwie3sgZGV2aWNlUHJvZmlsZU5hbWUgfX1cIi4nKSxcbiAgICAgIHsgZGV2aWNlUHJvZmlsZU5hbWUgfVxuICAgICk7XG4gICAgY29uc3QgZmluYWxRdWVzdGlvbiA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGdldHRleHQoJ0RvIHlvdSB3YW50IHRvIHByb2NlZWQ/JykpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsU2VydmljZS5jb25maXJtKFxuICAgICAgICB0aXRsZSxcbiAgICAgICAgYCR7Y29uZmlybWF0aW9uVGV4dH0gJHtmaW5hbFF1ZXN0aW9ufWAsXG4gICAgICAgIFN0YXR1cy5EQU5HRVIsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogZ2V0dGV4dCgnRGVsZXRlJylcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlKGRldmljZVByb2ZpbGUuaWQpO1xuICAgICAgdGhpcy5yZWxvYWQubmV4dCgpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkZWxldGUocHJvZmlsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZWxldGUocHJvZmlsZUlkKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnRGV2aWNlIHByb2ZpbGUgZGVsZXRlZC4nKSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgfVxufVxuIl19