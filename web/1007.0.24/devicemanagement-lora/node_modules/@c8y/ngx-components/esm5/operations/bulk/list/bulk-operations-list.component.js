import * as tslib_1 from "tslib";
import { Component, ViewChild, ViewChildren } from '@angular/core';
import { OperationBulkRealtimeService, DatePickerComponent } from '@c8y/ngx-components';
import { flatten } from 'lodash-es';
import { BehaviorSubject, combineLatest, pipe } from 'rxjs';
import { map, tap, switchMap, withLatestFrom, shareReplay } from 'rxjs/operators';
import { BulkOperationsService } from '../bulk-operations.service';
import { BulkOperationListItemComponent } from './bulk-operation-list-item.component';
import { BULK_OPERATION_STATUS_OPTIONS } from './bulk-operation-list-item.model';
var BulkOperationsListComponent = /** @class */ (function () {
    function BulkOperationsListComponent(realtime, bulkOperationsService) {
        var _this = this;
        this.realtime = realtime;
        this.bulkOperationsService = bulkOperationsService;
        this.selectedTypeFilters = this.getTypeFilters();
        this.bulkOperationStatusOptions = BULK_OPERATION_STATUS_OPTIONS;
        this.refreshLoading = false;
        this.statusFilter$ = new BehaviorSubject(null);
        this.typeFilter$ = new BehaviorSubject(null);
        this.timeFilter$ = new BehaviorSubject(null);
        this.reload$ = new BehaviorSubject(null);
        this.bulkOperations$ = combineLatest(this.statusFilter$, this.timeFilter$, this.typeFilter$, this.reload$).pipe(tap(function () {
            _this.refreshLoading = true;
        }), switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 2), statusFilters = _b[0], timeFilters = _b[1];
            return _this.filter(statusFilters, timeFilters);
        }), withLatestFrom(this.typeFilter$), map(function (_a) {
            var _b = tslib_1.__read(_a, 2), result = _b[0], typeFilter = _b[1];
            _this.filterPipe = pipe(map(function (data) { return _this.filterByType(data, typeFilter); }));
            return tslib_1.__assign({}, result, { data: _this.filterByType(result.data, typeFilter) });
        }), tap(function () {
            _this.refreshLoading = false;
        }), shareReplay(1));
        this.allFilterFragments = this.flattenFilterFragments(this.getTypeFilters());
    }
    BulkOperationsListComponent.prototype.filterByType = function (bulkOperations, typeFilter) {
        var flattenedFragments = this.flattenFilterFragments(typeFilter);
        if (
        // return data unfiltered if no filters selected...
        !flattenedFragments.length ||
            // ...or when all filters are selected
            this.allFilterFragments.every(function (fragment) { return flattenedFragments.includes(fragment); })) {
            return bulkOperations;
        }
        var filteredData = bulkOperations.filter(function (item) {
            return Object.keys(item.operationPrototype).some(function (key) { return flattenedFragments.includes(key); });
        });
        return filteredData;
    };
    BulkOperationsListComponent.prototype.resetFilter = function () {
        this.statusFilter$.next(null);
        this.timeFilter$.next(null);
        this.typeFilter$.next(null);
        this.datePicker.clearFilter();
        this.selectedTypeFilters = this.getTypeFilters();
        this.statusFilter.statusOptions.map(function (option) {
            option.selected = false;
            return option;
        });
    };
    BulkOperationsListComponent.prototype.isFilterApplied = function () {
        return (this.statusFilter$.getValue() || this.typeFilter$.getValue() || this.timeFilter$.getValue());
    };
    BulkOperationsListComponent.prototype.filter = function (statusFilters, timeFilter) {
        var status = statusFilters && statusFilters.length > 0
            ? {
                generalStatus: flatten(statusFilters.map(function (statusFilter) { return statusFilter.generalStatus; }))
            }
            : {};
        var time = timeFilter
            ? tslib_1.__assign({}, (timeFilter.dateFrom && {
                dateFrom: timeFilter.dateFrom.toISOString()
            }), (timeFilter.dateTo && {
                dateTo: timeFilter.dateTo.toISOString()
            })) : {};
        return this.getBulkOperations(tslib_1.__assign({}, status, time));
    };
    BulkOperationsListComponent.prototype.getBulkOperations = function (filter) {
        return this.bulkOperationsService.getBulkOperations(filter);
    };
    BulkOperationsListComponent.prototype.getTypeFilters = function () {
        return this.bulkOperationsService.getBulkTypes();
    };
    BulkOperationsListComponent.prototype.addBulkOperation = function () {
        this.bulkOperationsService.showNewBulkOperationModal();
    };
    BulkOperationsListComponent.prototype.openFailedOperation = function (failedParentId) {
        this.listItems.forEach(function (item) {
            if (item.bulkOperation.id === failedParentId) {
                item.listItem.collapsed = false;
                item.listItem.element.nativeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    };
    BulkOperationsListComponent.prototype.compareOperations = function (operationA, operationB) {
        return new Date(operationA.startDate).getTime() - new Date(operationB.startDate).getTime();
    };
    BulkOperationsListComponent.prototype.flattenFilterFragments = function (filters) {
        return (filters || []).reduce(function (flattened, current) { return flattened.concat(current.fragments); }, []);
    };
    BulkOperationsListComponent.ctorParameters = function () { return [
        { type: OperationBulkRealtimeService },
        { type: BulkOperationsService }
    ]; };
    tslib_1.__decorate([
        ViewChildren(BulkOperationListItemComponent)
    ], BulkOperationsListComponent.prototype, "listItems", void 0);
    tslib_1.__decorate([
        ViewChild('statusFilter', { static: true })
    ], BulkOperationsListComponent.prototype, "statusFilter", void 0);
    tslib_1.__decorate([
        ViewChild(DatePickerComponent, { static: true })
    ], BulkOperationsListComponent.prototype, "datePicker", void 0);
    BulkOperationsListComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-bulk-operations',
            template: "<c8y-title> {{ 'Device control' | translate }}</c8y-title>\n<c8y-action-bar-item itemClass=\"navbar-form\" [placement]=\"'left'\">\n  <label translate> Operation type</label>\n  <c8y-select\n    style=\"width: 180px;\"\n    [items]=\"getTypeFilters()\"\n    [selected]=\"selectedTypeFilters\"\n    (onChange)=\"selectedTypeFilters = $event; typeFilter$.next(selectedTypeFilters)\"\n  >\n  </c8y-select>\n</c8y-action-bar-item>\n<c8y-action-bar-item itemClass=\"btn-group\" [placement]=\"'left'\">\n  <c8y-status-filter\n    #statusFilter\n    [options]=\"bulkOperationStatusOptions\"\n    (onFilterChanged)=\"statusFilter$.next($event)\"\n  ></c8y-status-filter>\n</c8y-action-bar-item>\n<c8y-action-bar-item itemClass=\"navbar-form\" [placement]=\"'left'\">\n  <c8y-date-picker (onDateSelected)=\"timeFilter$.next($event)\"></c8y-date-picker>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <c8y-realtime-btn [service]=\"realtime\"></c8y-realtime-btn>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button\n    class=\"btn btn-link\"\n    (click)=\"addBulkOperation()\"\n    title=\"{{ 'New bulk operation' | translate }}\"\n  >\n    <i class=\"fa fa-plus-circle\"></i> {{ 'New bulk operation' | translate }}\n  </button>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"reload$.next()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': refreshLoading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n<!-- IF THERE ARE NO OPERATIONS TO DISPLAY SHOW THIS:  -->\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && !isFilterApplied()\"\n>\n  <h1 class=\"c8y-icon c8y-icon-energy c8y-icon-duocolor\"></h1>\n  <h3 translate>No items to display</h3>\n  <p translate>Bulk operations will be displayed here</p>\n  <button\n    type=\"button\"\n    title=\"{{ 'New bulk operation' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"addBulkOperation()\"\n    translate\n  >\n    New bulk operation\n  </button>\n</div>\n<!-- DETAILED LIST OF OPERATIONS + LOAD MORE BUTTON -->\n<c8y-list-group class=\"m-b-24\">\n  <div\n    class=\"d-contents\"\n    *c8yFor=\"\n      let bulkOperation of bulkOperations$;\n      let i = index;\n      realtime: realtime;\n      pipe: filterPipe;\n      comparator: compareOperations.bind(this);\n      loadMore: 'auto';\n    \"\n  >\n    <c8y-bulk-operation-list-item\n      [bulkOperation]=\"bulkOperation\"\n      (reload)=\"reload$.next()\"\n      (showFailedOperation)=\"openFailedOperation($event)\"\n      class=\"d-contents\"\n    >\n    </c8y-bulk-operation-list-item>\n  </div>\n</c8y-list-group>\n<!-- no results empty state -->\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && isFilterApplied()\"\n>\n  <h1 class=\"fa fa-search\"></h1>\n  <h3 translate>No items to display</h3>\n  <p translate>Adjust or reset the filter.</p>\n  <button\n    class=\"btn btn-primary\"\n    (click)=\"resetFilter()\"\n    title=\"{{ 'Reset filter' | translate }}\"\n    translate\n  >\n    Reset filter\n  </button>\n</div>\n",
            providers: [OperationBulkRealtimeService]
        })
    ], BulkOperationsListComponent);
    return BulkOperationsListComponent;
}());
export { BulkOperationsListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLWxpc3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zLyIsInNvdXJjZXMiOlsiYnVsay9saXN0L2J1bGstb3BlcmF0aW9ucy1saXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTlFLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEMsT0FBTyxFQUFFLGVBQWUsRUFBYyxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHbEYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdEYsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFRakY7SUF1Q0UscUNBQ1MsUUFBc0MsRUFDckMscUJBQTRDO1FBRnRELGlCQUtDO1FBSlEsYUFBUSxHQUFSLFFBQVEsQ0FBOEI7UUFDckMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQXhDdEQsd0JBQW1CLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQzVDLCtCQUEwQixHQUFvQiw2QkFBNkIsQ0FBQztRQUc1RSxtQkFBYyxHQUFZLEtBQUssQ0FBQztRQUNoQyxrQkFBYSxHQUFxQyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RSxnQkFBVyxHQUFx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QUFDLDhCQUE4QixDQUFDO2tFQUUzQztJQUMyQztRQUE1QyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO3FFQUFxQztJQUMvQjtRQUFqRCxTQUFTLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7bUVBQWlDO0lBZHZFLDJCQUEyQjtRQUx2QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUscUJBQXFCO1lBQy9CLHNzR0FBb0Q7WUFDcEQsU0FBUyxFQUFFLENBQUMsNEJBQTRCLENBQUM7U0FDMUMsQ0FBQztPQUNXLDJCQUEyQixDQW9JdkM7SUFBRCxrQ0FBQztDQUFBLEFBcElELElBb0lDO1NBcElZLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgUXVlcnlMaXN0LCBWaWV3Q2hpbGQsIFZpZXdDaGlsZHJlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU9wZXJhdGlvbkJ1bGssIElSZXN1bHRMaXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgT3BlcmF0aW9uQnVsa1JlYWx0aW1lU2VydmljZSwgRGF0ZVBpY2tlckNvbXBvbmVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZmxhdHRlbiB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIGNvbWJpbmVMYXRlc3QsIHBpcGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFwLCBzd2l0Y2hNYXAsIHdpdGhMYXRlc3RGcm9tLCBzaGFyZVJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN0YXR1c0ZpbHRlckNvbXBvbmVudCB9IGZyb20gJy4uLy4uL3N0YXR1cy1maWx0ZXIvc3RhdHVzLWZpbHRlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgSVN0YXR1c09wdGlvbiB9IGZyb20gJy4uLy4uL3N0YXR1cy1maWx0ZXIvc3RhdHVzLW9wdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uc1NlcnZpY2UgfSBmcm9tICcuLi9idWxrLW9wZXJhdGlvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uTGlzdEl0ZW1Db21wb25lbnQgfSBmcm9tICcuL2J1bGstb3BlcmF0aW9uLWxpc3QtaXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgQlVMS19PUEVSQVRJT05fU1RBVFVTX09QVElPTlMgfSBmcm9tICcuL2J1bGstb3BlcmF0aW9uLWxpc3QtaXRlbS5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi90eXBlLWxpc3Qvb3BlcmF0aW9uLXR5cGUubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktYnVsay1vcGVyYXRpb25zJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2J1bGstb3BlcmF0aW9ucy1saXN0LmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbT3BlcmF0aW9uQnVsa1JlYWx0aW1lU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvbnNMaXN0Q29tcG9uZW50IHtcbiAgc2VsZWN0ZWRUeXBlRmlsdGVycyA9IHRoaXMuZ2V0VHlwZUZpbHRlcnMoKTtcbiAgYnVsa09wZXJhdGlvblN0YXR1c09wdGlvbnM6IElTdGF0dXNPcHRpb25bXSA9IEJVTEtfT1BFUkFUSU9OX1NUQVRVU19PUFRJT05TO1xuXG4gIGZpbHRlclBpcGU7XG4gIHJlZnJlc2hMb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHN0YXR1c0ZpbHRlciQ6IEJlaGF2aW9yU3ViamVjdDxJU3RhdHVzT3B0aW9uW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgdHlwZUZpbHRlciQ6IEJlaGF2aW9yU3ViamVjdDxPcGVyYXRpb25UeXBlW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgdGltZUZpbHRlciQ6IEJlaGF2aW9yU3ViamVjdDxhbnk+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgcmVsb2FkJDogQmVoYXZpb3JTdWJqZWN0PHZvaWQ+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgQFZpZXdDaGlsZHJlbihCdWxrT3BlcmF0aW9uTGlzdEl0ZW1Db21wb25lbnQpIGxpc3RJdGVtczogUXVlcnlMaXN0PFxuICAgIEJ1bGtPcGVyYXRpb25MaXN0SXRlbUNvbXBvbmVudFxuICA+O1xuICBAVmlld0NoaWxkKCdzdGF0dXNGaWx0ZXInLCB7IHN0YXRpYzogdHJ1ZSB9KSBzdGF0dXNGaWx0ZXI6IFN0YXR1c0ZpbHRlckNvbXBvbmVudDtcbiAgQFZpZXdDaGlsZChEYXRlUGlja2VyQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KSBkYXRlUGlja2VyOiBEYXRlUGlja2VyQ29tcG9uZW50O1xuXG4gIGJ1bGtPcGVyYXRpb25zJDogT2JzZXJ2YWJsZTxJUmVzdWx0TGlzdDxJT3BlcmF0aW9uQnVsaz4+ID0gY29tYmluZUxhdGVzdChcbiAgICB0aGlzLnN0YXR1c0ZpbHRlciQsXG4gICAgdGhpcy50aW1lRmlsdGVyJCxcbiAgICB0aGlzLnR5cGVGaWx0ZXIkLFxuICAgIHRoaXMucmVsb2FkJFxuICApLnBpcGUoXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMucmVmcmVzaExvYWRpbmcgPSB0cnVlO1xuICAgIH0pLFxuICAgIHN3aXRjaE1hcCgoW3N0YXR1c0ZpbHRlcnMsIHRpbWVGaWx0ZXJzXSkgPT4gdGhpcy5maWx0ZXIoc3RhdHVzRmlsdGVycywgdGltZUZpbHRlcnMpKSxcbiAgICB3aXRoTGF0ZXN0RnJvbSh0aGlzLnR5cGVGaWx0ZXIkKSxcbiAgICBtYXAoKFtyZXN1bHQsIHR5cGVGaWx0ZXJdOiBbSVJlc3VsdExpc3Q8SU9wZXJhdGlvbkJ1bGs+LCBPcGVyYXRpb25UeXBlW11dKSA9PiB7XG4gICAgICB0aGlzLmZpbHRlclBpcGUgPSBwaXBlKG1hcCgoZGF0YTogW10pID0+IHRoaXMuZmlsdGVyQnlUeXBlKGRhdGEsIHR5cGVGaWx0ZXIpKSk7XG4gICAgICByZXR1cm4geyAuLi5yZXN1bHQsIGRhdGE6IHRoaXMuZmlsdGVyQnlUeXBlKHJlc3VsdC5kYXRhLCB0eXBlRmlsdGVyKSB9O1xuICAgIH0pLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnJlZnJlc2hMb2FkaW5nID0gZmFsc2U7XG4gICAgfSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcblxuICBwcml2YXRlIGFsbEZpbHRlckZyYWdtZW50czogc3RyaW5nW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWx0aW1lOiBPcGVyYXRpb25CdWxrUmVhbHRpbWVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnVsa09wZXJhdGlvbnNTZXJ2aWNlOiBCdWxrT3BlcmF0aW9uc1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5hbGxGaWx0ZXJGcmFnbWVudHMgPSB0aGlzLmZsYXR0ZW5GaWx0ZXJGcmFnbWVudHModGhpcy5nZXRUeXBlRmlsdGVycygpKTtcbiAgfVxuXG4gIGZpbHRlckJ5VHlwZShidWxrT3BlcmF0aW9uczogSU9wZXJhdGlvbkJ1bGtbXSwgdHlwZUZpbHRlcikge1xuICAgIGNvbnN0IGZsYXR0ZW5lZEZyYWdtZW50czogc3RyaW5nW10gPSB0aGlzLmZsYXR0ZW5GaWx0ZXJGcmFnbWVudHModHlwZUZpbHRlcik7XG4gICAgaWYgKFxuICAgICAgLy8gcmV0dXJuIGRhdGEgdW5maWx0ZXJlZCBpZiBubyBmaWx0ZXJzIHNlbGVjdGVkLi4uXG4gICAgICAhZmxhdHRlbmVkRnJhZ21lbnRzLmxlbmd0aCB8fFxuICAgICAgLy8gLi4ub3Igd2hlbiBhbGwgZmlsdGVycyBhcmUgc2VsZWN0ZWRcbiAgICAgIHRoaXMuYWxsRmlsdGVyRnJhZ21lbnRzLmV2ZXJ5KGZyYWdtZW50ID0+IGZsYXR0ZW5lZEZyYWdtZW50cy5pbmNsdWRlcyhmcmFnbWVudCkpXG4gICAgKSB7XG4gICAgICByZXR1cm4gYnVsa09wZXJhdGlvbnM7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsdGVyZWREYXRhID0gYnVsa09wZXJhdGlvbnMuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGl0ZW0ub3BlcmF0aW9uUHJvdG90eXBlKS5zb21lKGtleSA9PiBmbGF0dGVuZWRGcmFnbWVudHMuaW5jbHVkZXMoa2V5KSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZmlsdGVyZWREYXRhO1xuICB9XG5cbiAgcmVzZXRGaWx0ZXIoKSB7XG4gICAgdGhpcy5zdGF0dXNGaWx0ZXIkLm5leHQobnVsbCk7XG4gICAgdGhpcy50aW1lRmlsdGVyJC5uZXh0KG51bGwpO1xuICAgIHRoaXMudHlwZUZpbHRlciQubmV4dChudWxsKTtcblxuICAgIHRoaXMuZGF0ZVBpY2tlci5jbGVhckZpbHRlcigpO1xuICAgIHRoaXMuc2VsZWN0ZWRUeXBlRmlsdGVycyA9IHRoaXMuZ2V0VHlwZUZpbHRlcnMoKTtcbiAgICB0aGlzLnN0YXR1c0ZpbHRlci5zdGF0dXNPcHRpb25zLm1hcChvcHRpb24gPT4ge1xuICAgICAgb3B0aW9uLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICByZXR1cm4gb3B0aW9uO1xuICAgIH0pO1xuICB9XG5cbiAgaXNGaWx0ZXJBcHBsaWVkKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnN0YXR1c0ZpbHRlciQuZ2V0VmFsdWUoKSB8fCB0aGlzLnR5cGVGaWx0ZXIkLmdldFZhbHVlKCkgfHwgdGhpcy50aW1lRmlsdGVyJC5nZXRWYWx1ZSgpXG4gICAgKTtcbiAgfVxuXG4gIGZpbHRlcihzdGF0dXNGaWx0ZXJzLCB0aW1lRmlsdGVyKSB7XG4gICAgY29uc3Qgc3RhdHVzID1cbiAgICAgIHN0YXR1c0ZpbHRlcnMgJiYgc3RhdHVzRmlsdGVycy5sZW5ndGggPiAwXG4gICAgICAgID8ge1xuICAgICAgICAgICAgZ2VuZXJhbFN0YXR1czogZmxhdHRlbihzdGF0dXNGaWx0ZXJzLm1hcChzdGF0dXNGaWx0ZXIgPT4gc3RhdHVzRmlsdGVyLmdlbmVyYWxTdGF0dXMpKVxuICAgICAgICAgIH1cbiAgICAgICAgOiB7fTtcblxuICAgIGNvbnN0IHRpbWUgPSB0aW1lRmlsdGVyXG4gICAgICA/IHtcbiAgICAgICAgICAuLi4odGltZUZpbHRlci5kYXRlRnJvbSAmJiB7XG4gICAgICAgICAgICBkYXRlRnJvbTogdGltZUZpbHRlci5kYXRlRnJvbS50b0lTT1N0cmluZygpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgLi4uKHRpbWVGaWx0ZXIuZGF0ZVRvICYmIHtcbiAgICAgICAgICAgIGRhdGVUbzogdGltZUZpbHRlci5kYXRlVG8udG9JU09TdHJpbmcoKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIDoge307XG4gICAgcmV0dXJuIHRoaXMuZ2V0QnVsa09wZXJhdGlvbnMoeyAuLi5zdGF0dXMsIC4uLnRpbWUgfSk7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9ucyhmaWx0ZXI/KSB7XG4gICAgcmV0dXJuIHRoaXMuYnVsa09wZXJhdGlvbnNTZXJ2aWNlLmdldEJ1bGtPcGVyYXRpb25zKGZpbHRlcik7XG4gIH1cblxuICBnZXRUeXBlRmlsdGVycygpIHtcbiAgICByZXR1cm4gdGhpcy5idWxrT3BlcmF0aW9uc1NlcnZpY2UuZ2V0QnVsa1R5cGVzKCk7XG4gIH1cblxuICBhZGRCdWxrT3BlcmF0aW9uKCkge1xuICAgIHRoaXMuYnVsa09wZXJhdGlvbnNTZXJ2aWNlLnNob3dOZXdCdWxrT3BlcmF0aW9uTW9kYWwoKTtcbiAgfVxuXG4gIG9wZW5GYWlsZWRPcGVyYXRpb24oZmFpbGVkUGFyZW50SWQpIHtcbiAgICB0aGlzLmxpc3RJdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaWYgKGl0ZW0uYnVsa09wZXJhdGlvbi5pZCA9PT0gZmFpbGVkUGFyZW50SWQpIHtcbiAgICAgICAgaXRlbS5saXN0SXRlbS5jb2xsYXBzZWQgPSBmYWxzZTtcbiAgICAgICAgaXRlbS5saXN0SXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogJ3Ntb290aCcsIGJsb2NrOiAnY2VudGVyJyB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNvbXBhcmVPcGVyYXRpb25zKG9wZXJhdGlvbkE6IElPcGVyYXRpb25CdWxrLCBvcGVyYXRpb25COiBJT3BlcmF0aW9uQnVsayk6IG51bWJlciB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKG9wZXJhdGlvbkEuc3RhcnREYXRlKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShvcGVyYXRpb25CLnN0YXJ0RGF0ZSkuZ2V0VGltZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBmbGF0dGVuRmlsdGVyRnJhZ21lbnRzKGZpbHRlcnM6IE9wZXJhdGlvblR5cGVbXSk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gKGZpbHRlcnMgfHwgW10pLnJlZHVjZSgoZmxhdHRlbmVkLCBjdXJyZW50KSA9PiBmbGF0dGVuZWQuY29uY2F0KGN1cnJlbnQuZnJhZ21lbnRzKSwgW10pO1xuICB9XG59XG4iXX0=