import * as tslib_1 from "tslib";
import { Component, ViewChild } from '@angular/core';
import { C8yStepper, gettext, ModalService, Status } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { uniq } from 'lodash-es';
import { BaseStepperComponent } from '../base-stepper.component';
import { SelectSoftwareStepComponent } from './software-update-stepper/select-software-step.component';
var StepperBulkTypeSoftware = /** @class */ (function (_super) {
    tslib_1.__extends(StepperBulkTypeSoftware, _super);
    function StepperBulkTypeSoftware(modal, translate) {
        var _this = _super.call(this) || this;
        _this.modal = modal;
        _this.translate = translate;
        _this.descriptionTemplateSingle = gettext('Update software to: {{ name }} (version {{ version }})');
        _this.descriptionTemplateOneOther = gettext('Update software to: {{ name }} (version {{ version }}) and one other');
        _this.descriptionTemplateMultiple = gettext('Update software to: {{ name }} (version {{ version }}) and {{ count }} others');
        _this.selectedSoftware = [];
        return _this;
    }
    StepperBulkTypeSoftware.prototype.onSoftwareSelected = function (selectedItem) {
        this.selectedSoftware = this.selectedSoftware.filter(function (item) { return item.software.id !== selectedItem.software.id; });
        this.selectedSoftware.push(selectedItem);
    };
    StepperBulkTypeSoftware.prototype.confirmSoftwareSelection = function ($event) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var deviceTypes, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        deviceTypes = this.getUniqueDeviceTypes();
                        this.deviceTypes = deviceTypes;
                        if (!(deviceTypes.length > 1)) return [3 /*break*/, 5];
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.modal.confirm(gettext('Selected software for various device types'), gettext('Operation may fail due to unsupported software. Do you want to proceed?'), Status.WARNING, { ok: gettext('Confirm'), cancel: gettext('Cancel') })];
                    case 2:
                        _a.sent();
                        $event.stepper.next();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        this.selectedSoftware = [];
                        this.selectSoftware.resetSelection();
                        return [3 /*break*/, 4];
                    case 4: return [3 /*break*/, 6];
                    case 5:
                        $event.stepper.next();
                        _a.label = 6;
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    StepperBulkTypeSoftware.prototype.retrieveOperationPrototype = function () {
        var softwareList = this.selectedSoftware.map(function (item) { return ({
            name: item.software.name,
            version: item.version.c8y_Software.version,
            url: item.version.c8y_Software.url,
            action: item.action
        }); });
        var interpolationParams = {
            name: softwareList[0].name,
            version: softwareList[0].version,
            count: softwareList.length - 1
        };
        var description;
        switch (softwareList.length) {
            case 1:
                description = this.translate.instant(this.descriptionTemplateSingle, interpolationParams);
                break;
            case 2:
                description = this.translate.instant(this.descriptionTemplateOneOther, interpolationParams);
                break;
            default:
                description = this.translate.instant(this.descriptionTemplateMultiple, interpolationParams);
        }
        return {
            name: gettext('Software update'),
            prototype: {
                description: description,
                c8y_SoftwareUpdate: softwareList
            }
        };
    };
    StepperBulkTypeSoftware.prototype.getUniqueDeviceTypes = function () {
        return uniq(this.selectedSoftware
            .map(function (item) { return item.software.c8y_Filter && item.software.c8y_Filter.type; })
            .filter(function (type) { return !!type; }));
    };
    StepperBulkTypeSoftware.ctorParameters = function () { return [
        { type: ModalService },
        { type: TranslateService }
    ]; };
    tslib_1.__decorate([
        ViewChild(SelectSoftwareStepComponent, { static: false })
    ], StepperBulkTypeSoftware.prototype, "selectSoftware", void 0);
    StepperBulkTypeSoftware = tslib_1.__decorate([
        Component({
            selector: 'c8y-stepper-bulk-type-software',
            template: "<c8y-bulk-operation-stepper>\n  <ng-container\n    *customStep=\"\n      'Select software' | translate; \n      completed: !!selectedSoftware.length;\n      buttonsDisabled: !selectedSoftware.length; \n      onNext: confirmSoftwareSelection.bind(this)\"\n  >\n    <c8y-select-software-step\n      (software)=\"onSoftwareSelected($event)\"\n      class=\"d-contents\"\n    ></c8y-select-software-step>\n  </ng-container>\n  <ng-container *customStep=\"'Confirm selected software' | translate\">\n    <c8y-confirm-software-selection-step\n      class=\"d-contents\"\n      [selectedItems]=\"selectedSoftware\"\n    ></c8y-confirm-software-selection-step>\n  </ng-container>\n</c8y-bulk-operation-stepper>\n"
        })
    ], StepperBulkTypeSoftware);
    return StepperBulkTypeSoftware;
}(BaseStepperComponent));
export { StepperBulkTypeSoftware };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci1idWxrLXR5cGUtc29mdHdhcmUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zLyIsInNvdXJjZXMiOlsiYnVsay9jcmVhdGlvbi9zdGVwcGVyLWJ1bGstdHlwZS1zb2Z0d2FyZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJELE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNoRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRWpFLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBVXZHO0lBQTZDLG1EQUFvQjtJQWUvRCxpQ0FBb0IsS0FBbUIsRUFBVSxTQUEyQjtRQUE1RSxZQUNFLGlCQUFPLFNBQ1I7UUFGbUIsV0FBSyxHQUFMLEtBQUssQ0FBYztRQUFVLGVBQVMsR0FBVCxTQUFTLENBQWtCO1FBZG5FLCtCQUF5QixHQUFXLE9BQU8sQ0FDbEQsd0RBQXdELENBQ3pELENBQUM7UUFDTyxpQ0FBMkIsR0FBVyxPQUFPLENBQ3BELHNFQUFzRSxDQUN2RSxDQUFDO1FBQ08saUNBQTJCLEdBQVcsT0FBTyxDQUNwRCwrRUFBK0UsQ0FDaEYsQ0FBQztRQUVGLHNCQUFnQixHQUF3QixFQUFFLENBQUM7O0lBTTNDLENBQUM7SUFFRCxvREFBa0IsR0FBbEIsVUFBbUIsWUFBWTtRQUM3QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FDbEQsVUFB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SSxDQUFDLFFBQVEsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUF6RCxDQUF5RCxDQUFDO2FBQ3RFLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLEVBQU4sQ0FBTSxDQUFDLENBQzFCLENBQUM7SUFDSixDQUFDOztnQkF4RTBCLFlBQVk7Z0JBQXFCLGdCQUFnQjs7SUFGNUU7UUFEQyxTQUFTLENBQUMsMkJBQTJCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7bUVBQ2Q7SUFiakMsdUJBQXVCO1FBSm5DLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxnQ0FBZ0M7WUFDMUMsNHNCQUF3RDtTQUN6RCxDQUFDO09BQ1csdUJBQXVCLENBd0ZuQztJQUFELDhCQUFDO0NBQUEsQUF4RkQsQ0FBNkMsb0JBQW9CLEdBd0ZoRTtTQXhGWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZGtTdGVwIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3N0ZXBwZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElPcGVyYXRpb24gfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBDOHlTdGVwcGVyLCBnZXR0ZXh0LCBNb2RhbFNlcnZpY2UsIFN0YXR1cyB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgdW5pcSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCYXNlU3RlcHBlckNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2Utc3RlcHBlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlscyB9IGZyb20gJy4uL29wZXJhdGlvbi1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7IFNlbGVjdFNvZnR3YXJlU3RlcENvbXBvbmVudCB9IGZyb20gJy4vc29mdHdhcmUtdXBkYXRlLXN0ZXBwZXIvc2VsZWN0LXNvZnR3YXJlLXN0ZXAuY29tcG9uZW50JztcbmltcG9ydCB7XG4gIElTZWxlY3RlZFNvZnR3YXJlLFxuICBJU29mdHdhcmVVcGRhdGVPcGVyYXRpb25Qcm90b3R5cGVcbn0gZnJvbSAnLi9zb2Z0d2FyZS11cGRhdGUtc3RlcHBlci9zZWxlY3Qtc29mdHdhcmUubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktc3RlcHBlci1idWxrLXR5cGUtc29mdHdhcmUnLFxuICB0ZW1wbGF0ZVVybDogJ3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTdGVwcGVyQnVsa1R5cGVTb2Z0d2FyZSBleHRlbmRzIEJhc2VTdGVwcGVyQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgZGVzY3JpcHRpb25UZW1wbGF0ZVNpbmdsZTogc3RyaW5nID0gZ2V0dGV4dChcbiAgICAnVXBkYXRlIHNvZnR3YXJlIHRvOiB7eyBuYW1lIH19ICh2ZXJzaW9uIHt7IHZlcnNpb24gfX0pJ1xuICApO1xuICByZWFkb25seSBkZXNjcmlwdGlvblRlbXBsYXRlT25lT3RoZXI6IHN0cmluZyA9IGdldHRleHQoXG4gICAgJ1VwZGF0ZSBzb2Z0d2FyZSB0bzoge3sgbmFtZSB9fSAodmVyc2lvbiB7eyB2ZXJzaW9uIH19KSBhbmQgb25lIG90aGVyJ1xuICApO1xuICByZWFkb25seSBkZXNjcmlwdGlvblRlbXBsYXRlTXVsdGlwbGU6IHN0cmluZyA9IGdldHRleHQoXG4gICAgJ1VwZGF0ZSBzb2Z0d2FyZSB0bzoge3sgbmFtZSB9fSAodmVyc2lvbiB7eyB2ZXJzaW9uIH19KSBhbmQge3sgY291bnQgfX0gb3RoZXJzJ1xuICApO1xuXG4gIHNlbGVjdGVkU29mdHdhcmU6IElTZWxlY3RlZFNvZnR3YXJlW10gPSBbXTtcbiAgQFZpZXdDaGlsZChTZWxlY3RTb2Z0d2FyZVN0ZXBDb21wb25lbnQsIHsgc3RhdGljOiBmYWxzZSB9KVxuICBzZWxlY3RTb2Z0d2FyZTogU2VsZWN0U29mdHdhcmVTdGVwQ29tcG9uZW50O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbW9kYWw6IE1vZGFsU2VydmljZSwgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgb25Tb2Z0d2FyZVNlbGVjdGVkKHNlbGVjdGVkSXRlbSkge1xuICAgIHRoaXMuc2VsZWN0ZWRTb2Z0d2FyZSA9IHRoaXMuc2VsZWN0ZWRTb2Z0d2FyZS5maWx0ZXIoXG4gICAgICBpdGVtID0+IGl0ZW0uc29mdHdhcmUuaWQgIT09IHNlbGVjdGVkSXRlbS5zb2Z0d2FyZS5pZFxuICAgICk7XG4gICAgdGhpcy5zZWxlY3RlZFNvZnR3YXJlLnB1c2goc2VsZWN0ZWRJdGVtKTtcbiAgfVxuXG4gIGFzeW5jIGNvbmZpcm1Tb2Z0d2FyZVNlbGVjdGlvbigkZXZlbnQ6IHsgc3RlcHBlcjogQzh5U3RlcHBlcjsgc3RlcDogQ2RrU3RlcCB9KSB7XG4gICAgY29uc3QgZGV2aWNlVHlwZXM6IHN0cmluZ1tdID0gdGhpcy5nZXRVbmlxdWVEZXZpY2VUeXBlcygpO1xuICAgIHRoaXMuZGV2aWNlVHlwZXMgPSBkZXZpY2VUeXBlcztcbiAgICBpZiAoZGV2aWNlVHlwZXMubGVuZ3RoID4gMSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5tb2RhbC5jb25maXJtKFxuICAgICAgICAgIGdldHRleHQoJ1NlbGVjdGVkIHNvZnR3YXJlIGZvciB2YXJpb3VzIGRldmljZSB0eXBlcycpLFxuICAgICAgICAgIGdldHRleHQoJ09wZXJhdGlvbiBtYXkgZmFpbCBkdWUgdG8gdW5zdXBwb3J0ZWQgc29mdHdhcmUuIERvIHlvdSB3YW50IHRvIHByb2NlZWQ/JyksXG4gICAgICAgICAgU3RhdHVzLldBUk5JTkcsXG4gICAgICAgICAgeyBvazogZ2V0dGV4dCgnQ29uZmlybScpLCBjYW5jZWw6IGdldHRleHQoJ0NhbmNlbCcpIH1cbiAgICAgICAgKTtcbiAgICAgICAgJGV2ZW50LnN0ZXBwZXIubmV4dCgpO1xuICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFNvZnR3YXJlID0gW107XG4gICAgICAgIHRoaXMuc2VsZWN0U29mdHdhcmUucmVzZXRTZWxlY3Rpb24oKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgJGV2ZW50LnN0ZXBwZXIubmV4dCgpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCByZXRyaWV2ZU9wZXJhdGlvblByb3RvdHlwZSgpOiBPcGVyYXRpb25EZXRhaWxzIHtcbiAgICBjb25zdCBzb2Z0d2FyZUxpc3Q6IElTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvblByb3RvdHlwZVtdID0gdGhpcy5zZWxlY3RlZFNvZnR3YXJlLm1hcChpdGVtID0+ICh7XG4gICAgICBuYW1lOiBpdGVtLnNvZnR3YXJlLm5hbWUsXG4gICAgICB2ZXJzaW9uOiBpdGVtLnZlcnNpb24uYzh5X1NvZnR3YXJlLnZlcnNpb24sXG4gICAgICB1cmw6IGl0ZW0udmVyc2lvbi5jOHlfU29mdHdhcmUudXJsLFxuICAgICAgYWN0aW9uOiBpdGVtLmFjdGlvblxuICAgIH0pKTtcblxuICAgIGNvbnN0IGludGVycG9sYXRpb25QYXJhbXM6IG9iamVjdCA9IHtcbiAgICAgIG5hbWU6IHNvZnR3YXJlTGlzdFswXS5uYW1lLFxuICAgICAgdmVyc2lvbjogc29mdHdhcmVMaXN0WzBdLnZlcnNpb24sXG4gICAgICBjb3VudDogc29mdHdhcmVMaXN0Lmxlbmd0aCAtIDFcbiAgICB9O1xuICAgIGxldCBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIHN3aXRjaCAoc29mdHdhcmVMaXN0Lmxlbmd0aCkge1xuICAgICAgY2FzZSAxOlxuICAgICAgICBkZXNjcmlwdGlvbiA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5kZXNjcmlwdGlvblRlbXBsYXRlU2luZ2xlLCBpbnRlcnBvbGF0aW9uUGFyYW1zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIGRlc2NyaXB0aW9uID0gdGhpcy50cmFuc2xhdGUuaW5zdGFudCh0aGlzLmRlc2NyaXB0aW9uVGVtcGxhdGVPbmVPdGhlciwgaW50ZXJwb2xhdGlvblBhcmFtcyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgZGVzY3JpcHRpb24gPSB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuZGVzY3JpcHRpb25UZW1wbGF0ZU11bHRpcGxlLCBpbnRlcnBvbGF0aW9uUGFyYW1zKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogZ2V0dGV4dCgnU29mdHdhcmUgdXBkYXRlJyksXG4gICAgICBwcm90b3R5cGU6ICh7XG4gICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICBjOHlfU29mdHdhcmVVcGRhdGU6IHNvZnR3YXJlTGlzdFxuICAgICAgfSBhcyB1bmtub3duKSBhcyBJT3BlcmF0aW9uXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VW5pcXVlRGV2aWNlVHlwZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB1bmlxKFxuICAgICAgdGhpcy5zZWxlY3RlZFNvZnR3YXJlXG4gICAgICAgIC5tYXAoaXRlbSA9PiBpdGVtLnNvZnR3YXJlLmM4eV9GaWx0ZXIgJiYgaXRlbS5zb2Z0d2FyZS5jOHlfRmlsdGVyLnR5cGUpXG4gICAgICAgIC5maWx0ZXIodHlwZSA9PiAhIXR5cGUpXG4gICAgKTtcbiAgfVxufVxuIl19