import * as tslib_1 from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken } from '@angular/core';
import { IdReference, IManagedObject, InventoryService, IOperation, IOperationBulk, IResult, OperationBulkService, OperationService } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { has, isUndefined } from 'lodash-es';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { Subject } from 'rxjs';
import { BulkOperationType } from './bulk-operation.model';
import { BulkOperationsModalComponent } from './modal/bulk-operations-modal.component';
export var baseUrl = 'devicecontrol/bulk/creation/';
export var HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export var C8Y_BULK_TYPES = [
    {
        type: BulkOperationType.CONFIGURATION,
        c8yIcon: 'cogs',
        name: gettext('Configuration update'),
        path: baseUrl + "configuration",
        component: undefined,
        fragments: ['c8y_DownloadConfigFile', 'c8y_Configuration'],
        selected: false
    },
    {
        type: BulkOperationType.FIRMWARE,
        c8yIcon: 'c8y-firmware',
        name: gettext('Firmware update'),
        path: baseUrl + "firmware",
        component: undefined,
        fragments: ['c8y_Firmware'],
        selected: false
    },
    {
        type: BulkOperationType.SOFTWARE,
        c8yIcon: 'c8y-tools',
        name: gettext('Software update'),
        path: baseUrl + "software",
        component: undefined,
        fragments: ['c8y_SoftwareList', 'c8y_SoftwareUpdate'],
        selected: false
    },
    {
        type: BulkOperationType.DEVICE_PROFILE,
        c8yIcon: 'c8y-device-profile',
        name: gettext('Apply device profile'),
        path: baseUrl + "device-profile",
        component: undefined,
        fragments: ['c8y_DeviceProfile'],
        selected: false
    }
];
var ɵ0 = function (flattened, current) { return flattened.concat(current.fragments); };
export var C8Y_BULK_TYPE_FRAGMENTS = C8Y_BULK_TYPES.reduce(ɵ0, []);
var BulkOperationsService = /** @class */ (function () {
    function BulkOperationsService(operationBulkService, operationService, inventoryService, bsModalService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.bsModalService = bsModalService;
        this.location = location;
        this.bulkTypes = bulkTypes;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        if (bulkTypes && bulkTypes.length > 0) {
            this.bulkTypes = bulkTypes.map(function (type) {
                if (isUndefined(type.selected)) {
                    type.selected = false;
                }
                return type;
            });
        }
    }
    BulkOperationsService.prototype.getBulkOperations = function (customFilter) {
        if (customFilter === void 0) { customFilter = {}; }
        var filter = tslib_1.__assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    };
    BulkOperationsService.prototype.getBulkOperationById = function (bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    };
    BulkOperationsService.prototype.createBulkOperation = function (bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    };
    BulkOperationsService.prototype.deleteBulkOperation = function (bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    };
    BulkOperationsService.prototype.updateBulkOperation = function (bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    };
    BulkOperationsService.prototype.getOperation = function (id) {
        return this.operationService.detail(id);
    };
    BulkOperationsService.prototype.showNewBulkOperationModal = function () {
        this.bsModalRef = this.bsModalService.show(BulkOperationsModalComponent, {
            backdrop: 'static',
            class: 'modal-sm'
        });
    };
    BulkOperationsService.prototype.hideNewBulkOperationModal = function () {
        if (this.bsModalRef) {
            this.bsModalRef.hide();
        }
    };
    BulkOperationsService.prototype.returnToBulkOperationOverview = function () {
        this.location.back();
    };
    BulkOperationsService.prototype.setBulkTypes = function (list) {
        this.bulkTypes = list;
    };
    BulkOperationsService.prototype.getBulkTypes = function () {
        return this.bulkTypes;
    };
    BulkOperationsService.prototype.setFirmwareId = function (id) {
        this.firmwareId.next(id);
    };
    BulkOperationsService.prototype.createGroup = function (deviceQueryDataString) {
        var dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    };
    BulkOperationsService.prototype.scheduleBulkOperation = function (deviceQueryString, details) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dynamicGroup, bulkOperation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.createGroup(deviceQueryString)];
                    case 1:
                        dynamicGroup = _a.sent();
                        bulkOperation = {
                            groupId: dynamicGroup.data.id,
                            operationPrototype: details.prototype,
                            creationRamp: details.schedule.delayInSeconds,
                            startDate: details.schedule.scheduledDate.toISOString(),
                            note: details.note
                        };
                        return [4 /*yield*/, this.createBulkOperation(bulkOperation)];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    BulkOperationsService.prototype.getSingleOperationsByStatus = function (status, bulkOperationId) {
        var filter = {
            withTotalPages: true,
            bulkOperationId: bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    };
    BulkOperationsService.prototype.createSingleOperation = function (operation) {
        return this.operationService.create(operation);
    };
    BulkOperationsService.prototype.updateSingleOperation = function (partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    };
    BulkOperationsService.prototype.getManagedObject = function (deviceId) {
        return this.inventoryService.detail(deviceId);
    };
    BulkOperationsService.prototype.retrieveBulkOperationType = function (operation) {
        var type;
        C8Y_BULK_TYPES.some(function (t) {
            if (t.fragments.some(function (fragment) { return has(operation, fragment); })) {
                type = t.type;
                return true;
            }
        });
        return type;
    };
    BulkOperationsService.ctorParameters = function () { return [
        { type: OperationBulkService },
        { type: OperationService },
        { type: InventoryService },
        { type: BsModalService },
        { type: Location },
        { type: Array, decorators: [{ type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
    ]; };
    BulkOperationsService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(5, Inject(HOOK_LIST_BULK_TYPE))
    ], BulkOperationsService);
    return BulkOperationsService;
}());
export { BulkOperationsService };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvIiwic291cmNlcyI6WyJidWxrL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFDTCxXQUFXLEVBQ1gsY0FBYyxFQUNkLGdCQUFnQixFQUNoQixVQUFVLEVBQ1YsY0FBYyxFQUNkLE9BQU8sRUFDUCxvQkFBb0IsRUFDcEIsZ0JBQWdCLEVBQ2pCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHM0QsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFHdkYsTUFBTSxDQUFDLElBQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxJQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUFrQixnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3pGLE1BQU0sQ0FBQyxJQUFNLGNBQWMsR0FBb0I7SUFDN0M7UUFDRSxJQUFJLEVBQUUsaUJBQWlCLENBQUMsYUFBYTtRQUNyQyxPQUFPLEVBQUUsTUFBTTtRQUNmLElBQUksRUFBRSxPQUFPLENBQUMsc0JB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LHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElkUmVmZXJlbmNlLFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgSU9wZXJhdGlvbkJ1bGssXG4gIElSZXN1bHQsXG4gIE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICBPcGVyYXRpb25TZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGhhcywgaXNVbmRlZmluZWQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQnNNb2RhbFJlZiwgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9idWxrLW9wZXJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBJU3RhdHVzT3B0aW9uIH0gZnJvbSAnLi4vc3RhdHVzLWZpbHRlci9zdGF0dXMtb3B0aW9uLm1vZGVsJztcbmltcG9ydCB7IE9wZXJhdGlvblR5cGUgfSBmcm9tICcuL2xpc3QvdHlwZS1saXN0L29wZXJhdGlvbi10eXBlLm1vZGVsJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25zTW9kYWxDb21wb25lbnQgfSBmcm9tICcuL21vZGFsL2J1bGstb3BlcmF0aW9ucy1tb2RhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlscyB9IGZyb20gJy4vb3BlcmF0aW9uLWRldGFpbHMubW9kZWwnO1xuXG5leHBvcnQgY29uc3QgYmFzZVVybCA9ICdkZXZpY2Vjb250cm9sL2J1bGsvY3JlYXRpb24vJztcbmV4cG9ydCBjb25zdCBIT09LX0xJU1RfQlVMS19UWVBFID0gbmV3IEluamVjdGlvblRva2VuPE9wZXJhdGlvblR5cGVbXT4oJ0xJU1RfQlVMS19UWVBFJyk7XG5leHBvcnQgY29uc3QgQzhZX0JVTEtfVFlQRVM6IE9wZXJhdGlvblR5cGVbXSA9IFtcbiAge1xuICAgIHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlLkNPTkZJR1VSQVRJT04sXG4gICAgYzh5SWNvbjogJ2NvZ3MnLFxuICAgIG5hbWU6IGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1jb25maWd1cmF0aW9uYCxcbiAgICBjb21wb25lbnQ6IHVuZGVmaW5lZCxcbiAgICBmcmFnbWVudHM6IFsnYzh5X0Rvd25sb2FkQ29uZmlnRmlsZScsICdjOHlfQ29uZmlndXJhdGlvbiddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9LFxuICB7XG4gICAgdHlwZTogQnVsa09wZXJhdGlvblR5cGUuRklSTVdBUkUsXG4gICAgYzh5SWNvbjogJ2M4eS1maXJtd2FyZScsXG4gICAgbmFtZTogZ2V0dGV4dCgnRmlybXdhcmUgdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1maXJtd2FyZWAsXG4gICAgY29tcG9uZW50OiB1bmRlZmluZWQsXG4gICAgZnJhZ21lbnRzOiBbJ2M4eV9GaXJtd2FyZSddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9LFxuICB7XG4gICAgdHlwZTogQnVsa09wZXJhdGlvblR5cGUuU09GVFdBUkUsXG4gICAgYzh5SWNvbjogJ2M4eS10b29scycsXG4gICAgbmFtZTogZ2V0dGV4dCgnU29mdHdhcmUgdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1zb2Z0d2FyZWAsXG4gICAgY29tcG9uZW50OiB1bmRlZmluZWQsXG4gICAgZnJhZ21lbnRzOiBbJ2M4eV9Tb2Z0d2FyZUxpc3QnLCAnYzh5X1NvZnR3YXJlVXBkYXRlJ10sXG4gICAgc2VsZWN0ZWQ6IGZhbHNlXG4gIH0sXG4gIHtcbiAgICB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZS5ERVZJQ0VfUFJPRklMRSxcbiAgICBjOHlJY29uOiAnYzh5LWRldmljZS1wcm9maWxlJyxcbiAgICBuYW1lOiBnZXR0ZXh0KCdBcHBseSBkZXZpY2UgcHJvZmlsZScpLFxuICAgIHBhdGg6IGAke2Jhc2VVcmx9ZGV2aWNlLXByb2ZpbGVgLFxuICAgIGNvbXBvbmVudDogdW5kZWZpbmVkLFxuICAgIGZyYWdtZW50czogWydjOHlfRGV2aWNlUHJvZmlsZSddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9XG5dO1xuZXhwb3J0IGNvbnN0IEM4WV9CVUxLX1RZUEVfRlJBR01FTlRTOiBzdHJpbmdbXSA9IEM4WV9CVUxLX1RZUEVTLnJlZHVjZShcbiAgKGZsYXR0ZW5lZCwgY3VycmVudCkgPT4gZmxhdHRlbmVkLmNvbmNhdChjdXJyZW50LmZyYWdtZW50cyksXG4gIFtdXG4pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvbnNTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgRERfTE9XX0NPVU5UOiBudW1iZXIgPSAxMDtcbiAgZmlybXdhcmVJZDogU3ViamVjdDxJZFJlZmVyZW5jZT4gPSBuZXcgU3ViamVjdDxJZFJlZmVyZW5jZT4oKTtcblxuICBwcml2YXRlIGJzTW9kYWxSZWY6IEJzTW9kYWxSZWY7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgb3BlcmF0aW9uQnVsa1NlcnZpY2U6IE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24sXG5cbiAgICBASW5qZWN0KEhPT0tfTElTVF9CVUxLX1RZUEUpIHByaXZhdGUgYnVsa1R5cGVzOiBPcGVyYXRpb25UeXBlW11cbiAgKSB7XG4gICAgaWYgKGJ1bGtUeXBlcyAmJiBidWxrVHlwZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5idWxrVHlwZXMgPSBidWxrVHlwZXMubWFwKHR5cGUgPT4ge1xuICAgICAgICBpZiAoaXNVbmRlZmluZWQodHlwZS5zZWxlY3RlZCkpIHtcbiAgICAgICAgICB0eXBlLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHR5cGU7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9ucyhjdXN0b21GaWx0ZXIgPSB7fSkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgd2l0aERlbGV0ZWQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogNTAsXG4gICAgICAuLi5jdXN0b21GaWx0ZXJcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbkJ5SWQoYnVsa09wZXJhdGlvbklkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZXRhaWwoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIGNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5jcmVhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBkZWxldGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmRlbGV0ZShidWxrT3BlcmF0aW9uSWQpO1xuICB9XG5cbiAgdXBkYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uOiBQYXJ0aWFsPElPcGVyYXRpb25CdWxrPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLnVwZGF0ZShidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldE9wZXJhdGlvbihpZDogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0PElPcGVyYXRpb24+PiB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5kZXRhaWwoaWQpO1xuICB9XG5cbiAgc2hvd05ld0J1bGtPcGVyYXRpb25Nb2RhbCgpIHtcbiAgICB0aGlzLmJzTW9kYWxSZWYgPSB0aGlzLmJzTW9kYWxTZXJ2aWNlLnNob3coQnVsa09wZXJhdGlvbnNNb2RhbENvbXBvbmVudCwge1xuICAgICAgYmFja2Ryb3A6ICdzdGF0aWMnLFxuICAgICAgY2xhc3M6ICdtb2RhbC1zbSdcbiAgICB9KTtcbiAgfVxuXG4gIGhpZGVOZXdCdWxrT3BlcmF0aW9uTW9kYWwoKSB7XG4gICAgaWYgKHRoaXMuYnNNb2RhbFJlZikge1xuICAgICAgdGhpcy5ic01vZGFsUmVmLmhpZGUoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm5Ub0J1bGtPcGVyYXRpb25PdmVydmlldygpIHtcbiAgICB0aGlzLmxvY2F0aW9uLmJhY2soKTtcbiAgfVxuXG4gIHNldEJ1bGtUeXBlcyhsaXN0OiBPcGVyYXRpb25UeXBlW10pIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGxpc3Q7XG4gIH1cblxuICBnZXRCdWxrVHlwZXMoKTogT3BlcmF0aW9uVHlwZVtdIHtcbiAgICByZXR1cm4gdGhpcy5idWxrVHlwZXM7XG4gIH1cblxuICBzZXRGaXJtd2FyZUlkKGlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHRoaXMuZmlybXdhcmVJZC5uZXh0KGlkKTtcbiAgfVxuXG4gIGNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5RGF0YVN0cmluZzogc3RyaW5nKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHtcbiAgICAgIG5hbWU6ICdCdWxrIG9wZXJhdGlvbnMgZ3JvdXAnLFxuICAgICAgdHlwZTogJ2M4eV9EeW5hbWljR3JvdXAnLFxuICAgICAgYzh5X0lzRHluYW1pY0dyb3VwOiB7IGludmlzaWJsZToge30gfSxcbiAgICAgIGM4eV9EZXZpY2VRdWVyeVN0cmluZzogZGV2aWNlUXVlcnlEYXRhU3RyaW5nXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGR5bmFtaWNHcm91cCk7XG4gIH1cblxuICBhc3luYyBzY2hlZHVsZUJ1bGtPcGVyYXRpb24oZGV2aWNlUXVlcnlTdHJpbmc6IHN0cmluZywgZGV0YWlsczogT3BlcmF0aW9uRGV0YWlscykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cCA9IGF3YWl0IHRoaXMuY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlTdHJpbmcpO1xuXG4gICAgY29uc3QgYnVsa09wZXJhdGlvbjogSU9wZXJhdGlvbkJ1bGsgPSB7XG4gICAgICBncm91cElkOiBkeW5hbWljR3JvdXAuZGF0YS5pZCxcbiAgICAgIG9wZXJhdGlvblByb3RvdHlwZTogZGV0YWlscy5wcm90b3R5cGUsXG4gICAgICBjcmVhdGlvblJhbXA6IGRldGFpbHMuc2NoZWR1bGUuZGVsYXlJblNlY29uZHMsXG4gICAgICBzdGFydERhdGU6IGRldGFpbHMuc2NoZWR1bGUuc2NoZWR1bGVkRGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgbm90ZTogZGV0YWlscy5ub3RlXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldFNpbmdsZU9wZXJhdGlvbnNCeVN0YXR1cyhzdGF0dXMsIGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgYnVsa09wZXJhdGlvbklkLFxuICAgICAgc3RhdHVzOiAoc3RhdHVzICYmIHN0YXR1cy50b1VwcGVyQ2FzZSgpKSB8fCAnJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGNyZWF0ZVNpbmdsZU9wZXJhdGlvbihvcGVyYXRpb246IElPcGVyYXRpb24pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb24pO1xuICB9XG5cbiAgdXBkYXRlU2luZ2xlT3BlcmF0aW9uKHBhcnRpYWxVcGRhdGVPYmplY3Q6IFBhcnRpYWw8SU9wZXJhdGlvbj4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLnVwZGF0ZShwYXJ0aWFsVXBkYXRlT2JqZWN0KTtcbiAgfVxuXG4gIGdldE1hbmFnZWRPYmplY3QoZGV2aWNlSWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwoZGV2aWNlSWQpO1xuICB9XG5cbiAgcmV0cmlldmVCdWxrT3BlcmF0aW9uVHlwZShvcGVyYXRpb246IElPcGVyYXRpb24pOiBCdWxrT3BlcmF0aW9uVHlwZSB7XG4gICAgbGV0IHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlO1xuXG4gICAgQzhZX0JVTEtfVFlQRVMuc29tZSh0ID0+IHtcbiAgICAgIGlmICh0LmZyYWdtZW50cy5zb21lKGZyYWdtZW50ID0+IGhhcyhvcGVyYXRpb24sIGZyYWdtZW50KSkpIHtcbiAgICAgICAgdHlwZSA9IHQudHlwZTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdHlwZTtcbiAgfVxufVxuIl19