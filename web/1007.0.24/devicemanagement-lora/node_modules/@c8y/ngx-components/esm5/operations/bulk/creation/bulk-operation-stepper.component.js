import * as tslib_1 from "tslib";
import { Component, ContentChildren, EventEmitter, Output, ViewChild } from '@angular/core';
import { AlertService, C8yStepper, gettext, ModalService, Status } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { OperationDetailsComponent } from '../../details/operation-details.component';
import { BulkOperationsService } from '../bulk-operations.service';
import { CustomStep } from '../custom-step.directive';
var BulkOperationStepper = /** @class */ (function () {
    function BulkOperationStepper(bulkOperationService, modal, alert) {
        this.bulkOperationService = bulkOperationService;
        this.modal = modal;
        this.alert = alert;
        this.selectionChange = new EventEmitter();
        this.steps = [];
        this.showStepper = false;
        this.showButtons = false;
        this.stepperButtonsLabels = { custom: gettext('Schedule bulk operation') };
        this.deviceTypesSubject$ = new Subject();
        this.endSubscriptions = new Subject();
        this.deviceTypes$ = this.deviceTypesSubject$.asObservable();
    }
    BulkOperationStepper.prototype.ngAfterViewInit = function () {
        var _this = this;
        setTimeout(function () {
            // wait for the next event loop turn as `steps` has already been checked in this CD cycle
            _this.steps = _this.customSteps.toArray();
            _this.showStepper = true;
            setTimeout(function () {
                // postpone rendering of buttons for custom steps to the point where custom steps have already been rendered
                _this.showButtons = true;
                if (_this.stepper) {
                    _this.stepper.selectionChange.pipe(takeUntil(_this.endSubscriptions)).subscribe(function (event) {
                        _this.selectionChange.next(event);
                    });
                    _this.operationDetailsForm = _this.operationDetailsComponent.fgOperationDescription;
                }
            });
        });
    };
    BulkOperationStepper.prototype.changeDeviceTypes = function (deviceTypes) {
        if (deviceTypes) {
            this.deviceTypesSubject$.next(Array.isArray(deviceTypes) ? deviceTypes : [deviceTypes]);
        }
        else {
            this.deviceTypesSubject$.next([]);
        }
    };
    BulkOperationStepper.prototype.confirmDeviceSelection = function ($event) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, ex_1, _c, _d;
            return tslib_1.__generator(this, function (_e) {
                switch (_e.label) {
                    case 0:
                        if (!!this.deviceQueryString) return [3 /*break*/, 8];
                        _e.label = 1;
                    case 1:
                        _e.trys.push([1, 6, , 7]);
                        return [4 /*yield*/, this.modal.confirm(gettext('All devices selected'), gettext('You are about to schedule the bulk operation to be executed for all devices. Do you want to proceed?'), Status.WARNING, { ok: gettext('Schedule for all devices'), cancel: gettext('Cancel and select devices') })];
                    case 2:
                        _e.sent();
                        $event.step.completed = true;
                        $event.stepper.next();
                        _a = this;
                        if (!this.retrieveOperationDetails) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.retrieveOperationDetails()];
                    case 3:
                        _b = _e.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        _b = undefined;
                        _e.label = 5;
                    case 5:
                        _a.operationDetails = _b;
                        return [3 /*break*/, 7];
                    case 6:
                        ex_1 = _e.sent();
                        return [3 /*break*/, 7];
                    case 7: return [3 /*break*/, 12];
                    case 8:
                        $event.step.completed = true;
                        $event.stepper.next();
                        _c = this;
                        if (!this.retrieveOperationDetails) return [3 /*break*/, 10];
                        return [4 /*yield*/, this.retrieveOperationDetails()];
                    case 9:
                        _d = _e.sent();
                        return [3 /*break*/, 11];
                    case 10:
                        _d = undefined;
                        _e.label = 11;
                    case 11:
                        _c.operationDetails = _d;
                        _e.label = 12;
                    case 12:
                        this.bulkOperationType = this.bulkOperationService.retrieveBulkOperationType(get(this.operationDetails, 'prototype'));
                        if (this.operationDetailsForm &&
                            get(this.operationDetailsForm, 'controls.description.pristine') &&
                            this.operationDetails) {
                            this.operationDetailsForm.patchValue({
                                description: get(this.operationDetails, 'prototype.description')
                            });
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    BulkOperationStepper.prototype.cancel = function () {
        this.close();
    };
    BulkOperationStepper.prototype.scheduleBulkOperation = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.pendingStatus = true;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        this.operationDetails.prototype.description = get(this.operationDetailsForm, 'controls.description.value');
                        this.operationDetails.note = get(this.operationDetailsForm, 'controls.note.value');
                        this.operationDetails.schedule = get(this.operationDetailsForm, 'controls.schedule.value');
                        return [4 /*yield*/, this.bulkOperationService.scheduleBulkOperation(this.deviceQueryString, this.operationDetails)];
                    case 2:
                        _a.sent();
                        this.alert.success(gettext('New bulk operation scheduled.'));
                        this.close();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_2 = _a.sent();
                        this.alert.addServerFailure(ex_2);
                        return [3 /*break*/, 4];
                    case 4:
                        this.pendingStatus = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    BulkOperationStepper.prototype.ngOnDestroy = function () {
        this.endSubscriptions.next();
        this.endSubscriptions.complete();
    };
    BulkOperationStepper.prototype.close = function () {
        this.stepper.reset();
        this.bulkOperationService.returnToBulkOperationOverview();
    };
    BulkOperationStepper.ctorParameters = function () { return [
        { type: BulkOperationsService },
        { type: ModalService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Output()
    ], BulkOperationStepper.prototype, "selectionChange", void 0);
    tslib_1.__decorate([
        ContentChildren(CustomStep)
    ], BulkOperationStepper.prototype, "customSteps", void 0);
    tslib_1.__decorate([
        ViewChild(C8yStepper, { static: false })
    ], BulkOperationStepper.prototype, "stepper", void 0);
    tslib_1.__decorate([
        ViewChild(OperationDetailsComponent, { static: false })
    ], BulkOperationStepper.prototype, "operationDetailsComponent", void 0);
    BulkOperationStepper = tslib_1.__decorate([
        Component({
            selector: 'c8y-bulk-operation-stepper',
            template: "<div class=\"fit-v\">\n  <c8y-stepper\n    class=\"flex-col no-align-items fit-v c8y-stepper--no-btns\"\n    linear\n    [disableDefaultIcons]=\"{ edit: true, done: false }\"\n    [customClasses]=\"['col-md-6', 'col-md-offset-3', 'p-t-16', 'p-b-32', 'flex-no-shrink']\"\n    *ngIf=\"showStepper\"\n  >\n    <!-- CUSTOM STEPS 1 to N-2 -->\n    <cdk-step\n      *ngFor=\"let step of steps\"\n      [label]=\"step.label | translate\"\n      [completed]=\"step.completed\"\n    >\n      <ng-container *ngTemplateOutlet=\"step.templateRef\"></ng-container>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        *ngIf=\"showButtons\"\n        [disabled]=\"step.buttonsDisabled\"\n        (onNext)=\"step.onNext($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n    <!-- STEP N-1 - Data-grid -->\n    <cdk-step [label]=\"'Select target devices' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Select target devices' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <c8y-device-selector\n          [deviceTypes]=\"deviceTypes$\"\n          (onDeviceQueryStringChange)=\"deviceQueryString = $event\"\n        ></c8y-device-selector>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        (onNext)=\"confirmDeviceSelection($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n\n    <!-- STEP N - Scheduler -->\n    <cdk-step [label]=\"'Confirm and schedule bulk operation' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Confirm and schedule bulk operation' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <div class=\"card-inner-scroll fit-v\">\n          <div class=\"card-block p-b-0\">\n            <div class=\"text-center p-b-16\">\n              <c8y-operation-summary\n                [name]=\"operationDetails?.name | translate\"\n                [description]=\"operationDetails?.description | translate\"\n                [deviceQueryString]=\"deviceQueryString\"\n              ></c8y-operation-summary>\n            </div>\n            <div class=\"row\">\n              <div class=\"col-md-4 col-md-offset-4\">\n                <c8y-operation-details\n                  [bulkOperationType]=\"bulkOperationType\"\n                ></c8y-operation-details>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        [labels]=\"stepperButtonsLabels\"\n        [pending]=\"pendingStatus\"\n        [disabled]=\"operationDetailsForm?.invalid\"\n        (onCancel)=\"cancel()\"\n        (onCustom)=\"scheduleBulkOperation()\"\n      >\n      </c8y-stepper-buttons>\n    </cdk-step>\n  </c8y-stepper>\n</div>\n"
        })
    ], BulkOperationStepper);
    return BulkOperationStepper;
}());
export { BulkOperationStepper };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb24tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvIiwic291cmNlcyI6WyJidWxrL2NyZWF0aW9uL2J1bGstb3BlcmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQ0wsU0FBUyxFQUNULGVBQWUsRUFDZixZQUFZLEVBRVosTUFBTSxFQUVOLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlGLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFHdEYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBT3REO0lBd0JFLDhCQUNVLG9CQUEyQyxFQUMzQyxLQUFtQixFQUNuQixLQUFtQjtRQUZuQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXVCO1FBQzNDLFVBQUssR0FBTCxLQUFLLENBQWM7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQTFCbkIsb0JBQWUsR0FBd0MsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU9wRixVQUFLLEdBQWlCLEVBQUUsQ0FBQztRQUN6QixnQkFBVyxHQUFZLEtBQUssQ0FBQztRQUM3QixnQkFBVyxHQUFZLEtBQUssQ0FBQztRQUU3Qix5QkFBb0IsR0FBRyxFQUFFLE1BQU0s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LFNBR0MsQ0FBQzt3QkFDRixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsK0JBQStCLENBQUMsQ0FBQyxDQUFDO3dCQUM3RCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Ozs7d0JBRWIsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFFLENBQUMsQ0FBQzs7O3dCQUdsQyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQzs7Ozs7S0FDNUI7SUFFRCwwQ0FBVyxHQUFYO1FBQ0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRU8sb0NBQUssR0FBYjtRQUNFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLDZCQUE2QixFQUFFLENBQUM7SUFDNUQsQ0FBQzs7Z0JBOUcrQixxQkFBcUI7Z0JBQ3BDLFlBQVk7Z0JBQ1osWUFBWTs7SUExQm5CO1FBQVQsTUFBTSxFQUFFO2lFQUEyRTtJQUN2RDtRQUE1QixlQUFlLENBQUMsVUFBVSxDQUFDOzZEQUFvQztJQUVoRTtRQURDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7eURBQ3JCO0lBRXBCO1FBREMsU0FBUyxDQUFDLHlCQUF5QixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzJFQUNIO0lBTjFDLG9CQUFvQjtRQUpoQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsNEJBQTRCO1lBQ3RDLG80R0FBb0Q7U0FDckQsQ0FBQztPQUNXLG9CQUFvQixDQXdJaEM7SUFBRCwyQkFBQztDQUFBLEFBeElELElBd0lDO1NBeElZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENka1N0ZXAsIFN0ZXBwZXJTZWxlY3Rpb25FdmVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zdGVwcGVyJztcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgQzh5U3RlcHBlciwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGV0YWlscy9vcGVyYXRpb24tZGV0YWlscy5jb21wb25lbnQnO1xuaW1wb3J0IHsgT3BlcmF0aW9uU2NoZWR1bGUgfSBmcm9tICcuLi8uLi9zY2hlZHVsZXIvb3BlcmF0aW9uLXNjaGVkdWxlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4uL2J1bGstb3BlcmF0aW9uLm1vZGVsJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25zU2VydmljZSB9IGZyb20gJy4uL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IEN1c3RvbVN0ZXAgfSBmcm9tICcuLi9jdXN0b20tc3RlcC5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlscyB9IGZyb20gJy4uL29wZXJhdGlvbi1kZXRhaWxzLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWJ1bGstb3BlcmF0aW9uLXN0ZXBwZXInLFxuICB0ZW1wbGF0ZVVybDogJ2J1bGstb3BlcmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25TdGVwcGVyIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgQE91dHB1dCgpIHNlbGVjdGlvbkNoYW5nZTogRXZlbnRFbWl0dGVyPFN0ZXBwZXJTZWxlY3Rpb25FdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBDb250ZW50Q2hpbGRyZW4oQ3VzdG9tU3RlcCkgY3VzdG9tU3RlcHM6IFF1ZXJ5TGlzdDxDdXN0b21TdGVwPjtcbiAgQFZpZXdDaGlsZChDOHlTdGVwcGVyLCB7IHN0YXRpYzogZmFsc2UgfSlcbiAgc3RlcHBlcjogQzh5U3RlcHBlcjtcbiAgQFZpZXdDaGlsZChPcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50LCB7IHN0YXRpYzogZmFsc2UgfSlcbiAgb3BlcmF0aW9uRGV0YWlsc0NvbXBvbmVudDogT3BlcmF0aW9uRGV0YWlsc0NvbXBvbmVudDtcblxuICBzdGVwczogQ3VzdG9tU3RlcFtdID0gW107XG4gIHNob3dTdGVwcGVyOiBib29sZWFuID0gZmFsc2U7XG4gIHNob3dCdXR0b25zOiBib29sZWFuID0gZmFsc2U7XG4gIHBlbmRpbmdTdGF0dXM6IGJvb2xlYW47XG4gIHN0ZXBwZXJCdXR0b25zTGFiZWxzID0geyBjdXN0b206IGdldHRleHQoJ1NjaGVkdWxlIGJ1bGsgb3BlcmF0aW9uJykgfTtcbiAgZGV2aWNlVHlwZXMkOiBPYnNlcnZhYmxlPHN0cmluZ1tdPjtcbiAgZGV2aWNlUXVlcnlTdHJpbmc6IHN0cmluZztcbiAgYnVsa09wZXJhdGlvblR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlO1xuICBzY2hlZHVsZURhdGE6IE9wZXJhdGlvblNjaGVkdWxlO1xuICBvcGVyYXRpb25EZXRhaWxzRm9ybTogRm9ybUdyb3VwO1xuICBvcGVyYXRpb25EZXRhaWxzOiBPcGVyYXRpb25EZXRhaWxzO1xuICByZXRyaWV2ZU9wZXJhdGlvbkRldGFpbHM6ICgpID0+IE9wZXJhdGlvbkRldGFpbHMgfCBQcm9taXNlPE9wZXJhdGlvbkRldGFpbHM+O1xuXG4gIHByaXZhdGUgZGV2aWNlVHlwZXNTdWJqZWN0JDogU3ViamVjdDxzdHJpbmdbXT4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIGVuZFN1YnNjcmlwdGlvbnM6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYnVsa09wZXJhdGlvblNlcnZpY2U6IEJ1bGtPcGVyYXRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIG1vZGFsOiBNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZGV2aWNlVHlwZXMkID0gdGhpcy5kZXZpY2VUeXBlc1N1YmplY3QkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgLy8gd2FpdCBmb3IgdGhlIG5leHQgZXZlbnQgbG9vcCB0dXJuIGFzIGBzdGVwc2AgaGFzIGFscmVhZHkgYmVlbiBjaGVja2VkIGluIHRoaXMgQ0QgY3ljbGVcbiAgICAgIHRoaXMuc3RlcHMgPSB0aGlzLmN1c3RvbVN0ZXBzLnRvQXJyYXkoKTtcbiAgICAgIHRoaXMuc2hvd1N0ZXBwZXIgPSB0cnVlO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIC8vIHBvc3Rwb25lIHJlbmRlcmluZyBvZiBidXR0b25zIGZvciBjdXN0b20gc3RlcHMgdG8gdGhlIHBvaW50IHdoZXJlIGN1c3RvbSBzdGVwcyBoYXZlIGFscmVhZHkgYmVlbiByZW5kZXJlZFxuICAgICAgICB0aGlzLnNob3dCdXR0b25zID0gdHJ1ZTtcbiAgICAgICAgaWYgKHRoaXMuc3RlcHBlcikge1xuICAgICAgICAgIHRoaXMuc3RlcHBlci5zZWxlY3Rpb25DaGFuZ2UucGlwZSh0YWtlVW50aWwodGhpcy5lbmRTdWJzY3JpcHRpb25zKSkuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uQ2hhbmdlLm5leHQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0gPSB0aGlzLm9wZXJhdGlvbkRldGFpbHNDb21wb25lbnQuZmdPcGVyYXRpb25EZXNjcmlwdGlvbjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBjaGFuZ2VEZXZpY2VUeXBlcyhkZXZpY2VUeXBlczogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICBpZiAoZGV2aWNlVHlwZXMpIHtcbiAgICAgIHRoaXMuZGV2aWNlVHlwZXNTdWJqZWN0JC5uZXh0KEFycmF5LmlzQXJyYXkoZGV2aWNlVHlwZXMpID8gZGV2aWNlVHlwZXMgOiBbZGV2aWNlVHlwZXNdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXZpY2VUeXBlc1N1YmplY3QkLm5leHQoW10pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNvbmZpcm1EZXZpY2VTZWxlY3Rpb24oJGV2ZW50OiB7IHN0ZXBwZXI6IEM4eVN0ZXBwZXI7IHN0ZXA6IENka1N0ZXAgfSkge1xuICAgIGlmICghdGhpcy5kZXZpY2VRdWVyeVN0cmluZykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5tb2RhbC5jb25maXJtKFxuICAgICAgICAgIGdldHRleHQoJ0FsbCBkZXZpY2VzIHNlbGVjdGVkJyksXG4gICAgICAgICAgZ2V0dGV4dChcbiAgICAgICAgICAgICdZb3UgYXJlIGFib3V0IHRvIHNjaGVkdWxlIHRoZSBidWxrIG9wZXJhdGlvbiB0byBiZSBleGVjdXRlZCBmb3IgYWxsIGRldmljZXMuIERvIHlvdSB3YW50IHRvIHByb2NlZWQ/J1xuICAgICAgICAgICksXG4gICAgICAgICAgU3RhdHVzLldBUk5JTkcsXG4gICAgICAgICAgeyBvazogZ2V0dGV4dCgnU2NoZWR1bGUgZm9yIGFsbCBkZXZpY2VzJyksIGNhbmNlbDogZ2V0dGV4dCgnQ2FuY2VsIGFuZCBzZWxlY3QgZGV2aWNlcycpIH1cbiAgICAgICAgKTtcbiAgICAgICAgJGV2ZW50LnN0ZXAuY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgJGV2ZW50LnN0ZXBwZXIubmV4dCgpO1xuICAgICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHMgPSB0aGlzLnJldHJpZXZlT3BlcmF0aW9uRGV0YWlsc1xuICAgICAgICAgID8gYXdhaXQgdGhpcy5yZXRyaWV2ZU9wZXJhdGlvbkRldGFpbHMoKVxuICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgLy8gSW50ZW50aW9uYWxseSBlbXB0eVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAkZXZlbnQuc3RlcC5jb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgJGV2ZW50LnN0ZXBwZXIubmV4dCgpO1xuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzID0gdGhpcy5yZXRyaWV2ZU9wZXJhdGlvbkRldGFpbHNcbiAgICAgICAgPyBhd2FpdCB0aGlzLnJldHJpZXZlT3BlcmF0aW9uRGV0YWlscygpXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHRoaXMuYnVsa09wZXJhdGlvblR5cGUgPSB0aGlzLmJ1bGtPcGVyYXRpb25TZXJ2aWNlLnJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUoXG4gICAgICBnZXQodGhpcy5vcGVyYXRpb25EZXRhaWxzLCAncHJvdG90eXBlJylcbiAgICApO1xuICAgIGlmIChcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0gJiZcbiAgICAgIGdldCh0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtLCAnY29udHJvbHMuZGVzY3JpcHRpb24ucHJpc3RpbmUnKSAmJlxuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzXG4gICAgKSB7XG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtLnBhdGNoVmFsdWUoe1xuICAgICAgICBkZXNjcmlwdGlvbjogZ2V0KHRoaXMub3BlcmF0aW9uRGV0YWlscywgJ3Byb3RvdHlwZS5kZXNjcmlwdGlvbicpXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjYW5jZWwoKSB7XG4gICAgdGhpcy5jbG9zZSgpO1xuICB9XG5cbiAgYXN5bmMgc2NoZWR1bGVCdWxrT3BlcmF0aW9uKCkge1xuICAgIHRoaXMucGVuZGluZ1N0YXR1cyA9IHRydWU7XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzLnByb3RvdHlwZS5kZXNjcmlwdGlvbiA9IGdldChcbiAgICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSxcbiAgICAgICAgJ2NvbnRyb2xzLmRlc2NyaXB0aW9uLnZhbHVlJ1xuICAgICAgKTtcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlscy5ub3RlID0gZ2V0KHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0sICdjb250cm9scy5ub3RlLnZhbHVlJyk7XG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHMuc2NoZWR1bGUgPSBnZXQodGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSwgJ2NvbnRyb2xzLnNjaGVkdWxlLnZhbHVlJyk7XG5cbiAgICAgIGF3YWl0IHRoaXMuYnVsa09wZXJhdGlvblNlcnZpY2Uuc2NoZWR1bGVCdWxrT3BlcmF0aW9uKFxuICAgICAgICB0aGlzLmRldmljZVF1ZXJ5U3RyaW5nLFxuICAgICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNcbiAgICAgICk7XG4gICAgICB0aGlzLmFsZXJ0LnN1Y2Nlc3MoZ2V0dGV4dCgnTmV3IGJ1bGsgb3BlcmF0aW9uIHNjaGVkdWxlZC4nKSk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nU3RhdHVzID0gZmFsc2U7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmVuZFN1YnNjcmlwdGlvbnMubmV4dCgpO1xuICAgIHRoaXMuZW5kU3Vic2NyaXB0aW9ucy5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbG9zZSgpIHtcbiAgICB0aGlzLnN0ZXBwZXIucmVzZXQoKTtcbiAgICB0aGlzLmJ1bGtPcGVyYXRpb25TZXJ2aWNlLnJldHVyblRvQnVsa09wZXJhdGlvbk92ZXJ2aWV3KCk7XG4gIH1cbn1cbiJdfQ==