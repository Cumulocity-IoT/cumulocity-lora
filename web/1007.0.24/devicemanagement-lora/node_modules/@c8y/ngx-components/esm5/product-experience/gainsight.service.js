import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { combineLatest, fromEvent, BehaviorSubject } from 'rxjs';
import { filter, delay, map, take } from 'rxjs/operators';
import { AppStateService, OptionsService } from '@c8y/ngx-components';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
/**
 * A service to manage the Gainsight integration. It allows to load the
 * tag and
 */
var GainsightService = /** @class */ (function () {
    function GainsightService(appState, options) {
        this.appState = appState;
        this.options = options;
        /**
         * A subject that emits the tag function as soon as a new tag is set.
         */
        this.tagFunction$ = new BehaviorSubject(null);
        this.GAINSIGHT_URL = 'web-sdk.aptrinsic.com/api/aptrinsic.js?a=';
        this.GAINSIGHT_GLOBAL_SCOPE = 'aptrinsic';
        this.SCRIPT_EXECUTION_WAIT_TIME = 500;
        this.OPTIONS_KEY_CATEGORY = 'gainsight';
        this.OPTIONS_KEY_NAME = 'api.key';
    }
    Object.defineProperty(GainsightService.prototype, "tagFunction", {
        /**
         * Returns the tag global function which can be used to identify user
         * or add special events.
         */
        get: function () {
            return window[this.GAINSIGHT_GLOBAL_SCOPE];
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Load the script tag and calls the identify function to start the tracking.
     * @param accountId The account where the user is registered. Could be the name of the tenant.
     * @param identify If set to false, only the tag is loaded.
     */
    GainsightService.prototype.loadTag = function (accountId, identify) {
        if (identify === void 0) { identify = true; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var scriptTag, key, _a;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        scriptTag = document.createElement('script');
                        _a = this.options.gainsightKey;
                        if (_a) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.options.getSystemOption(this.OPTIONS_KEY_CATEGORY, this.OPTIONS_KEY_NAME)];
                    case 1:
                        _a = (_b.sent());
                        _b.label = 2;
                    case 2:
                        key = _a;
                        if (key) {
                            this.loadScriptTag(scriptTag, key);
                            combineLatest(this.appState.currentUser, fromEvent(scriptTag, 'load'), this.appState.state$.pipe(filter(function (_a) {
                                var versions = _a.versions;
                                return versions.backend;
                            }), map(function (_a) {
                                var versions = _a.versions;
                                return versions;
                            }), take(1)))
                                .pipe(delay(this.SCRIPT_EXECUTION_WAIT_TIME), filter(function (_a) {
                                var _b = tslib_1.__read(_a, 2), user = _b[0], scriptEvent = _b[1];
                                return !!(scriptEvent && user);
                            }))
                                .subscribe(function (_a) {
                                var _b = tslib_1.__read(_a, 3), user = _b[0], scriptEvent = _b[1], versions = _b[2];
                                var instanceId = _this.getInstanceIdFromUrl();
                                if (identify) {
                                    _this.identify(user.id, accountId, instanceId, versions.ui.ngx, versions.backend);
                                }
                                _this.tagFunction$.next(_this.tagFunction);
                            });
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Identifies the user/account at Gainsight.
     * @param userId The user id which is given to Gainsight.
     * @param accountId The account id which is given to Gainsight (e.g. the tenant name)
     * @param versionUI The UI version used.
     * @param versionBE The BE version used.
     */
    GainsightService.prototype.identify = function (userId, accountId, instanceId, versionUI, versionBE) {
        var windowRef = window;
        windowRef[this.GAINSIGHT_GLOBAL_SCOPE]('identify', {
            id: userId + "_" + accountId + "_" + instanceId,
            versionUI: versionUI,
            versionBE: versionBE,
            instanceId: instanceId
        }, {
            id: accountId + "_" + instanceId,
            instanceId: instanceId
        });
    };
    GainsightService.prototype.loadScriptTag = function (scriptTag, key) {
        try {
            var windowRef_1 = window;
            var firstTag = document.getElementsByTagName('script')[0];
            var protocol = location.protocol;
            var gainsightGlobalScope_1 = this.GAINSIGHT_GLOBAL_SCOPE;
            scriptTag.src = protocol + "//" + this.GAINSIGHT_URL + key;
            (windowRef_1[this.GAINSIGHT_GLOBAL_SCOPE] =
                windowRef_1[this.GAINSIGHT_GLOBAL_SCOPE] ||
                    // tslint:disable-next-line:only-arrow-functions
                    function () {
                        (windowRef_1[gainsightGlobalScope_1].q = windowRef_1[gainsightGlobalScope_1].q || []).push(arguments);
                    }),
                (windowRef_1[gainsightGlobalScope_1].p = key);
            scriptTag.async = true;
            firstTag.parentNode.insertBefore(scriptTag, firstTag);
        }
        catch (ex) {
            console.warn('Failed to load Gainsight PX', ex);
        }
    };
    GainsightService.prototype.getInstanceIdFromUrl = function () {
        var hostName = location.hostname;
        return hostName.substring(hostName.indexOf('.') + 1);
    };
    GainsightService.ctorParameters = function () { return [
        { type: AppStateService },
        { type: OptionsService }
    ]; };
    GainsightService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function GainsightService_Factory() { return new GainsightService(i0.ɵɵinject(i1.AppStateService), i0.ɵɵinject(i1.OptionsService)); }, token: GainsightService, providedIn: "root" });
    GainsightService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        })
    ], GainsightService);
    return GainsightService;
}());
export { GainsightService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FpbnNpZ2h0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3Byb2R1Y3QtZXhwZXJpZW5jZS8iLCJzb3VyY2VzIjpbImdhaW5zaWdodC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7O0FBRXRFOzs7R0FHRztBQUlIO0lBWUUsMEJBQW9CLFFBQXlCLEVBQVUsT0FBdUI7UUFBMUQsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQVg5RTs7V0FFRztRQUNILGlCQUFZLEdBQUcsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEIsa0JBQWEsR0FBRywyQ0FBMkMsQ0FBQztRQUM1RCwyQkFBc0IsR0FBRyxXQUFXLENBQUM7UUFDckMsK0JBQTBCLEdBQUcsR0FBRyxDQUFDO1FBQ2pDLHlCQUFvQixHQUFHLFdBQVcsQ0FBQztRQUNuQyxxQkFBZ0IsR0FBRyxTQUFTLENBQUM7SUFFbUMsQ0FBQztJQU1sRixzQkFBSSx5Q0FBVztRQUpmOzs7V0FHRzthQUNIO1lBQ0UsT0FBUSxNQUFjLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDdEQsQ0FBQzs7O09BQUE7SUFFRDs7OztPQUlHO0lBQ0csa0NBQU8sR0FBYixVQUFjLFNBQVMsRUFBRSxRQUFlO1FBQWYseUJBQUEsRUFBQSxlQUFlOzs7Ozs7O3dCQUNoQyxTQUFTLEdBQUcsUUFBUSxD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O1lBQzNELENBQUMsV0FBUyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztnQkFDckMsV0FBUyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztvQkFDdEMsZ0RBQWdEO29CQUNoRDt3QkFDRSxDQUFDLFdBQVMsQ0FBQyxzQkFBb0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxXQUFTLENBQUMsc0JBQW9CLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNoRixTQUFTLENBQ1YsQ0FBQztvQkFDSixDQUFDLENBQUM7Z0JBQ0YsQ0FBQyxXQUFTLENBQUMsc0JBQW9CLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDNUMsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDdkIsUUFBUSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZEO1FBQUMsT0FBTyxFQUFFLEVBQUU7WUFDWCxPQUFPLENBQUMsSUFBSSxDQUFDLDZCQUE2QixFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ2pEO0lBQ0gsQ0FBQztJQUVPLCtDQUFvQixHQUE1QjtRQUNFLElBQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDbkMsT0FBTyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQzs7Z0JBaEc2QixlQUFlO2dCQUFtQixjQUFjOzs7SUFabkUsZ0JBQWdCO1FBSDVCLFVBQVUsQ0FBQztZQUNWLFVBQVUsRUFBRSxNQUFNO1NBQ25CLENBQUM7T0FDVyxnQkFBZ0IsQ0E2RzVCOzJCQXpIRDtDQXlIQyxBQTdHRCxJQTZHQztTQTdHWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBmcm9tRXZlbnQsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBkZWxheSwgbWFwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlLCBPcHRpb25zU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG4vKipcbiAqIEEgc2VydmljZSB0byBtYW5hZ2UgdGhlIEdhaW5zaWdodCBpbnRlZ3JhdGlvbi4gSXQgYWxsb3dzIHRvIGxvYWQgdGhlXG4gKiB0YWcgYW5kXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEdhaW5zaWdodFNlcnZpY2Uge1xuICAvKipcbiAgICogQSBzdWJqZWN0IHRoYXQgZW1pdHMgdGhlIHRhZyBmdW5jdGlvbiBhcyBzb29uIGFzIGEgbmV3IHRhZyBpcyBzZXQuXG4gICAqL1xuICB0YWdGdW5jdGlvbiQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgR0FJTlNJR0hUX1VSTCA9ICd3ZWItc2RrLmFwdHJpbnNpYy5jb20vYXBpL2FwdHJpbnNpYy5qcz9hPSc7XG4gIHByaXZhdGUgcmVhZG9ubHkgR0FJTlNJR0hUX0dMT0JBTF9TQ09QRSA9ICdhcHRyaW5zaWMnO1xuICBwcml2YXRlIHJlYWRvbmx5IFNDUklQVF9FWEVDVVRJT05fV0FJVF9USU1FID0gNTAwO1xuICBwcml2YXRlIHJlYWRvbmx5IE9QVElPTlNfS0VZX0NBVEVHT1JZID0gJ2dhaW5zaWdodCc7XG4gIHByaXZhdGUgcmVhZG9ubHkgT1BUSU9OU19LRVlfTkFNRSA9ICdhcGkua2V5JztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcFN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsIHByaXZhdGUgb3B0aW9uczogT3B0aW9uc1NlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHRhZyBnbG9iYWwgZnVuY3Rpb24gd2hpY2ggY2FuIGJlIHVzZWQgdG8gaWRlbnRpZnkgdXNlclxuICAgKiBvciBhZGQgc3BlY2lhbCBldmVudHMuXG4gICAqL1xuICBnZXQgdGFnRnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuICh3aW5kb3cgYXMgYW55KVt0aGlzLkdBSU5TSUdIVF9HTE9CQUxfU0NPUEVdO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgdGhlIHNjcmlwdCB0YWcgYW5kIGNhbGxzIHRoZSBpZGVudGlmeSBmdW5jdGlvbiB0byBzdGFydCB0aGUgdHJhY2tpbmcuXG4gICAqIEBwYXJhbSBhY2NvdW50SWQgVGhlIGFjY291bnQgd2hlcmUgdGhlIHVzZXIgaXMgcmVnaXN0ZXJlZC4gQ291bGQgYmUgdGhlIG5hbWUgb2YgdGhlIHRlbmFudC5cbiAgICogQHBhcmFtIGlkZW50aWZ5IElmIHNldCB0byBmYWxzZSwgb25seSB0aGUgdGFnIGlzIGxvYWRlZC5cbiAgICovXG4gIGFzeW5jIGxvYWRUYWcoYWNjb3VudElkLCBpZGVudGlmeSA9IHRydWUpIHtcbiAgICBjb25zdCBzY3JpcHRUYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBjb25zdCBrZXkgPVxuICAgICAgdGhpcy5vcHRpb25zLmdhaW5zaWdodEtleSB8fFxuICAgICAgKGF3YWl0IHRoaXMub3B0aW9ucy5nZXRTeXN0ZW1PcHRpb24odGhpcy5PUFRJT05TX0tFWV9DQVRFR09SWSwgdGhpcy5PUFRJT05TX0tFWV9OQU1FKSk7XG5cbiAgICBpZiAoa2V5KSB7XG4gICAgICB0aGlzLmxvYWRTY3JpcHRUYWcoc2NyaXB0VGFnLCBrZXkpO1xuICAgICAgY29tYmluZUxhdGVzdChcbiAgICAgICAgdGhpcy5hcHBTdGF0ZS5jdXJyZW50VXNlcixcbiAgICAgICAgZnJvbUV2ZW50KHNjcmlwdFRhZywgJ2xvYWQnKSxcbiAgICAgICAgdGhpcy5hcHBTdGF0ZS5zdGF0ZSQucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKHsgdmVyc2lvbnMgfSkgPT4gdmVyc2lvbnMuYmFja2VuZCksXG4gICAgICAgICAgbWFwKCh7IHZlcnNpb25zIH0pID0+IHZlcnNpb25zKSxcbiAgICAgICAgICB0YWtlKDEpXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZGVsYXkodGhpcy5TQ1JJUFRfRVhFQ1VUSU9OX1dBSVRfVElNRSksXG4gICAgICAgICAgZmlsdGVyKChbdXNlciwgc2NyaXB0RXZlbnRdKSA9PiAhIShzY3JpcHRFdmVudCAmJiB1c2VyKSlcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKChbdXNlciwgc2NyaXB0RXZlbnQsIHZlcnNpb25zXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGluc3RhbmNlSWQgPSB0aGlzLmdldEluc3RhbmNlSWRGcm9tVXJsKCk7XG4gICAgICAgICAgaWYgKGlkZW50aWZ5KSB7XG4gICAgICAgICAgICB0aGlzLmlkZW50aWZ5KHVzZXIuaWQsIGFjY291bnRJZCwgaW5zdGFuY2VJZCwgdmVyc2lvbnMudWkubmd4LCB2ZXJzaW9ucy5iYWNrZW5kKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy50YWdGdW5jdGlvbiQubmV4dCh0aGlzLnRhZ0Z1bmN0aW9uKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIElkZW50aWZpZXMgdGhlIHVzZXIvYWNjb3VudCBhdCBHYWluc2lnaHQuXG4gICAqIEBwYXJhbSB1c2VySWQgVGhlIHVzZXIgaWQgd2hpY2ggaXMgZ2l2ZW4gdG8gR2FpbnNpZ2h0LlxuICAgKiBAcGFyYW0gYWNjb3VudElkIFRoZSBhY2NvdW50IGlkIHdoaWNoIGlzIGdpdmVuIHRvIEdhaW5zaWdodCAoZS5nLiB0aGUgdGVuYW50IG5hbWUpXG4gICAqIEBwYXJhbSB2ZXJzaW9uVUkgVGhlIFVJIHZlcnNpb24gdXNlZC5cbiAgICogQHBhcmFtIHZlcnNpb25CRSBUaGUgQkUgdmVyc2lvbiB1c2VkLlxuICAgKi9cbiAgaWRlbnRpZnkodXNlcklkLCBhY2NvdW50SWQsIGluc3RhbmNlSWQsIHZlcnNpb25VST8sIHZlcnNpb25CRT8pIHtcbiAgICBjb25zdCB3aW5kb3dSZWYgPSB3aW5kb3cgYXMgYW55O1xuICAgIHdpbmRvd1JlZlt0aGlzLkdBSU5TSUdIVF9HTE9CQUxfU0NPUEVdKFxuICAgICAgJ2lkZW50aWZ5JyxcbiAgICAgIHtcbiAgICAgICAgaWQ6IGAke3VzZXJJZH1fJHthY2NvdW50SWR9XyR7aW5zdGFuY2VJZH1gLFxuICAgICAgICB2ZXJzaW9uVUksXG4gICAgICAgIHZlcnNpb25CRSxcbiAgICAgICAgaW5zdGFuY2VJZFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgaWQ6IGAke2FjY291bnRJZH1fJHtpbnN0YW5jZUlkfWAsXG4gICAgICAgIGluc3RhbmNlSWRcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkU2NyaXB0VGFnKHNjcmlwdFRhZzogSFRNTFNjcmlwdEVsZW1lbnQsIGtleTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdpbmRvd1JlZiA9IHdpbmRvdyBhcyBhbnk7XG4gICAgICBjb25zdCBmaXJzdFRhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTtcbiAgICAgIGNvbnN0IHByb3RvY29sID0gbG9jYXRpb24ucHJvdG9jb2w7XG4gICAgICBjb25zdCBnYWluc2lnaHRHbG9iYWxTY29wZSA9IHRoaXMuR0FJTlNJR0hUX0dMT0JBTF9TQ09QRTtcbiAgICAgIHNjcmlwdFRhZy5zcmMgPSBgJHtwcm90b2NvbH0vLyR7dGhpcy5HQUlOU0lHSFRfVVJMfSR7a2V5fWA7XG4gICAgICAod2luZG93UmVmW3RoaXMuR0FJTlNJR0hUX0dMT0JBTF9TQ09QRV0gPVxuICAgICAgICB3aW5kb3dSZWZbdGhpcy5HQUlOU0lHSFRfR0xPQkFMX1NDT1BFXSB8fFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgKHdpbmRvd1JlZltnYWluc2lnaHRHbG9iYWxTY29wZV0ucSA9IHdpbmRvd1JlZltnYWluc2lnaHRHbG9iYWxTY29wZV0ucSB8fCBbXSkucHVzaChcbiAgICAgICAgICAgIGFyZ3VtZW50c1xuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICAod2luZG93UmVmW2dhaW5zaWdodEdsb2JhbFNjb3BlXS5wID0ga2V5KTtcbiAgICAgIHNjcmlwdFRhZy5hc3luYyA9IHRydWU7XG4gICAgICBmaXJzdFRhZy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShzY3JpcHRUYWcsIGZpcnN0VGFnKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gbG9hZCBHYWluc2lnaHQgUFgnLCBleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRJbnN0YW5jZUlkRnJvbVVybCgpIHtcbiAgICBjb25zdCBob3N0TmFtZSA9IGxvY2F0aW9uLmhvc3RuYW1lO1xuICAgIHJldHVybiBob3N0TmFtZS5zdWJzdHJpbmcoaG9zdE5hbWUuaW5kZXhPZignLicpICsgMSk7XG4gIH1cbn1cbiJdfQ==