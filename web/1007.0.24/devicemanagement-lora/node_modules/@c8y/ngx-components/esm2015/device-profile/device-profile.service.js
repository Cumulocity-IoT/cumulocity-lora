import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IManagedObject, InventoryService, IOperation, IResultList, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService } from '@c8y/ngx-components';
import { sortBy, toArray, get } from 'lodash-es';
let DeviceProfileService = class DeviceProfileService {
    constructor(inventoryService, operationService, alertService) {
        this.inventoryService = inventoryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.queriesUtil = new QueriesUtil();
    }
    createDeviceProfile(deviceProfile) {
        return this.inventoryService.create(deviceProfile);
    }
    getDeviceProfilesByDeviceType(deviceType) {
        const deviceTypeFilter = {
            __or: [{ 'c8y_Filter.type': deviceType }, { __not: { __has: 'c8y_Filter.type' } }]
        };
        return this.getDeviceProfiles(deviceTypeFilter);
    }
    getDeviceProfiles(andQuery) {
        let query = {
            type: 'c8y_Profile'
        };
        const filter = {
            pageSize: 100,
            withTotalPages: true
        };
        query = this.queriesUtil.addAndFilter(query, andQuery || {});
        return this.inventoryService.listQuery(query, filter);
    }
    getProfileOperation(deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filter = {
                deviceId,
                fragmentType: 'c8y_DeviceProfile',
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 1
            };
            const operation = (yield this.operationService.list(filter)).data[0];
            return operation && operation.status !== OperationStatus.SUCCESSFUL ? operation : undefined;
        });
    }
    createProfileOperation(device, deviceProfile) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let operation;
            const operationCfg = {
                deviceId: device.id,
                profileId: deviceProfile.id,
                profileName: deviceProfile.name,
                c8y_DeviceProfile: deviceProfile.c8y_DeviceProfile,
                description: `Assign device profile ${deviceProfile.name} to device ${device.name}`
            };
            try {
                const { data } = yield this.operationService.create(operationCfg);
                operation = data;
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return operation;
        });
    }
    getFirmwareItems(device, selectedProfile) {
        const deviceFirmware = device.c8y_Firmware;
        const profileFirmware = get(selectedProfile, 'c8y_DeviceProfile.firmware');
        const deviceItems = [];
        const profileItems = [];
        if (deviceFirmware) {
            deviceItems.push(deviceFirmware);
        }
        if (profileFirmware) {
            profileItems.push(profileFirmware);
        }
        return this.createProfileComparison(deviceItems, profileItems, 'version');
    }
    getSoftwareItems(device, selectedProfile) {
        const deviceSoftware = device.c8y_SoftwareList;
        const profileSoftware = get(selectedProfile, 'c8y_DeviceProfile.software');
        return this.createProfileComparison(deviceSoftware, profileSoftware, 'version');
    }
    getConfigurationItems(device, selectedProfile) {
        const deviceConfiguration = [];
        Object.keys(device).forEach(key => {
            if (key.slice(0, 18) === 'c8y_Configuration_') {
                deviceConfiguration.push(device[key]);
            }
        });
        const profileConfiguration = get(selectedProfile, 'c8y_DeviceProfile.configuration');
        return this.createProfileComparison(deviceConfiguration, profileConfiguration, 'type');
    }
    createProfileComparison(deviceItems = [], profileItems = [], propToCompare) {
        const comparisonObj = this.createProfileComparisonFromDeviceItems(deviceItems, propToCompare);
        const extendedComparisonObj = this.extendProfileComparisonWithProfileItems(comparisonObj, profileItems, propToCompare);
        return sortBy(toArray(extendedComparisonObj), 'name');
    }
    createProfileComparisonFromDeviceItems(deviceItems, propToCompare) {
        const deviceItemsObject = {};
        deviceItems.forEach(item => {
            Object.assign(deviceItemsObject, {
                [item.name]: {
                    name: item.name,
                    profileVersion: undefined,
                    deviceVersion: item[propToCompare]
                }
            });
        });
        return deviceItemsObject;
    }
    extendProfileComparisonWithProfileItems(comparisonObj, profileItems, propToCompare) {
        profileItems.forEach(item => {
            if (comparisonObj[item.name]) {
                comparisonObj[item.name].profileVersion = item[propToCompare];
            }
            else {
                Object.assign(comparisonObj, {
                    [item.name]: {
                        name: item.name,
                        profileVersion: item[propToCompare],
                        deviceVersion: undefined
                    }
                });
            }
        });
        return comparisonObj;
    }
};
DeviceProfileService.ctorParameters = () => [
    { type: InventoryService },
    { type: OperationService },
    { type: AlertService }
];
DeviceProfileService = tslib_1.__decorate([
    Injectable()
], DeviceProfileService);
export { DeviceProfileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLXByb2ZpbGUvIiwic291cmNlcyI6WyJkZXZpY2UtcHJvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDZixXQUFXLEVBQ1osTUFBTSxhQUFhLENBQUM7QUFPckIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUdqRCxJQUFhLG9CQUFvQixHQUFqQyxNQUFhLG9CQUFvQjtJQUsvQixZQUNVLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsWUFBMEI7UUFGMUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUDNCLGFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixXQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsc0JBQXNCO1FBUXZFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRUQsbUJBQW1CLENBQUMsYUFBcUM7UUFDdkQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLGFBQStCLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsNkJBQTZCLENBQUMsVUFBa0I7UUFDOUMsTUFB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QUFDO0lBQ3ZCLENBQUM7Q0FDRixDQUFBOztZQWpKNkIsZ0JBQWdCO1lBQ2hCLGdCQUFnQjtZQUNwQixZQUFZOztBQVJ6QixvQkFBb0I7SUFEaEMsVUFBVSxFQUFFO0dBQ0Esb0JBQW9CLENBdUpoQztTQXZKWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgSVJlc3VsdExpc3QsXG4gIE9wZXJhdGlvblNlcnZpY2UsXG4gIE9wZXJhdGlvblN0YXR1cyxcbiAgUXVlcmllc1V0aWxcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgRGV2aWNlUHJvZmlsZSxcbiAgRGV2aWNlUHJvZmlsZUZpcm13YXJlLFxuICBEZXZpY2VQcm9maWxlU29mdHdhcmUsXG4gIFByb2ZpbGVJdGVtXG59IGZyb20gJy4vZGV2aWNlLXByb2ZpbGUubW9kZWwnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBzb3J0QnksIHRvQXJyYXksIGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEZXZpY2VQcm9maWxlU2VydmljZSB7XG4gIHJlYWRvbmx5IGRhdGVGcm9tID0gbmV3IERhdGUoMCk7XG4gIHJlYWRvbmx5IGRhdGVUbyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyA4NjQwMDAwMCk7IC8vIDEgZGF5IGluIHRoZSBmdXR1cmVcbiAgcHJpdmF0ZSBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgfVxuXG4gIGNyZWF0ZURldmljZVByb2ZpbGUoZGV2aWNlUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPikge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGRldmljZVByb2ZpbGUgYXMgSU1hbmFnZWRPYmplY3QpO1xuICB9XG5cbiAgZ2V0RGV2aWNlUHJvZmlsZXNCeURldmljZVR5cGUoZGV2aWNlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBkZXZpY2VUeXBlRmlsdGVyID0ge1xuICAgICAgX19vcjogW3sgJ2M4eV9GaWx0ZXIudHlwZSc6IGRldmljZVR5cGUgfSwgeyBfX25vdDogeyBfX2hhczogJ2M4eV9GaWx0ZXIudHlwZScgfSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlUHJvZmlsZXMoZGV2aWNlVHlwZUZpbHRlcik7XG4gIH1cblxuICBnZXREZXZpY2VQcm9maWxlcyhhbmRRdWVyeT86IGFueSk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgbGV0IHF1ZXJ5OiBvYmplY3QgPSB7XG4gICAgICB0eXBlOiAnYzh5X1Byb2ZpbGUnXG4gICAgfTtcbiAgICBjb25zdCBmaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIHBhZ2VTaXplOiAxMDAsXG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgIH07XG4gICAgcXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihxdWVyeSwgYW5kUXVlcnkgfHwge30pO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXIpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJvZmlsZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgY29uc3QgZmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGZyYWdtZW50VHlwZTogJ2M4eV9EZXZpY2VQcm9maWxlJyxcbiAgICAgIGRhdGVGcm9tOiB0aGlzLmRhdGVGcm9tLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IHRoaXMuZGF0ZVRvLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG5cbiAgICBjb25zdCBvcGVyYXRpb24gPSAoYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKSkuZGF0YVswXTtcbiAgICByZXR1cm4gb3BlcmF0aW9uICYmIG9wZXJhdGlvbi5zdGF0dXMgIT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMID8gb3BlcmF0aW9uIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlUHJvZmlsZU9wZXJhdGlvbihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBkZXZpY2VQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KSB7XG4gICAgbGV0IG9wZXJhdGlvbjtcbiAgICBjb25zdCBvcGVyYXRpb25DZmc6IElPcGVyYXRpb24gPSB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgcHJvZmlsZUlkOiBkZXZpY2VQcm9maWxlLmlkLFxuICAgICAgcHJvZmlsZU5hbWU6IGRldmljZVByb2ZpbGUubmFtZSxcbiAgICAgIGM4eV9EZXZpY2VQcm9maWxlOiBkZXZpY2VQcm9maWxlLmM4eV9EZXZpY2VQcm9maWxlLFxuICAgICAgZGVzY3JpcHRpb246IGBBc3NpZ24gZGV2aWNlIHByb2ZpbGUgJHtkZXZpY2VQcm9maWxlLm5hbWV9IHRvIGRldmljZSAke2RldmljZS5uYW1lfWBcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uQ2ZnKTtcbiAgICAgIG9wZXJhdGlvbiA9IGRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG5cbiAgZ2V0RmlybXdhcmVJdGVtcyhkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBzZWxlY3RlZFByb2ZpbGU6IFBhcnRpYWw8RGV2aWNlUHJvZmlsZT4pOiBQcm9maWxlSXRlbVtdIHtcbiAgICBjb25zdCBkZXZpY2VGaXJtd2FyZSA9IGRldmljZS5jOHlfRmlybXdhcmU7XG4gICAgY29uc3QgcHJvZmlsZUZpcm13YXJlID0gZ2V0KHNlbGVjdGVkUHJvZmlsZSwgJ2M4eV9EZXZpY2VQcm9maWxlLmZpcm13YXJlJyk7XG4gICAgY29uc3QgZGV2aWNlSXRlbXMgPSBbXTtcbiAgICBjb25zdCBwcm9maWxlSXRlbXMgPSBbXTtcblxuICAgIGlmIChkZXZpY2VGaXJtd2FyZSkge1xuICAgICAgZGV2aWNlSXRlbXMucHVzaChkZXZpY2VGaXJtd2FyZSk7XG4gICAgfVxuICAgIGlmIChwcm9maWxlRmlybXdhcmUpIHtcbiAgICAgIHByb2ZpbGVJdGVtcy5wdXNoKHByb2ZpbGVGaXJtd2FyZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uKGRldmljZUl0ZW1zLCBwcm9maWxlSXRlbXMsICd2ZXJzaW9uJyk7XG4gIH1cblxuICBnZXRTb2Z0d2FyZUl0ZW1zKGRldmljZTogSU1hbmFnZWRPYmplY3QsIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPik6IFByb2ZpbGVJdGVtW10ge1xuICAgIGNvbnN0IGRldmljZVNvZnR3YXJlID0gZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3Q7XG4gICAgY29uc3QgcHJvZmlsZVNvZnR3YXJlID0gZ2V0KHNlbGVjdGVkUHJvZmlsZSwgJ2M4eV9EZXZpY2VQcm9maWxlLnNvZnR3YXJlJyk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oZGV2aWNlU29mdHdhcmUsIHByb2ZpbGVTb2Z0d2FyZSwgJ3ZlcnNpb24nKTtcbiAgfVxuXG4gIGdldENvbmZpZ3VyYXRpb25JdGVtcyhcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPlxuICApOiBQcm9maWxlSXRlbVtdIHtcbiAgICBjb25zdCBkZXZpY2VDb25maWd1cmF0aW9uID0gW107XG4gICAgT2JqZWN0LmtleXMoZGV2aWNlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAoa2V5LnNsaWNlKDAsIDE4KSA9PT0gJ2M4eV9Db25maWd1cmF0aW9uXycpIHtcbiAgICAgICAgZGV2aWNlQ29uZmlndXJhdGlvbi5wdXNoKGRldmljZVtrZXldKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBwcm9maWxlQ29uZmlndXJhdGlvbiA9IGdldChzZWxlY3RlZFByb2ZpbGUsICdjOHlfRGV2aWNlUHJvZmlsZS5jb25maWd1cmF0aW9uJyk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oZGV2aWNlQ29uZmlndXJhdGlvbiwgcHJvZmlsZUNvbmZpZ3VyYXRpb24sICd0eXBlJyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVByb2ZpbGVDb21wYXJpc29uKFxuICAgIGRldmljZUl0ZW1zOiBhbnlbXSA9IFtdLFxuICAgIHByb2ZpbGVJdGVtczogQXJyYXk8RGV2aWNlUHJvZmlsZVNvZnR3YXJlIHwgRGV2aWNlUHJvZmlsZUZpcm13YXJlPiA9IFtdLFxuICAgIHByb3BUb0NvbXBhcmU6IHN0cmluZ1xuICApOiBQcm9maWxlSXRlbVtdIHtcbiAgICBjb25zdCBjb21wYXJpc29uT2JqID0gdGhpcy5jcmVhdGVQcm9maWxlQ29tcGFyaXNvbkZyb21EZXZpY2VJdGVtcyhkZXZpY2VJdGVtcywgcHJvcFRvQ29tcGFyZSk7XG4gICAgY29uc3QgZXh0ZW5kZWRDb21wYXJpc29uT2JqID0gdGhpcy5leHRlbmRQcm9maWxlQ29tcGFyaXNvbldpdGhQcm9maWxlSXRlbXMoXG4gICAgICBjb21wYXJpc29uT2JqLFxuICAgICAgcHJvZmlsZUl0ZW1zLFxuICAgICAgcHJvcFRvQ29tcGFyZVxuICAgICk7XG4gICAgcmV0dXJuIHNvcnRCeSh0b0FycmF5KGV4dGVuZGVkQ29tcGFyaXNvbk9iaiksICduYW1lJyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVByb2ZpbGVDb21wYXJpc29uRnJvbURldmljZUl0ZW1zKGRldmljZUl0ZW1zOiBhbnlbXSwgcHJvcFRvQ29tcGFyZTogc3RyaW5nKSB7XG4gICAgY29uc3QgZGV2aWNlSXRlbXNPYmplY3QgPSB7fTtcbiAgICBkZXZpY2VJdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgT2JqZWN0LmFzc2lnbihkZXZpY2VJdGVtc09iamVjdCwge1xuICAgICAgICBbaXRlbS5uYW1lXToge1xuICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgICAgICBwcm9maWxlVmVyc2lvbjogdW5kZWZpbmVkLFxuICAgICAgICAgIGRldmljZVZlcnNpb246IGl0ZW1bcHJvcFRvQ29tcGFyZV1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRldmljZUl0ZW1zT2JqZWN0O1xuICB9XG5cbiAgcHJpdmF0ZSBleHRlbmRQcm9maWxlQ29tcGFyaXNvbldpdGhQcm9maWxlSXRlbXMoXG4gICAgY29tcGFyaXNvbk9iajogb2JqZWN0LFxuICAgIHByb2ZpbGVJdGVtczogQXJyYXk8RGV2aWNlUHJvZmlsZVNvZnR3YXJlIHwgRGV2aWNlUHJvZmlsZUZpcm13YXJlPixcbiAgICBwcm9wVG9Db21wYXJlOiBzdHJpbmdcbiAgKSB7XG4gICAgcHJvZmlsZUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAoY29tcGFyaXNvbk9ialtpdGVtLm5hbWVdKSB7XG4gICAgICAgIGNvbXBhcmlzb25PYmpbaXRlbS5uYW1lXS5wcm9maWxlVmVyc2lvbiA9IGl0ZW1bcHJvcFRvQ29tcGFyZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3QuYXNzaWduKGNvbXBhcmlzb25PYmosIHtcbiAgICAgICAgICBbaXRlbS5uYW1lXToge1xuICAgICAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICAgICAgcHJvZmlsZVZlcnNpb246IGl0ZW1bcHJvcFRvQ29tcGFyZV0sXG4gICAgICAgICAgICBkZXZpY2VWZXJzaW9uOiB1bmRlZmluZWRcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb21wYXJpc29uT2JqO1xuICB9XG59XG4iXX0=