import * as tslib_1 from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken } from '@angular/core';
import { IdReference, IManagedObject, InventoryService, IOperation, IOperationBulk, IResult, OperationBulkService, OperationService } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { has, isUndefined } from 'lodash-es';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { Subject } from 'rxjs';
import { BulkOperationType } from './bulk-operation.model';
import { BulkOperationsModalComponent } from './modal/bulk-operations-modal.component';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export const C8Y_BULK_TYPES = [
    {
        type: BulkOperationType.CONFIGURATION,
        c8yIcon: 'cogs',
        name: gettext('Configuration update'),
        path: `${baseUrl}configuration`,
        component: undefined,
        fragments: ['c8y_DownloadConfigFile', 'c8y_Configuration'],
        selected: false
    },
    {
        type: BulkOperationType.FIRMWARE,
        c8yIcon: 'c8y-firmware',
        name: gettext('Firmware update'),
        path: `${baseUrl}firmware`,
        component: undefined,
        fragments: ['c8y_Firmware'],
        selected: false
    },
    {
        type: BulkOperationType.SOFTWARE,
        c8yIcon: 'c8y-tools',
        name: gettext('Software update'),
        path: `${baseUrl}software`,
        component: undefined,
        fragments: ['c8y_SoftwareList', 'c8y_SoftwareUpdate'],
        selected: false
    },
    {
        type: BulkOperationType.DEVICE_PROFILE,
        c8yIcon: 'c8y-device-profile',
        name: gettext('Apply device profile'),
        path: `${baseUrl}device-profile`,
        component: undefined,
        fragments: ['c8y_DeviceProfile'],
        selected: false
    }
];
const ɵ0 = (flattened, current) => flattened.concat(current.fragments);
export const C8Y_BULK_TYPE_FRAGMENTS = C8Y_BULK_TYPES.reduce(ɵ0, []);
let BulkOperationsService = class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, bsModalService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.bsModalService = bsModalService;
        this.location = location;
        this.bulkTypes = bulkTypes;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        if (bulkTypes && bulkTypes.length > 0) {
            this.bulkTypes = bulkTypes.map(type => {
                if (isUndefined(type.selected)) {
                    type.selected = false;
                }
                return type;
            });
        }
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    showNewBulkOperationModal() {
        this.bsModalRef = this.bsModalService.show(BulkOperationsModalComponent, {
            backdrop: 'static',
            class: 'modal-sm'
        });
    }
    hideNewBulkOperationModal() {
        if (this.bsModalRef) {
            this.bsModalRef.hide();
        }
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    createSingleOperation(operation) {
        return this.operationService.create(operation);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    getManagedObject(deviceId) {
        return this.inventoryService.detail(deviceId);
    }
    retrieveBulkOperationType(operation) {
        let type;
        C8Y_BULK_TYPES.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
};
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: BsModalService },
    { type: Location },
    { type: Array, decorators: [{ type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
BulkOperationsService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(5, Inject(HOOK_LIST_BULK_TYPE))
], BulkOperationsService);
export { BulkOperationsService };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvIiwic291cmNlcyI6WyJidWxrL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFDTCxXQUFXLEVBQ1gsY0FBYyxFQUNkLGdCQUFnQixFQUNoQixVQUFVLEVBQ1YsY0FBYyxFQUNkLE9BQU8sRUFDUCxvQkFBb0IsRUFDcEIsZ0JBQWdCLEVBQ2pCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHM0QsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFHdkYsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUFrQixnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3pGLE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBb0I7SUFDN0M7UUFDRSxJQUFJLEVBQUUsaUJBQWlCLENBQUMsYUFBYTtRQUNyQyxPQUFPLEVBQUUsTUFBTTtRQUNmLElBQUksRUFBRSxPQUFPLENBQUMsc0JBQXNCLENBQUM7UUFDckMsSUFBSSxFQUFFLEdBQUcsT0FBTyxlQUFlO1FBQy9CLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLFNBQVMsRUFBRSxDQUFDLHdCQUF3QixFQUFFLG1CQUFtQixDQUFDO1FBQzFELFFBQVEsRUFBRSxLQUFLO0tBQ2hCO0lBQ0Q7UUFDRSxJQUFJLEVBQUUsaUJBQWlCLENBQUMsUUFBUTtRQUNoQyxPQUFPLEVBQUUsY0FBYztRQUN2QixJQUFJLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDO1FBQ2hDLElBQUksRUFBRSxHQUFHLE9BQU8sVUFBVTtRQUMxQixTQUFTLEVBQUUsU0FBUztRQUNwQixTQUFTLEVBQUUsQ0FBQyxjQUFjLENBQUM7UUFDM0IsUUFBUSxFQUFFLEtBQUs7S0FDaEI7SUFDRDtRQUNFLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxRQUFRO1FBQ2hDLE9BQU8sRUFBRSxXQUFXO1FBQ3BCLElBQUksRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDaEMsSUFBSSxFQUFFLEdBQUcsT0FBTyxVQUFVO1FBQzFCLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLFNBQVMsRUFBRSxDQUFDLGtCQUFrQixFQUFFLG9CQUFvQixDQUFDO1FBQ3JELFFBQVEsRUFBRSxLQUFLO0tBQ2hCO0lBQ0Q7UUFDRSxJQUFJLEVBQUUsaUJBQWlCLENBQUMsY0FBYztRQUN0QyxPQUFPLEVBQUUsb0JBQW9CO1FBQzdCLElBQUksRUFBRSxPQUFPLENBQUMsc0JBQXNCLENBQUM7UUFDckMsSUFBSSxFQUFFLEdBQUcsT0FBTyxnQkFBZ0I7UUFDaEMsU0FBUyxFQUFFLFNBQVM7UUFDcEIsU0FBUyxFQUFFLENBQUMsbUJBQW1CLENBQUM7UUFDaEMsUUFBUSxFQUFFLEtBQUs7S0FDaEI7Q0FDRixDQUFDO1dBRUEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFEN0QsTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQWEsY0FBYyxDQUFDLE1BQU0sS0FFcEUsRUFBRSxDQUNILENBQUM7QUFHRixJQUFhLHFCQUFxQixHQUFsQyxNQUFhLHFCQUFxQjtJQUtoQyxZQUNVLG9CQUEwQyxFQUMxQyxnQkFBa0MsRUFDbEMsZ0JBQWtDLEVBQ2xDLGNBQThCLEVBQzlCLFFBQWtCLEVBRVcsU0FBMEI7UUFOdkQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFFVyxjQUFTLEdBQVQsU0FBUyxDQUFpQjtRQVh4RCxpQkFBWSxHQUFXLEVBQUUsQ0FBQztRQUNuQyxlQUFVLEdBQXlCLElBQUksT0FBTyxFQUFlLENBQUM7UUFZNUQsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNwQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2lCQUN2QjtnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUQsaUJBQWlCLENBQUMsWUFBWSxHQUFHLEVBQUU7UUFDakMsTUFBTSxNQUFNLG1CQUNWLGNBQWMsRUFBRSxJQUFJLEVBQ3BCLFdBQVcsRUFBRSxJQUFJLEVBQ2pCLFFBQVEsRUFBRSxFQUFFLElBQ1QsWUFBWSxDQUNoQixDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxlQUFnQztRQUNuRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELG1CQUFtQixDQUFDLGFBQXNDO1FBQ3hELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsbUJBQW1CLENBQUMsZUFBZTtRQUNqQyxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELG1CQUFtQixDQUFDLGFBQXNDO1FBQ3hELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsWUFBWSxDQUFDLEVBQVU7UUFDckIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCx5QkFBeUI7UUFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtZQUN2RSxRQUFRLEVBQUUsUUFBUTtZQUNsQixLQUFLLEVBQUUsVUFBVTtTQUNsQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQseUJBQXlCO1FBQ3ZCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztJQUVELDZCQUE2QjtRQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBcUI7UUFDaEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELFlBQVk7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVELGFBQWEsQ0FBQyxFQUFlO1FBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxXQUFXLENBQUMscUJBQTZCO1FBQ3ZDLE1BQU0sWUFBWSxHQUE0QjtZQUM1QyxJQUFJLEVBQUUsdUJBQXVCO1lBQzdCLElBQUksRUFBRSxrQkFBa0I7WUFDeEIsa0JBQWtCLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFO1lBQ3JDLHFCQUFxQixFQUFFLHFCQUFxQjtTQUM3QyxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFSyxxQkFBcUIsQ0FBQyxpQkFBeUIsRUFBRSxPQUF5Qjs7WUFDOUUsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFFL0QsTUFBTSxhQUFhLEdBQW1CO2dCQUNwQyxPQUFPLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3QixrQkFBa0IsRUFBRSxPQUFPLENBQUMsU0FBUztnQkFDckMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsY0FBYztnQkFDN0MsU0FBUyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRTtnQkFDdkQsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2FBQ25CLENBQUM7WUFFRixNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxDQUFDO0tBQUE7SUFFRCwyQkFBMkIsQ0FBQyxNQUFNLEVBQUUsZUFBZTtRQUNqRCxNQUFNLE1BQU0sR0FBRztZQUNiLGNBQWMsRUFBRSxJQUFJO1lBQ3BCLGVBQWU7WUFDZixNQUFNLEVBQUUsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRTtTQUMvQyxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxTQUFxQjtRQUN6QyxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELHFCQUFxQixDQUFDLG1CQUF3QztRQUM1RCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsUUFBcUI7UUFDcEMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCx5QkFBeUIsQ0FBQyxTQUFxQjtRQUM3QyxJQUFJLElBQXVCLENBQUM7UUFFNUIsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN0QixJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxFQUFFO2dCQUMxRCxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDZCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFBOztZQXpJaUMsb0JBQW9CO1lBQ3hCLGdCQUFnQjtZQUNoQixnQkFBZ0I7WUFDbEIsY0FBYztZQUNwQixRQUFRO3dDQUV6QixNQUFNLFNBQUMsbUJBQW1COztBQVpsQixxQkFBcUI7SUFEakMsVUFBVSxFQUFFO0lBYVIsbUJBQUEsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7R0FabkIscUJBQXFCLENBK0lqQztTQS9JWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBJZFJlZmVyZW5jZSxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElPcGVyYXRpb24sXG4gIElPcGVyYXRpb25CdWxrLFxuICBJUmVzdWx0LFxuICBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgT3BlcmF0aW9uU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBoYXMsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJzTW9kYWxSZWYsIEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgSVN0YXR1c09wdGlvbiB9IGZyb20gJy4uL3N0YXR1cy1maWx0ZXIvc3RhdHVzLW9wdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9saXN0L3R5cGUtbGlzdC9vcGVyYXRpb24tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uc01vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9tb2RhbC9idWxrLW9wZXJhdGlvbnMtbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IE9wZXJhdGlvbkRldGFpbHMgfSBmcm9tICcuL29wZXJhdGlvbi1kZXRhaWxzLm1vZGVsJztcblxuZXhwb3J0IGNvbnN0IGJhc2VVcmwgPSAnZGV2aWNlY29udHJvbC9idWxrL2NyZWF0aW9uLyc7XG5leHBvcnQgY29uc3QgSE9PS19MSVNUX0JVTEtfVFlQRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxPcGVyYXRpb25UeXBlW10+KCdMSVNUX0JVTEtfVFlQRScpO1xuZXhwb3J0IGNvbnN0IEM4WV9CVUxLX1RZUEVTOiBPcGVyYXRpb25UeXBlW10gPSBbXG4gIHtcbiAgICB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZS5DT05GSUdVUkFUSU9OLFxuICAgIGM4eUljb246ICdjb2dzJyxcbiAgICBuYW1lOiBnZXR0ZXh0KCdDb25maWd1cmF0aW9uIHVwZGF0ZScpLFxuICAgIHBhdGg6IGAke2Jhc2VVcmx9Y29uZmlndXJhdGlvbmAsXG4gICAgY29tcG9uZW50OiB1bmRlZmluZWQsXG4gICAgZnJhZ21lbnRzOiBbJ2M4eV9Eb3dubG9hZENvbmZpZ0ZpbGUnLCAnYzh5X0NvbmZpZ3VyYXRpb24nXSxcbiAgICBzZWxlY3RlZDogZmFsc2VcbiAgfSxcbiAge1xuICAgIHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlLkZJUk1XQVJFLFxuICAgIGM4eUljb246ICdjOHktZmlybXdhcmUnLFxuICAgIG5hbWU6IGdldHRleHQoJ0Zpcm13YXJlIHVwZGF0ZScpLFxuICAgIHBhdGg6IGAke2Jhc2VVcmx9ZmlybXdhcmVgLFxuICAgIGNvbXBvbmVudDogdW5kZWZpbmVkLFxuICAgIGZyYWdtZW50czogWydjOHlfRmlybXdhcmUnXSxcbiAgICBzZWxlY3RlZDogZmFsc2VcbiAgfSxcbiAge1xuICAgIHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlLlNPRlRXQVJFLFxuICAgIGM4eUljb246ICdjOHktdG9vbHMnLFxuICAgIG5hbWU6IGdldHRleHQoJ1NvZnR3YXJlIHVwZGF0ZScpLFxuICAgIHBhdGg6IGAke2Jhc2VVcmx9c29mdHdhcmVgLFxuICAgIGNvbXBvbmVudDogdW5kZWZpbmVkLFxuICAgIGZyYWdtZW50czogWydjOHlfU29mdHdhcmVMaXN0JywgJ2M4eV9Tb2Z0d2FyZVVwZGF0ZSddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9LFxuICB7XG4gICAgdHlwZTogQnVsa09wZXJhdGlvblR5cGUuREVWSUNFX1BST0ZJTEUsXG4gICAgYzh5SWNvbjogJ2M4eS1kZXZpY2UtcHJvZmlsZScsXG4gICAgbmFtZTogZ2V0dGV4dCgnQXBwbHkgZGV2aWNlIHByb2ZpbGUnKSxcbiAgICBwYXRoOiBgJHtiYXNlVXJsfWRldmljZS1wcm9maWxlYCxcbiAgICBjb21wb25lbnQ6IHVuZGVmaW5lZCxcbiAgICBmcmFnbWVudHM6IFsnYzh5X0RldmljZVByb2ZpbGUnXSxcbiAgICBzZWxlY3RlZDogZmFsc2VcbiAgfVxuXTtcbmV4cG9ydCBjb25zdCBDOFlfQlVMS19UWVBFX0ZSQUdNRU5UUzogc3RyaW5nW10gPSBDOFlfQlVMS19UWVBFUy5yZWR1Y2UoXG4gIChmbGF0dGVuZWQsIGN1cnJlbnQpID0+IGZsYXR0ZW5lZC5jb25jYXQoY3VycmVudC5mcmFnbWVudHMpLFxuICBbXVxuKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25zU2VydmljZSB7XG4gIHJlYWRvbmx5IEREX0xPV19DT1VOVDogbnVtYmVyID0gMTA7XG4gIGZpcm13YXJlSWQ6IFN1YmplY3Q8SWRSZWZlcmVuY2U+ID0gbmV3IFN1YmplY3Q8SWRSZWZlcmVuY2U+KCk7XG5cbiAgcHJpdmF0ZSBic01vZGFsUmVmOiBCc01vZGFsUmVmO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wZXJhdGlvbkJ1bGtTZXJ2aWNlOiBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLFxuXG4gICAgQEluamVjdChIT09LX0xJU1RfQlVMS19UWVBFKSBwcml2YXRlIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdXG4gICkge1xuICAgIGlmIChidWxrVHlwZXMgJiYgYnVsa1R5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuYnVsa1R5cGVzID0gYnVsa1R5cGVzLm1hcCh0eXBlID0+IHtcbiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUuc2VsZWN0ZWQpKSB7XG4gICAgICAgICAgdHlwZS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0eXBlO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbnMoY3VzdG9tRmlsdGVyID0ge30pIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIHdpdGhEZWxldGVkOiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgLi4uY3VzdG9tRmlsdGVyXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25CeUlkKGJ1bGtPcGVyYXRpb25JZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGV0YWlsKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICBjcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuY3JlYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZGVsZXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZWxldGUoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIHVwZGF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS51cGRhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRPcGVyYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdDxJT3BlcmF0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuZGV0YWlsKGlkKTtcbiAgfVxuXG4gIHNob3dOZXdCdWxrT3BlcmF0aW9uTW9kYWwoKSB7XG4gICAgdGhpcy5ic01vZGFsUmVmID0gdGhpcy5ic01vZGFsU2VydmljZS5zaG93KEJ1bGtPcGVyYXRpb25zTW9kYWxDb21wb25lbnQsIHtcbiAgICAgIGJhY2tkcm9wOiAnc3RhdGljJyxcbiAgICAgIGNsYXNzOiAnbW9kYWwtc20nXG4gICAgfSk7XG4gIH1cblxuICBoaWRlTmV3QnVsa09wZXJhdGlvbk1vZGFsKCkge1xuICAgIGlmICh0aGlzLmJzTW9kYWxSZWYpIHtcbiAgICAgIHRoaXMuYnNNb2RhbFJlZi5oaWRlKCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuVG9CdWxrT3BlcmF0aW9uT3ZlcnZpZXcoKSB7XG4gICAgdGhpcy5sb2NhdGlvbi5iYWNrKCk7XG4gIH1cblxuICBzZXRCdWxrVHlwZXMobGlzdDogT3BlcmF0aW9uVHlwZVtdKSB7XG4gICAgdGhpcy5idWxrVHlwZXMgPSBsaXN0O1xuICB9XG5cbiAgZ2V0QnVsa1R5cGVzKCk6IE9wZXJhdGlvblR5cGVbXSB7XG4gICAgcmV0dXJuIHRoaXMuYnVsa1R5cGVzO1xuICB9XG5cbiAgc2V0RmlybXdhcmVJZChpZDogSWRSZWZlcmVuY2UpIHtcbiAgICB0aGlzLmZpcm13YXJlSWQubmV4dChpZCk7XG4gIH1cblxuICBjcmVhdGVHcm91cChkZXZpY2VRdWVyeURhdGFTdHJpbmc6IHN0cmluZykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cDogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7XG4gICAgICBuYW1lOiAnQnVsayBvcGVyYXRpb25zIGdyb3VwJyxcbiAgICAgIHR5cGU6ICdjOHlfRHluYW1pY0dyb3VwJyxcbiAgICAgIGM4eV9Jc0R5bmFtaWNHcm91cDogeyBpbnZpc2libGU6IHt9IH0sXG4gICAgICBjOHlfRGV2aWNlUXVlcnlTdHJpbmc6IGRldmljZVF1ZXJ5RGF0YVN0cmluZ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNyZWF0ZShkeW5hbWljR3JvdXApO1xuICB9XG5cbiAgYXN5bmMgc2NoZWR1bGVCdWxrT3BlcmF0aW9uKGRldmljZVF1ZXJ5U3RyaW5nOiBzdHJpbmcsIGRldGFpbHM6IE9wZXJhdGlvbkRldGFpbHMpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXAgPSBhd2FpdCB0aGlzLmNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5U3RyaW5nKTtcblxuICAgIGNvbnN0IGJ1bGtPcGVyYXRpb246IElPcGVyYXRpb25CdWxrID0ge1xuICAgICAgZ3JvdXBJZDogZHluYW1pY0dyb3VwLmRhdGEuaWQsXG4gICAgICBvcGVyYXRpb25Qcm90b3R5cGU6IGRldGFpbHMucHJvdG90eXBlLFxuICAgICAgY3JlYXRpb25SYW1wOiBkZXRhaWxzLnNjaGVkdWxlLmRlbGF5SW5TZWNvbmRzLFxuICAgICAgc3RhcnREYXRlOiBkZXRhaWxzLnNjaGVkdWxlLnNjaGVkdWxlZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgIG5vdGU6IGRldGFpbHMubm90ZVxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRTaW5nbGVPcGVyYXRpb25zQnlTdGF0dXMoc3RhdHVzLCBidWxrT3BlcmF0aW9uSWQpIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIGJ1bGtPcGVyYXRpb25JZCxcbiAgICAgIHN0YXR1czogKHN0YXR1cyAmJiBzdGF0dXMudG9VcHBlckNhc2UoKSkgfHwgJydcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5saXN0KGZpbHRlcik7XG4gIH1cblxuICBjcmVhdGVTaW5nbGVPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uKTtcbiAgfVxuXG4gIHVwZGF0ZVNpbmdsZU9wZXJhdGlvbihwYXJ0aWFsVXBkYXRlT2JqZWN0OiBQYXJ0aWFsPElPcGVyYXRpb24+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS51cGRhdGUocGFydGlhbFVwZGF0ZU9iamVjdCk7XG4gIH1cblxuICBnZXRNYW5hZ2VkT2JqZWN0KGRldmljZUlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGRldmljZUlkKTtcbiAgfVxuXG4gIHJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogQnVsa09wZXJhdGlvblR5cGUge1xuICAgIGxldCB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcblxuICAgIEM4WV9CVUxLX1RZUEVTLnNvbWUodCA9PiB7XG4gICAgICBpZiAodC5mcmFnbWVudHMuc29tZShmcmFnbWVudCA9PiBoYXMob3BlcmF0aW9uLCBmcmFnbWVudCkpKSB7XG4gICAgICAgIHR5cGUgPSB0LnR5cGU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHR5cGU7XG4gIH1cbn1cbiJdfQ==