import * as tslib_1 from "tslib";
import { of, from, throwError, merge } from 'rxjs';
import { map, switchMap, takeWhile, take, filter, withLatestFrom } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { isNil, isUndefined, assign, set, head, get, isString, pick, cloneDeep, remove, find, forEach, map as _map } from 'lodash-es';
import { AlertService, gettext } from '@c8y/ngx-components';
import { InventoryService, InventoryBinaryService, IResult, IManagedObject, IManagedObjectBinary, IIdentified, QueriesUtil, IResultList, IFetchResponse, IOperation, OperationService, Realtime, OperationStatus, IEvent, EventService, EventBinaryService } from '@c8y/client';
import { RepositoryType, REPOSITORY_BINARY_TYPES } from './repository.model';
let RepositoryService = class RepositoryService {
    constructor(inventory, inventoryBinary, operation, alert, event, realtime, eventBinary) {
        this.inventory = inventory;
        this.inventoryBinary = inventoryBinary;
        this.operation = operation;
        this.alert = alert;
        this.event = event;
        this.realtime = realtime;
        this.eventBinary = eventBinary;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.queriesUtil = new QueriesUtil();
    }
    /**
     * Lists repository entries of given type.
     * @param type The type of repository entries to list.
     * @param options Extra listing options.
     */
    listRepositoryEntries(type, options) {
        const defaultOrder = [{ name: 1 }];
        const defaultFilters = { type };
        const legacyFilters = { __has: `url` };
        let fullQuery = (options && options.query) || {};
        fullQuery = this.queriesUtil.addOrderbys(fullQuery, defaultOrder, 'prepend');
        fullQuery = this.queriesUtil.addAndFilter(fullQuery, defaultFilters);
        if (options && options.partialName) {
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { name: `*${options.partialName}*` });
        }
        if (options && options.skipLegacy) {
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { __not: legacyFilters });
        }
        const filters = Object.assign({ query: this.queriesUtil.buildQuery(fullQuery), pageSize: 50, withTotalPages: true }, ((options && options.params) || {}));
        return this.inventory.list(filters);
    }
    // TODO: merge with create()
    save(data, type, mo = {}) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            switch (type) {
                case RepositoryType.CONFIGURATION: {
                    Object.assign(mo, {
                        type: RepositoryType.CONFIGURATION,
                        configurationType: data.selected ? data.selected.configurationType : undefined,
                        name: data.version,
                        description: data.description,
                        deviceType: data.deviceType,
                        c8y_Global: {}
                    });
                    break;
                }
            }
            const existingUrl = mo.url;
            if (data.binary.url) {
                mo.url = data.binary.url;
            }
            else if (data.binary.file) {
                const response = yield this.inventoryBinary.create(data.binary.file, {
                    c8y_Global: {}
                });
                mo.url = response.data.self;
            }
            if (mo.id) {
                return this.updateEntry(mo, existingUrl);
            }
            return this.createEntry(mo);
        });
    }
    create(modal, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            switch (type) {
                case RepositoryType.FIRMWARE:
                case RepositoryType.SOFTWARE:
                    return this.createFirmwareOrSoftware(modal, type);
            }
        });
    }
    createFirmwareOrSoftware(modal, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let binary;
            let binaryURL;
            let repositoryEntry;
            let repositoryBinary;
            const mos = [];
            const { selected: { id: selectedId }, binary: { file, url } } = modal;
            try {
                if (file) {
                    ({ data: binary } = yield this.saveBinary(file));
                    ({ self: binaryURL } = binary);
                    mos.push(binary);
                }
                else {
                    binaryURL = url;
                }
                ({ data: repositoryEntry } = yield this.createOrUpdateRepositoryEntry(modal, type));
                if (isNil(selectedId)) {
                    mos.push(repositoryEntry);
                }
                ({ data: repositoryBinary } = yield this.createRepositoryBinary(modal, binaryURL, type, repositoryEntry));
                mos.push(repositoryBinary);
                if (file) {
                    yield this.linkBinary(repositoryBinary, binary);
                }
                return repositoryEntry;
            }
            catch (error) {
                this.cleanUp(mos);
                this.errorMsg();
                // Propagate error
                throw error;
            }
        });
    }
    saveBinary(file) {
        return this.inventoryBinary.create(file, { c8y_Global: {} });
    }
    createOrUpdateRepositoryEntry(modal, type) {
        const { selected: { id, name }, description } = modal;
        const mo = {
            id,
            name: id ? undefined : name,
            description,
            type: id ? undefined : type,
            c8y_Global: {}
        };
        return id
            ? this.inventory.update(mo)
            : this.inventory.create(mo);
    }
    createRepositoryBinary(modal, binaryURL, type, parent) {
        const mo = this.prepareRepositoryBinaryMO(modal, binaryURL, type);
        return this.inventory.childAdditionsCreate(mo, parent);
    }
    prepareRepositoryBinaryMO(modal, binaryURL, type) {
        const { version, patchVersion, dependency } = modal;
        const result = {
            type: REPOSITORY_BINARY_TYPES[type],
            [type]: {
                url: binaryURL
            },
            c8y_Global: {}
        };
        if (dependency) {
            set(result, [type, 'version'], patchVersion);
            assign(result, {
                c8y_Patch: {
                    dependency: dependency.c8y_Firmware.version
                }
            });
        }
        else {
            set(result, [type, 'version'], version);
        }
        return result;
    }
    linkBinary(repositoryBinary, binary) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { id: repositoryBinaryId } = repositoryBinary;
            if (binary) {
                const { id: binaryId } = binary;
                return this.inventory.childAdditionsAdd(binaryId, repositoryBinaryId);
            }
        });
    }
    cleanUp(mosToDelete) {
        mosToDelete.forEach(mo => {
            const { c8y_IsBinary } = mo;
            isUndefined(c8y_IsBinary) ? this.delete(mo) : this.inventoryBinary.delete(mo);
        });
    }
    delete(entity) {
        return this.inventory.delete(entity, { forceCascade: true });
    }
    errorMsg() {
        const msg = gettext('Failed to save');
        this.alert.danger(msg);
    }
    getBaseVersionsCount$(entry) {
        if (this.isLegacyEntry(entry)) {
            return of(1);
        }
        return from(this.listBaseVersions(entry, { pageSize: 1, withTotalPages: true })).pipe(map(({ paging }) => paging.totalPages));
    }
    getBaseVersionFromMO(mo) {
        return this.isPatch(mo) ? get(mo, 'c8y_Patch.dependency') : get(mo, 'c8y_Firmware.version');
    }
    isPatch(mo) {
        return !!get(mo, 'c8y_Patch.dependency');
    }
    getPatchVersionsCount$(entry, baseVersion) {
        if (this.isLegacyEntry(baseVersion)) {
            return of(0);
        }
        return from(this.listPatchVersions(entry, baseVersion, { pageSize: 1, withTotalPages: true })).pipe(map(({ paging }) => paging.totalPages));
    }
    isLegacyEntry(entry) {
        return Boolean(entry.url);
    }
    /**
     * Lists all versions (base and patch ones) of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    listAllVersions(entry, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        const VERSION_FILTER_ORDER = {
            __filter: {},
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, VERSION_FILTER_ORDER, params);
    }
    /**
     * Lists base versions of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    listBaseVersions(entry, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        const NO_PATCH_FILTER_ORDER = {
            __filter: {
                __not: { __has: 'c8y_Patch' }
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, NO_PATCH_FILTER_ORDER, params);
    }
    /**
     * Lists patch versions of given base version under the entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    listPatchVersions(entry, baseVersion, params = {}) {
        const version = isString(baseVersion) ? baseVersion : get(baseVersion, 'c8y_Firmware.version');
        const PATCH_FILTER_ORDER = {
            __filter: {
                'c8y_Patch.dependency': version
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    }
    /**
     * Lists patch versions of given base version under the entry including the base version.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * In terms of legacy base version the entry gets transformed to fit the needed data model.
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    listBaseVersionAndPatches(entry, baseVersion, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return Promise.resolve({
                data: [
                    Object.assign({
                        c8y_Firmware: {
                            version: entry.version,
                            url: entry.url
                        }
                    }, entry)
                ]
            });
        }
        const PATCH_FILTER_ORDER = {
            __filter: {
                __or: {
                    'c8y_Patch.dependency': baseVersion.c8y_Firmware.version,
                    'c8y_Firmware.version': baseVersion.c8y_Firmware.version
                }
            },
            __orderby: [{ 'c8y_Patch.dependency': 1 }, { 'c8y_Firmware.version': 1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    }
    listChildren(entry, filters = {}, params = {}) {
        const childrenFilters = { __bygroupid: entry.id };
        const query = this.queriesUtil.addAndFilter(filters, childrenFilters);
        // FIXME: needed because of issue in forOf directive (...)
        params.withTotalPages = true;
        return this.inventory.listQuery(query, params);
    }
    /**
     * Fetches all items from the list starting with the provided page.
     * @param firstPage The first page of the list to fetch all items for.
     */
    fetchAllItemsFromList(firstPage) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let allItems;
            if (!firstPage.then) {
                allItems = [...firstPage];
            }
            else {
                let { paging, data: items } = yield firstPage;
                allItems = [...items];
                while (paging && paging.nextPage) {
                    ({ paging, data: items } = yield paging.next());
                    allItems = [...allItems, ...items];
                }
            }
            return allItems;
        });
    }
    /**
     * Gets top level repository entry managed object for base or patch version.
     * @param mo Base or patch version managed object with parents.
     */
    getRepositoryEntryMO$(mo) {
        if (!mo) {
            return of(undefined);
        }
        const [reference] = get(mo, 'additionParents.references');
        const id = get(reference, 'managedObject.id');
        return id
            ? from(this.inventory.detail(id, { withChildren: false })).pipe(map(({ data }) => data))
            : of(undefined);
    }
    /**
     * Gets base or patch version managed object.
     * @param deviceRepositoryFragment Device repository fragment.
     * @param type Top level repository entry type.
     * @param configuration Configuration object with options:
     * - **skipLegacy** - `boolean` - Exclude legacy entries.
     * - **filters** - `object` - Filter object.
     *
     * @deprecated as it doesn't support 'missing url' case
     */
    getRepositoryBinaryMoByVersion(deviceRepositoryFragment, type, { skipLegacy = false, filters = {} } = {}) {
        const { version, url, name } = deviceRepositoryFragment;
        const repositoryBinaryType = REPOSITORY_BINARY_TYPES[type];
        let query;
        const newModelBaseVersionQuery = {
            [`${type}.version`]: version,
            [`${type}.url`]: url,
            type: repositoryBinaryType
        };
        const legacyVersionQuery = { url, type, name };
        filters = Object.assign({ withChildren: false, withParents: true }, filters);
        if (skipLegacy) {
            query = {
                __and: Object.assign({}, newModelBaseVersionQuery)
            };
        }
        else {
            query = {
                __or: [{ __and: Object.assign({}, newModelBaseVersionQuery) }, { __and: Object.assign({}, legacyVersionQuery) }]
            };
        }
        return this.inventory.listQuery(query, filters).then(({ data }) => head(data));
    }
    getBinaryName$(binaryUrl) {
        if (!binaryUrl) {
            return of('---');
        }
        const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
        if (!binaryId) {
            return of(binaryUrl);
        }
        return this.inventory.detail$(binaryId).pipe(map(mo => mo.name));
    }
    /**
     * Generates an inventory query object which can be used to find
     * repository entries of specified type matching the type of provided device.
     * @param repositoryType The type of repository entries which will be queried with the generated query.
     * @param device The device for which matching repository entries will be queried with the generated query.
     */
    getDeviceTypeQuery(repositoryType, device) {
        let result = { type: repositoryType };
        if (device.type) {
            if (repositoryType === RepositoryType.CONFIGURATION) {
                result = this.queriesUtil.addAndFilter(result, {
                    __or: [{ deviceType: device.type }, { __not: { __has: `deviceType` } }]
                });
            }
            else {
                result = this.queriesUtil.addAndFilter(result, {
                    __or: [{ 'c8y_Filter.type': device.type }, { __not: { __has: `c8y_Filter.type` } }]
                });
            }
        }
        return result;
    }
    /**
     * Generates an inventory query object which can be used to find configuration repository entries
     * matching the type of provided device and specified configuration type.
     * @param device The device for which matching repository entries will be queried with the generated query.
     * @param configurationType Configuration type for which matching repository entries will be queried with the generated query.
     */
    getConfigurationTypeQuery(device, configurationType) {
        const query = this.getDeviceTypeQuery(RepositoryType.CONFIGURATION, device);
        return this.queriesUtil.addAndFilter(query, {
            __or: [{ configurationType }, { __not: { __has: `configurationType` } }]
        });
    }
    /**
     * Gets the list of software installed in the device in the uniform format.
     * Supports c8y_SoftwareList and c8y_Software fragments.
     * @param device The device whose software list should be returned.
     */
    getDeviceSoftwareList(device) {
        if (device.c8y_SoftwareList) {
            return cloneDeep(device.c8y_SoftwareList);
        }
        if (device.c8y_Software) {
            return _map(device.c8y_Software, (version, name) => ({ name, version }));
        }
        return [];
    }
    /**
     * Prepares a software update operation for given device and the list of changes, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param changes The list of software changes which should be applied.
     */
    createSoftwareUpdateOperation(device, changes) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const operation = this.getSoftwareUpdateOperation(device, changes);
            return (yield this.operation.create(operation)).data;
        });
    }
    /**
     * Prepares a software update operation for given device and changes.
     * Returned operation type depends on device's supported operations.
     * Supports c8y_SoftwareUpdate, c8y_SoftwareList, and c8y_Software operations.
     * @param device The device for which operation should be prepared.
     * @param changes The list of software changes which should be applied.
     */
    getSoftwareUpdateOperation(device, changes) {
        const operation = {
            deviceId: device.id,
            description: `Apply software changes: ${changes
                .map(change => `${change.action} "${change.name}"${change.version ? ` (version: ${change.version})` : ''}`)
                .join(', ')}`
        };
        if (device.c8y_SupportedOperations.includes('c8y_SoftwareUpdate')) {
            operation.c8y_SoftwareUpdate = cloneDeep(changes);
        }
        else if (device.c8y_SupportedOperations.includes('c8y_SoftwareList')) {
            operation.c8y_SoftwareList = cloneDeep(device.c8y_SoftwareList) || [];
            changes.forEach(change => {
                const deviceSoftware = pick(change, ['name', 'version', 'url']);
                if (change.action === 'delete') {
                    remove(operation.c8y_SoftwareList, deviceSoftware);
                }
                if (change.action === 'install') {
                    operation.c8y_SoftwareList.push(deviceSoftware);
                }
            });
        }
        else if (device.c8y_SupportedOperations.includes('c8y_Software')) {
            operation.c8y_Software = cloneDeep(device.c8y_Software) || {};
            changes.forEach(change => {
                if (change.action === 'delete') {
                    delete operation.c8y_Software[change.name];
                }
                if (change.action === 'install') {
                    operation.c8y_Software[change.name] = change.version;
                }
            });
        }
        return operation;
    }
    /**
     * Extracts the list of device software changes from given operation in the context of given device.
     * @param operation The operation from which the list should be extracted.
     * @param device The target device of the operation.
     */
    getDeviceSoftwareChangesFromOperation(operation, device) {
        if (operation.c8y_SoftwareUpdate) {
            return cloneDeep(operation.c8y_SoftwareUpdate);
        }
        if (operation.c8y_SoftwareList) {
            return this.getDeviceSoftwareChangesFromSoftwareListOperation(operation, device);
        }
        if (operation.c8y_Software) {
            return this.getDeviceSoftwareChangesFromSoftwareOperation(operation, device);
        }
        return [];
    }
    /**
     * Prepares a firmware update operation for given device and the selected repository binary, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param selectedOption The selected repository binary option.
     */
    createFirmwareUpdateOperation(device, selectedOption) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const operation = this.getFirmwareUpdateOperation(device, selectedOption);
            return (yield this.operation.create(operation)).data;
        });
    }
    /**
     * Prepares a firmware update operation for given device and selected version.
     * Supports c8y_Firmware operation.
     * @param device The device for which operation should be prepared.
     * @param selectedOption Selected firmware version.
     */
    getFirmwareUpdateOperation(device, selectedOption) {
        delete selectedOption.id;
        const operation = {
            deviceId: device.id,
            description: `Update firmware to: "${selectedOption.name}"${selectedOption.version ? ` (version: ${selectedOption.version})` : ''}`,
            c8y_Firmware: Object.assign({}, selectedOption)
        };
        return operation;
    }
    /**
     * Prepares a configuration file upload operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param isLegacy  A legacy operation is created without a configurationType.
     */
    getUploadConfigurationFileOperation(device, configurationType, isLegacy = false) {
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: `Retrieve configuration snapshot from device ${device.name}`,
                c8y_UploadConfigFile: {}
            };
        }
        return {
            deviceId: device.id,
            description: `Retrieve ${configurationType} configuration snapshot from device ${device.name}`,
            c8y_UploadConfigFile: {
                type: configurationType
            }
        };
    }
    /**
     * Prepares a configuration file download operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param binaryUrl The url of a binary to be downloaded.
     * @param isLegacy A legacy operation is created without a configurationType.
     */
    getDownloadConfigurationFileOperation(device, configurationType, configSnapshot, isLegacy = false) {
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: `Send configuration snapshot ${configSnapshot.name} to device ${device.name}`,
                c8y_DownloadConfigFile: {
                    url: configSnapshot.binaryUrl,
                    c8y_ConfigurationDump: {
                        id: configSnapshot.id
                    }
                }
            };
        }
        return {
            deviceId: device.id,
            description: `Send configuration snapshot ${configSnapshot.name} of configuration type ${configurationType} to device ${device.name}`,
            c8y_DownloadConfigFile: {
                url: configSnapshot.binaryUrl,
                type: configurationType
            }
        };
    }
    /**
     * Gets the last firmware update operation for given device.
     * Looks for c8y_Firmware operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    getLastFirmwareUpdateOperation(deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filters = {
                deviceId,
                dateFrom: new Date(0).toISOString(),
                dateTo: new Date(Date.now()).toISOString(),
                revert: true,
                pageSize: 1
            };
            return this.getFirstMatchingOperation([Object.assign({}, filters, { fragmentType: 'c8y_Firmware' })]);
        });
    }
    /**
     * Gets the last software update operation for given device.
     * Looks for c8y_SoftwareUpdate, c8y_SoftwareList, or c8y_Software operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    getLastSoftwareUpdateOperation(deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filters = {
                deviceId,
                dateFrom: new Date(0).toISOString(),
                dateTo: new Date(Date.now()).toISOString(),
                revert: true,
                pageSize: 1
            };
            return this.getFirstMatchingOperation([
                Object.assign({}, filters, { fragmentType: 'c8y_SoftwareUpdate' }),
                Object.assign({}, filters, { fragmentType: 'c8y_SoftwareList' }),
                Object.assign({}, filters, { fragmentType: 'c8y_Software' })
            ]);
        });
    }
    /**
     * Iterates over the list of filters and queries the operations.
     * If a query returns at least one operation, the first one will be returned.
     * Otherwise the next query will be performed.
     * If none of the queries returns any operation, null will be returned.
     * @param filtersList The list of filters for the queries.
     */
    getFirstMatchingOperation(filtersList) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let matchingOperation = null;
            for (const filters of filtersList) {
                const operations = (yield this.operation.list(filters)).data;
                if (operations.length) {
                    matchingOperation = operations[0];
                    break;
                }
            }
            return matchingOperation;
        });
    }
    /**
     * Creates the operation and returns an observable to track its progress.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to create and track.
     */
    createObservedOperation(operation) {
        return from(this.operation.create(operation)).pipe(map(({ data }) => data), take(1), switchMap(createdOperation => this.observeOperation(createdOperation)));
    }
    /**
     * Returns an observable to track progress of given operation.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to be observed.
     */
    observeOperation(operation) {
        const observedOperation$ = of(operation);
        const operationUpdates$ = observedOperation$.pipe(switchMap(observedOperation => this.realtime.observable(`/operations/${observedOperation.deviceId}`)), map(({ data }) => data), withLatestFrom(observedOperation$), filter(([operationUpdate, observedOperation]) => operationUpdate.id === observedOperation.id), switchMap(([operationUpdate]) => {
            if (operationUpdate.status === OperationStatus.FAILED) {
                return throwError(operationUpdate);
            }
            return of(operationUpdate);
        }), takeWhile(operationUpdate => operationUpdate.status !== OperationStatus.SUCCESSFUL, true));
        return merge(observedOperation$, operationUpdates$);
    }
    /**
     * Gets a single event with latest creationTime for the given device Id and event type.
     * @param deviceId The device Id for which the events should be queried.
     * @param type Event type.
     */
    getLatestConfigurationEvent(deviceId, type) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const eventFilter = {
                source: deviceId,
                type,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                pageSize: 1
            };
            const { data } = yield this.event.list(eventFilter);
            return data[0];
        });
    }
    /**
     * Gets a list of operations for the given device Id, and operation type.
     * @param deviceId The device Id for which the operation should be queried.
     * @param operationType Operation type fragment.
     */
    getConfigFileOperationList(deviceId, operationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const operationFilter = {
                deviceId,
                fragmentType: operationType,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 2000
            };
            return (yield this.operation.list(operationFilter)).data;
        });
    }
    /**
     * Gets latest uploaded configuration snapshot for the given device, and configuration type.
     * @param device The device for which the configuration snapshot was uploaded.
     * @param configurationType Selected configuration type.
     */
    getConfigSnapshot(device, configurationType) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const event = yield this.getLatestConfigurationEvent(device.id, configurationType);
            let configSnapshot;
            if (event) {
                configSnapshot = {
                    time: event.time,
                    name: event.text,
                    deviceType: device.type,
                    configurationType
                };
                try {
                    configSnapshot.binary = yield (yield this.eventBinary.download(event)).text();
                    if (event.c8y_IsBinary) {
                        configSnapshot.binaryType = event.c8y_IsBinary.type;
                    }
                }
                catch (ex) {
                    const msg = gettext('Could not get the binary.');
                    this.alert.danger(msg);
                }
            }
            return configSnapshot;
        });
    }
    getLegacyConfigSnapshot(deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let configSnapshot;
            let mo;
            const device = (yield this.inventory.detail(deviceId, { withChildren: false })).data;
            const snapshotId = device.c8y_ConfigurationDump && device.c8y_ConfigurationDump.id;
            if (!snapshotId) {
                return;
            }
            try {
                mo = (yield this.inventory.detail(snapshotId)).data;
            }
            catch (ex) {
                // do nothing
            }
            if (mo) {
                configSnapshot = {
                    time: mo.creationTime,
                    name: mo.name
                };
                configSnapshot.binary = yield this.getBinaryText(mo.url, { allowExternal: false });
            }
            return configSnapshot;
        });
    }
    getBinaryFile(binaryUrl, options) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
            if (!binaryId && !options.allowExternal) {
                return;
            }
            const { data } = yield this.inventory.detail(binaryId);
            const binary = !!binaryId
                ? yield this.getBinary(binaryId)
                : this.fetchExternalBinary(binaryUrl);
            const fileBinary = new File([binary], data.name, { type: data.contentType });
            return fileBinary;
        });
    }
    getBinaryText(binaryUrl, options) {
        const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
        if (!binaryId && options.allowExternal) {
            return this.fetchExternalBinary(binaryUrl);
        }
        return this.getBinary(binaryId);
    }
    getBinary(binaryId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let binary;
            try {
                const res = yield this.inventoryBinary.download(binaryId);
                binary = yield res.text();
            }
            catch (ex) {
                const msg = gettext('Could not get the binary.');
                this.alert.danger(msg);
            }
            return binary;
        });
    }
    fetchExternalBinary(url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let configBinary;
            try {
                const res = yield fetch(url);
                if (res.status === 200) {
                    configBinary = yield res.text();
                }
            }
            catch (ex) {
                const msg = gettext('Could not get the external binary.');
                this.alert.danger(msg);
            }
            return configBinary;
        });
    }
    createEntry(mo) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const binaryId = yield this.inventoryBinary.getIdFromUrl(mo.url);
            const newMo = yield this.inventory.create(mo);
            if (binaryId) {
                yield this.inventory.childAdditionsAdd(binaryId, newMo.data);
            }
            return newMo;
        });
    }
    updateEntry(mo, url) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const existingBinaryId = yield this.inventoryBinary.getIdFromUrl(url);
            const newBinaryId = yield this.inventoryBinary.getIdFromUrl(mo.url);
            if (existingBinaryId && existingBinaryId !== newBinaryId) {
                const id = this.inventoryBinary.getIdFromUrl(url);
                yield this.inventoryBinary.delete(id);
            }
            if (newBinaryId) {
                yield this.inventory.childAdditionsAdd(newBinaryId, mo);
            }
            return this.inventory.update(mo);
        });
    }
    getBaseVersionResultListForLegacyEntry(entry) {
        return Promise.resolve({
            res: {},
            data: [
                Object.assign({}, entry, { [entry.type]: {
                        version: entry.version,
                        url: entry.url
                    } })
            ]
        });
    }
    getDeviceSoftwareChangesFromSoftwareListOperation(operation, device) {
        const changes = [];
        forEach(device.c8y_SoftwareList, deviceSoftware => {
            const operationSoftware = find(operation.c8y_SoftwareList, { name: deviceSoftware.name });
            if (deviceSoftware.version !== operationSoftware.version) {
                changes.push(Object.assign({}, deviceSoftware, { action: 'delete' }));
            }
        });
        forEach(operation.c8y_SoftwareList, operationSoftware => {
            const deviceSoftware = find(device.c8y_SoftwareList, { name: operationSoftware.name });
            if (operationSoftware.version !== deviceSoftware.version) {
                changes.push(Object.assign({}, operationSoftware, { action: 'install' }));
            }
        });
        return changes;
    }
    getDeviceSoftwareChangesFromSoftwareOperation(operation, device) {
        const changes = [];
        forEach(device.c8y_Software, (deviceSoftwareVersion, deviceSoftwareName) => {
            if (operation.c8y_Software[deviceSoftwareName] !== deviceSoftwareVersion) {
                changes.push({
                    name: deviceSoftwareName,
                    version: deviceSoftwareVersion,
                    action: 'delete'
                });
            }
        });
        forEach(operation.c8y_Software, (operationSoftwareVersion, operationSoftwareName) => {
            if (device.c8y_Software[operationSoftwareName] !== operationSoftwareVersion) {
                changes.push({
                    name: operationSoftwareName,
                    version: operationSoftwareVersion,
                    action: 'install'
                });
            }
        });
        return changes;
    }
};
RepositoryService.ctorParameters = () => [
    { type: InventoryService },
    { type: InventoryBinaryService },
    { type: OperationService },
    { type: AlertService },
    { type: EventService },
    { type: Realtime },
    { type: EventBinaryService }
];
RepositoryService = tslib_1.__decorate([
    Injectable()
], RepositoryService);
export { RepositoryService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5LyIsInNvdXJjZXMiOlsicmVwb3NpdG9yeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNMLEtBQUssRUFDTCxXQUFXLEVBQ1gsTUFBTSxFQUNOLEdBQUcsRUFDSCxJQUFJLEVBQ0osR0FBRyxFQUNILFFBQVEsRUFDUixJQUFJLEVBQ0osU0FBUyxFQUNULE1BQU0sRUFDTixJQUFJLEVBQ0osT0FBTyxFQUNQLEdBQUcsSUFBSSxJQUFJLEVBQ1osTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLHNCQUFzQixFQUN0QixPQUFPLEVBQ1AsY0FBYyxFQUNkLG9CQUFvQixFQUNwQixXQUFXLEVBQ1gsV0FBVyxFQUNYLFdBQVcsRUFDWCxjQUFjLEVBQ2QsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixRQUFRLEVBQ1IsZUFBZSxFQUNmLE1BQU0sRUFDTixZQUFZLEVBQ1osa0JBQWtCLEVBQ25CLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFPTCxjQUFjLEVBQ2QsdUJBQXVCLEVBTXhCLE1BQU0sb0JBQW9CLENBQUM7QUFHNUIsSUFBYSxpQkFBaUIsR0FBOUIsTUFBYSxpQkFBaUI7SUFLNUIsWUFDVSxTQUEyQixF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ZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgdGFrZVdoaWxlLCB0YWtlLCBmaWx0ZXIsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgaXNOaWwsXG4gIGlzVW5kZWZpbmVkLFxuICBhc3NpZ24sXG4gIHNldCxcbiAgaGVhZCxcbiAgZ2V0LFxuICBpc1N0cmluZyxcbiAgcGljayxcbiAgY2xvbmVEZWVwLFxuICByZW1vdmUsXG4gIGZpbmQsXG4gIGZvckVhY2gsXG4gIG1hcCBhcyBfbWFwXG59IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7XG4gIEludmVudG9yeVNlcnZpY2UsXG4gIEludmVudG9yeUJpbmFyeVNlcnZpY2UsXG4gIElSZXN1bHQsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJTWFuYWdlZE9iamVjdEJpbmFyeSxcbiAgSUlkZW50aWZpZWQsXG4gIFF1ZXJpZXNVdGlsLFxuICBJUmVzdWx0TGlzdCxcbiAgSUZldGNoUmVzcG9uc2UsXG4gIElPcGVyYXRpb24sXG4gIE9wZXJhdGlvblNlcnZpY2UsXG4gIFJlYWx0aW1lLFxuICBPcGVyYXRpb25TdGF0dXMsXG4gIElFdmVudCxcbiAgRXZlbnRTZXJ2aWNlLFxuICBFdmVudEJpbmFyeVNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgUmVwb3NpdG9yeUNhdGVnb3J5LFxuICBSZXBvc2l0b3J5QmluYXJ5LFxuICBGaXJtd2FyZUJpbmFyeSxcbiAgU29mdHdhcmVCaW5hcnksXG4gIEZpcm13YXJlUGF0Y2hCaW5hcnksXG4gIE1vZGFsTW9kZWwsXG4gIFJlcG9zaXRvcnlUeXBlLFxuICBSRVBPU0lUT1JZX0JJTkFSWV9UWVBFUyxcbiAgRGV2aWNlRmlybXdhcmUsXG4gIERldmljZVNvZnR3YXJlLFxuICBEZXZpY2VTb2Z0d2FyZUNoYW5nZSxcbiAgU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5LFxuICBDb25maWd1cmF0aW9uU25hcHNob3Rcbn0gZnJvbSAnLi9yZXBvc2l0b3J5Lm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlcG9zaXRvcnlTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZGF0ZUZyb20gPSBuZXcgRGF0ZSgwKTtcbiAgcmVhZG9ubHkgZGF0ZVRvID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDg2NDAwMDAwKTsgLy8gMSBkYXkgaW4gdGhlIGZ1dHVyZVxuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeTogSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvbjogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBldmVudDogRXZlbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lLFxuICAgIHByaXZhdGUgZXZlbnRCaW5hcnk6IEV2ZW50QmluYXJ5U2VydmljZVxuICApIHtcbiAgICB0aGlzLnF1ZXJpZXNVdGlsID0gbmV3IFF1ZXJpZXNVdGlsKCk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgcmVwb3NpdG9yeSBlbnRyaWVzIG9mIGdpdmVuIHR5cGUuXG4gICAqIEBwYXJhbSB0eXBlIFRoZSB0eXBlIG9mIHJlcG9zaXRvcnkgZW50cmllcyB0byBsaXN0LlxuICAgKiBAcGFyYW0gb3B0aW9ucyBFeHRyYSBsaXN0aW5nIG9wdGlvbnMuXG4gICAqL1xuICBsaXN0UmVwb3NpdG9yeUVudHJpZXMoXG4gICAgdHlwZTogUmVwb3NpdG9yeVR5cGUsXG4gICAgb3B0aW9ucz86IHtcbiAgICAgIC8qKiBBZGRpdGlvbmFsIHF1ZXJ5LiAqL1xuICAgICAgcXVlcnk/OiBhbnk7XG4gICAgICAvKiogT25seSBpbmNsdWRlIGVudHJpZXMgd2l0aCBtYXRjaGluZyBwYXJ0aWFsIG5hbWVzLiAqL1xuICAgICAgcGFydGlhbE5hbWU/OiBzdHJpbmc7XG4gICAgICAvKiogRXhjbHVkZSBsZWdhY3kgZW50cmllcy4gKi9cbiAgICAgIHNraXBMZWdhY3k/OiBib29sZWFuO1xuICAgICAgLyoqIE90aGVyIHJlcXVlc3QgcGFyYW1zLiAqL1xuICAgICAgcGFyYW1zPzogYW55O1xuICAgIH1cbiAgKSB7XG4gICAgY29uc3QgZGVmYXVsdE9yZGVyID0gW3sgbmFtZTogMSB9XTtcbiAgICBjb25zdCBkZWZhdWx0RmlsdGVycyA9IHsgdHlwZSB9O1xuICAgIGNvbnN0IGxlZ2FjeUZpbHRlcnMgPSB7IF9faGFzOiBgdXJsYCB9O1xuXG4gICAgbGV0IGZ1bGxRdWVyeSA9IChvcHRpb25zICYmIG9wdGlvbnMucXVlcnkpIHx8IHt9O1xuICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkT3JkZXJieXMoZnVsbFF1ZXJ5LCBkZWZhdWx0T3JkZXIsICdwcmVwZW5kJyk7XG4gICAgZnVsbFF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIoZnVsbFF1ZXJ5LCBkZWZhdWx0RmlsdGVycyk7XG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJ0aWFsTmFtZSkge1xuICAgICAgZnVsbFF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIoZnVsbFF1ZXJ5LCB7IG5hbWU6IGAqJHtvcHRpb25zLnBhcnRpYWxOYW1lfSpgIH0pO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNraXBMZWdhY3kpIHtcbiAgICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZ1bGxRdWVyeSwgeyBfX25vdDogbGVnYWN5RmlsdGVycyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgcXVlcnk6IHRoaXMucXVlcmllc1V0aWwuYnVpbGRRdWVyeShmdWxsUXVlcnkpLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICAuLi4oKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJhbXMpIHx8IHt9KVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5Lmxpc3QoZmlsdGVycyk7XG4gIH1cblxuICAvLyBUT0RPOiBtZXJnZSB3aXRoIGNyZWF0ZSgpXG4gIGFzeW5jIHNhdmUoZGF0YTogTW9kYWxNb2RlbCwgdHlwZTogUmVwb3NpdG9yeVR5cGUsIG1vOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHt9KSB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT046IHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihtbywge1xuICAgICAgICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sXG4gICAgICAgICAgY29uZmlndXJhdGlvblR5cGU6IGRhdGEuc2VsZWN0ZWQgPyBkYXRhLnNlbGVjdGVkLmNvbmZpZ3VyYXRpb25UeXBlIDogdW5kZWZpbmVkLFxuICAgICAgICAgIG5hbWU6IGRhdGEudmVyc2lvbixcbiAgICAgICAgICBkZXNjcmlwdGlvbjogZGF0YS5kZXNjcmlwdGlvbixcbiAgICAgICAgICBkZXZpY2VUeXBlOiBkYXRhLmRldmljZVR5cGUsXG4gICAgICAgICAgYzh5X0dsb2JhbDoge31cbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0aW5nVXJsID0gbW8udXJsO1xuICAgIGlmIChkYXRhLmJpbmFyeS51cmwpIHtcbiAgICAgIG1vLnVybCA9IGRhdGEuYmluYXJ5LnVybDtcbiAgICB9IGVsc2UgaWYgKGRhdGEuYmluYXJ5LmZpbGUpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuY3JlYXRlKGRhdGEuYmluYXJ5LmZpbGUsIHtcbiAgICAgICAgYzh5X0dsb2JhbDoge31cbiAgICAgIH0gYXMgUGFydGlhbDxJTWFuYWdlZE9iamVjdD4pO1xuICAgICAgbW8udXJsID0gcmVzcG9uc2UuZGF0YS5zZWxmO1xuICAgIH1cblxuICAgIGlmIChtby5pZCkge1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlRW50cnkobW8sIGV4aXN0aW5nVXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlRW50cnkobW8pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlKG1vZGFsOiBNb2RhbE1vZGVsLCB0eXBlOiBSZXBvc2l0b3J5VHlwZSkge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBSZXBvc2l0b3J5VHlwZS5GSVJNV0FSRTpcbiAgICAgIGNhc2UgUmVwb3NpdG9yeVR5cGUuU09GVFdBUkU6XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZpcm13YXJlT3JTb2Z0d2FyZShtb2RhbCwgdHlwZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlRmlybXdhcmVPclNvZnR3YXJlKFxuICAgIG1vZGFsOiBNb2RhbE1vZGVsLFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlXG4gICk6IFByb21pc2U8UmVwb3NpdG9yeUNhdGVnb3J5PiB7XG4gICAgbGV0IGJpbmFyeTogSU1hbmFnZWRPYmplY3RCaW5hcnk7XG4gICAgbGV0IGJpbmFyeVVSTDogc3RyaW5nO1xuICAgIGxldCByZXBvc2l0b3J5RW50cnk6IFJlcG9zaXRvcnlDYXRlZ29yeTtcbiAgICBsZXQgcmVwb3NpdG9yeUJpbmFyeTogRmlybXdhcmVCaW5hcnkgfCBTb2Z0d2FyZUJpbmFyeTtcbiAgICBjb25zdCBtb3MgPSBbXTtcbiAgICBjb25zdCB7XG4gICAgICBzZWxlY3RlZDogeyBpZDogc2VsZWN0ZWRJZCB9LFxuICAgICAgYmluYXJ5OiB7IGZpbGUsIHVybCB9XG4gICAgfSA9IG1vZGFsO1xuICAgIHRyeSB7XG4gICAgICBpZiAoZmlsZSkge1xuICAgICAgICAoeyBkYXRhOiBiaW5hcnkgfSA9IGF3YWl0IHRoaXMuc2F2ZUJpbmFyeShmaWxlKSk7XG4gICAgICAgICh7IHNlbGY6IGJpbmFyeVVSTCB9ID0gYmluYXJ5KTtcbiAgICAgICAgbW9zLnB1c2goYmluYXJ5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJpbmFyeVVSTCA9IHVybDtcbiAgICAgIH1cblxuICAgICAgKHsgZGF0YTogcmVwb3NpdG9yeUVudHJ5IH0gPSBhd2FpdCB0aGlzLmNyZWF0ZU9yVXBkYXRlUmVwb3NpdG9yeUVudHJ5KG1vZGFsLCB0eXBlKSk7XG4gICAgICBpZiAoaXNOaWwoc2VsZWN0ZWRJZCkpIHtcbiAgICAgICAgbW9zLnB1c2gocmVwb3NpdG9yeUVudHJ5KTtcbiAgICAgIH1cblxuICAgICAgKHsgZGF0YTogcmVwb3NpdG9yeUJpbmFyeSB9ID0gYXdhaXQgdGhpcy5jcmVhdGVSZXBvc2l0b3J5QmluYXJ5KFxuICAgICAgICBtb2RhbCxcbiAgICAgICAgYmluYXJ5VVJMLFxuICAgICAgICB0eXBlLFxuICAgICAgICByZXBvc2l0b3J5RW50cnlcbiAgICAgICkpO1xuICAgICAgbW9zLnB1c2gocmVwb3NpdG9yeUJpbmFyeSk7XG5cbiAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubGlua0JpbmFyeShyZXBvc2l0b3J5QmluYXJ5LCBiaW5hcnkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVwb3NpdG9yeUVudHJ5O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmNsZWFuVXAobW9zKTtcbiAgICAgIHRoaXMuZXJyb3JNc2coKTtcblxuICAgICAgLy8gUHJvcGFnYXRlIGVycm9yXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBzYXZlQmluYXJ5KGZpbGU6IEZpbGUpOiBQcm9taXNlPElSZXN1bHQ8SU1hbmFnZWRPYmplY3RCaW5hcnk+PiB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5QmluYXJ5LmNyZWF0ZShmaWxlLCB7IGM4eV9HbG9iYWw6IHt9IH0gYXMgUGFydGlhbDxJTWFuYWdlZE9iamVjdD4pO1xuICB9XG5cbiAgY3JlYXRlT3JVcGRhdGVSZXBvc2l0b3J5RW50cnkoXG4gICAgbW9kYWw6IE1vZGFsTW9kZWwsXG4gICAgdHlwZTogUmVwb3NpdG9yeVR5cGVcbiAgKTogUHJvbWlzZTxJUmVzdWx0PFJlcG9zaXRvcnlDYXRlZ29yeT4+IHtcbiAgICBjb25zdCB7XG4gICAgICBzZWxlY3RlZDogeyBpZCwgbmFtZSB9LFxuICAgICAgZGVzY3JpcHRpb25cbiAgICB9ID0gbW9kYWw7XG5cbiAgICBjb25zdCBtbyA9IHtcbiAgICAgIGlkLFxuICAgICAgbmFtZTogaWQgPyB1bmRlZmluZWQgOiBuYW1lLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICB0eXBlOiBpZCA/IHVuZGVmaW5lZCA6IHR5cGUsXG4gICAgICBjOHlfR2xvYmFsOiB7fVxuICAgIH07XG5cbiAgICByZXR1cm4gaWRcbiAgICAgID8gKHRoaXMuaW52ZW50b3J5LnVwZGF0ZShtbykgYXMgUHJvbWlzZTxJUmVzdWx0PFJlcG9zaXRvcnlDYXRlZ29yeT4+KVxuICAgICAgOiAodGhpcy5pbnZlbnRvcnkuY3JlYXRlKG1vKSBhcyBQcm9taXNlPElSZXN1bHQ8UmVwb3NpdG9yeUNhdGVnb3J5Pj4pO1xuICB9XG5cbiAgY3JlYXRlUmVwb3NpdG9yeUJpbmFyeShcbiAgICBtb2RhbDogTW9kYWxNb2RlbCxcbiAgICBiaW5hcnlVUkw6IHN0cmluZyxcbiAgICB0eXBlOiBSZXBvc2l0b3J5VHlwZSxcbiAgICBwYXJlbnQ6IFJlcG9zaXRvcnlDYXRlZ29yeVxuICApOiBQcm9taXNlPElSZXN1bHQ8RmlybXdhcmVCaW5hcnkgfCBTb2Z0d2FyZUJpbmFyeSB8IEZpcm13YXJlUGF0Y2hCaW5hcnk+PiB7XG4gICAgY29uc3QgbW8gPSB0aGlzLnByZXBhcmVSZXBvc2l0b3J5QmluYXJ5TU8obW9kYWwsIGJpbmFyeVVSTCwgdHlwZSk7XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNDcmVhdGUobW8sIHBhcmVudCkgYXMgUHJvbWlzZTxcbiAgICAgIElSZXN1bHQ8RmlybXdhcmVCaW5hcnkgfCBTb2Z0d2FyZUJpbmFyeSB8IEZpcm13YXJlUGF0Y2hCaW5hcnk+XG4gICAgPjtcbiAgfVxuXG4gIHByZXBhcmVSZXBvc2l0b3J5QmluYXJ5TU8obW9kYWw6IE1vZGFsTW9kZWwsIGJpbmFyeVVSTDogc3RyaW5nLCB0eXBlOiBSZXBvc2l0b3J5VHlwZSkge1xuICAgIGNvbnN0IHsgdmVyc2lvbiwgcGF0Y2hWZXJzaW9uLCBkZXBlbmRlbmN5IH0gPSBtb2RhbDtcbiAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICB0eXBlOiBSRVBPU0lUT1JZX0JJTkFSWV9UWVBFU1t0eXBlXSxcbiAgICAgIFt0eXBlXToge1xuICAgICAgICB1cmw6IGJpbmFyeVVSTFxuICAgICAgfSxcbiAgICAgIGM4eV9HbG9iYWw6IHt9XG4gICAgfTtcblxuICAgIGlmIChkZXBlbmRlbmN5KSB7XG4gICAgICBzZXQocmVzdWx0LCBbdHlwZSwgJ3ZlcnNpb24nXSwgcGF0Y2hWZXJzaW9uKTtcbiAgICAgIGFzc2lnbihyZXN1bHQsIHtcbiAgICAgICAgYzh5X1BhdGNoOiB7XG4gICAgICAgICAgZGVwZW5kZW5jeTogZGVwZW5kZW5jeS5jOHlfRmlybXdhcmUudmVyc2lvblxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0KHJlc3VsdCwgW3R5cGUsICd2ZXJzaW9uJ10sIHZlcnNpb24pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgbGlua0JpbmFyeShcbiAgICByZXBvc2l0b3J5QmluYXJ5OiBGaXJtd2FyZUJpbmFyeSB8IFNvZnR3YXJlQmluYXJ5LFxuICAgIGJpbmFyeTogSU1hbmFnZWRPYmplY3RCaW5hcnlcbiAgKSB7XG4gICAgY29uc3QgeyBpZDogcmVwb3NpdG9yeUJpbmFyeUlkIH0gPSByZXBvc2l0b3J5QmluYXJ5O1xuICAgIGlmIChiaW5hcnkpIHtcbiAgICAgIGNvbnN0IHsgaWQ6IGJpbmFyeUlkIH0gPSBiaW5hcnk7XG4gICAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQoYmluYXJ5SWQsIHJlcG9zaXRvcnlCaW5hcnlJZCk7XG4gICAgfVxuICB9XG5cbiAgY2xlYW5VcChtb3NUb0RlbGV0ZTogSUlkZW50aWZpZWRbXSkge1xuICAgIG1vc1RvRGVsZXRlLmZvckVhY2gobW8gPT4ge1xuICAgICAgY29uc3QgeyBjOHlfSXNCaW5hcnkgfSA9IG1vO1xuICAgICAgaXNVbmRlZmluZWQoYzh5X0lzQmluYXJ5KSA/IHRoaXMuZGVsZXRlKG1vKSA6IHRoaXMuaW52ZW50b3J5QmluYXJ5LmRlbGV0ZShtbyk7XG4gICAgfSk7XG4gIH1cblxuICBkZWxldGUoZW50aXR5OiBJSWRlbnRpZmllZCk6IFByb21pc2U8SVJlc3VsdDxudWxsPj4ge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5kZWxldGUoZW50aXR5LCB7IGZvcmNlQ2FzY2FkZTogdHJ1ZSB9KTtcbiAgfVxuXG4gIGVycm9yTXNnKCkge1xuICAgIGNvbnN0IG1zZyA9IGdldHRleHQoJ0ZhaWxlZCB0byBzYXZlJyk7XG4gICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgfVxuXG4gIGdldEJhc2VWZXJzaW9uc0NvdW50JChlbnRyeTogSU1hbmFnZWRPYmplY3QpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIGlmICh0aGlzLmlzTGVnYWN5RW50cnkoZW50cnkpKSB7XG4gICAgICByZXR1cm4gb2YoMSk7XG4gICAgfVxuICAgIHJldHVybiBmcm9tKHRoaXMubGlzdEJhc2VWZXJzaW9ucyhlbnRyeSwgeyBwYWdlU2l6ZTogMSwgd2l0aFRvdGFsUGFnZXM6IHRydWUgfSkpLnBpcGUoXG4gICAgICBtYXAoKHsgcGFnaW5nIH0pID0+IHBhZ2luZy50b3RhbFBhZ2VzKVxuICAgICk7XG4gIH1cblxuICBnZXRCYXNlVmVyc2lvbkZyb21NTyhtbzogUmVwb3NpdG9yeUJpbmFyeSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuaXNQYXRjaChtbykgPyBnZXQobW8sICdjOHlfUGF0Y2guZGVwZW5kZW5jeScpIDogZ2V0KG1vLCAnYzh5X0Zpcm13YXJlLnZlcnNpb24nKTtcbiAgfVxuXG4gIGlzUGF0Y2gobW86IFJlcG9zaXRvcnlCaW5hcnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISFnZXQobW8sICdjOHlfUGF0Y2guZGVwZW5kZW5jeScpO1xuICB9XG5cbiAgZ2V0UGF0Y2hWZXJzaW9uc0NvdW50JChlbnRyeTogSU1hbmFnZWRPYmplY3QsIGJhc2VWZXJzaW9uOiBGaXJtd2FyZUJpbmFyeSk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgaWYgKHRoaXMuaXNMZWdhY3lFbnRyeShiYXNlVmVyc2lvbikpIHtcbiAgICAgIHJldHVybiBvZigwKTtcbiAgICB9XG4gICAgcmV0dXJuIGZyb20oXG4gICAgICB0aGlzLmxpc3RQYXRjaFZlcnNpb25zKGVudHJ5LCBiYXNlVmVyc2lvbiwgeyBwYWdlU2l6ZTogMSwgd2l0aFRvdGFsUGFnZXM6IHRydWUgfSlcbiAgICApLnBpcGUobWFwKCh7IHBhZ2luZyB9KSA9PiBwYWdpbmcudG90YWxQYWdlcykpO1xuICB9XG5cbiAgaXNMZWdhY3lFbnRyeShlbnRyeTogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihlbnRyeS51cmwpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIGFsbCB2ZXJzaW9ucyAoYmFzZSBhbmQgcGF0Y2ggb25lcykgb2YgZ2l2ZW4gdG9wIGxldmVsIGVudHJ5LlxuICAgKiBWZXJzaW9ucyBhcmUgb3JkZXJlZCBieSBjcmVhdGlvbiB0aW1lIChhc3N1bWluZyB0aGUgZWFybGllciBjcmVhdGVkLCB0aGUgb2xkZXIgdGhlIHZlcnNpb24pLlxuICAgKiBAcGFyYW0gZW50cnkgVG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqIEBwYXJhbSBwYXJhbXMgQWRkaXRpb25hbCBxdWVyeSBwYXJhbXMuXG4gICAqL1xuICBsaXN0QWxsVmVyc2lvbnMoZW50cnk6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+LCBwYXJhbXMgPSB7fSkge1xuICAgIGlmICh0aGlzLmlzTGVnYWN5RW50cnkoZW50cnkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRCYXNlVmVyc2lvblJlc3VsdExpc3RGb3JMZWdhY3lFbnRyeShlbnRyeSk7XG4gICAgfVxuXG4gICAgY29uc3QgVkVSU0lPTl9GSUxURVJfT1JERVIgPSB7XG4gICAgICBfX2ZpbHRlcjoge30sXG4gICAgICBfX29yZGVyYnk6IFt7ICdjcmVhdGlvblRpbWUuZGF0ZSc6IC0xIH0sIHsgY3JlYXRpb25UaW1lOiAtMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMubGlzdENoaWxkcmVuKGVudHJ5LCBWRVJTSU9OX0ZJTFRFUl9PUkRFUiwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBiYXNlIHZlcnNpb25zIG9mIGdpdmVuIHRvcCBsZXZlbCBlbnRyeS5cbiAgICogVmVyc2lvbnMgYXJlIG9yZGVyZWQgYnkgY3JlYXRpb24gdGltZSAoYXNzdW1pbmcgdGhlIGVhcmxpZXIgY3JlYXRlZCwgdGhlIG9sZGVyIHRoZSB2ZXJzaW9uKS5cbiAgICogQHBhcmFtIGVudHJ5IFRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5LlxuICAgKiBAcGFyYW0gcGFyYW1zIEFkZGl0aW9uYWwgcXVlcnkgcGFyYW1zLlxuICAgKi9cbiAgbGlzdEJhc2VWZXJzaW9ucyhlbnRyeTogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4sIHBhcmFtcyA9IHt9KSB7XG4gICAgaWYgKHRoaXMuaXNMZWdhY3lFbnRyeShlbnRyeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEJhc2VWZXJzaW9uUmVzdWx0TGlzdEZvckxlZ2FjeUVudHJ5KGVudHJ5KTtcbiAgICB9XG5cbiAgICBjb25zdCBOT19QQVRDSF9GSUxURVJfT1JERVIgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICBfX25vdDogeyBfX2hhczogJ2M4eV9QYXRjaCcgfVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgJ2NyZWF0aW9uVGltZS5kYXRlJzogLTEgfSwgeyBjcmVhdGlvblRpbWU6IC0xIH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5saXN0Q2hpbGRyZW4oZW50cnksIE5PX1BBVENIX0ZJTFRFUl9PUkRFUiwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBwYXRjaCB2ZXJzaW9ucyBvZiBnaXZlbiBiYXNlIHZlcnNpb24gdW5kZXIgdGhlIGVudHJ5LlxuICAgKiBWZXJzaW9ucyBhcmUgb3JkZXJlZCBieSBjcmVhdGlvbiB0aW1lIChhc3N1bWluZyB0aGUgZWFybGllciBjcmVhdGVkLCB0aGUgb2xkZXIgdGhlIHZlcnNpb24pLlxuICAgKiBAcGFyYW0gZW50cnkgVG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqIEBwYXJhbSBiYXNlVmVyc2lvbiBCYXNlIHZlcnNpb24uXG4gICAqIEBwYXJhbSBwYXJhbXMgQWRkaXRpb25hbCBxdWVyeSBwYXJhbXMuXG4gICAqL1xuICBsaXN0UGF0Y2hWZXJzaW9ucyhlbnRyeTogSU1hbmFnZWRPYmplY3QsIGJhc2VWZXJzaW9uOiBGaXJtd2FyZUJpbmFyeSB8IHN0cmluZywgcGFyYW1zID0ge30pIHtcbiAgICBjb25zdCB2ZXJzaW9uID0gaXNTdHJpbmcoYmFzZVZlcnNpb24pID8gYmFzZVZlcnNpb24gOiBnZXQoYmFzZVZlcnNpb24sICdjOHlfRmlybXdhcmUudmVyc2lvbicpO1xuICAgIGNvbnN0IFBBVENIX0ZJTFRFUl9PUkRFUiA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgICdjOHlfUGF0Y2guZGVwZW5kZW5jeSc6IHZlcnNpb25cbiAgICAgIH0sXG4gICAgICBfX29yZGVyYnk6IFt7ICdjcmVhdGlvblRpbWUuZGF0ZSc6IC0xIH0sIHsgY3JlYXRpb25UaW1lOiAtMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMubGlzdENoaWxkcmVuKGVudHJ5LCBQQVRDSF9GSUxURVJfT1JERVIsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgcGF0Y2ggdmVyc2lvbnMgb2YgZ2l2ZW4gYmFzZSB2ZXJzaW9uIHVuZGVyIHRoZSBlbnRyeSBpbmNsdWRpbmcgdGhlIGJhc2UgdmVyc2lvbi5cbiAgICogVmVyc2lvbnMgYXJlIG9yZGVyZWQgYnkgY3JlYXRpb24gdGltZSAoYXNzdW1pbmcgdGhlIGVhcmxpZXIgY3JlYXRlZCwgdGhlIG9sZGVyIHRoZSB2ZXJzaW9uKS5cbiAgICogSW4gdGVybXMgb2YgbGVnYWN5IGJhc2UgdmVyc2lvbiB0aGUgZW50cnkgZ2V0cyB0cmFuc2Zvcm1lZCB0byBmaXQgdGhlIG5lZWRlZCBkYXRhIG1vZGVsLlxuICAgKiBAcGFyYW0gZW50cnkgVG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqIEBwYXJhbSBiYXNlVmVyc2lvbiBCYXNlIHZlcnNpb24uXG4gICAqIEBwYXJhbSBwYXJhbXMgQWRkaXRpb25hbCBxdWVyeSBwYXJhbXMuXG4gICAqL1xuICBsaXN0QmFzZVZlcnNpb25BbmRQYXRjaGVzKGVudHJ5OiBJTWFuYWdlZE9iamVjdCwgYmFzZVZlcnNpb246IElNYW5hZ2VkT2JqZWN0LCBwYXJhbXMgPSB7fSkge1xuICAgIGlmICh0aGlzLmlzTGVnYWN5RW50cnkoZW50cnkpKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgZGF0YTogW1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24oXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGM4eV9GaXJtd2FyZToge1xuICAgICAgICAgICAgICAgIHZlcnNpb246IGVudHJ5LnZlcnNpb24sXG4gICAgICAgICAgICAgICAgdXJsOiBlbnRyeS51cmxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVudHJ5XG4gICAgICAgICAgKVxuICAgICAgICBdXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBQQVRDSF9GSUxURVJfT1JERVIgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICBfX29yOiB7XG4gICAgICAgICAgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JzogYmFzZVZlcnNpb24uYzh5X0Zpcm13YXJlLnZlcnNpb24sXG4gICAgICAgICAgJ2M4eV9GaXJtd2FyZS52ZXJzaW9uJzogYmFzZVZlcnNpb24uYzh5X0Zpcm13YXJlLnZlcnNpb25cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JzogMSB9LCB7ICdjOHlfRmlybXdhcmUudmVyc2lvbic6IDEgfV1cbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmxpc3RDaGlsZHJlbihlbnRyeSwgUEFUQ0hfRklMVEVSX09SREVSLCBwYXJhbXMpO1xuICB9XG5cbiAgbGlzdENoaWxkcmVuKGVudHJ5OiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiwgZmlsdGVycyA9IHt9LCBwYXJhbXM6IGFueSA9IHt9KSB7XG4gICAgY29uc3QgY2hpbGRyZW5GaWx0ZXJzID0geyBfX2J5Z3JvdXBpZDogZW50cnkuaWQgfTtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZpbHRlcnMsIGNoaWxkcmVuRmlsdGVycyk7XG4gICAgLy8gRklYTUU6IG5lZWRlZCBiZWNhdXNlIG9mIGlzc3VlIGluIGZvck9mIGRpcmVjdGl2ZSAoLi4uKVxuICAgIHBhcmFtcy53aXRoVG90YWxQYWdlcyA9IHRydWU7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5Lmxpc3RRdWVyeShxdWVyeSwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaGVzIGFsbCBpdGVtcyBmcm9tIHRoZSBsaXN0IHN0YXJ0aW5nIHdpdGggdGhlIHByb3ZpZGVkIHBhZ2UuXG4gICAqIEBwYXJhbSBmaXJzdFBhZ2UgVGhlIGZpcnN0IHBhZ2Ugb2YgdGhlIGxpc3QgdG8gZmV0Y2ggYWxsIGl0ZW1zIGZvci5cbiAgICovXG4gIGFzeW5jIGZldGNoQWxsSXRlbXNGcm9tTGlzdChmaXJzdFBhZ2UpIHtcbiAgICBsZXQgYWxsSXRlbXM7XG5cbiAgICBpZiAoIWZpcnN0UGFnZS50aGVuKSB7XG4gICAgICBhbGxJdGVtcyA9IFsuLi5maXJzdFBhZ2VdO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgeyBwYWdpbmcsIGRhdGE6IGl0ZW1zIH0gPSBhd2FpdCBmaXJzdFBhZ2U7XG4gICAgICBhbGxJdGVtcyA9IFsuLi5pdGVtc107XG5cbiAgICAgIHdoaWxlIChwYWdpbmcgJiYgcGFnaW5nLm5leHRQYWdlKSB7XG4gICAgICAgICh7IHBhZ2luZywgZGF0YTogaXRlbXMgfSA9IGF3YWl0IHBhZ2luZy5uZXh0KCkpO1xuICAgICAgICBhbGxJdGVtcyA9IFsuLi5hbGxJdGVtcywgLi4uaXRlbXNdO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhbGxJdGVtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5IG1hbmFnZWQgb2JqZWN0IGZvciBiYXNlIG9yIHBhdGNoIHZlcnNpb24uXG4gICAqIEBwYXJhbSBtbyBCYXNlIG9yIHBhdGNoIHZlcnNpb24gbWFuYWdlZCBvYmplY3Qgd2l0aCBwYXJlbnRzLlxuICAgKi9cbiAgZ2V0UmVwb3NpdG9yeUVudHJ5TU8kKG1vOiBJTWFuYWdlZE9iamVjdCk6IE9ic2VydmFibGU8SU1hbmFnZWRPYmplY3QgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIW1vKSB7XG4gICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcbiAgICB9XG4gICAgY29uc3QgW3JlZmVyZW5jZV0gPSBnZXQobW8sICdhZGRpdGlvblBhcmVudHMucmVmZXJlbmNlcycpO1xuICAgIGNvbnN0IGlkID0gZ2V0KHJlZmVyZW5jZSwgJ21hbmFnZWRPYmplY3QuaWQnKTtcbiAgICByZXR1cm4gaWRcbiAgICAgID8gZnJvbSh0aGlzLmludmVudG9yeS5kZXRhaWwoaWQsIHsgd2l0aENoaWxkcmVuOiBmYWxzZSB9KSkucGlwZShtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKSlcbiAgICAgIDogb2YodW5kZWZpbmVkKTtcbiAgfVxuICAvKipcbiAgICogR2V0cyBiYXNlIG9yIHBhdGNoIHZlcnNpb24gbWFuYWdlZCBvYmplY3QuXG4gICAqIEBwYXJhbSBkZXZpY2VSZXBvc2l0b3J5RnJhZ21lbnQgRGV2aWNlIHJlcG9zaXRvcnkgZnJhZ21lbnQuXG4gICAqIEBwYXJhbSB0eXBlIFRvcCBsZXZlbCByZXBvc2l0b3J5IGVudHJ5IHR5cGUuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uIENvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggb3B0aW9uczpcbiAgICogLSAqKnNraXBMZWdhY3kqKiAtIGBib29sZWFuYCAtIEV4Y2x1ZGUgbGVnYWN5IGVudHJpZXMuXG4gICAqIC0gKipmaWx0ZXJzKiogLSBgb2JqZWN0YCAtIEZpbHRlciBvYmplY3QuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIGFzIGl0IGRvZXNuJ3Qgc3VwcG9ydCAnbWlzc2luZyB1cmwnIGNhc2VcbiAgICovXG4gIGdldFJlcG9zaXRvcnlCaW5hcnlNb0J5VmVyc2lvbihcbiAgICBkZXZpY2VSZXBvc2l0b3J5RnJhZ21lbnQ6IERldmljZUZpcm13YXJlIHwgRGV2aWNlU29mdHdhcmUsXG4gICAgdHlwZTogUmVwb3NpdG9yeVR5cGUsXG4gICAgeyBza2lwTGVnYWN5ID0gZmFsc2UsIGZpbHRlcnMgPSB7fSB9OiB7IHNraXBMZWdhY3k/OiBib29sZWFuOyBmaWx0ZXJzPzogb2JqZWN0IH0gPSB7fVxuICApOiBQcm9taXNlPElNYW5hZ2VkT2JqZWN0PiB7XG4gICAgY29uc3QgeyB2ZXJzaW9uLCB1cmwsIG5hbWUgfSA9IGRldmljZVJlcG9zaXRvcnlGcmFnbWVudDtcbiAgICBjb25zdCByZXBvc2l0b3J5QmluYXJ5VHlwZSA9IFJFUE9TSVRPUllfQklOQVJZX1RZUEVTW3R5cGVdO1xuICAgIGxldCBxdWVyeTtcbiAgICBjb25zdCBuZXdNb2RlbEJhc2VWZXJzaW9uUXVlcnkgPSB7XG4gICAgICBbYCR7dHlwZX0udmVyc2lvbmBdOiB2ZXJzaW9uLFxuICAgICAgW2Ake3R5cGV9LnVybGBdOiB1cmwsXG4gICAgICB0eXBlOiByZXBvc2l0b3J5QmluYXJ5VHlwZVxuICAgIH07XG4gICAgY29uc3QgbGVnYWN5VmVyc2lvblF1ZXJ5ID0geyB1cmwsIHR5cGUsIG5hbWUgfTtcbiAgICBmaWx0ZXJzID0geyB3aXRoQ2hpbGRyZW46IGZhbHNlLCB3aXRoUGFyZW50czogdHJ1ZSwgLi4uZmlsdGVycyB9O1xuXG4gICAgaWYgKHNraXBMZWdhY3kpIHtcbiAgICAgIHF1ZXJ5ID0ge1xuICAgICAgICBfX2FuZDoge1xuICAgICAgICAgIC4uLm5ld01vZGVsQmFzZVZlcnNpb25RdWVyeVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBxdWVyeSA9IHtcbiAgICAgICAgX19vcjogW3sgX19hbmQ6IHsgLi4ubmV3TW9kZWxCYXNlVmVyc2lvblF1ZXJ5IH0gfSwgeyBfX2FuZDogeyAuLi5sZWdhY3lWZXJzaW9uUXVlcnkgfSB9XVxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXJzKS50aGVuKCh7IGRhdGEgfSkgPT4gaGVhZChkYXRhKSk7XG4gIH1cblxuICBnZXRCaW5hcnlOYW1lJChiaW5hcnlVcmw6IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgaWYgKCFiaW5hcnlVcmwpIHtcbiAgICAgIHJldHVybiBvZignLS0tJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYmluYXJ5SWQgPSB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwoYmluYXJ5VXJsKTtcbiAgICBpZiAoIWJpbmFyeUlkKSB7XG4gICAgICByZXR1cm4gb2YoYmluYXJ5VXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LmRldGFpbCQoYmluYXJ5SWQpLnBpcGUobWFwKG1vID0+IG1vLm5hbWUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYW4gaW52ZW50b3J5IHF1ZXJ5IG9iamVjdCB3aGljaCBjYW4gYmUgdXNlZCB0byBmaW5kXG4gICAqIHJlcG9zaXRvcnkgZW50cmllcyBvZiBzcGVjaWZpZWQgdHlwZSBtYXRjaGluZyB0aGUgdHlwZSBvZiBwcm92aWRlZCBkZXZpY2UuXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5VHlwZSBUaGUgdHlwZSBvZiByZXBvc2l0b3J5IGVudHJpZXMgd2hpY2ggd2lsbCBiZSBxdWVyaWVkIHdpdGggdGhlIGdlbmVyYXRlZCBxdWVyeS5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCBtYXRjaGluZyByZXBvc2l0b3J5IGVudHJpZXMgd2lsbCBiZSBxdWVyaWVkIHdpdGggdGhlIGdlbmVyYXRlZCBxdWVyeS5cbiAgICovXG4gIGdldERldmljZVR5cGVRdWVyeShyZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGUsIGRldmljZTogSU1hbmFnZWRPYmplY3QpOiBvYmplY3Qge1xuICAgIGxldCByZXN1bHQgPSB7IHR5cGU6IHJlcG9zaXRvcnlUeXBlIH07XG4gICAgaWYgKGRldmljZS50eXBlKSB7XG4gICAgICBpZiAocmVwb3NpdG9yeVR5cGUgPT09IFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04pIHtcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIocmVzdWx0LCB7XG4gICAgICAgICAgX19vcjogW3sgZGV2aWNlVHlwZTogZGV2aWNlLnR5cGUgfSwgeyBfX25vdDogeyBfX2hhczogYGRldmljZVR5cGVgIH0gfV1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihyZXN1bHQsIHtcbiAgICAgICAgICBfX29yOiBbeyAnYzh5X0ZpbHRlci50eXBlJzogZGV2aWNlLnR5cGUgfSwgeyBfX25vdDogeyBfX2hhczogYGM4eV9GaWx0ZXIudHlwZWAgfSB9XVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYW4gaW52ZW50b3J5IHF1ZXJ5IG9iamVjdCB3aGljaCBjYW4gYmUgdXNlZCB0byBmaW5kIGNvbmZpZ3VyYXRpb24gcmVwb3NpdG9yeSBlbnRyaWVzXG4gICAqIG1hdGNoaW5nIHRoZSB0eXBlIG9mIHByb3ZpZGVkIGRldmljZSBhbmQgc3BlY2lmaWVkIGNvbmZpZ3VyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCBtYXRjaGluZyByZXBvc2l0b3J5IGVudHJpZXMgd2lsbCBiZSBxdWVyaWVkIHdpdGggdGhlIGdlbmVyYXRlZCBxdWVyeS5cbiAgICogQHBhcmFtIGNvbmZpZ3VyYXRpb25UeXBlIENvbmZpZ3VyYXRpb24gdHlwZSBmb3Igd2hpY2ggbWF0Y2hpbmcgcmVwb3NpdG9yeSBlbnRyaWVzIHdpbGwgYmUgcXVlcmllZCB3aXRoIHRoZSBnZW5lcmF0ZWQgcXVlcnkuXG4gICAqL1xuICBnZXRDb25maWd1cmF0aW9uVHlwZVF1ZXJ5KGRldmljZTogSU1hbmFnZWRPYmplY3QsIGNvbmZpZ3VyYXRpb25UeXBlOiBzdHJpbmcpOiBvYmplY3Qge1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5nZXREZXZpY2VUeXBlUXVlcnkoUmVwb3NpdG9yeVR5cGUuQ09ORklHVVJBVElPTiwgZGV2aWNlKTtcbiAgICByZXR1cm4gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIocXVlcnksIHtcbiAgICAgIF9fb3I6IFt7IGNvbmZpZ3VyYXRpb25UeXBlIH0sIHsgX19ub3Q6IHsgX19oYXM6IGBjb25maWd1cmF0aW9uVHlwZWAgfSB9XVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxpc3Qgb2Ygc29mdHdhcmUgaW5zdGFsbGVkIGluIHRoZSBkZXZpY2UgaW4gdGhlIHVuaWZvcm0gZm9ybWF0LlxuICAgKiBTdXBwb3J0cyBjOHlfU29mdHdhcmVMaXN0IGFuZCBjOHlfU29mdHdhcmUgZnJhZ21lbnRzLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2Ugd2hvc2Ugc29mdHdhcmUgbGlzdCBzaG91bGQgYmUgcmV0dXJuZWQuXG4gICAqL1xuICBnZXREZXZpY2VTb2Z0d2FyZUxpc3QoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IERldmljZVNvZnR3YXJlW10ge1xuICAgIGlmIChkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdCkge1xuICAgICAgcmV0dXJuIGNsb25lRGVlcChkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdCk7XG4gICAgfVxuICAgIGlmIChkZXZpY2UuYzh5X1NvZnR3YXJlKSB7XG4gICAgICByZXR1cm4gX21hcChkZXZpY2UuYzh5X1NvZnR3YXJlLCAodmVyc2lvbiwgbmFtZSkgPT4gKHsgbmFtZSwgdmVyc2lvbiB9KSk7XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyBhIHNvZnR3YXJlIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgdGhlIGxpc3Qgb2YgY2hhbmdlcywgYW5kIHNlbmRzIGl0IHRvIHRoZSBkZXZpY2UuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSB3aGljaCB0aGUgb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZCBmb3IgYW5kIHNlbnQgdG8uXG4gICAqIEBwYXJhbSBjaGFuZ2VzIFRoZSBsaXN0IG9mIHNvZnR3YXJlIGNoYW5nZXMgd2hpY2ggc2hvdWxkIGJlIGFwcGxpZWQuXG4gICAqL1xuICBhc3luYyBjcmVhdGVTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIGNoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW11cbiAgKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gdGhpcy5nZXRTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbihkZXZpY2UsIGNoYW5nZXMpO1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5vcGVyYXRpb24uY3JlYXRlKG9wZXJhdGlvbikpLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBzb2Z0d2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIGNoYW5nZXMuXG4gICAqIFJldHVybmVkIG9wZXJhdGlvbiB0eXBlIGRlcGVuZHMgb24gZGV2aWNlJ3Mgc3VwcG9ydGVkIG9wZXJhdGlvbnMuXG4gICAqIFN1cHBvcnRzIGM4eV9Tb2Z0d2FyZVVwZGF0ZSwgYzh5X1NvZnR3YXJlTGlzdCwgYW5kIGM4eV9Tb2Z0d2FyZSBvcGVyYXRpb25zLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQuXG4gICAqIEBwYXJhbSBjaGFuZ2VzIFRoZSBsaXN0IG9mIHNvZnR3YXJlIGNoYW5nZXMgd2hpY2ggc2hvdWxkIGJlIGFwcGxpZWQuXG4gICAqL1xuICBnZXRTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBjaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdKTogSU9wZXJhdGlvbiB7XG4gICAgY29uc3Qgb3BlcmF0aW9uOiBJT3BlcmF0aW9uID0ge1xuICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgIGRlc2NyaXB0aW9uOiBgQXBwbHkgc29mdHdhcmUgY2hhbmdlczogJHtjaGFuZ2VzXG4gICAgICAgIC5tYXAoXG4gICAgICAgICAgY2hhbmdlID0+XG4gICAgICAgICAgICBgJHtjaGFuZ2UuYWN0aW9ufSBcIiR7Y2hhbmdlLm5hbWV9XCIke1xuICAgICAgICAgICAgICBjaGFuZ2UudmVyc2lvbiA/IGAgKHZlcnNpb246ICR7Y2hhbmdlLnZlcnNpb259KWAgOiAnJ1xuICAgICAgICAgICAgfWBcbiAgICAgICAgKVxuICAgICAgICAuam9pbignLCAnKX1gXG4gICAgfTtcbiAgICBpZiAoZGV2aWNlLmM4eV9TdXBwb3J0ZWRPcGVyYXRpb25zLmluY2x1ZGVzKCdjOHlfU29mdHdhcmVVcGRhdGUnKSkge1xuICAgICAgb3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZVVwZGF0ZSA9IGNsb25lRGVlcChjaGFuZ2VzKTtcbiAgICB9IGVsc2UgaWYgKGRldmljZS5jOHlfU3VwcG9ydGVkT3BlcmF0aW9ucy5pbmNsdWRlcygnYzh5X1NvZnR3YXJlTGlzdCcpKSB7XG4gICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCA9IGNsb25lRGVlcChkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdCkgfHwgW107XG4gICAgICBjaGFuZ2VzLmZvckVhY2goY2hhbmdlID0+IHtcbiAgICAgICAgY29uc3QgZGV2aWNlU29mdHdhcmU6IERldmljZVNvZnR3YXJlID0gcGljayhjaGFuZ2UsIFsnbmFtZScsICd2ZXJzaW9uJywgJ3VybCddKTtcbiAgICAgICAgaWYgKGNoYW5nZS5hY3Rpb24gPT09ICdkZWxldGUnKSB7XG4gICAgICAgICAgcmVtb3ZlKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVMaXN0LCBkZXZpY2VTb2Z0d2FyZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNoYW5nZS5hY3Rpb24gPT09ICdpbnN0YWxsJykge1xuICAgICAgICAgIG9wZXJhdGlvbi5jOHlfU29mdHdhcmVMaXN0LnB1c2goZGV2aWNlU29mdHdhcmUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGRldmljZS5jOHlfU3VwcG9ydGVkT3BlcmF0aW9ucy5pbmNsdWRlcygnYzh5X1NvZnR3YXJlJykpIHtcbiAgICAgIG9wZXJhdGlvbi5jOHlfU29mdHdhcmUgPSBjbG9uZURlZXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZSkgfHwge307XG4gICAgICBjaGFuZ2VzLmZvckVhY2goY2hhbmdlID0+IHtcbiAgICAgICAgaWYgKGNoYW5nZS5hY3Rpb24gPT09ICdkZWxldGUnKSB7XG4gICAgICAgICAgZGVsZXRlIG9wZXJhdGlvbi5jOHlfU29mdHdhcmVbY2hhbmdlLm5hbWVdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnaW5zdGFsbCcpIHtcbiAgICAgICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlW2NoYW5nZS5uYW1lXSA9IGNoYW5nZS52ZXJzaW9uO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG9wZXJhdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0cyB0aGUgbGlzdCBvZiBkZXZpY2Ugc29mdHdhcmUgY2hhbmdlcyBmcm9tIGdpdmVuIG9wZXJhdGlvbiBpbiB0aGUgY29udGV4dCBvZiBnaXZlbiBkZXZpY2UuXG4gICAqIEBwYXJhbSBvcGVyYXRpb24gVGhlIG9wZXJhdGlvbiBmcm9tIHdoaWNoIHRoZSBsaXN0IHNob3VsZCBiZSBleHRyYWN0ZWQuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIHRhcmdldCBkZXZpY2Ugb2YgdGhlIG9wZXJhdGlvbi5cbiAgICovXG4gIGdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21PcGVyYXRpb24oXG4gICAgb3BlcmF0aW9uOiBJT3BlcmF0aW9uLFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3RcbiAgKTogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSB7XG4gICAgaWYgKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVVcGRhdGUpIHtcbiAgICAgIHJldHVybiBjbG9uZURlZXAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZVVwZGF0ZSk7XG4gICAgfVxuICAgIGlmIChvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlU29mdHdhcmVDaGFuZ2VzRnJvbVNvZnR3YXJlTGlzdE9wZXJhdGlvbihvcGVyYXRpb24sIGRldmljZSk7XG4gICAgfVxuICAgIGlmIChvcGVyYXRpb24uYzh5X1NvZnR3YXJlKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tU29mdHdhcmVPcGVyYXRpb24ob3BlcmF0aW9uLCBkZXZpY2UpO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBmaXJtd2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIHRoZSBzZWxlY3RlZCByZXBvc2l0b3J5IGJpbmFyeSwgYW5kIHNlbmRzIGl0IHRvIHRoZSBkZXZpY2UuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSB3aGljaCB0aGUgb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZCBmb3IgYW5kIHNlbnQgdG8uXG4gICAqIEBwYXJhbSBzZWxlY3RlZE9wdGlvbiBUaGUgc2VsZWN0ZWQgcmVwb3NpdG9yeSBiaW5hcnkgb3B0aW9uLlxuICAgKi9cbiAgYXN5bmMgY3JlYXRlRmlybXdhcmVVcGRhdGVPcGVyYXRpb24oXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBzZWxlY3RlZE9wdGlvbjogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5XG4gICk6IFByb21pc2U8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMuZ2V0RmlybXdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlLCBzZWxlY3RlZE9wdGlvbik7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLm9wZXJhdGlvbi5jcmVhdGUob3BlcmF0aW9uKSkuZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyBhIGZpcm13YXJlIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgc2VsZWN0ZWQgdmVyc2lvbi5cbiAgICogU3VwcG9ydHMgYzh5X0Zpcm13YXJlIG9wZXJhdGlvbi5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCBvcGVyYXRpb24gc2hvdWxkIGJlIHByZXBhcmVkLlxuICAgKiBAcGFyYW0gc2VsZWN0ZWRPcHRpb24gU2VsZWN0ZWQgZmlybXdhcmUgdmVyc2lvbi5cbiAgICovXG4gIGdldEZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRPcHRpb246IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVxuICApOiBJT3BlcmF0aW9uIHtcbiAgICBkZWxldGUgc2VsZWN0ZWRPcHRpb24uaWQ7XG5cbiAgICBjb25zdCBvcGVyYXRpb246IElPcGVyYXRpb24gPSB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGBVcGRhdGUgZmlybXdhcmUgdG86IFwiJHtzZWxlY3RlZE9wdGlvbi5uYW1lfVwiJHtcbiAgICAgICAgc2VsZWN0ZWRPcHRpb24udmVyc2lvbiA/IGAgKHZlcnNpb246ICR7c2VsZWN0ZWRPcHRpb24udmVyc2lvbn0pYCA6ICcnXG4gICAgICB9YCxcbiAgICAgIGM4eV9GaXJtd2FyZTogeyAuLi5zZWxlY3RlZE9wdGlvbiB9XG4gICAgfTtcblxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBjb25maWd1cmF0aW9uIGZpbGUgdXBsb2FkIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICogQHBhcmFtIGNvbmZpZ3VyYXRpb25UeXBlIFNlbGVjdGVkIGNvbmZpZ3VyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGlzTGVnYWN5ICBBIGxlZ2FjeSBvcGVyYXRpb24gaXMgY3JlYXRlZCB3aXRob3V0IGEgY29uZmlndXJhdGlvblR5cGUuXG4gICAqL1xuICBnZXRVcGxvYWRDb25maWd1cmF0aW9uRmlsZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBzdHJpbmcsXG4gICAgaXNMZWdhY3k6IGJvb2xlYW4gPSBmYWxzZVxuICApOiBJT3BlcmF0aW9uIHtcbiAgICBpZiAoaXNMZWdhY3kpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgUmV0cmlldmUgY29uZmlndXJhdGlvbiBzbmFwc2hvdCBmcm9tIGRldmljZSAke2RldmljZS5uYW1lfWAsXG4gICAgICAgIGM4eV9VcGxvYWRDb25maWdGaWxlOiB7fVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBkZXNjcmlwdGlvbjogYFJldHJpZXZlICR7Y29uZmlndXJhdGlvblR5cGV9IGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZnJvbSBkZXZpY2UgJHtcbiAgICAgICAgZGV2aWNlLm5hbWVcbiAgICAgIH1gLFxuICAgICAgYzh5X1VwbG9hZENvbmZpZ0ZpbGU6IHtcbiAgICAgICAgdHlwZTogY29uZmlndXJhdGlvblR5cGVcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgY29uZmlndXJhdGlvbiBmaWxlIGRvd25sb2FkIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICogQHBhcmFtIGNvbmZpZ3VyYXRpb25UeXBlIFNlbGVjdGVkIGNvbmZpZ3VyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGJpbmFyeVVybCBUaGUgdXJsIG9mIGEgYmluYXJ5IHRvIGJlIGRvd25sb2FkZWQuXG4gICAqIEBwYXJhbSBpc0xlZ2FjeSBBIGxlZ2FjeSBvcGVyYXRpb24gaXMgY3JlYXRlZCB3aXRob3V0IGEgY29uZmlndXJhdGlvblR5cGUuXG4gICAqL1xuICBnZXREb3dubG9hZENvbmZpZ3VyYXRpb25GaWxlT3BlcmF0aW9uKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgY29uZmlndXJhdGlvblR5cGU6IHN0cmluZyxcbiAgICBjb25maWdTbmFwc2hvdDogQ29uZmlndXJhdGlvblNuYXBzaG90LFxuICAgIGlzTGVnYWN5OiBib29sZWFuID0gZmFsc2VcbiAgKTogSU9wZXJhdGlvbiB7XG4gICAgaWYgKGlzTGVnYWN5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFNlbmQgY29uZmlndXJhdGlvbiBzbmFwc2hvdCAke2NvbmZpZ1NuYXBzaG90Lm5hbWV9IHRvIGRldmljZSAke2RldmljZS5uYW1lfWAsXG4gICAgICAgIGM4eV9Eb3dubG9hZENvbmZpZ0ZpbGU6IHtcbiAgICAgICAgICB1cmw6IGNvbmZpZ1NuYXBzaG90LmJpbmFyeVVybCxcbiAgICAgICAgICBjOHlfQ29uZmlndXJhdGlvbkR1bXA6IHtcbiAgICAgICAgICAgIGlkOiBjb25maWdTbmFwc2hvdC5pZFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBkZXNjcmlwdGlvbjogYFNlbmQgY29uZmlndXJhdGlvbiBzbmFwc2hvdCAke1xuICAgICAgICBjb25maWdTbmFwc2hvdC5uYW1lXG4gICAgICB9IG9mIGNvbmZpZ3VyYXRpb24gdHlwZSAke2NvbmZpZ3VyYXRpb25UeXBlfSB0byBkZXZpY2UgJHtkZXZpY2UubmFtZX1gLFxuICAgICAgYzh5X0Rvd25sb2FkQ29uZmlnRmlsZToge1xuICAgICAgICB1cmw6IGNvbmZpZ1NuYXBzaG90LmJpbmFyeVVybCxcbiAgICAgICAgdHlwZTogY29uZmlndXJhdGlvblR5cGVcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxhc3QgZmlybXdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlLlxuICAgKiBMb29rcyBmb3IgYzh5X0Zpcm13YXJlIG9wZXJhdGlvbnMuXG4gICAqIEBwYXJhbSBkZXZpY2VJZCBUaGUgSUQgb2YgdGhlIGRldmljZSB0byBmaW5kIGFuIG9wZXJhdGlvbiBmb3IuXG4gICAqL1xuICBhc3luYyBnZXRMYXN0RmlybXdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlcik6IFByb21pc2U8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGRhdGVGcm9tOiBuZXcgRGF0ZSgwKS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0ZVRvOiBuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpLFxuICAgICAgcmV2ZXJ0OiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDFcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmdldEZpcnN0TWF0Y2hpbmdPcGVyYXRpb24oW3sgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X0Zpcm13YXJlJyB9XSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyB0aGUgbGFzdCBzb2Z0d2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UuXG4gICAqIExvb2tzIGZvciBjOHlfU29mdHdhcmVVcGRhdGUsIGM4eV9Tb2Z0d2FyZUxpc3QsIG9yIGM4eV9Tb2Z0d2FyZSBvcGVyYXRpb25zLlxuICAgKiBAcGFyYW0gZGV2aWNlSWQgVGhlIElEIG9mIHRoZSBkZXZpY2UgdG8gZmluZCBhbiBvcGVyYXRpb24gZm9yLlxuICAgKi9cbiAgYXN5bmMgZ2V0TGFzdFNvZnR3YXJlVXBkYXRlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBkYXRlRnJvbTogbmV3IERhdGUoMCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRGaXJzdE1hdGNoaW5nT3BlcmF0aW9uKFtcbiAgICAgIHsgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X1NvZnR3YXJlVXBkYXRlJyB9LFxuICAgICAgeyAuLi5maWx0ZXJzLCBmcmFnbWVudFR5cGU6ICdjOHlfU29mdHdhcmVMaXN0JyB9LFxuICAgICAgeyAuLi5maWx0ZXJzLCBmcmFnbWVudFR5cGU6ICdjOHlfU29mdHdhcmUnIH1cbiAgICBdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJdGVyYXRlcyBvdmVyIHRoZSBsaXN0IG9mIGZpbHRlcnMgYW5kIHF1ZXJpZXMgdGhlIG9wZXJhdGlvbnMuXG4gICAqIElmIGEgcXVlcnkgcmV0dXJucyBhdCBsZWFzdCBvbmUgb3BlcmF0aW9uLCB0aGUgZmlyc3Qgb25lIHdpbGwgYmUgcmV0dXJuZWQuXG4gICAqIE90aGVyd2lzZSB0aGUgbmV4dCBxdWVyeSB3aWxsIGJlIHBlcmZvcm1lZC5cbiAgICogSWYgbm9uZSBvZiB0aGUgcXVlcmllcyByZXR1cm5zIGFueSBvcGVyYXRpb24sIG51bGwgd2lsbCBiZSByZXR1cm5lZC5cbiAgICogQHBhcmFtIGZpbHRlcnNMaXN0IFRoZSBsaXN0IG9mIGZpbHRlcnMgZm9yIHRoZSBxdWVyaWVzLlxuICAgKi9cbiAgYXN5bmMgZ2V0Rmlyc3RNYXRjaGluZ09wZXJhdGlvbihmaWx0ZXJzTGlzdDogYW55W10pOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBsZXQgbWF0Y2hpbmdPcGVyYXRpb24gPSBudWxsO1xuXG4gICAgZm9yIChjb25zdCBmaWx0ZXJzIG9mIGZpbHRlcnNMaXN0KSB7XG4gICAgICBjb25zdCBvcGVyYXRpb25zID0gKGF3YWl0IHRoaXMub3BlcmF0aW9uLmxpc3QoZmlsdGVycykpLmRhdGE7XG4gICAgICBpZiAob3BlcmF0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgbWF0Y2hpbmdPcGVyYXRpb24gPSBvcGVyYXRpb25zWzBdO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWF0Y2hpbmdPcGVyYXRpb247XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyB0aGUgb3BlcmF0aW9uIGFuZCByZXR1cm5zIGFuIG9ic2VydmFibGUgdG8gdHJhY2sgaXRzIHByb2dyZXNzLlxuICAgKiBGYWlscyB0aGUgb2JzZXJ2YWJsZSB3aGVuIHRoZSBvcGVyYXRpb24gcmV0dXJucyBGQUlMRUQgc3RhdHVzLlxuICAgKiBDb21wbGV0ZXMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgU1VDQ0VTU0ZVTCBzdGF0dXMuXG4gICAqIEBwYXJhbSBvcGVyYXRpb24gVGhlIG9wZXJhdGlvbiB0byBjcmVhdGUgYW5kIHRyYWNrLlxuICAgKi9cbiAgY3JlYXRlT2JzZXJ2ZWRPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogT2JzZXJ2YWJsZTxJT3BlcmF0aW9uPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5vcGVyYXRpb24uY3JlYXRlKG9wZXJhdGlvbikpLnBpcGUoXG4gICAgICBtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKSxcbiAgICAgIHRha2UoMSksXG4gICAgICBzd2l0Y2hNYXAoY3JlYXRlZE9wZXJhdGlvbiA9PiB0aGlzLm9ic2VydmVPcGVyYXRpb24oY3JlYXRlZE9wZXJhdGlvbikpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIG9ic2VydmFibGUgdG8gdHJhY2sgcHJvZ3Jlc3Mgb2YgZ2l2ZW4gb3BlcmF0aW9uLlxuICAgKiBGYWlscyB0aGUgb2JzZXJ2YWJsZSB3aGVuIHRoZSBvcGVyYXRpb24gcmV0dXJucyBGQUlMRUQgc3RhdHVzLlxuICAgKiBDb21wbGV0ZXMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgU1VDQ0VTU0ZVTCBzdGF0dXMuXG4gICAqIEBwYXJhbSBvcGVyYXRpb24gVGhlIG9wZXJhdGlvbiB0byBiZSBvYnNlcnZlZC5cbiAgICovXG4gIG9ic2VydmVPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogT2JzZXJ2YWJsZTxJT3BlcmF0aW9uPiB7XG4gICAgY29uc3Qgb2JzZXJ2ZWRPcGVyYXRpb24kID0gb2Yob3BlcmF0aW9uKTtcbiAgICBjb25zdCBvcGVyYXRpb25VcGRhdGVzJCA9IG9ic2VydmVkT3BlcmF0aW9uJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKG9ic2VydmVkT3BlcmF0aW9uID0+XG4gICAgICAgIHRoaXMucmVhbHRpbWUub2JzZXJ2YWJsZShgL29wZXJhdGlvbnMvJHtvYnNlcnZlZE9wZXJhdGlvbi5kZXZpY2VJZH1gKVxuICAgICAgKSxcbiAgICAgIG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpLFxuICAgICAgd2l0aExhdGVzdEZyb20ob2JzZXJ2ZWRPcGVyYXRpb24kKSxcbiAgICAgIGZpbHRlcigoW29wZXJhdGlvblVwZGF0ZSwgb2JzZXJ2ZWRPcGVyYXRpb25dKSA9PiBvcGVyYXRpb25VcGRhdGUuaWQgPT09IG9ic2VydmVkT3BlcmF0aW9uLmlkKSxcbiAgICAgIHN3aXRjaE1hcCgoW29wZXJhdGlvblVwZGF0ZV0pID0+IHtcbiAgICAgICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5GQUlMRUQpIHtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihvcGVyYXRpb25VcGRhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvZihvcGVyYXRpb25VcGRhdGUpO1xuICAgICAgfSksXG4gICAgICB0YWtlV2hpbGUob3BlcmF0aW9uVXBkYXRlID0+IG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgIT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMLCB0cnVlKVxuICAgICk7XG4gICAgcmV0dXJuIG1lcmdlKG9ic2VydmVkT3BlcmF0aW9uJCwgb3BlcmF0aW9uVXBkYXRlcyQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYSBzaW5nbGUgZXZlbnQgd2l0aCBsYXRlc3QgY3JlYXRpb25UaW1lIGZvciB0aGUgZ2l2ZW4gZGV2aWNlIElkIGFuZCBldmVudCB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlSWQgVGhlIGRldmljZSBJZCBmb3Igd2hpY2ggdGhlIGV2ZW50cyBzaG91bGQgYmUgcXVlcmllZC5cbiAgICogQHBhcmFtIHR5cGUgRXZlbnQgdHlwZS5cbiAgICovXG4gIGFzeW5jIGdldExhdGVzdENvbmZpZ3VyYXRpb25FdmVudChcbiAgICBkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgIHR5cGU6IHN0cmluZ1xuICApOiBQcm9taXNlPElFdmVudCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGV2ZW50RmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBzb3VyY2U6IGRldmljZUlkLFxuICAgICAgdHlwZSxcbiAgICAgIGRhdGVGcm9tOiB0aGlzLmRhdGVGcm9tLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IHRoaXMuZGF0ZVRvLnRvSVNPU3RyaW5nKCksXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG5cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuZXZlbnQubGlzdChldmVudEZpbHRlcik7XG4gICAgcmV0dXJuIGRhdGFbMF07XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIGxpc3Qgb2Ygb3BlcmF0aW9ucyBmb3IgdGhlIGdpdmVuIGRldmljZSBJZCwgYW5kIG9wZXJhdGlvbiB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlSWQgVGhlIGRldmljZSBJZCBmb3Igd2hpY2ggdGhlIG9wZXJhdGlvbiBzaG91bGQgYmUgcXVlcmllZC5cbiAgICogQHBhcmFtIG9wZXJhdGlvblR5cGUgT3BlcmF0aW9uIHR5cGUgZnJhZ21lbnQuXG4gICAqL1xuICBhc3luYyBnZXRDb25maWdGaWxlT3BlcmF0aW9uTGlzdChcbiAgICBkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgIG9wZXJhdGlvblR5cGU6IHN0cmluZ1xuICApOiBQcm9taXNlPElPcGVyYXRpb25bXT4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbkZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBmcmFnbWVudFR5cGU6IG9wZXJhdGlvblR5cGUsXG4gICAgICBkYXRlRnJvbTogdGhpcy5kYXRlRnJvbS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0ZVRvOiB0aGlzLmRhdGVUby50b0lTT1N0cmluZygpLFxuICAgICAgcmV2ZXJ0OiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDIwMDBcbiAgICB9O1xuXG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLm9wZXJhdGlvbi5saXN0KG9wZXJhdGlvbkZpbHRlcikpLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBsYXRlc3QgdXBsb2FkZWQgY29uZmlndXJhdGlvbiBzbmFwc2hvdCBmb3IgdGhlIGdpdmVuIGRldmljZSwgYW5kIGNvbmZpZ3VyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCB0aGUgY29uZmlndXJhdGlvbiBzbmFwc2hvdCB3YXMgdXBsb2FkZWQuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBTZWxlY3RlZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqL1xuICBhc3luYyBnZXRDb25maWdTbmFwc2hvdChcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxDb25maWd1cmF0aW9uU25hcHNob3QgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBldmVudDogSUV2ZW50ID0gYXdhaXQgdGhpcy5nZXRMYXRlc3RDb25maWd1cmF0aW9uRXZlbnQoZGV2aWNlLmlkLCBjb25maWd1cmF0aW9uVHlwZSk7XG4gICAgbGV0IGNvbmZpZ1NuYXBzaG90OiBDb25maWd1cmF0aW9uU25hcHNob3Q7XG4gICAgaWYgKGV2ZW50KSB7XG4gICAgICBjb25maWdTbmFwc2hvdCA9IHtcbiAgICAgICAgdGltZTogZXZlbnQudGltZSxcbiAgICAgICAgbmFtZTogZXZlbnQudGV4dCxcbiAgICAgICAgZGV2aWNlVHlwZTogZGV2aWNlLnR5cGUsXG4gICAgICAgIGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9O1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uZmlnU25hcHNob3QuYmluYXJ5ID0gYXdhaXQgKGF3YWl0IHRoaXMuZXZlbnRCaW5hcnkuZG93bmxvYWQoZXZlbnQpKS50ZXh0KCk7XG4gICAgICAgIGlmIChldmVudC5jOHlfSXNCaW5hcnkpIHtcbiAgICAgICAgICBjb25maWdTbmFwc2hvdC5iaW5hcnlUeXBlID0gZXZlbnQuYzh5X0lzQmluYXJ5LnR5cGU7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IGdldHRleHQoJ0NvdWxkIG5vdCBnZXQgdGhlIGJpbmFyeS4nKTtcbiAgICAgICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ1NuYXBzaG90O1xuICB9XG5cbiAgYXN5bmMgZ2V0TGVnYWN5Q29uZmlnU25hcHNob3QoZGV2aWNlSWQpIHtcbiAgICBsZXQgY29uZmlnU25hcHNob3Q6IENvbmZpZ3VyYXRpb25TbmFwc2hvdDtcbiAgICBsZXQgbW87XG4gICAgY29uc3QgZGV2aWNlID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5LmRldGFpbChkZXZpY2VJZCwgeyB3aXRoQ2hpbGRyZW46IGZhbHNlIH0pKS5kYXRhO1xuICAgIGNvbnN0IHNuYXBzaG90SWQgPSBkZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb25EdW1wICYmIGRldmljZS5jOHlfQ29uZmlndXJhdGlvbkR1bXAuaWQ7XG4gICAgaWYgKCFzbmFwc2hvdElkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIG1vID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5LmRldGFpbChzbmFwc2hvdElkKSkuZGF0YTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gZG8gbm90aGluZ1xuICAgIH1cbiAgICBpZiAobW8pIHtcbiAgICAgIGNvbmZpZ1NuYXBzaG90ID0ge1xuICAgICAgICB0aW1lOiBtby5jcmVhdGlvblRpbWUsXG4gICAgICAgIG5hbWU6IG1vLm5hbWVcbiAgICAgIH07XG4gICAgICBjb25maWdTbmFwc2hvdC5iaW5hcnkgPSBhd2FpdCB0aGlzLmdldEJpbmFyeVRleHQobW8udXJsLCB7IGFsbG93RXh0ZXJuYWw6IGZhbHNlIH0pO1xuICAgIH1cbiAgICByZXR1cm4gY29uZmlnU25hcHNob3Q7XG4gIH1cblxuICBhc3luYyBnZXRCaW5hcnlGaWxlKGJpbmFyeVVybDogc3RyaW5nLCBvcHRpb25zOiB7IGFsbG93RXh0ZXJuYWw6IGJvb2xlYW4gfSk6IFByb21pc2U8RmlsZT4ge1xuICAgIGNvbnN0IGJpbmFyeUlkID0gdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKGJpbmFyeVVybCk7XG5cbiAgICBpZiAoIWJpbmFyeUlkICYmICFvcHRpb25zLmFsbG93RXh0ZXJuYWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoYmluYXJ5SWQpO1xuICAgIGNvbnN0IGJpbmFyeSA9ICEhYmluYXJ5SWRcbiAgICAgID8gYXdhaXQgdGhpcy5nZXRCaW5hcnkoYmluYXJ5SWQpXG4gICAgICA6IHRoaXMuZmV0Y2hFeHRlcm5hbEJpbmFyeShiaW5hcnlVcmwpO1xuICAgIGNvbnN0IGZpbGVCaW5hcnkgPSBuZXcgRmlsZShbYmluYXJ5XSwgZGF0YS5uYW1lLCB7IHR5cGU6IGRhdGEuY29udGVudFR5cGUgfSk7XG4gICAgcmV0dXJuIGZpbGVCaW5hcnk7XG4gIH1cblxuICBnZXRCaW5hcnlUZXh0KGJpbmFyeVVybDogc3RyaW5nLCBvcHRpb25zOiB7IGFsbG93RXh0ZXJuYWw6IGJvb2xlYW4gfSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgYmluYXJ5SWQgPSB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwoYmluYXJ5VXJsKTtcbiAgICBpZiAoIWJpbmFyeUlkICYmIG9wdGlvbnMuYWxsb3dFeHRlcm5hbCkge1xuICAgICAgcmV0dXJuIHRoaXMuZmV0Y2hFeHRlcm5hbEJpbmFyeShiaW5hcnlVcmwpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRCaW5hcnkoYmluYXJ5SWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRCaW5hcnkoYmluYXJ5SWQpIHtcbiAgICBsZXQgYmluYXJ5O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5kb3dubG9hZChiaW5hcnlJZCk7XG4gICAgICBiaW5hcnkgPSBhd2FpdCByZXMudGV4dCgpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBjb25zdCBtc2cgPSBnZXR0ZXh0KCdDb3VsZCBub3QgZ2V0IHRoZSBiaW5hcnkuJyk7XG4gICAgICB0aGlzLmFsZXJ0LmRhbmdlcihtc2cpO1xuICAgIH1cblxuICAgIHJldHVybiBiaW5hcnk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZldGNoRXh0ZXJuYWxCaW5hcnkodXJsKSB7XG4gICAgbGV0IGNvbmZpZ0JpbmFyeTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsKTtcbiAgICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgY29uZmlnQmluYXJ5ID0gYXdhaXQgcmVzLnRleHQoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnQ291bGQgbm90IGdldCB0aGUgZXh0ZXJuYWwgYmluYXJ5LicpO1xuICAgICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ0JpbmFyeTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlRW50cnkobW86IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KSB7XG4gICAgY29uc3QgYmluYXJ5SWQgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwobW8udXJsKTtcbiAgICBjb25zdCBuZXdNbyA9IGF3YWl0IHRoaXMuaW52ZW50b3J5LmNyZWF0ZShtbyk7XG4gICAgaWYgKGJpbmFyeUlkKSB7XG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeS5jaGlsZEFkZGl0aW9uc0FkZChiaW5hcnlJZCwgbmV3TW8uZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiBuZXdNbztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlRW50cnkobW86IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+LCB1cmwpIHtcbiAgICBjb25zdCBleGlzdGluZ0JpbmFyeUlkID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKHVybCk7XG4gICAgY29uc3QgbmV3QmluYXJ5SWQgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwobW8udXJsKTtcbiAgICBpZiAoZXhpc3RpbmdCaW5hcnlJZCAmJiBleGlzdGluZ0JpbmFyeUlkICE9PSBuZXdCaW5hcnlJZCkge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwodXJsKTtcbiAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmRlbGV0ZShpZCk7XG4gICAgfVxuICAgIGlmIChuZXdCaW5hcnlJZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQobmV3QmluYXJ5SWQsIG1vKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LnVwZGF0ZShtbyk7XG4gIH1cblxuICBwcml2YXRlIGdldEJhc2VWZXJzaW9uUmVzdWx0TGlzdEZvckxlZ2FjeUVudHJ5KGVudHJ5KSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICByZXM6IHt9IGFzIElGZXRjaFJlc3BvbnNlLFxuICAgICAgZGF0YTogW1xuICAgICAgICB7XG4gICAgICAgICAgLi4uZW50cnksXG4gICAgICAgICAgW2VudHJ5LnR5cGVdOiB7XG4gICAgICAgICAgICB2ZXJzaW9uOiBlbnRyeS52ZXJzaW9uLFxuICAgICAgICAgICAgdXJsOiBlbnRyeS51cmxcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9IGFzIElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pik7XG4gIH1cblxuICBwcml2YXRlIGdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21Tb2Z0d2FyZUxpc3RPcGVyYXRpb24oXG4gICAgb3BlcmF0aW9uOiBJT3BlcmF0aW9uLFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3RcbiAgKTogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSB7XG4gICAgY29uc3QgY2hhbmdlczogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSA9IFtdO1xuICAgIGZvckVhY2goZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QsIGRldmljZVNvZnR3YXJlID0+IHtcbiAgICAgIGNvbnN0IG9wZXJhdGlvblNvZnR3YXJlID0gZmluZChvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCwgeyBuYW1lOiBkZXZpY2VTb2Z0d2FyZS5uYW1lIH0pO1xuICAgICAgaWYgKGRldmljZVNvZnR3YXJlLnZlcnNpb24gIT09IG9wZXJhdGlvblNvZnR3YXJlLnZlcnNpb24pIHtcbiAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICAuLi5kZXZpY2VTb2Z0d2FyZSxcbiAgICAgICAgICBhY3Rpb246ICdkZWxldGUnXG4gICAgICAgIH0gYXMgRGV2aWNlU29mdHdhcmVDaGFuZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGZvckVhY2gob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QsIG9wZXJhdGlvblNvZnR3YXJlID0+IHtcbiAgICAgIGNvbnN0IGRldmljZVNvZnR3YXJlID0gZmluZChkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdCwgeyBuYW1lOiBvcGVyYXRpb25Tb2Z0d2FyZS5uYW1lIH0pO1xuICAgICAgaWYgKG9wZXJhdGlvblNvZnR3YXJlLnZlcnNpb24gIT09IGRldmljZVNvZnR3YXJlLnZlcnNpb24pIHtcbiAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICAuLi5vcGVyYXRpb25Tb2Z0d2FyZSxcbiAgICAgICAgICBhY3Rpb246ICdpbnN0YWxsJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY2hhbmdlcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGV2aWNlU29mdHdhcmVDaGFuZ2VzRnJvbVNvZnR3YXJlT3BlcmF0aW9uKFxuICAgIG9wZXJhdGlvbjogSU9wZXJhdGlvbixcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0XG4gICk6IERldmljZVNvZnR3YXJlQ2hhbmdlW10ge1xuICAgIGNvbnN0IGNoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW10gPSBbXTtcbiAgICBmb3JFYWNoKGRldmljZS5jOHlfU29mdHdhcmUsIChkZXZpY2VTb2Z0d2FyZVZlcnNpb24sIGRldmljZVNvZnR3YXJlTmFtZSkgPT4ge1xuICAgICAgaWYgKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVbZGV2aWNlU29mdHdhcmVOYW1lXSAhPT0gZGV2aWNlU29mdHdhcmVWZXJzaW9uKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgbmFtZTogZGV2aWNlU29mdHdhcmVOYW1lLFxuICAgICAgICAgIHZlcnNpb246IGRldmljZVNvZnR3YXJlVmVyc2lvbixcbiAgICAgICAgICBhY3Rpb246ICdkZWxldGUnXG4gICAgICAgIH0gYXMgRGV2aWNlU29mdHdhcmVDaGFuZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGZvckVhY2gob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZSwgKG9wZXJhdGlvblNvZnR3YXJlVmVyc2lvbiwgb3BlcmF0aW9uU29mdHdhcmVOYW1lKSA9PiB7XG4gICAgICBpZiAoZGV2aWNlLmM4eV9Tb2Z0d2FyZVtvcGVyYXRpb25Tb2Z0d2FyZU5hbWVdICE9PSBvcGVyYXRpb25Tb2Z0d2FyZVZlcnNpb24pIHtcbiAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICBuYW1lOiBvcGVyYXRpb25Tb2Z0d2FyZU5hbWUsXG4gICAgICAgICAgdmVyc2lvbjogb3BlcmF0aW9uU29mdHdhcmVWZXJzaW9uLFxuICAgICAgICAgIGFjdGlvbjogJ2luc3RhbGwnXG4gICAgICAgIH0gYXMgRGV2aWNlU29mdHdhcmVDaGFuZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjaGFuZ2VzO1xuICB9XG59XG4iXX0=