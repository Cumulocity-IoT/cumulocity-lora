import * as tslib_1 from "tslib";
import { Component, Output, Input, EventEmitter } from '@angular/core';
import { from, of } from 'rxjs';
import { shareReplay, map, switchMap, distinctUntilChanged } from 'rxjs/operators';
import { BsModalService } from 'ngx-bootstrap/modal';
import { IManagedObject, InventoryService, IOperation } from '@c8y/client';
import { gettext, ModalSelectionMode } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
import { RepositoryType } from './../repository.model';
import { RepositorySelectModalComponent } from '../select-modal/repository-select-modal.component';
let InstalledSoftwareComponent = class InstalledSoftwareComponent {
    constructor(repository, inventory, bsModal) {
        this.repository = repository;
        this.inventory = inventory;
        this.bsModal = bsModal;
        this.changes = new EventEmitter();
    }
    installSoftware() {
        this.displaySoftwareSelectModal({
            title: gettext('Install software'),
            labels: { ok: gettext('Install') },
            repositoryEntriesWithVersions$: of([]),
            repositoryEntriesWithVersionsFn$: modal => this.getAllSoftwaresWithVersions$(modal.content.searchTerm)
        }).subscribe(softwareToInstall => {
            this.emitSoftwareInstall(softwareToInstall);
        });
    }
    updateSoftware(softwareToRemove) {
        this.displaySoftwareSelectModal({
            title: gettext('Update software'),
            labels: { ok: gettext('Update') },
            showFilter: false,
            repositoryEntriesWithVersions$: this.getSingleSoftwareWithVersions$(softwareToRemove)
        }).subscribe(softwareToInstall => {
            this.emitSoftwareUpdate(softwareToRemove, softwareToInstall);
        });
    }
    removeSoftware(softwareToRemove) {
        this.emitSoftwareRemoval(softwareToRemove);
    }
    getAllSoftwaresWithVersions$(searchTerm$) {
        return searchTerm$.pipe(distinctUntilChanged(), switchMap(searchTerm => this.repository.listRepositoryEntries(RepositoryType.SOFTWARE, {
            query: this.deviceTypeQuery,
            partialName: searchTerm,
            params: { pageSize: 100 }
        })), map(({ data }) => data), map(softwares => this.attachVersions(softwares)), shareReplay(1));
    }
    getSingleSoftwareWithVersions$(software) {
        return from(this.repository.listRepositoryEntries(RepositoryType.SOFTWARE, {
            query: { name: software.name }
        })).pipe(map(({ data }) => data), map(softwares => this.attachVersions(softwares)), shareReplay(1));
    }
    attachVersions(softwares) {
        softwares.forEach(software => {
            software.versions = this.repository.listBaseVersions(software);
        });
        return softwares;
    }
    displaySoftwareSelectModal(initialStateOverrides) {
        const initialState = Object.assign({ repositoryType: RepositoryType.SOFTWARE, subTitle: gettext('Available softwares matching the device type'), mode: ModalSelectionMode.SINGLE, icon: 'c8y-tools', disableSelected: false, selected: this.softwareList }, initialStateOverrides);
        const modal = this.bsModal.show(RepositorySelectModalComponent, {
            ignoreBackdropClick: true,
            class: 'modal-sm',
            initialState
        });
        if (initialStateOverrides.repositoryEntriesWithVersionsFn$) {
            modal.content.repositoryEntriesWithVersions$ = initialStateOverrides.repositoryEntriesWithVersionsFn$(modal);
        }
        modal.content.load.next();
        return modal.content.resultEmitter;
    }
    emitSoftwareInstall({ name, version, url }) {
        this.changes.emit([{ name, version, url, action: 'install' }]);
    }
    emitSoftwareUpdate(softwareToRemove, softwareToInstall) {
        this.emitSoftwareRemoval(softwareToRemove);
        this.emitSoftwareInstall(softwareToInstall);
    }
    emitSoftwareRemoval({ name, version, url }) {
        this.changes.emit([{ name, version, url, action: 'delete' }]);
    }
};
InstalledSoftwareComponent.ctorParameters = () => [
    { type: RepositoryService },
    { type: InventoryService },
    { type: BsModalService }
];
tslib_1.__decorate([
    Input()
], InstalledSoftwareComponent.prototype, "softwareList", void 0);
tslib_1.__decorate([
    Input()
], InstalledSoftwareComponent.prototype, "deviceSoftwareChanges", void 0);
tslib_1.__decorate([
    Input()
], InstalledSoftwareComponent.prototype, "deviceSoftwareChangesOperation", void 0);
tslib_1.__decorate([
    Input()
], InstalledSoftwareComponent.prototype, "deviceSoftwareChangesInProgress", void 0);
tslib_1.__decorate([
    Input()
], InstalledSoftwareComponent.prototype, "deviceTypeQuery", void 0);
tslib_1.__decorate([
    Output()
], InstalledSoftwareComponent.prototype, "changes", void 0);
InstalledSoftwareComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-installed-software',
        template: "<div class=\"card\">\n  <div class=\"card-header separator\">\n    <h4 class=\"card-title\" translate>Installed software</h4>\n  </div>\n\n  <fieldset *ngIf=\"deviceSoftwareChangesOperation\" class=\"card-block bg-gray-white\">\n    <c8y-single-operation [operation]=\"deviceSoftwareChangesOperation\"></c8y-single-operation>\n  </fieldset>\n\n  <fieldset>\n    <!-- EMPTY STATE -->\n    <div class=\"card-block\" *ngIf=\"softwareList.length === 0\">\n      <div class=\"c8y-empty-state text-center m-t-16\">\n        <h1 class=\"c8y-icon c8y-icon-tools c8y-icon-duocolor\"></h1>\n        <p>\n          <strong translate>No software installed.</strong> <br />\n          <small translate>Click below to install software into this device.</small>\n        </p>\n      </div>\n    </div>\n\n    <!-- NOT EMPTY STATE -->\n    <ng-container *ngIf=\"softwareList.length > 0\">\n      <c8y-device-software-list\n        [softwareList]=\"softwareList\"\n        [deviceSoftwareChanges]=\"deviceSoftwareChanges\"\n        (update)=\"updateSoftware($event)\"\n        (remove)=\"removeSoftware($event)\"\n        class=\"d-block p-l-16 p-r-16\"\n      >\n      </c8y-device-software-list>\n    </ng-container>\n  </fieldset>\n\n  <!-- INSTALL SOFTWARE-->\n  <div class=\"card-footer\">\n    <button\n      class=\"btn btn-add-block m-0\"\n      title=\"{{ 'Install software' | translate }}\"\n      (click)=\"installSoftware()\"\n      [disabled]=\"deviceSoftwareChangesInProgress\"\n    >\n      <i c8yIcon=\"plus-circle\"></i>\n      {{ 'Install software' | translate }}\n    </button>\n  </div>\n</div>\n"
    })
], InstalledSoftwareComponent);
export { InstalledSoftwareComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVkLXNvZnR3YXJlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbInNvZnR3YXJlLWRldmljZS10YWIvaW5zdGFsbGVkLXNvZnR3YXJlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBbUIsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQXdDLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzdGLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBTW5HLElBQWEsMEJBQTBCLEdBQXZDLE1BQWEsMEJBQTBCO0lBUXJDLFlBQ1UsVUFBNkIsRUFDN0IsU0FBMkIsRUFDM0IsT0FBdUI7UUFGdkIsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7UUFDN0IsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFMdkIsWUFBTyxHQUFHLElBQUksWUFBWSxFQUEwQixDQUFDO0lBTTVELENBQUM7SUFFSixl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RSxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRTtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0NBQ0YsQ0FBQTs7WUF6R3VCLGlCQUFpQjtZQUNsQixnQkFBZ0I7WUFDbEIsY0FBYzs7QUFWeEI7SUFBUixLQUFLLEVBQUU7Z0VBQWdDO0FBQy9CO0lBQVIsS0FBSyxFQUFFO3lFQUErQztBQUM5QztJQUFSLEtBQUssRUFBRTtrRkFBNEM7QUFDM0M7SUFBUixLQUFLLEVBQUU7bUZBQTBDO0FBQ3pDO0lBQVIsS0FBSyxFQUFFO21FQUF5QjtBQUN2QjtJQUFULE1BQU0sRUFBRTsyREFBc0Q7QUFOcEQsMEJBQTBCO0lBSnRDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSx3QkFBd0I7UUFDbEMsMmtEQUFnRDtLQUNqRCxDQUFDO0dBQ1csMEJBQTBCLENBa0h0QztTQWxIWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE91dHB1dCwgSW5wdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSwgb2YsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc2hhcmVSZXBsYXksIG1hcCwgc3dpdGNoTWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSwgSU9wZXJhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldHRleHQsIE1vZGFsU2VsZWN0aW9uTW9kZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRGV2aWNlU29mdHdhcmUsIERldmljZVNvZnR3YXJlQ2hhbmdlLCBSZXBvc2l0b3J5VHlwZSB9IGZyb20gJy4vLi4vcmVwb3NpdG9yeS5tb2RlbCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQgfSBmcm9tICcuLi9zZWxlY3QtbW9kYWwvcmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwuY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWluc3RhbGxlZC1zb2Z0d2FyZScsXG4gIHRlbXBsYXRlVXJsOiAnaW5zdGFsbGVkLXNvZnR3YXJlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBJbnN0YWxsZWRTb2Z0d2FyZUNvbXBvbmVudCB7XG4gIEBJbnB1dCgpIHNvZnR3YXJlTGlzdDogRGV2aWNlU29mdHdhcmVbXTtcbiAgQElucHV0KCkgZGV2aWNlU29mdHdhcmVDaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdO1xuICBASW5wdXQoKSBkZXZpY2VTb2Z0d2FyZUNoYW5nZXNPcGVyYXRpb246IElPcGVyYXRpb247XG4gIEBJbnB1dCgpIGRldmljZVNvZnR3YXJlQ2hhbmdlc0luUHJvZ3Jlc3M6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGRldmljZVR5cGVRdWVyeTogb2JqZWN0O1xuICBAT3V0cHV0KCkgY2hhbmdlcyA9IG5ldyBFdmVudEVtaXR0ZXI8RGV2aWNlU29mdHdhcmVDaGFuZ2VbXT4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgaW52ZW50b3J5OiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbDogQnNNb2RhbFNlcnZpY2VcbiAgKSB7fVxuXG4gIGluc3RhbGxTb2Z0d2FyZSgpIHtcbiAgICB0aGlzLmRpc3BsYXlTb2Z0d2FyZVNlbGVjdE1vZGFsKHtcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdJbnN0YWxsIHNvZnR3YXJlJyksXG4gICAgICBsYWJlbHM6IHsgb2s6IGdldHRleHQoJ0luc3RhbGwnKSB9LFxuICAgICAgcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiBvZihbXSksXG4gICAgICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9uc0ZuJDogbW9kYWwgPT5cbiAgICAgICAgdGhpcy5nZXRBbGxTb2Z0d2FyZXNXaXRoVmVyc2lvbnMkKG1vZGFsLmNvbnRlbnQuc2VhcmNoVGVybSlcbiAgICB9KS5zdWJzY3JpYmUoc29mdHdhcmVUb0luc3RhbGwgPT4ge1xuICAgICAgdGhpcy5lbWl0U29mdHdhcmVJbnN0YWxsKHNvZnR3YXJlVG9JbnN0YWxsKTtcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZVNvZnR3YXJlKHNvZnR3YXJlVG9SZW1vdmUpIHtcbiAgICB0aGlzLmRpc3BsYXlTb2Z0d2FyZVNlbGVjdE1vZGFsKHtcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdVcGRhdGUgc29mdHdhcmUnKSxcbiAgICAgIGxhYmVsczogeyBvazogZ2V0dGV4dCgnVXBkYXRlJykgfSxcbiAgICAgIHNob3dGaWx0ZXI6IGZhbHNlLFxuICAgICAgcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiB0aGlzLmdldFNpbmdsZVNvZnR3YXJlV2l0aFZlcnNpb25zJChzb2Z0d2FyZVRvUmVtb3ZlKVxuICAgIH0pLnN1YnNjcmliZShzb2Z0d2FyZVRvSW5zdGFsbCA9PiB7XG4gICAgICB0aGlzLmVtaXRTb2Z0d2FyZVVwZGF0ZShzb2Z0d2FyZVRvUmVtb3ZlLCBzb2Z0d2FyZVRvSW5zdGFsbCk7XG4gICAgfSk7XG4gIH1cblxuICByZW1vdmVTb2Z0d2FyZShzb2Z0d2FyZVRvUmVtb3ZlKSB7XG4gICAgdGhpcy5lbWl0U29mdHdhcmVSZW1vdmFsKHNvZnR3YXJlVG9SZW1vdmUpO1xuICB9XG5cbiAgZ2V0QWxsU29mdHdhcmVzV2l0aFZlcnNpb25zJChzZWFyY2hUZXJtJDogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4pIHtcbiAgICByZXR1cm4gc2VhcmNoVGVybSQucGlwZShcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAoc2VhcmNoVGVybSA9PlxuICAgICAgICB0aGlzLnJlcG9zaXRvcnkubGlzdFJlcG9zaXRvcnlFbnRyaWVzKFJlcG9zaXRvcnlUeXBlLlNPRlRXQVJFLCB7XG4gICAgICAgICAgcXVlcnk6IHRoaXMuZGV2aWNlVHlwZVF1ZXJ5LFxuICAgICAgICAgIHBhcnRpYWxOYW1lOiBzZWFyY2hUZXJtLFxuICAgICAgICAgIHBhcmFtczogeyBwYWdlU2l6ZTogMTAwIH1cbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKSxcbiAgICAgIG1hcChzb2Z0d2FyZXMgPT4gdGhpcy5hdHRhY2hWZXJzaW9ucyhzb2Z0d2FyZXMpKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcbiAgfVxuXG4gIGdldFNpbmdsZVNvZnR3YXJlV2l0aFZlcnNpb25zJChzb2Z0d2FyZTogRGV2aWNlU29mdHdhcmUpIHtcbiAgICByZXR1cm4gZnJvbShcbiAgICAgIHRoaXMucmVwb3NpdG9yeS5saXN0UmVwb3NpdG9yeUVudHJpZXMoUmVwb3NpdG9yeVR5cGUuU09GVFdBUkUsIHtcbiAgICAgICAgcXVlcnk6IHsgbmFtZTogc29mdHdhcmUubmFtZSB9XG4gICAgICB9KVxuICAgICkucGlwZShcbiAgICAgIG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpLFxuICAgICAgbWFwKHNvZnR3YXJlcyA9PiB0aGlzLmF0dGFjaFZlcnNpb25zKHNvZnR3YXJlcykpLFxuICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICApO1xuICB9XG5cbiAgYXR0YWNoVmVyc2lvbnMoc29mdHdhcmVzOiBJTWFuYWdlZE9iamVjdFtdKSB7XG4gICAgc29mdHdhcmVzLmZvckVhY2goc29mdHdhcmUgPT4ge1xuICAgICAgc29mdHdhcmUudmVyc2lvbnMgPSB0aGlzLnJlcG9zaXRvcnkubGlzdEJhc2VWZXJzaW9ucyhzb2Z0d2FyZSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHNvZnR3YXJlcztcbiAgfVxuXG4gIGRpc3BsYXlTb2Z0d2FyZVNlbGVjdE1vZGFsKGluaXRpYWxTdGF0ZU92ZXJyaWRlcykge1xuICAgIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAgICAgIHJlcG9zaXRvcnlUeXBlOiBSZXBvc2l0b3J5VHlwZS5TT0ZUV0FSRSxcbiAgICAgIHN1YlRpdGxlOiBnZXR0ZXh0KCdBdmFpbGFibGUgc29mdHdhcmVzIG1hdGNoaW5nIHRoZSBkZXZpY2UgdHlwZScpLFxuICAgICAgbW9kZTogTW9kYWxTZWxlY3Rpb25Nb2RlLlNJTkdMRSxcbiAgICAgIGljb246ICdjOHktdG9vbHMnLFxuICAgICAgZGlzYWJsZVNlbGVjdGVkOiBmYWxzZSxcbiAgICAgIHNlbGVjdGVkOiB0aGlzLnNvZnR3YXJlTGlzdCxcbiAgICAgIC4uLmluaXRpYWxTdGF0ZU92ZXJyaWRlc1xuICAgIH07XG4gICAgY29uc3QgbW9kYWwgPSB0aGlzLmJzTW9kYWwuc2hvdyhSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQsIHtcbiAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWUsXG4gICAgICBjbGFzczogJ21vZGFsLXNtJyxcbiAgICAgIGluaXRpYWxTdGF0ZVxuICAgIH0pO1xuXG4gICAgaWYgKGluaXRpYWxTdGF0ZU92ZXJyaWRlcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9uc0ZuJCkge1xuICAgICAgbW9kYWwuY29udGVudC5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQgPSBpbml0aWFsU3RhdGVPdmVycmlkZXMucmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnNGbiQoXG4gICAgICAgIG1vZGFsXG4gICAgICApO1xuICAgIH1cblxuICAgIG1vZGFsLmNvbnRlbnQubG9hZC5uZXh0KCk7XG4gICAgcmV0dXJuIG1vZGFsLmNvbnRlbnQucmVzdWx0RW1pdHRlcjtcbiAgfVxuXG4gIGVtaXRTb2Z0d2FyZUluc3RhbGwoeyBuYW1lLCB2ZXJzaW9uLCB1cmwgfSkge1xuICAgIHRoaXMuY2hhbmdlcy5lbWl0KFt7IG5hbWUsIHZlcnNpb24sIHVybCwgYWN0aW9uOiAnaW5zdGFsbCcgfV0pO1xuICB9XG5cbiAgZW1pdFNvZnR3YXJlVXBkYXRlKHNvZnR3YXJlVG9SZW1vdmUsIHNvZnR3YXJlVG9JbnN0YWxsKSB7XG4gICAgdGhpcy5lbWl0U29mdHdhcmVSZW1vdmFsKHNvZnR3YXJlVG9SZW1vdmUpO1xuICAgIHRoaXMuZW1pdFNvZnR3YXJlSW5zdGFsbChzb2Z0d2FyZVRvSW5zdGFsbCk7XG4gIH1cblxuICBlbWl0U29mdHdhcmVSZW1vdmFsKHsgbmFtZSwgdmVyc2lvbiwgdXJsIH0pIHtcbiAgICB0aGlzLmNoYW5nZXMuZW1pdChbeyBuYW1lLCB2ZXJzaW9uLCB1cmwsIGFjdGlvbjogJ2RlbGV0ZScgfV0pO1xuICB9XG59XG4iXX0=