import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, HostBinding, Input, Output, TemplateRef } from '@angular/core';
let LoadMoreComponent = class LoadMoreComponent {
    constructor(element) {
        this.element = element;
        this.useIntersection = true;
        this.hidden = false;
        this.class = 'c8y-list__item bg-transparent';
        this.maxIterations = 10;
        this.onLoad = new EventEmitter();
        this.isLoading = false;
        this.counter = 0;
        this.showNoMoreDataHint = false;
        this.LOAD_SAME_PAGE_THRESHOLD = 50;
    }
    get hostClass() {
        return this.hidden || (!this.hasMore && !this.showNoMoreDataHint) ? '' : this.class;
    }
    get hasMore() {
        return (this.paging && (this.paging.totalPages > this.paging.currentPage || !!this.paging.nextPage));
    }
    ngAfterContentInit() {
        if (this.useIntersection && 'IntersectionObserver' in window) {
            this.intersectionObserver = new IntersectionObserver(event => this.buttonInView(event[0]), {
                root: this.container ? this.container.nativeElement : null
            });
            this.intersectionObserver.observe(this.element.nativeElement);
        }
        this.showNoMoreDataHint = this.shouldShowNoMoreDataHint();
    }
    ngOnDestroy() {
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
        }
    }
    loadMore(event) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.isLoading = true;
            if (event) {
                event.stopPropagation();
            }
            if (this.hasMore) {
                const result = yield this.paging.next();
                this.counter++;
                this.paging = result.paging;
                this.onLoad.emit(result.data);
                this.intersectionLoading();
                this.showNoMoreDataHint = this.shouldShowNoMoreDataHint();
            }
            else {
                this.counter = 0;
                this.isLoading = false;
            }
        });
    }
    intersectionLoading() {
        if (this.useIntersection && this.hasMore && this.loadUntilIntersected !== null) {
            this.loadUntilIntersected = setTimeout(() => this.loadMore(), this.getLoadingThreshold());
            this.useIntersection = this.shouldSwitchMode();
        }
        else {
            this.isLoading = false;
            this.loadUntilIntersected = undefined;
        }
    }
    getLoadingThreshold() {
        return this.LOAD_SAME_PAGE_THRESHOLD * this.counter;
    }
    shouldShowNoMoreDataHint() {
        return (this.counter !== 0 || this.noMoreDataHint) && !this.hasMore && !this.hidden;
    }
    shouldSwitchMode() {
        return this.counter < this.maxIterations || this.hidden;
    }
    buttonInView(event) {
        if (event.isIntersecting) {
            this.loadMore();
        }
        else if (this.loadUntilIntersected) {
            clearTimeout(this.loadUntilIntersected);
            this.loadUntilIntersected = null;
            this.isLoading = false;
        }
        else {
            // avoiding a race condition when timeout is faster
            // cleared then set
            this.loadUntilIntersected = null;
        }
    }
};
LoadMoreComponent.ctorParameters = () => [
    { type: ElementRef }
];
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "paging", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "useIntersection", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "hidden", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "container", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "class", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "maxIterations", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "noMoreDataHint", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "loadNextLabel", void 0);
tslib_1.__decorate([
    Input()
], LoadMoreComponent.prototype, "loadingLabel", void 0);
tslib_1.__decorate([
    Output()
], LoadMoreComponent.prototype, "onLoad", void 0);
tslib_1.__decorate([
    HostBinding('class')
], LoadMoreComponent.prototype, "hostClass", null);
LoadMoreComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-load-more',
        template: "<button\n  class=\"btn btn-default btn-block text-center\"\n  (click)=\"loadMore($event)\"\n  [ngClass]=\"{ 'btn-pending': isLoading }\"\n  *ngIf=\"hasMore\"\n  [style.visibility]=\"hidden ? 'hidden' : 'visible'\"\n  [style.height]=\"hidden ? '1px' : null\"\n  title=\"{{ 'Load more' | translate }}\"\n>\n  <ng-container *ngIf=\"!isLoading\">\n    <span *ngIf=\"loadNextLabel; else loadPage\" [innerHTML]=\"loadNextLabel | translate\"></span>\n    <ng-template #loadPage>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Load page {{ pageNo }}</span\n      >\n    </ng-template>\n  </ng-container>\n  <ng-container *ngIf=\"isLoading\">\n    <span *ngIf=\"loadingLabel; else loading\" [innerHTML]=\"loadingLabel | translate\"></span>\n    <ng-template #loading>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Page {{ pageNo }} is loading\u2026\n      </span>\n    </ng-template>\n  </ng-container>\n</button>\n\n<ng-container *ngIf=\"showNoMoreDataHint\">\n  <ng-container *ngTemplateOutlet=\"noMoreDataHint || finishHint\"></ng-container>\n</ng-container>\n\n<ng-template #finishHint>\n  <div class=\"legend form-block center\">\n    <i [c8yIcon]=\"'flag-checkered'\" class=\"m-r-4\"></i>\n    {{ 'Last record' | translate }}\n  </div>\n</ng-template>\n"
    })
], LoadMoreComponent);
export { LoadMoreComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1tb3JlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2NvbW1vbi9sb2FkLW1vcmUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osV0FBVyxFQUNYLEtBQUssRUFDTCxNQUFNLEVBQ04sV0FBVyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBT3ZCLElBQWEsaUJBQWlCLEdBQTlCLE1BQWEsaUJBQWlCO0lBd0M1QixZQUFvQixPQUFtQjtRQUFuQixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBcEN2QyxvQkFBZSxHQUFHLElBQUksQ0FBQztRQUV2QixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBSWYsVUFBSyxHQUFXLCtCQUErQixDQUFDO1FBRWhELGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBUW5CLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFDbEIsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUNaLHVCQUFrQixHQUFHLEtBQUssQ0FBQztRQUVWLDZCQUF3QixHQUFHLEVBQUUsQ0FBQztJQWNMLENBQUM7SUFWM0MsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0RixDQUFDO0lBRUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxDQUNMLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FDNUYsQ0FBQztJQUNKLENBQUM7SUFJRCxrQkFBa0I7UUFDaEIsSUFBSSxJQUFJLENBQUMsZUFBZSxJQUFJLHNCQUFzQixJQUFJLE1BQU0sRUFBRTtZQUM1RCxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3pGLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSTthQUMzRCxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDL0Q7UUFDRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7SUFDNUQsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QixJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDeEM7SUFDSCxDQUFDO0lBRUssUUFBUSxDQUFDLEtBQU07O1lBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLElBQUksS0FBSyxFQUFFO2dCQUNULEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQzthQUN6QjtZQUNELElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN4QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2YsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO2dCQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO2dCQUMzQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7YUFDM0Q7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2FBQ3hCO1FBQ0gsQ0FBQztLQUFBO0lBRU8sbUJBQW1CO1FBQ3pCLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7WUFDOUUsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztZQUMxRixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ2hEO2FBQU07WUFDTCxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztZQUN2QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsU0FBUyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixPQUFPLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RELENBQUM7SUFFTyx3QkFBd0I7UUFDOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3RGLENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsT0FBTyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUMxRCxDQUFDO0lBRU8sWUFBWSxDQUFDLEtBQUs7UUFDeEIsSUFBSSxLQUFLLENBQUMsY0FBYyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUNqQjthQUFNLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQ3BDLFlBQVksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1NBQ3hCO2FBQU07WUFDTCxtREFBbUQ7WUFDbkQsbUJBQW1CO1lBQ25CLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUM7U0FDbEM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTs7WUF2RThCLFVBQVU7O0FBdEN2QztJQURDLEtBQUssRUFBRTtpREFDWTtBQUVwQjtJQURDLEtBQUssRUFBRTswREFDZTtBQUV2QjtJQURDLEtBQUssRUFBRTtpREFDTztBQUVmO0lBREMsS0FBSyxFQUFFO29EQUNjO0FBRXRCO0lBREMsS0FBSyxFQUFFO2dEQUN3QztBQUVoRDtJQURDLEtBQUssRUFBRTt3REFDVztBQUVuQjtJQURDLEtBQUssRUFBRTt5REFDeUI7QUFFakM7SUFEQyxLQUFLLEVBQUU7d0RBQ2M7QUFFdEI7SUFEQyxLQUFLLEVBQUU7dURBQ2E7QUFFckI7SUFEQyxNQUFNLEVBQUU7aURBQ2dDO0FBVXpDO0lBREMsV0FBVyxDQUFDLE9BQU8sQ0FBQztrREFHcEI7QUFoQ1UsaUJBQWlCO0lBSjdCLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxlQUFlO1FBQ3pCLGkyQ0FBeUM7S0FDMUMsQ0FBQztHQUNXLGlCQUFpQixDQStHN0I7U0EvR1ksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBUZW1wbGF0ZVJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElJZGVudGlmaWVkLCBQYWdpbmcgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1sb2FkLW1vcmUnLFxuICB0ZW1wbGF0ZVVybDogJy4vbG9hZC1tb3JlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBMb2FkTW9yZUNvbXBvbmVudCB7XG4gIEBJbnB1dCgpXG4gIHBhZ2luZzogUGFnaW5nPGFueT47XG4gIEBJbnB1dCgpXG4gIHVzZUludGVyc2VjdGlvbiA9IHRydWU7XG4gIEBJbnB1dCgpXG4gIGhpZGRlbiA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBjb250YWluZXI6IEVsZW1lbnRSZWY7XG4gIEBJbnB1dCgpXG4gIGNsYXNzOiBzdHJpbmcgPSAnYzh5LWxpc3RfX2l0ZW0gYmctdHJhbnNwYXJlbnQnO1xuICBASW5wdXQoKVxuICBtYXhJdGVyYXRpb25zID0gMTA7XG4gIEBJbnB1dCgpXG4gIG5vTW9yZURhdGFIaW50OiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBASW5wdXQoKVxuICBsb2FkTmV4dExhYmVsOiBzdHJpbmc7XG4gIEBJbnB1dCgpXG4gIGxvYWRpbmdMYWJlbDogc3RyaW5nO1xuICBAT3V0cHV0KClcbiAgb25Mb2FkID0gbmV3IEV2ZW50RW1pdHRlcjxJSWRlbnRpZmllZD4oKTtcblxuICBpc0xvYWRpbmcgPSBmYWxzZTtcbiAgY291bnRlciA9IDA7XG4gIHNob3dOb01vcmVEYXRhSGludCA9IGZhbHNlO1xuICBwcml2YXRlIGxvYWRVbnRpbEludGVyc2VjdGVkO1xuICBwcml2YXRlIHJlYWRvbmx5IExPQURfU0FNRV9QQUdFX1RIUkVTSE9MRCA9IDUwO1xuICBwcml2YXRlIGludGVyc2VjdGlvbk9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlcjtcblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzJylcbiAgZ2V0IGhvc3RDbGFzcygpIHtcbiAgICByZXR1cm4gdGhpcy5oaWRkZW4gfHwgKCF0aGlzLmhhc01vcmUgJiYgIXRoaXMuc2hvd05vTW9yZURhdGFIaW50KSA/ICcnIDogdGhpcy5jbGFzcztcbiAgfVxuXG4gIGdldCBoYXNNb3JlKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnBhZ2luZyAmJiAodGhpcy5wYWdpbmcudG90YWxQYWdlcyA+IHRoaXMucGFnaW5nLmN1cnJlbnRQYWdlIHx8ICEhdGhpcy5wYWdpbmcubmV4dFBhZ2UpXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZikge31cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudXNlSW50ZXJzZWN0aW9uICYmICdJbnRlcnNlY3Rpb25PYnNlcnZlcicgaW4gd2luZG93KSB7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKGV2ZW50ID0+IHRoaXMuYnV0dG9uSW5WaWV3KGV2ZW50WzBdKSwge1xuICAgICAgICByb290OiB0aGlzLmNvbnRhaW5lciA/IHRoaXMuY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQgOiBudWxsXG4gICAgICB9KTtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgfVxuICAgIHRoaXMuc2hvd05vTW9yZURhdGFIaW50ID0gdGhpcy5zaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyKSB7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2FkTW9yZShldmVudD8pIHtcbiAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XG4gICAgaWYgKGV2ZW50KSB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuaGFzTW9yZSkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wYWdpbmcubmV4dCgpO1xuICAgICAgdGhpcy5jb3VudGVyKys7XG4gICAgICB0aGlzLnBhZ2luZyA9IHJlc3VsdC5wYWdpbmc7XG4gICAgICB0aGlzLm9uTG9hZC5lbWl0KHJlc3VsdC5kYXRhKTtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uTG9hZGluZygpO1xuICAgICAgdGhpcy5zaG93Tm9Nb3JlRGF0YUhpbnQgPSB0aGlzLnNob3VsZFNob3dOb01vcmVEYXRhSGludCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvdW50ZXIgPSAwO1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGludGVyc2VjdGlvbkxvYWRpbmcoKSB7XG4gICAgaWYgKHRoaXMudXNlSW50ZXJzZWN0aW9uICYmIHRoaXMuaGFzTW9yZSAmJiB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmxvYWRNb3JlKCksIHRoaXMuZ2V0TG9hZGluZ1RocmVzaG9sZCgpKTtcbiAgICAgIHRoaXMudXNlSW50ZXJzZWN0aW9uID0gdGhpcy5zaG91bGRTd2l0Y2hNb2RlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9hZGluZ1RocmVzaG9sZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLkxPQURfU0FNRV9QQUdFX1RIUkVTSE9MRCAqIHRoaXMuY291bnRlcjtcbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkU2hvd05vTW9yZURhdGFIaW50KCkge1xuICAgIHJldHVybiAodGhpcy5jb3VudGVyICE9PSAwIHx8IHRoaXMubm9Nb3JlRGF0YUhpbnQpICYmICF0aGlzLmhhc01vcmUgJiYgIXRoaXMuaGlkZGVuO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRTd2l0Y2hNb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmNvdW50ZXIgPCB0aGlzLm1heEl0ZXJhdGlvbnMgfHwgdGhpcy5oaWRkZW47XG4gIH1cblxuICBwcml2YXRlIGJ1dHRvbkluVmlldyhldmVudCkge1xuICAgIGlmIChldmVudC5pc0ludGVyc2VjdGluZykge1xuICAgICAgdGhpcy5sb2FkTW9yZSgpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMubG9hZFVudGlsSW50ZXJzZWN0ZWQpO1xuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IG51bGw7XG4gICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBhdm9pZGluZyBhIHJhY2UgY29uZGl0aW9uIHdoZW4gdGltZW91dCBpcyBmYXN0ZXJcbiAgICAgIC8vIGNsZWFyZWQgdGhlbiBzZXRcbiAgICAgIHRoaXMubG9hZFVudGlsSW50ZXJzZWN0ZWQgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuIl19