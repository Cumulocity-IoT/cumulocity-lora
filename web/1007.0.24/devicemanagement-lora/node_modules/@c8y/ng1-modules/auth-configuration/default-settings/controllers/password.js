"use strict";function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),i.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}!function(){function t(u,r,e,t,n,i,o,a,c,l){var s,p="password",y="limit.validity",f="strength.validity",g="enforce.strength",d=c.loginOptions.BASIC.value.toUpperCase(),h=c.loginOptions.OAUTH2_INTERNAL.value.toUpperCase(),v=c.loginOptions.OAUTH2.value.toUpperCase(),O="SSO_REDIRECT",m={userManagementSource:"INTERNAL",grantType:"PASSWORD",providerName:"Cumulocity",visibleOnLoginPage:!0,type:d},b=!1;function T(){return c.list({silentError:!0}).then(e.getResData).then(C).catch(C)}function C(t){var e=t.loginOptions;s=void 0===e?[]:e;var n,i=M(),r=s.find(function(t){var e=t.type,n=t.grantType;return e===v&&"AUTHORIZATION_CODE"===n}),o=A();n=!r||i||o?i?i.type:o?o.type:m.type:O,u.loginModeType=n,u.noOAuth=!r,L()}function S(){var t=[];if(u.loginModeChanged){var e=u.loginModeType,n=!!A(),i=!!M();e===h?(n||t.push(function(){return N(d)}),i||t.push(function(){return N(h)})):e===d?(n||t.push(function(){return N(d)}),i&&t.push(E)):e===O&&(n&&t.push(R),i&&t.push(E)),t.push(L)}return t.reduce(function(t,e){return t.then(e)},r.resolve())}function L(){u.savedloginModeType=u.loginModeType}function A(){return s.find(function(t){return t.type===d})}function M(){return s.find(function(t){return t.type===h})}function N(t){return c.save(_objectSpread({},m,{type:t}))}function E(){var t=M();return t?c.remove(t):r.when()}function R(){var t=A();return t?c.remove(t):r.when()}function j(t){var e=t.key.replace(/\./g,"_"),n=JSON.parse(t.value);u[e]=t,u[e].value=n}function w(t){return n.detail({category:p,key:t}).then(e.getResData).catch(function(){return null})}function P(t){return n.getSystemOption({category:p,key:t}).then(e.getResData).catch(function(){return null})}function U(t){b||w(y).then(j),w(f).then(j),P(g).then(I),i.success(a("Login settings saved.")),t.$setPristine(),T()}function D(t){u.limit_validity.value=parseInt(t,10)}function I(t){j(_.assign({},t,{key:"system.".concat(t.key)}))}t.changeTitle({title:a("Authentication")}),r.all({systemLimitKeyOption:P("limit.validity"),tenantLimitKeyOption:w(y)}).then(function(t){var e=t.systemLimitKeyOption,n=t.tenantLimitKeyOption;if(null!==n&&j(n),null!==e){var i;I(e);try{i=JSON.parse(e.value)}catch(t){}_.isUndefined(i)||0===i||(b=!0,u.validityLimitEnforced=b,u.limit_validity={value:i})}}),P(g).then(I),w(f).then(j),T(),u.loginModeChanged=!1,u.onLoginModeChange=function(){u.loginModeChanged=!0},u.update=function(t){L();return r.all([b?r.when():n.updateOption(u.limit_validity),n.updateOption(u.strength_validity)]).then(S).then(function(){return u.loginModeChanged?l.requireLogout().catch(function(){U(t)}):U(t)}).catch(function(t){i.danger(e.getResErrorMessage(t))})},u.validateDays=function(t){var e=t;_.isNaN(_.toNumber(e))||parseInt(e,10)<0?D(e=e.slice(0,-1)):D(e);e.length||D(0)},u.validityLimitEnforced=b}t.$inject=["$scope","$q","c8yBase","c8yTitle","c8ySettings","c8yAlert","c8yTenant","gettext","c8yLoginOptions","c8yUserUtil"],angular.module("c8y.authenticationConfiguration").controller("passwordCtrl",t)}();