"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(n,e,r,a,t,o,i,u,l,s){var c=this,y="two-factor-authentication",f=s("TOTP requires OAuth Internal login mode."),d=s("Messaging application is not subscribed."),p=s("The setting is enforced on the platform level."),g=[{systemOption:!0,key:"tenant-scope-settings.enabled",default:!1,readOnly:!0},{key:"enabled",default:!1,loader:T},{key:"token.validity",default:43200,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"pin.validity",default:30,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"enforced",default:!1,loader:T}],m=[{key:"enforcedOnSystemLevel",default:!1,readOnly:!0},{key:"enforcedUsersGroup",default:!1,readOnly:!0},{key:"strategy",default:"SMS"}];function v(t){var e=b(t),n=t.default;return(t.systemOption?a.getSystemOptionValue(e,n):"function"==typeof t.loader?t.loader():a.detailValue(e,n)).then(function(e){return h(t,e)}).catch(function(){return h(t,t.default)})}function b(e){return{category:y,key:e.key}}function h(e,t){c[S(e.key)]=t,c.previousSettings[S(e.key)]=_.cloneDeep(t)}function S(e){return _.camelCase(e)}function A(e){var t={category:y,key:e.key,value:O(e)};return function(e){var t=c.previousSettings[S(e.key)]!==O(e),n=e.readOnly,r=e.readOnlyIfTenantScopeSettingsDisabled&&!c.tenantScopeSettingsEnabled;return t&&!e.systemOption&&!(n||r)}(e)?a.updateOption(t).then(function(){return h(e,t.value)}):n.when()}function O(e){return function(e){return _.isNumber(e)||!_.isNaN(_.toNumber(e))&&_.isString(e)?_.toNumber(e):e}(c[S(e.key)])}function T(){var t=this,n=b(this);return a.getSystemOptionValue(n,this.default).then(function(e){return!0===e?t.readOnly=!0:a.detailValue(n,t.default)})}_.assign(c,{$onInit:function(){m.forEach(function(e){_.assign(c,_defineProperty({},e.key,e.default))}),n.all([n.all([].concat(_toConsumableArray(_.map(g,v)),[void e.isAvailable({contextPath:"messaging"}).then(function(e){c.smsAppAvailable=e})])),o.current().then(function(e){return i.getTfaSettings(e)}).then(function(t){return m.forEach(function(e){t[e.key]&&h(e,t[e.key])})})]).finally(function(){c.initialized=!0})},saveSettings:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:c.tfaSettingsForm;c.enabled&&"TOTP"===c.strategy||(c.enforced=!1);var t=_.map(g,A);return t.push(function(){var e=n.resolve();return c.previousSettings.strategy!==c.strategy&&(e=o.current().then(function(e){return i.updateTfaSettings(e,c.strategy)}).then(function(){return l.requireLogout()}).catch(function(e){return u.danger(r.getResErrorMessage(e))})),e}()),n.all(t).then(function(){u.success(s("TFA settings saved.")),e&&e.$setPristine()})},limitValidityRegex:/^[0-9]\d*$/,initialized:!1,totpPopover:f,smsWarningPopover:d,enforcedOnSystemLevelPopover:p,oAuthLoginMode:function(){return c.loginMode===t.loginOptions.OAUTH2_INTERNAL.value.toUpperCase()},isReadOnly:function(r){return g.some(function(e){var t=e.key,n=e.readOnly;return t===r&&n})},previousSettings:{}})}e.$inject=["$q","c8yApplication","c8yBase","c8ySettings","c8yLoginOptions","c8yTenant","c8yTfaSettings","c8yAlert","c8yUserUtil","gettext"],angular.module("c8y.parts.tfaSettings").component("c8yTfaSettings",{controller:e,controllerAs:"vm",templateUrl:":::PLUGIN_PATH:::/tfa-settings.html",bindings:{loginMode:"<"}})}();