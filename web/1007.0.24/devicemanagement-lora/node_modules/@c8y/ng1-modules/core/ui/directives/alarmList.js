"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?Object(arguments[t]):{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}!function(){t.$inject=["$q","$injector","$window","c8yAlarms","c8yAlert","c8yInventory","c8yBase","c8yRealtime","c8yUser","c8yConfig","c8ySmartRulesAvailability","gettextCatalog"];var J="c8yAlarmList";function t(F,x,P,K,U,z,B,G,V,H,M,q){return{restrict:"EA",scope:{severities:"=?activeSeverities",options:"=?filter",realtime:"=?",hideHeaderActions:"=?",title:"=?",unresolved:"=?",paginate:"=?",refreshLoading:"=?",hideDevice:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/views/alarmList.html",link:function(a,t,i){var n={};function o(t){K.detail(t).then(_.partial(e,t))}function e(t,e){var r=F.when(t);return n[t.id]&&(r=r.then(a.auditRefresh[t.id])),r.then(function(){_.assign(t,e.data)})}function r(t){if(!a.auditList||!a.auditList[t.id])return q.getString("ACKNOWLEDGED");var e=a.auditList[t.id],r=K.ackTime(t,e),n={ackBy:K.acknowledgedBy(t,e),ackTimeFromNow:moment(r).fromNow()};return q.getString("ACKNOWLEDGED by: {{ackBy}} {{ackTimeFromNow}}",n)}function u(t){if(!a.auditList||!a.auditList[t.id])return q.getString("CLEARED");var e={alarmDuration:K.alarmDuration(t,a.auditList[t.id])};return q.getString("CLEARED: was active for {{alarmDuration}}",e)}function s(t){var e={alarmTimeFromNow:moment(t.time).fromNow()};return q.getString("ACTIVE: triggered {{alarmTimeFromNow}}",e)}function c(t){var e=!0;return i.activeSeverities&&(e=_.isEmpty(a.severities)||a.severities[t.severity]),e&&!((a.unresolved||!1===(a.options&&a.options.resolved))&&"CLEARED"===t.status)}function l(){return a.refreshLoading?F.resolve():(a.refreshLoading=!0,a.alarms=[],a.auditList={},n={},a.options=a.options||{},a.options.type&&(a.options.types=[a.options.type]),function(){if(!b(a.options).byDevices())return F.reject();var t=N();if(t.length<=0)return F.reject();var e=_.map(t,function(t){return K.list(_objectSpread({source:t,withSourceDevices:!0,withSourceAssets:!0,resolved:a.options.resolved,pageSize:R()},p()))});return F.all(e).then(_.flatten)}().catch(v).catch(y).catch(m).catch(f).then(h).then(function(){a.refreshLoading=!1}))}function f(){var t={pageSize:R()};return K.list(t)}a.refreshLoading=!1;var d=_.throttle(function(){a.refreshLoading||(a.paging.loading=!0,a.refreshLoading=!0,a.realtimeAnimation=!1,a.paging.next().then(function(t){_.forEach(t,function(t){a.alarms.push(t)}),a.paging.loading=!1,a.refreshLoading=!1,a.paging=t.paging}))},300,{trailing:!0});function m(){if(!b(a.options).bySeverity())return F.reject();var t={severity:a.options.severity,resolved:a.options.resolved,pageSize:R()};return B.timeOrderFilter(t),K.list(t)}function y(){return b(a.options).byStatus()?K.listByStatus(a.options.status,_objectSpread({pageSize:R()},p())):F.reject()}function p(){var t=_.reduce(a.severities,function(t,e,r){return e?[].concat(_toConsumableArray(t),[r]):t},[]);return 1===t.length?{severity:_.head(t)}:{}}function v(){if(!b(a.options).byType())return F.reject();var e=a.options.types,t=_objectSpread({pageSize:R()},p());return 1===e.length&&(t.type=e[0]),K.list(t).then(function(t){return _.filter(t,function(t){return _.includes(e,t.type)})})}function h(t){var e=t;(function(){if(i.paginate&&!a.paginate)return!1;if(void 0!==a.unresolved||i.severities)return!1;var t=a.options;if(!t)return!0;if(t.source)return!1;var e=b(t),r=[e.byType()?1:0,e.byStatus()&&function(t){return _.reduce(t,function(t,e){return e?t+1:t},0)}(_.values(t.status))||0,e.bySeverity()?1:0];return _.sum(r)<=1})()&&(a.paging=e.paging);var r=a.options;if(r){var n=b(r);e=_.filter(e,function(t){return(!n.byType()||_.includes(r.types,t.type))&&(!n.byStatus()||r.status[t.status])&&(!n.bySeverity()||r.severity===t.severity)})}return a.alarms=e}function g(t){var e=[["severity","time"],["asc","desc"]];if("ACTIVE_FIRST"===a.options.orderMode){var r={ACTIVE:1,ACKNOWLEDGED:0,CLEARED:-1};e=[[function(t){return r[t.status]},"severity","time"],["desc","asc","desc"]]}var n=_(t).filter(c).orderBy(e[0],e[1]).value(),i=_.get(a,"options.displayFilter");return i&&(n=_.filter(n,i)),a.filteredAlarms=n}function b(e){function t(t){return function(){return e&&!!t}}var r=e||{};return{byType:t(!_.isEmpty(r.types)),byStatus:t(r.status&&!_.isEmpty(r.status)&&function(t){return _.some(t,function(t){return!0===t})}(r.status)),bySeverity:t(r.severity),byDevices:function(){return t(!_.isEmpty(N()))}}}function S(){a.realtimeAnimation=!1,l()}function A(t,e){if(a.realtimeAnimation=!0,j(e,a.options)){var r=_.find(a.alarms,{id:e.id});r?E(e,r):L(e)}}function L(t){var e=L._executing;if(e)return e.creating=!0,F.reject(e);var r=C(t).then(function(t){a.alarms.unshift(t)}).finally(function(){L._executing=null});return L._executing=r}function E(e,t){var r=C(e,t.source.name);return n[e.id]&&(r=r.then(a.auditRefresh[e.id])),r.then(function(){a.realtimeAnimation=!0;var t=_.findIndex(a.alarms,{id:e.id});a.alarms[t]=e})}function w(t){_.remove(a.alarms,{id:t.id}),delete a.auditList[t.id],delete n[t.id]}function D(t,r){a.realtimeAnimation=!0,!_.some(a.alarms,function(t){var e;return t.id===r.id&&(j(r,a.options)?E(r,t):w(r),e=!0),e})&&j(r,a.options)&&L(r).catch(function(e,r){return function(t){return t&&t.creating&&_.isFunction(t.then)?t.then(_.partial(D,e,r)):F.reject(t)}}(t,r))}function T(t,e){var r;return a.realtimeAnimation=!0,_.forEach(a.alarms,function(t){t.id===e.id&&(w(e),r=!1)}),r}function C(e,t){var r=F.resolve(e);return _.defaultsDeep(e,{source:{name:t}}),!e.source.name&&e.source.id&&(r=function(t){return z.detail(t).then(B.getResData).then(function(t){return t.name})}(e.source.id).then(function(t){e.source.name=t}).then(function(){return e})),r}function j(t,e){return function(r,t){return!t||_.some(t,function(t,e){return t&&e===r.status})}(t,e.status)&&function(t,e){return _.isEmpty(e)||_.includes(e,t.type)}(t,e.types)&&function(t,e){return!e||e===t.severity}(t,e.severity)}function R(){return a.options&&Number(a.options.pageSize)||10}function I(){G.switchRealtime(a.$id,a.realtimeChannel)}function k(){return G.getStatus(a.$id,a.realtimeChannel)}function O(t,e){G.addListener(a.$id,a.realtimeChannel,t,e)}function $(){var t=a.realtimeChannel,e=function(){var t=N();return"/alarmsWithChildren/".concat(t.length?t.join(","):"*")}();if(t){if(e===t)return;G.removeSubscriber(a.$id,t),a.cancelDestroyRemoveSubscriber(),a.stopWatchingRealtime()}a.realtimeChannel=e,O("".concat(a.$id,"-subscribed"),S),O("CREATE",A),O("UPDATE",D),O("DELETE",T),a.cancelDestroyRemoveSubscriber=a.$on("$destroy",function(){return G.removeSubscriber(a.$id,a.realtimeChannel)}),a.stopWatchingRealtime=a.$watch("realtime",W),a.realtime&&I()}function N(){var t=a.options,e=t.source,r=t.sources,n=_.concat(r,e);return _(n).map(function(t){return B.hasId(t)&&B.getId(t)}).compact().value()}function W(){a.realtime&&l(),a.realtime!==k()&&I()}a.auditRefresh={},a.statusText=function(t){var e;switch((t.status||"").toUpperCase()){case K.status.ACKNOWLEDGED:e=r;break;case K.status.CLEARED:e=u;break;case K.status.ACTIVE:e=s;break;default:e=function(){return""}}return e(t)},a.isActive=function(t){return t.status===K.status.ACTIVE},a.toggle=function(t){n[t.id]=!n[t.id]},a.isOpen=function(t){return!0===n[t.id]},a.isNarrow=function(){return a.containerWidth<=991},a.changeStatus=function(t,e){a.changingStatus=!0;var r=q.getString('Alarm status changed to "{{status | translate}}".',{status:e}),n=K.update({id:t.id,status:e});return k()||(n=n.then(_.partial(o,t))),(n=n.then(function(){U.success(r)})).finally(function(){a.changingStatus=!1})},a.isFitSeverity=c,a.icon=K.icon,a.getStandardKeys=K.getStandardKeys.bind(K),a.getNonStandardKeys=K.getNonStandardKeys.bind(K),a.alarmDuration=function(t){return a.auditList&&a.auditList[t.id]?K.alarmDuration(t,a.auditList[t.id]):""},a.refresh=l,a.loadNext=d,a.createSmartRule=function(e){var t;if(a.smartRules){var r=x.get("smartRulesSvc");t=V.current().then(function(t){return r.addNewForInputAlarmAndOutputUserWithUI(e,t)})}return t},a.translateAlarmText=function(t){return q.getString(t.text)},a.getDeviceLinkFromAlarm=_.memoize(function(t){var e=H[J]||{};return e.getDeviceLinkFromAlarm?e.getDeviceLinkFromAlarm(t):["#","device",t.source.id].join("/")},function(t){return t.id}),a.$watch(function(){return{containerWidth:t.parent().width(),windowWidth:P.innerWidth}},function(t){a.containerWidth=t.containerWidth||t.windowWidth},!0),a.$watch("alarms",g,!0),a.$watch("severities",function(){l().then(function(){return g(a.alarms)})},!0),a.$on("alarmListRefresh",l),i.filter?a.$watch("options",function(){l().then($)},!0):a.realtime||l(),M.shouldShowGlobalSmartRules().then(function(t){a.smartRules=t&&B.checkIfModulesExist(["c8y.cockpit.config"])})}}}angular.module("c8y.ui").directive(J,t)}();