"use strict";!function(){function e(e,n,t,L){l.$inject=["$q","$routeParams"],d.$inject=["$q","$location","$uibModal","$window","gettextCatalog","c8yAlert","c8yModal","c8yUser","c8yRoles","c8yUserRolesUi","c8yUserInventoryRoles","c8yUserUtil","c8yPermissions","c8yLoginOptions","passwordStrengthCheckerFactory"];var r="c8y-user",o=["ROLE_USER_MANAGEMENT_READ","ROLE_USER_MANAGEMENT_ADMIN","ROLE_USER_MANAGEMENT_CREATE"],P=u(),$=u("/new"),C=u("/:userId"),a={template:"<c8y-user-list-view></c8y-user-list-view>"},i={priority:1e3,icon:r,name:L("Profile / Global roles"),template:'<c8y-user-detail-view user-id="$resolve.userId"></c8y-user-detail-view>',resolve:{userId:["$route",function(e){return e.current.params.userId}]}},s={priority:-1e3,icon:"c8y-modules",name:L("Application access"),template:'<c8y-user-application-access user="$resolve.user"></c8y-user-application-access>',resolve:{user:["$route","c8yUser","c8yBase",function(e,t,r){return t.detail(e.current.params.userId).then(r.getResData).then(function(n){return n.owner?t.detail(n.owner).then(r.getResData).then(function(e){return n._owner=e,n}).catch(function(){return n}):n})}]}},c={data:l};return{initUi:function(){e.addNavigation({parent:{name:L("Accounts"),icon:"c8y-accounts"},name:L("Users"),path:u().replace(/^\//,""),icon:r,priority:5e3,routerLinkExact:!1,showIfPermissions:{anyRole:o}}),n.when(P,a),n.when($,i),n.when(C,i),n.when(C,s),t.addTitle(C,c)},$get:d};function u(e){return"/users".concat(e||"")}function l(e,n){return e.when({title:n.userId})}function d(i,n,t,e,s,r,c,u,o,a,l,d,f,p,g){var v,y=g();return u.current().then(function(e){v=e.id}),{ROUTE_NEW_USER:$,fullName:function(e){return"".concat(e.firstName||""," ").concat(e.lastName||"")},toggleExpanded:function(e){var t=!e._expanded;(e._expanded=t)||!function n(e){_.forEach(e,function(e){e._expanded=t,n(e._owns)})}(e._owns);return e},createUserFlatTree:d.createUserFlatTree,visibleInList:function(e){return!_.get(e,"owner")||_.get(e,"_owner._expanded")},expandAll:function(e){_.forEach(e,function(e){e._expanded=!0})},collapseAll:function(e){_.forEach(e,function(e){delete e._expanded})},detailLink:h,editUser:function(e){n.path(h(e))},search:d.search,changeUser:function(e,n){var t={changeGlobalRoles:m,copyInventoryRoles:E,enable:w,disable:A,remove:R,delegate:U,removeDelegate:T},r="string"==typeof n?n:_.get(n,"name");return _.get(t,r,i.reject)(e,_.get(n,"data"))},getPasswordStrength:y.getStrengthForColor,getPasswordColor:y.getHexColorForColor,getPasswordIcon:y.getIconForColor,isTfaAvailable:u.isTfaAvailable,gotoList:function(){n.path(P)},userHierarchyActive:d.userHierarchyActive,hasAppManagement:function(e){return f.hasAnyRole(["ROLE_APPLICATION_MANAGEMENT_READ","ROLE_APPLICATION_MANAGEMENT_ADMIN"],e)},isUndeletable:function(e){return v?M(e)||f.hasRole(e,"ROLE_TENANT_ADMIN"):void 0},isCurrent:M,EXTERNAL_ORIGIN_TEXT:L("You cannot edit the user since it is managed via your authorization server."),LOCAL_USER_TEXT:L("You are about to create a local user which will not be able to log in via single sign-on.")};function h(e){return C.replace(/:userId/,e.id)}function m(e,n){var t=_.map(n.roles,"id");return o.global.updateGroups(e,t)}function E(o){return i.all({copy:a.copyFromUserDialog(o),assignedRoles:u.listInventoryRoles(o)}).then(function(e){var n="replace"===e.copy.process,t=e.copy.roles,r=_.keyBy(e.assignedRoles.data.inventoryAssignments,"managedObject");return l.copyUserRoles(t,r,o,n)})}function A(e){return u.disable(e)}function w(e){return u.enable(e)}function R(e){var r=e._owns,o=function n(e){return _(e._owns).map(function(e){return _.union(n(e),[e])}).flattenDeep().value()}(e),n=!!o.length,a=function(t){return function(e){var n=_.pick(e,["id"]);return n.owner=t,n}};return(n?t.open({component:"c8yUserRemoveChildrenModal",resolve:{user:_.constant(e)}}).result.then(function(e){var n;if(e.remove&&(n=function e(){var n=o.shift();return n&&u.remove(n).then(e)}()),!_.isUndefined(e.owner)){var t=_.map(r,a(e.owner));n=i.all(_.map(t,function(e){return u.save(e)}))}return n}):c({title:L("Delete user"),body:s.getString('You are about to delete user "{{userName}}". Do you want to proceed?',e),labels:{ok:L("Delete")},status:"danger"})).then(_.partial(u.remove,e)).then(_.partial(N,e)).then(_.constant({removeUser:!n,refresh:n}))}function N(e){return r.success(s.getString('User "{{userName}}" deleted.',e))}function U(e){return u.delegateTo(e).then(_.partial(I,e))}function I(e){return r.success(s.getString('You delegated to user "{{userName}}".',e))}function T(e){var n={id:e.id,delegatedBy:null};return u.save(n).then(_.partial(b,e))}function b(e){return r.success(s.getString('You removed delegation from user "{{userName}}".',e))}function M(e){return v&&v===e.id}}}e.$inject=["c8yNavigatorProvider","c8yViewsProvider","c8yTitleProvider","gettext"],angular.module("c8y.users").provider("c8yUsersUi",e)}();